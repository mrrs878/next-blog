{"pageProps":{"post":{"title":"React.js学习-图片懒加载（高阶组件实现）","tags":["React.js学习","HOC"],"categories":"React.js","description":"# 懒加载实现方式\n\nHTML5新API：`new IntersectionObserver(callback)`\n\n观察一个元素后，当元素出现在视口内，会触发回调\n\n[其他实现方式]([http://blog.p18c.top/2020/04/24/%E5%89%8D%E7%AB%AF%E6%9E%B6%E6%9E%84&%E8%BD%AF%E5%AE%9E%E5%8A%9B-%E9%A2%","createDate":"2020-05-12 23:03:54","updateDate":"2020-10-16 17:33:00","body":"<h1 id=\"懒加载实现方式\">懒加载实现方式</h1>\n<p>HTML5新API：<code>new IntersectionObserver(callback)</code></p>\n<p>观察一个元素后，当元素出现在视口内，会触发回调</p>\n<p><a href=\"%5Bhttp://blog.p18c.top/2020/04/24/%E5%89%8D%E7%AB%AF%E6%9E%B6%E6%9E%84&amp;%E8%BD%AF%E5%AE%9E%E5%8A%9B-%E9%A2%84%E5%8A%A0%E8%BD%BD&amp;%E6%87%92%E5%8A%A0%E8%BD%BD/%5D(http://blog.p18c.top/2020/04/24/%E5%89%8D%E7%AB%AF%E6%9E%B6%E6%9E%84&amp;%E8%BD%AF%E5%AE%9E%E5%8A%9B-%E9%A2%84%E5%8A%A0%E8%BD%BD&amp;%E6%87%92%E5%8A%A0%E8%BD%BD/)\">其他实现方式</a></p>\n<h1 id=\"代码实现\">代码实现</h1>\n<pre><code class=\"hljs language-tsx\"><span class=\"hljs-comment\">// MLazyLoad.tsx</span>\n\n<span class=\"hljs-keyword\">import</span> <span class=\"hljs-title class_\">React</span>, { useEffect, useRef, useState } <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">&#x27;react&#x27;</span>;\n<span class=\"hljs-keyword\">import</span> { clone } <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">&#x27;ramda&#x27;</span>;\n\n\n<span class=\"hljs-keyword\">interface</span> <span class=\"hljs-title class_\">PropsI</span> {\n  <span class=\"hljs-attr\">element</span>: <span class=\"hljs-function\">() =&gt;</span> <span class=\"hljs-variable constant_\">JSX</span>.<span class=\"hljs-property\">Element</span>,\n}\n\n<span class=\"hljs-keyword\">const</span> <span class=\"hljs-title class_\">LazyLoad</span>: <span class=\"hljs-title class_\">React</span>.<span class=\"hljs-property\">FC</span>&lt;<span class=\"hljs-title class_\">PropsI</span>&gt; = <span class=\"hljs-function\">(<span class=\"hljs-params\">props: PropsI</span>) =&gt;</span> {\n  <span class=\"hljs-keyword\">const</span> [<span class=\"hljs-title class_\">Element</span>, setElement] = useState&lt;<span class=\"hljs-variable constant_\">JSX</span>.<span class=\"hljs-property\">Element</span>&gt;(props.<span class=\"hljs-title function_\">element</span>());\n  <span class=\"hljs-keyword\">const</span> elementRef = useRef&lt;<span class=\"hljs-title class_\">HTMLDivElement</span>&gt;(<span class=\"hljs-literal\">null</span>);\n  <span class=\"hljs-title function_\">useEffect</span>(<span class=\"hljs-function\">() =&gt;</span> {\n    (<span class=\"hljs-keyword\">async</span> () =&gt; {\n      <span class=\"hljs-keyword\">if</span> (!elementRef || !elementRef.<span class=\"hljs-property\">current</span>) <span class=\"hljs-keyword\">return</span>;\n      <span class=\"hljs-keyword\">const</span> observer = <span class=\"hljs-keyword\">new</span> <span class=\"hljs-title class_\">IntersectionObserver</span>(<span class=\"hljs-function\">(<span class=\"hljs-params\">changes</span>) =&gt;</span> {\n        changes.<span class=\"hljs-title function_\">forEach</span>(<span class=\"hljs-function\">(<span class=\"hljs-params\">change</span>) =&gt;</span> {\n          <span class=\"hljs-keyword\">if</span> (change.<span class=\"hljs-property\">isIntersecting</span>) {\n            <span class=\"hljs-keyword\">const</span> <span class=\"hljs-title class_\">Com</span> = <span class=\"hljs-title function_\">clone</span>(<span class=\"hljs-title class_\">Element</span>);\n            <span class=\"hljs-title class_\">Com</span>.<span class=\"hljs-property\">props</span>.<span class=\"hljs-property\">src</span> = <span class=\"hljs-title class_\">Com</span>.<span class=\"hljs-property\">props</span>[<span class=\"hljs-string\">&#x27;data-src&#x27;</span>];\n            <span class=\"hljs-title class_\">Reflect</span>.<span class=\"hljs-title function_\">deleteProperty</span>(<span class=\"hljs-title class_\">Com</span>.<span class=\"hljs-property\">props</span>, <span class=\"hljs-string\">&#x27;data-src&#x27;</span>);\n            <span class=\"hljs-title function_\">setElement</span>(<span class=\"hljs-title class_\">Com</span>);\n            observer.<span class=\"hljs-title function_\">unobserve</span>(change.<span class=\"hljs-property\">target</span>);\n          }\n        });\n      });\n      observer.<span class=\"hljs-title function_\">observe</span>(elementRef.<span class=\"hljs-property\">current</span>);\n    })();\n  }, []);\n  <span class=\"hljs-keyword\">return</span> (\n    <span class=\"language-xml\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">div</span> <span class=\"hljs-attr\">ref</span>=<span class=\"hljs-string\">{elementRef}</span>&gt;</span>\n      {\n        Element\n      }\n    <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">div</span>&gt;</span></span>\n  );\n};\n\n<span class=\"hljs-keyword\">export</span> <span class=\"hljs-keyword\">default</span> <span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\">element: () =&gt; JSX.Element</span>) {\n  <span class=\"hljs-keyword\">return</span> (\n    <span class=\"language-xml\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">LazyLoad</span> <span class=\"hljs-attr\">element</span>=<span class=\"hljs-string\">{element}</span> /&gt;</span></span>\n  );\n}\n</code></pre>\n<h1 id=\"使用方式\">使用方式</h1>\n<pre><code class=\"hljs language-tsx\"><span class=\"hljs-keyword\">const</span> <span class=\"hljs-title function_\">ImageNode</span> = (<span class=\"hljs-params\"></span>) =&gt; <span class=\"language-xml\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">img</span> <span class=\"hljs-attr\">className</span>=<span class=\"hljs-string\">{style.itemImg}</span> <span class=\"hljs-attr\">data-src</span>=<span class=\"hljs-string\">&quot;xxx&quot;</span> <span class=\"hljs-attr\">alt</span>=<span class=\"hljs-string\">&quot;&quot;</span> /&gt;</span></span>;\n\n<span class=\"language-xml\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">div</span>&gt;</span>\n    {\n        lazyLoad(ImageNode)\n    }\n<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">div</span>&gt;</span></span>\n</code></pre>\n<h1 id=\"效果\">效果</h1>\n<p><img src=\"https://mrrsblog.oss-cn-shanghai.aliyuncs.com/lazyload.gif\" alt=\"lazyload\"></p>\n"}},"__N_SSG":true}
{"pageProps":{"post":{"title":"异常监控-异常上报","tags":["异常监控"],"categories":"前端架构&软实力","description":"# 上报数据结构设计\n\n## 公共信息\n\n```js\ninterface BaseinfoI {\n  title: string;        // 页面名称\n  location: string;     // 页面url\n  message: string;      // 报错信息\n  kind: string;         // 报错大类\n  type: string;","createDate":"2020-07-28 11:15:28","updateDate":"2021-02-20 17:14:37","body":"<h1 id=\"上报数据结构设计\">上报数据结构设计</h1>\n<h2 id=\"公共信息\">公共信息</h2>\n<pre><code class=\"hljs language-js\">interface <span class=\"hljs-title class_\">BaseinfoI</span> {\n  <span class=\"hljs-attr\">title</span>: string;        <span class=\"hljs-comment\">// 页面名称</span>\n  <span class=\"hljs-attr\">location</span>: string;     <span class=\"hljs-comment\">// 页面url</span>\n  <span class=\"hljs-attr\">message</span>: string;      <span class=\"hljs-comment\">// 报错信息</span>\n  <span class=\"hljs-attr\">kind</span>: string;         <span class=\"hljs-comment\">// 报错大类</span>\n  <span class=\"hljs-attr\">type</span>: string;         <span class=\"hljs-comment\">// 报错小类</span>\n  <span class=\"hljs-attr\">errorType</span>: string;    <span class=\"hljs-comment\">// 报错类型</span>\n  <span class=\"hljs-attr\">userAgent</span>: string;    <span class=\"hljs-comment\">// 浏览器信息</span>\n}\n</code></pre>\n<h2 id=\"js错误\">JS错误</h2>\n<pre><code class=\"hljs language-js\">interface <span class=\"hljs-title class_\">JSRunTimeErrorEventI</span> <span class=\"hljs-keyword\">extends</span> <span class=\"hljs-title class_\">BaseinfoI</span> {\n  <span class=\"hljs-attr\">filename</span>: string;     <span class=\"hljs-comment\">// 报错js文件名</span>\n  <span class=\"hljs-attr\">position</span>: string;     <span class=\"hljs-comment\">// 报错位置(行号:列号)</span>\n  <span class=\"hljs-attr\">stack</span>: string;        <span class=\"hljs-comment\">// 堆栈信息</span>\n  <span class=\"hljs-attr\">selector</span>: string;     <span class=\"hljs-comment\">// 触发错误的DOM</span>\n}\n</code></pre>\n<h2 id=\"静态资源加载错误\">静态资源加载错误</h2>\n<pre><code class=\"hljs language-js\">interface <span class=\"hljs-title class_\">AssetsErrorI</span> <span class=\"hljs-keyword\">extends</span> <span class=\"hljs-title class_\">BaseinfoI</span> {\n  <span class=\"hljs-attr\">url</span>: string;          <span class=\"hljs-comment\">// 报错资源url</span>\n  <span class=\"hljs-attr\">nodeName</span>: string;     <span class=\"hljs-comment\">// 资源类型</span>\n}\n</code></pre>\n<h2 id=\"promise错误\">Promise错误</h2>\n<h2 id=\"ajax错误\">Ajax错误</h2>\n<pre><code class=\"hljs language-js\">interface <span class=\"hljs-title class_\">AjaxErrorEventI</span> <span class=\"hljs-keyword\">extends</span> <span class=\"hljs-title class_\">BaseinfoI</span> {\n  <span class=\"hljs-attr\">response</span>: string;     <span class=\"hljs-comment\">// 后端响应</span>\n  <span class=\"hljs-attr\">status</span>: number;       <span class=\"hljs-comment\">// 请求状态码</span>\n  <span class=\"hljs-attr\">method</span>: string;       <span class=\"hljs-comment\">// 请求方法</span>\n  <span class=\"hljs-attr\">url</span>: string;          <span class=\"hljs-comment\">// 请求地址</span>\n  <span class=\"hljs-attr\">params</span>: string;       <span class=\"hljs-comment\">// 请求参数</span>\n}\n</code></pre>\n<h1 id=\"上报方式\">上报方式</h1>\n<h2 id=\"img\">img</h2>\n<pre><code class=\"hljs language-js\"><span class=\"hljs-keyword\">new</span> <span class=\"hljs-title class_\">Img</span>(<span class=\"hljs-string\">`http://xxx/report?info=<span class=\"hljs-subst\">${xxx}</span>`</span>)\n</code></pre>\n<h2 id=\"navigatorsendbeacon\">navigator.sendBeacon</h2>\n<p>MDN:<code>navigator.sendBeacon()</code>方法可用于通过HTTP将少量数据异步传输到Web服务器。使用<code>sendBeacon()</code>方法会使用户代理在有机会时异步地向服务器发送数据，同时不会延迟页面的卸载或影响下一导航的载入性能。这就解决了提交分析数据时的所有的问题：数据可靠，传输异步并且不会影响下一页面的加载。此外，代码实际上还要比其他技术简单许多！</p>\n<pre><code class=\"hljs language-js\">navigator.<span class=\"hljs-title function_\">sendBeacon</span>(<span class=\"hljs-string\">&quot;/log&quot;</span>, analyticsData)\n</code></pre>\n<h2 id=\"请求接口\">请求接口</h2>\n<h1 id=\"后端处理\">后端处理</h1>\n<p>// todo</p>\n"}},"__N_SSG":true}
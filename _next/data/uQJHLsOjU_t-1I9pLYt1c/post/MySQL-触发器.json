{"pageProps":{"post":{"title":"MySQL-触发器","tags":["MySQL","触发器"],"categories":"数据库 MySQL","description":"# MySQL-触发器\n## 什么是触发器\n- 触发器是一种**特殊的存储过程**，它在插入/删除或修改表中的数据时**触发执行**，它比数据库本身有着更精细和更复杂的数据约束力。\n\n## 触发器的作用\n- 用于实现完整性约束\n- 通过触发器，用户可以实现MySQL数据库本身并不支持的一些特性，如对于传统CHECK约束的支持，物化视图，高级复制，审计等特性\n\n## 触发器的特性\n- 监视地点：一","createDate":"2018-11-13 22:51:06","updateDate":"10/1/2021, 3:34:43 AM","body":"<h1 id=\"mysql-触发器\">MySQL-触发器</h1>\n<h2 id=\"什么是触发器\">什么是触发器</h2>\n<ul>\n<li>触发器是一种<strong>特殊的存储过程</strong>，它在插入/删除或修改表中的数据时<strong>触发执行</strong>，它比数据库本身有着更精细和更复杂的数据约束力。</li>\n</ul>\n<h2 id=\"触发器的作用\">触发器的作用</h2>\n<ul>\n<li>用于实现完整性约束</li>\n<li>通过触发器，用户可以实现MySQL数据库本身并不支持的一些特性，如对于传统CHECK约束的支持，物化视图，高级复制，审计等特性</li>\n</ul>\n<h2 id=\"触发器的特性\">触发器的特性</h2>\n<ul>\n<li>监视地点：一般就是某一张表</li>\n<li>监视/触发事件：UPDATE/INSERT/DELETE</li>\n<li>触发时间：AFTER/BEFORE</li>\n</ul>\n<h2 id=\"触发器的创建语法\">触发器的创建语法</h2>\n<pre><code class=\"hljs language-SQL\"><span class=\"hljs-keyword\">CREATE</span>\n[DEFINER <span class=\"hljs-operator\">=</span> { <span class=\"hljs-keyword\">user</span> <span class=\"hljs-operator\">|</span> <span class=\"hljs-built_in\">CURRENT_USER</span> }]\n<span class=\"hljs-keyword\">TRIGGER</span> trigger_name\ntrigger_time trigger_event\n<span class=\"hljs-keyword\">ON</span> tbl_name <span class=\"hljs-keyword\">FOR</span> <span class=\"hljs-keyword\">EACH</span> <span class=\"hljs-type\">ROW</span>\ntrigger_body\n\ntrigger_time: { BEFORE <span class=\"hljs-operator\">|</span> AFTER }\ntrigger_event: { <span class=\"hljs-keyword\">INSERT</span> <span class=\"hljs-operator\">|</span> <span class=\"hljs-keyword\">UPDATE</span> <span class=\"hljs-operator\">|</span> <span class=\"hljs-keyword\">DELETE</span> }\n</code></pre>\n<ul>\n<li>触发程序是与表有关的数据库对象，当表上出现特定事件时将激活该对象。触发程序与tbl_name相关，tbl_name必须引用永久性表，不能将触发程序与TEMPORARY表或视图关联起来。</li>\n<li>对于具有相同触发程序动作事件和时间的给定表，不能有两个触发程序。</li>\n<li>trigger_body是当触发程序激活时执行的语句。可以使用BEGIN...END复合语句结构。</li>\n<li>对于INSERT而言，新插入的行用NEW表示，行中的每一列值用NEW.col_name表示。</li>\n<li>对于DELETE而言，欲删除的那一行用OLD表示，行中的每一列值用OLD.col_name表示。</li>\n<li>对于UPDATE而言，修改前的行用OLD表示，修改后的行用NEW表示。</li>\n</ul>\n<h2 id=\"触发器的管理\">触发器的管理</h2>\n<ul>\n<li>查看所有触发器<pre><code class=\"hljs language-SQL\"><span class=\"hljs-keyword\">SHOW</span> TRIGGERS [<span class=\"hljs-keyword\">FROM</span> db_name] [like_or_where]\n</code></pre>\n</li>\n<li>MySQL中有一个information_schema.TRIGGERS表，存储所有库中的触发器，查看：<pre><code class=\"hljs language-SQL\"><span class=\"hljs-keyword\">DESC</span> information_schema.TRIGGERS\n</code></pre>\n</li>\n<li>删除触发器<pre><code class=\"hljs language-SQL\"><span class=\"hljs-keyword\">DROP</span> <span class=\"hljs-keyword\">VIEW</span> [IF <span class=\"hljs-keyword\">EXISTS</span>]\nview_name [, view_name] ...\n[RESTRICT <span class=\"hljs-operator\">|</span> CASCADE]\n</code></pre>\n</li>\n</ul>\n<h2 id=\"触发器的使用示例\">触发器的使用示例</h2>\n<h3 id=\"基本使用\">基本使用</h3>\n<pre><code class=\"hljs language-SQL\">DELIMITER <span class=\"hljs-operator\">/</span><span class=\"hljs-operator\">/</span>\n<span class=\"hljs-keyword\">CREATE</span> <span class=\"hljs-keyword\">TRIGGER</span> user_trg\nAFTER <span class=\"hljs-keyword\">INSERT</span>\n<span class=\"hljs-keyword\">ON</span> user_info <span class=\"hljs-keyword\">FOR</span> <span class=\"hljs-keyword\">EACH</span> <span class=\"hljs-type\">ROW</span>\n<span class=\"hljs-keyword\">BEGIN</span>\n   <span class=\"hljs-keyword\">INSERT</span> <span class=\"hljs-keyword\">INTO</span> user_salaries <span class=\"hljs-keyword\">SELECT</span> new.id, new.user_name, <span class=\"hljs-number\">0</span>;\n<span class=\"hljs-keyword\">END</span>;\n<span class=\"hljs-operator\">/</span><span class=\"hljs-operator\">/</span>\nDELIMITER;\n\n<span class=\"hljs-keyword\">INSERT</span> <span class=\"hljs-keyword\">INTO</span> user_info <span class=\"hljs-keyword\">SELECT</span> <span class=\"hljs-number\">1</span>, <span class=\"hljs-string\">&#x27;张三&#x27;</span>， <span class=\"hljs-string\">&#x27;123456&#x27;</span>;\n</code></pre>\n<p><img src=\"https://t1.picb.cc/uploads/2018/11/13/JS7x7L.png\" alt=\"enter image description here\"></p>\n<h3 id=\"对于约束的支持\">对于约束的支持</h3>\n<pre><code class=\"hljs language-SQL\"><span class=\"hljs-keyword\">CREATE</span> <span class=\"hljs-keyword\">TABLE</span> userCash(id <span class=\"hljs-type\">INT</span> UNSIGNED <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-keyword\">NULL</span> AUTO_INCREMENT <span class=\"hljs-keyword\">PRIMARY</span> KEY, \n                       cash <span class=\"hljs-type\">INT</span> UNSIGNED <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-keyword\">NULL</span> <span class=\"hljs-keyword\">DEFAULT</span> <span class=\"hljs-number\">0</span>\n)ENGINE <span class=\"hljs-operator\">=</span> INNODB CHARSET <span class=\"hljs-operator\">=</span> <span class=\"hljs-string\">&#x27;UTF8&#x27;</span>;\n<span class=\"hljs-keyword\">CREATE</span> <span class=\"hljs-keyword\">TABLE</span> userCashErr_log (\n    id <span class=\"hljs-type\">INT</span> UNSIGNED <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-keyword\">NULL</span> AUTO_INCREMENT <span class=\"hljs-keyword\">PRIMARY</span> KEY,\n    old_cash <span class=\"hljs-type\">INT</span> UNSIGNED <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-keyword\">NULL</span>,\n    new_cash <span class=\"hljs-type\">INT</span> UNSIGNED <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-keyword\">NULL</span>,\n    user_name <span class=\"hljs-type\">VARCHAR</span>(<span class=\"hljs-number\">20</span>),\n    <span class=\"hljs-type\">time</span> DATETIME\n)ENGINE <span class=\"hljs-operator\">=</span> INNODB CHARSET <span class=\"hljs-operator\">=</span> <span class=\"hljs-string\">&#x27;UTF8&#x27;</span>;\n\nDELIMITER <span class=\"hljs-operator\">/</span><span class=\"hljs-operator\">/</span>\n<span class=\"hljs-keyword\">CREATE</span> <span class=\"hljs-keyword\">TRIGGER</span> userCashUpdate_tgr \nBEFORE <span class=\"hljs-keyword\">UPDATE</span>\n<span class=\"hljs-keyword\">ON</span> userCash <span class=\"hljs-keyword\">FOR</span> <span class=\"hljs-keyword\">EACH</span> <span class=\"hljs-type\">ROW</span>\n<span class=\"hljs-keyword\">BEGIN</span>\n    IF new.cash <span class=\"hljs-operator\">-</span> old.cash <span class=\"hljs-operator\">&gt;</span> <span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">THEN</span>\n        <span class=\"hljs-keyword\">INSERT</span> <span class=\"hljs-keyword\">INTO</span> userCashErr_log <span class=\"hljs-keyword\">SELECT</span> old.id, old.cash, new.cash, <span class=\"hljs-keyword\">USER</span>(), NOW();\n        <span class=\"hljs-keyword\">SET</span> new.cash <span class=\"hljs-operator\">=</span> old.cash;\n    <span class=\"hljs-keyword\">END</span> IF;\n<span class=\"hljs-keyword\">END</span>;\n<span class=\"hljs-operator\">/</span><span class=\"hljs-operator\">/</span>\nDELIMITER ;\n\n<span class=\"hljs-keyword\">INSERT</span> <span class=\"hljs-keyword\">INTO</span> userCash <span class=\"hljs-keyword\">SELECT</span> <span class=\"hljs-number\">1</span>, <span class=\"hljs-number\">10000</span>;\n<span class=\"hljs-keyword\">SELECT</span> <span class=\"hljs-operator\">*</span> <span class=\"hljs-keyword\">FROM</span> userCashErr_log;\n<span class=\"hljs-keyword\">UPDATE</span> userCash <span class=\"hljs-keyword\">SET</span> cash <span class=\"hljs-operator\">=</span> cash <span class=\"hljs-operator\">-</span> (<span class=\"hljs-number\">-20</span>) <span class=\"hljs-keyword\">WHERE</span> id <span class=\"hljs-operator\">=</span> <span class=\"hljs-number\">1</span>;\n<span class=\"hljs-keyword\">SELECT</span> <span class=\"hljs-operator\">*</span> <span class=\"hljs-keyword\">FROM</span> userCashErr_log;\n</code></pre>\n<p><img src=\"https://t1.picb.cc/uploads/2018/11/13/JS7T9W.png\" alt=\"enter image description here\"></p>\n"}},"__N_SSG":true}
{"pageProps":{"post":{"title":"前端架构&软实力复习-图片预加载&懒加载","tags":["预加载","懒加载"],"categories":"2021复习","description":"## 预加载\n\n`new`一个新的`Image`，给`Image`的`src`赋值为真正的`src`；该`Image`在加载完毕后相应的图片资源就会在本地缓存\n\n## 懒加载\n\n首先设置一个把`src`设置为临时的`data-src`属性，`src`设置为一个loading图，待当前元素出现在视口后用`data-src`替换`src`\n\n可供实现的方案：\n\n- `window.onscroll","createDate":"2021-05-27 10:17:46","updateDate":"2021-05-27 18:42:04","body":"<h2 id=\"预加载\">预加载</h2>\n<p><code>new</code>一个新的<code>Image</code>，给<code>Image</code>的<code>src</code>赋值为真正的<code>src</code>；该<code>Image</code>在加载完毕后相应的图片资源就会在本地缓存</p>\n<h2 id=\"懒加载\">懒加载</h2>\n<p>首先设置一个把<code>src</code>设置为临时的<code>data-src</code>属性，<code>src</code>设置为一个loading图，待当前元素出现在视口后用<code>data-src</code>替换<code>src</code></p>\n<p>可供实现的方案：</p>\n<ul>\n<li><p><code>window.onscroll（节流）</code> + <code>clientTop</code> + <code>offsetTop</code> + <code>clientHieght</code> + <code>scrollTop</code></p>\n<p>  不容易判断元素位置</p>\n</li>\n<li><p><code>widnow.onscroll（节流）</code> + <code>Element.getBoundingClientRect()</code></p>\n<p>  <code>getBoundingClientRect()</code>会触发回流</p>\n</li>\n<li><p><code>IntersectionObserver</code> + <a href=\"https://github.com/Financial-Times/polyfill-library/blob/master/polyfills/IntersectionObserver/polyfill.js\">polyfill</a></p>\n</li>\n<li><p><code>img</code>的<code>lazy</code>属性</p>\n<p>  兼容性差</p>\n</li>\n</ul>\n<p>以<code>IntersectionObserver</code>为实现方案：</p>\n<pre><code class=\"hljs language-html\"><span class=\"hljs-meta\">&lt;!DOCTYPE <span class=\"hljs-keyword\">html</span>&gt;</span>\n<span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">html</span> <span class=\"hljs-attr\">lang</span>=<span class=\"hljs-string\">&quot;en&quot;</span>&gt;</span>\n<span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">head</span>&gt;</span>\n  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">meta</span> <span class=\"hljs-attr\">charset</span>=<span class=\"hljs-string\">&quot;UTF-8&quot;</span>&gt;</span>\n  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">meta</span> <span class=\"hljs-attr\">http-equiv</span>=<span class=\"hljs-string\">&quot;X-UA-Compatible&quot;</span> <span class=\"hljs-attr\">content</span>=<span class=\"hljs-string\">&quot;IE=edge&quot;</span>&gt;</span>\n  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">meta</span> <span class=\"hljs-attr\">name</span>=<span class=\"hljs-string\">&quot;viewport&quot;</span> <span class=\"hljs-attr\">content</span>=<span class=\"hljs-string\">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span>\n  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">title</span>&gt;</span>Document<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">title</span>&gt;</span>\n<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">head</span>&gt;</span>\n<span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">body</span>&gt;</span>\n  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">div</span> <span class=\"hljs-attr\">style</span>=<span class=\"hljs-string\">&quot;height: 100vh;&quot;</span>&gt;</span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">div</span>&gt;</span>\n  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">img</span> <span class=\"hljs-attr\">id</span>=<span class=\"hljs-string\">&quot;img&quot;</span> <span class=\"hljs-attr\">data-src</span>=<span class=\"hljs-string\">&quot;https://mrrsblog.oss-cn-shanghai.aliyuncs.com/avatar.jpg&quot;</span> <span class=\"hljs-attr\">alt</span>=<span class=\"hljs-string\">&quot;&quot;</span> <span class=\"hljs-attr\">srcset</span>=<span class=\"hljs-string\">&quot;&quot;</span>&gt;</span>\n  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span>&gt;</span><span class=\"language-javascript\">\n    <span class=\"hljs-keyword\">const</span> observer = <span class=\"hljs-keyword\">new</span> <span class=\"hljs-title class_\">IntersectionObserver</span>(<span class=\"hljs-function\">(<span class=\"hljs-params\">changes</span>) =&gt;</span> {\n      changes.<span class=\"hljs-title function_\">forEach</span>(<span class=\"hljs-function\">(<span class=\"hljs-params\">change</span>) =&gt;</span> {\n        <span class=\"hljs-keyword\">if</span> (change.<span class=\"hljs-property\">isIntersecting</span>) {\n          <span class=\"hljs-keyword\">const</span> img = change.<span class=\"hljs-property\">target</span>;\n          img.<span class=\"hljs-property\">src</span> = img.<span class=\"hljs-property\">dataset</span>.<span class=\"hljs-property\">src</span>;\n          <span class=\"hljs-title class_\">Reflect</span>.<span class=\"hljs-title function_\">deleteProperty</span>(img.<span class=\"hljs-property\">dataset</span>, <span class=\"hljs-string\">&#x27;src&#x27;</span>);\n          observer.<span class=\"hljs-title function_\">unobserve</span>(img);\n        }\n      })\n    });\n    observer.<span class=\"hljs-title function_\">observe</span>(<span class=\"hljs-variable language_\">document</span>.<span class=\"hljs-title function_\">querySelector</span>(<span class=\"hljs-string\">&#x27;#img&#x27;</span>));\n  </span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span>\n  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">script</span>&gt;</span><span class=\"language-javascript\">\n      <span class=\"hljs-comment\">// todo 添加节流</span>\n     <span class=\"hljs-variable language_\">window</span>.<span class=\"hljs-title function_\">addEventListener</span>(<span class=\"hljs-string\">&#x27;scroll&#x27;</span>, <span class=\"hljs-function\">() =&gt;</span> {\n      <span class=\"hljs-keyword\">const</span> innerHeight = <span class=\"hljs-variable language_\">window</span>.<span class=\"hljs-property\">innerHeight</span> || <span class=\"hljs-variable language_\">document</span>.<span class=\"hljs-property\">documentElement</span>.<span class=\"hljs-property\">clientHeight</span> || <span class=\"hljs-variable language_\">document</span>.<span class=\"hljs-property\">body</span>.<span class=\"hljs-property\">clientHeight</span>;\n      <span class=\"hljs-keyword\">const</span> img = <span class=\"hljs-variable language_\">document</span>.<span class=\"hljs-title function_\">querySelector</span>(<span class=\"hljs-string\">&quot;#img&quot;</span>);\n      <span class=\"hljs-variable language_\">console</span>.<span class=\"hljs-title function_\">log</span>(img.<span class=\"hljs-property\">dataset</span>.<span class=\"hljs-property\">src</span>);\n      <span class=\"hljs-keyword\">const</span> { left, right, top, bottom } = img.<span class=\"hljs-title function_\">getBoundingClientRect</span>();\n      <span class=\"hljs-keyword\">if</span> (innerHeight &gt; top &amp;&amp; bottom &gt; -<span class=\"hljs-number\">30</span>) {\n        img.<span class=\"hljs-property\">src</span> = img.<span class=\"hljs-property\">dataset</span>.<span class=\"hljs-property\">src</span>;\n        <span class=\"hljs-title class_\">Reflect</span>.<span class=\"hljs-title function_\">deleteProperty</span>(img.<span class=\"hljs-property\">dataset</span>, <span class=\"hljs-string\">&#x27;src&#x27;</span>);\n      }\n    })\n  </span><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">script</span>&gt;</span>\n<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">body</span>&gt;</span>\n<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">html</span>&gt;</span>\n</code></pre>\n"}},"__N_SSG":true}
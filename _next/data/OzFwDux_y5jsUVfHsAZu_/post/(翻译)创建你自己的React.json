{"pageProps":{"post":{"title":"(ç¿»è¯‘)åˆ›å»ºä½ è‡ªå·±çš„React","tags":["React.js"],"categories":"React.js","description":"> åŸæ–‡é“¾æ¥:https://pomb.us/build-your-own-react/\n\n# Build your own React\n\næˆ‘ä»¬å°†ä»å¤´å¼€å§‹é‡å†™Reactã€‚ ä¸€æ­¥æ­¥ã€‚ éµå¾ªçœŸå®çš„Reactä»£ç ä¸­çš„æ¶æ„ï¼Œä½†æ²¡æœ‰æ‰€æœ‰çš„ä¼˜åŒ–å’Œéå¿…è¦çš„åŠŸèƒ½ã€‚\n\nå¦‚æœæ‚¨é˜…è¯»è¿‡[æˆ‘ä»¥å‰çš„ä»»ä½•â€œæ„å»ºè‡ªå·±çš„Reactâ€æ–‡ç« ](https://engineering.hexacta.com/didact-lear","createDate":"2020-11-02 14:25:18","updateDate":"2020-11-11 15:00:53","body":"<blockquote>\n<p>åŸæ–‡é“¾æ¥:<a href=\"https://pomb.us/build-your-own-react/\">https://pomb.us/build-your-own-react/</a></p>\n</blockquote>\n\n      <h1>\n        <span class=\"prefix\"></span>\n        <span class=\"content\">Build your own React</span>\n        <span class=\"suffix\"></span>\n      </h1>\n    <p>æˆ‘ä»¬å°†ä»å¤´å¼€å§‹é‡å†™Reactã€‚ ä¸€æ­¥æ­¥ã€‚ éµå¾ªçœŸå®çš„Reactä»£ç ä¸­çš„æ¶æ„ï¼Œä½†æ²¡æœ‰æ‰€æœ‰çš„ä¼˜åŒ–å’Œéå¿…è¦çš„åŠŸèƒ½ã€‚</p>\n<p>å¦‚æœæ‚¨é˜…è¯»è¿‡<a href=\"https://engineering.hexacta.com/didact-learning-how-react-works-by-building-it-from-scratch-51007984e5c5\">æˆ‘ä»¥å‰çš„ä»»ä½•â€œæ„å»ºè‡ªå·±çš„Reactâ€æ–‡ç« </a>ï¼Œä¸åŒä¹‹å¤„åœ¨äºè¯¥æ–‡ç« åŸºäºReact 16.8ï¼Œå› æ­¤æˆ‘ä»¬ç°åœ¨å¯ä»¥ä½¿ç”¨<code>hook</code>å¹¶åˆ é™¤æ‰€æœ‰ä¸<code>class</code>ç›¸å…³çš„ä»£ç ã€‚</p>\n<p>æ‚¨å¯ä»¥åœ¨æ—§åšå®¢æ–‡ç« ä¸­æ‰¾åˆ°å†å²è®°å½•ï¼Œå¹¶åœ¨<a href=\"https://github.com/pomber/didact\">Didactä»“åº“</a>ä¸­æ‰¾åˆ°ä»£ç ã€‚ è¿˜æœ‰ä¸€ä¸ªæ¼”è®²æ¶‰åŠç›¸åŒçš„å†…å®¹ã€‚</p>\n<p>ä»¥ä¸‹è¿™äº›éƒ½æ˜¯æˆ‘ä»¬å°†ä¸€ä¸€æ·»åŠ åˆ°æˆ‘ä»¬çš„Reactç‰ˆæœ¬ä¸­çš„å†…å®¹ï¼š</p>\n<ul>\n<li>ç¬¬ä¸€æ­¥: <code>createElement</code> å‡½æ•°</li>\n<li>ç¬¬äºŒæ­¥: <code>render</code> å‡½æ•°</li>\n<li>ç¬¬ä¸‰æ­¥: Concurrent Mode</li>\n<li>ç¬¬å››æ­¥: Fibers</li>\n<li>ç¬¬äº”æ­¥: Render and Commit Phases</li>\n<li>ç¬¬å…­æ­¥: Reconciliation</li>\n<li>ç¬¬ä¸ƒæ­¥: å‡½æ•°å¼ç»„ä»¶</li>\n<li>ç¬¬å…«æ­¥: Hooks</li>\n</ul>\n\n      <h2>\n        <span class=\"prefix\"></span>\n        <span class=\"content\">ç¬¬é›¶æ­¥</span>\n        <span class=\"suffix\"></span>\n      </h2>\n    <p>å¦‚æœæ‚¨å·²ç»å¯¹Reactï¼ŒJSXå’ŒDOMèŠ‚ç‚¹çš„å·¥ä½œæ–¹å¼æœ‰äº†å¾ˆå¥½çš„äº†è§£ï¼Œåˆ™å¯ä»¥è·³è¿‡æ­¤æ­¥éª¤ã€‚é¦–å…ˆè®©æˆ‘ä»¬å›é¡¾ä¸€äº›åŸºæœ¬æ¦‚å¿µï¼Œæˆ‘ä»¬å°†ä½¿ç”¨åªæœ‰ä¸‰è¡Œä»£ç çš„Reactåº”ç”¨ç¨‹åºï¼šç¬¬ä¸€ä¸ªå®šä¹‰ä¸€ä¸ªReactèŠ‚ç‚¹ï¼Œä¸‹ä¸€ä¸ªä»DOMè·å–ä¸€ä¸ªèŠ‚ç‚¹ï¼Œæœ€åä¸€ä¸ªå°†ReactèŠ‚ç‚¹æ¸²æŸ“åˆ°å®¹å™¨ä¸­ã€‚ç„¶åï¼Œæˆ‘ä»¬ä¼šåˆ é™¤æ‰€æœ‰ç‰¹å®šäºReactçš„ä»£ç å°†å…¶æ›¿æ¢ä¸ºåŸå§‹JavaScriptã€‚</p>\n<pre><code class=\"hljs language-js\"><span class=\"hljs-keyword\">const</span> element = <span class=\"language-xml\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">h1</span> <span class=\"hljs-attr\">title</span>=<span class=\"hljs-string\">&quot;foo&quot;</span>&gt;</span>Hello<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">h1</span>&gt;</span></span>\n<span class=\"hljs-keyword\">const</span> container = <span class=\"hljs-variable language_\">document</span>.<span class=\"hljs-title function_\">getElementById</span>(<span class=\"hljs-string\">&quot;root&quot;</span>)\n<span class=\"hljs-title class_\">ReactDOM</span>.<span class=\"hljs-title function_\">render</span>(element, container)\n</code></pre>\n<p>åœ¨ç¬¬ä¸€è¡Œä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨JSXå®šä¹‰äº†èŠ‚ç‚¹ã€‚ å®ƒä¸æ˜¯æœ‰æ•ˆçš„JavaScriptï¼Œå› æ­¤è¦ç”¨åŸç”ŸJSå–ä»£å®ƒã€‚é€šè¿‡Babelç­‰æ„å»ºå·¥å…·ï¼ŒJSXè½¬æ¢ä¸ºJSã€‚ è½¬æ¢é€šå¸¸å¾ˆç®€å•ï¼šä½¿ç”¨å¯¹<code>createElement</code>çš„è°ƒç”¨æ¥æ›¿æ¢æ ‡ç­¾å†…çš„ä»£ç ï¼Œå¹¶å°†æ ‡ç­¾<code>type</code>ã€<code>props</code>ã€<code>children</code>ä½œä¸ºå‚æ•°ä¼ é€’ã€‚<code>React.createElement</code>æ ¹æ®å…¶å‚æ•°åˆ›å»ºä¸€ä¸ªå¯¹è±¡ï¼Œé™¤äº†ä¸€äº›éªŒè¯ä¹‹å¤–ï¼Œè¿™å°±æ˜¯å…¨éƒ¨ã€‚ å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥å®‰å…¨åœ°å°†å‡½æ•°è°ƒç”¨æ›¿æ¢ä¸ºå…¶è¾“å‡ºã€‚</p>\n<pre><code class=\"hljs language-js\"><span class=\"hljs-keyword\">const</span> element = <span class=\"language-xml\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">h1</span> <span class=\"hljs-attr\">title</span>=<span class=\"hljs-string\">&quot;foo&quot;</span>&gt;</span>Hello<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">h1</span>&gt;</span></span>\n\nğŸ‘‡\n\n<span class=\"hljs-keyword\">const</span> element = <span class=\"hljs-title class_\">React</span>.<span class=\"hljs-title function_\">createElement</span>(\n  <span class=\"hljs-string\">&quot;h1&quot;</span>,\n  { <span class=\"hljs-attr\">title</span>: <span class=\"hljs-string\">&quot;foo&quot;</span> },\n  <span class=\"hljs-string\">&quot;Hello&quot;</span>\n)\n</code></pre>\n<p>è¿™å°±æ˜¯ä¸€ä¸ªèŠ‚ç‚¹ï¼Œä¸€ä¸ªå…·æœ‰ä¸¤ä¸ªå±æ€§çš„å¯¹è±¡ï¼š<code>type</code>å’Œ<code>props</code>ï¼ˆå—¯ï¼Œ<a href=\"https://github.com/facebook/react/blob/f4cc45ce962adc9f307690e1d5cfa28a288418eb/packages/react/src/ReactElement.js#L111\">å®ƒæœ‰æ›´å¤šçš„å±æ€§</a>ï¼Œä½†æ˜¯æˆ‘ä»¬åªå…³å¿ƒè¿™ä¸¤ä¸ªå±æ€§ï¼‰ã€‚<code>type</code>æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œç”¨äºæŒ‡å®šæˆ‘ä»¬è¦åˆ›å»ºçš„DOMèŠ‚ç‚¹çš„ç±»å‹ï¼Œå®ƒæ˜¯æ‚¨è¦åˆ›å»ºHTMLèŠ‚ç‚¹æ—¶ä¼ é€’ç»™<code>document.createElement</code>çš„<code>tagName</code>ã€‚ å®ƒä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œä½†æˆ‘ä»¬å°†å…¶ç•™ç»™æ­¥éª¤VIIã€‚<code>props</code>æ˜¯å¦ä¸€ä¸ªå¯¹è±¡ï¼Œå®ƒå…·æœ‰JSXå±æ€§ä¸­çš„æ‰€æœ‰é”®å’Œå€¼ã€‚ å®ƒè¿˜æœ‰ä¸€ä¸ªç‰¹æ®Šçš„å±æ€§ï¼š<code>children</code>ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œ<code>children</code>æ˜¯å­—ç¬¦ä¸²ï¼Œä½†é€šå¸¸æ˜¯åŒ…å«æ›´å¤šèŠ‚ç‚¹çš„æ•°ç»„ï¼ˆè¿™å°±æ˜¯ä¸ºä»€ä¹ˆèŠ‚ç‚¹ä¹Ÿæ˜¯æ ‘çš„åŸå› ï¼‰ã€‚</p>\n<pre><code class=\"hljs language-js\"><span class=\"hljs-keyword\">const</span> element = {\n  <span class=\"hljs-attr\">type</span>: <span class=\"hljs-string\">&quot;h1&quot;</span>,\n  <span class=\"hljs-attr\">props</span>: {\n    <span class=\"hljs-attr\">title</span>: <span class=\"hljs-string\">&quot;foo&quot;</span>,\n    <span class=\"hljs-attr\">children</span>: <span class=\"hljs-string\">&quot;Hello&quot;</span>,\n  },\n}\n</code></pre>\n<p>æˆ‘ä»¬éœ€è¦æ›¿æ¢çš„å¦ä¸€éƒ¨åˆ†Reactä»£ç æ˜¯å¯¹<code>ReactDOM.render</code>çš„è°ƒç”¨ã€‚<code>render</code>æ˜¯Reactæ›´æ–°DOMçš„åœ°æ–¹ï¼Œç°åœ¨ç”¨æˆ‘ä»¬è‡ªå·±çš„ä»£ç è¿›è¡Œæ“ä½œã€‚</p>\n<p>é¦–å…ˆï¼Œæˆ‘ä»¬ä½¿ç”¨èŠ‚ç‚¹<code>type</code>ï¼ˆåœ¨æœ¬ä¾‹ä¸­ä¸º<code>h1</code>ï¼‰åˆ›å»ºä¸€ä¸ª<code>node*</code>ã€‚ç„¶åï¼Œæˆ‘ä»¬å°†æ‰€æœ‰èŠ‚ç‚¹å±æ€§åˆ†é…ç»™è¯¥èŠ‚ç‚¹ã€‚ è¿™é‡Œåªæœ‰ä¸€ä¸ª<code>title</code>ã€‚*ä¸ºé¿å…æ··æ·†ï¼Œæˆ‘å°†ä½¿ç”¨<code>element</code>æ¥æŒ‡ä»£ReactèŠ‚ç‚¹ï¼Œå¹¶ä½¿ç”¨<code>node</code>æ¥æŒ‡ä»£DOMèŠ‚ç‚¹ã€‚</p>\n<p>ç„¶åï¼Œæˆ‘ä»¬ä¸º<code>children</code>åˆ›å»ºèŠ‚ç‚¹ã€‚ æˆ‘ä»¬åªæœ‰ä¸€ä¸ªå­—ç¬¦ä¸²ä½œä¸º<code>children</code>ï¼Œå› æ­¤æˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªæ–‡æœ¬èŠ‚ç‚¹ã€‚ä½¿ç”¨<code>textNode</code>è€Œä¸æ˜¯è®¾ç½®<code>innerText</code>å°†å…è®¸æˆ‘ä»¬ä»¥åä»¥ç›¸åŒçš„æ–¹å¼å¯¹å¾…æ‰€æœ‰èŠ‚ç‚¹ã€‚å¦è¯·æ³¨æ„ï¼Œæˆ‘ä»¬åƒè®¾ç½®<code>h1</code>æ ‡é¢˜ä¸€æ ·è®¾ç½®<code>nodeValue</code>ï¼Œå°±åƒå­—ç¬¦ä¸²ä¸­å¸¦æœ‰<code>props: {nodeValue: &quot;hello&quot;}</code>ã€‚æœ€åï¼Œæˆ‘ä»¬å°†<code>textNode</code>æ·»åŠ åˆ°<code>h1</code>å¹¶å°†<code>h1</code>æ·»åŠ åˆ°<code>container</code>ã€‚</p>\n<pre><code class=\"hljs language-js\"><span class=\"hljs-keyword\">const</span> element = {\n  <span class=\"hljs-attr\">type</span>: <span class=\"hljs-string\">&quot;h1&quot;</span>,\n  <span class=\"hljs-attr\">props</span>: {\n    <span class=\"hljs-attr\">title</span>: <span class=\"hljs-string\">&quot;foo&quot;</span>,\n    <span class=\"hljs-attr\">children</span>: <span class=\"hljs-string\">&quot;Hello&quot;</span>,\n  },\n}\n\n<span class=\"hljs-keyword\">const</span> container = <span class=\"hljs-variable language_\">document</span>.<span class=\"hljs-title function_\">getElementById</span>(<span class=\"hljs-string\">&quot;root&quot;</span>)\n\n<span class=\"hljs-keyword\">const</span> node = <span class=\"hljs-variable language_\">document</span>.<span class=\"hljs-title function_\">createElement</span>(element.<span class=\"hljs-property\">type</span>)\nnode[<span class=\"hljs-string\">&quot;title&quot;</span>] = element.<span class=\"hljs-property\">props</span>.<span class=\"hljs-property\">title</span>\n\n<span class=\"hljs-keyword\">const</span> text = <span class=\"hljs-variable language_\">document</span>.<span class=\"hljs-title function_\">createTextNode</span>(<span class=\"hljs-string\">&quot;&quot;</span>)\ntext[<span class=\"hljs-string\">&quot;nodeValue&quot;</span>] = element.<span class=\"hljs-property\">props</span>.<span class=\"hljs-property\">children</span>\n\nnode.<span class=\"hljs-title function_\">appendChild</span>(text)\ncontainer.<span class=\"hljs-title function_\">appendChild</span>(node)\n</code></pre>\n\n      <h2>\n        <span class=\"prefix\"></span>\n        <span class=\"content\">ç¬¬ä¸€æ­¥: createElement å‡½æ•°</span>\n        <span class=\"suffix\"></span>\n      </h2>\n    <p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬åˆ‡æ¢åˆ°å¦ä¸€ä¸ªAppï¼šè‡ªå·±å®ç°çš„ç®€æ˜“Reactã€‚</p>\n<p>é¦–å…ˆï¼Œä»ç¼–å†™<code>createElement</code>å¼€å§‹ï¼Œå°†JSXè½¬æ¢ä¸ºJSã€‚æ­£å¦‚åœ¨ä¸Šä¸€æ­¥ä¸­çœ‹åˆ°çš„ï¼Œ<code>element</code>æ˜¯å…·æœ‰ç±»å‹å’Œå±æ€§çš„å¯¹è±¡ã€‚<code>createElement</code>å”¯ä¸€éœ€è¦åšçš„å°±æ˜¯åˆ›å»ºè¯¥å¯¹è±¡ã€‚</p>\n<p>å› ä¸º<code>children</code>ä¹Ÿå¯ä»¥åŒ…å«åŸå§‹æ•°æ®ç±»å‹ï¼Œæ¯”å¦‚å­—ç¬¦ä¸²æˆ–æ•°å­—ï¼Œæ‰€ä»¥å¯¹ä¸æ˜¯<code>object</code>çš„<code>child</code>åˆ›å»ºç‰¹æ®ŠèŠ‚ç‚¹ç±»å‹ï¼š<code>TEXT_ELEMENT</code>ã€‚è¿™æ ·åšæ˜¯å› ä¸ºå¯ä»¥ç®€åŒ–ä»£ç ã€‚å¯¹äºæˆ‘ä»¬çš„åº“ï¼Œæˆ‘æ›´å–œæ¬¢ç®€å•è€Œä¸æ˜¯é«˜æ€§èƒ½ä»£ç ã€‚</p>\n<pre><code class=\"hljs language-js\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title function_\">createTextElement</span>(<span class=\"hljs-params\">text</span>) {\n  <span class=\"hljs-keyword\">return</span> {\n    <span class=\"hljs-attr\">type</span>: <span class=\"hljs-string\">&quot;TEXT_ELEMENT&quot;</span>,\n    <span class=\"hljs-attr\">props</span>: {\n      <span class=\"hljs-attr\">nodeValue</span>: text,\n      <span class=\"hljs-attr\">children</span>: [],\n    },\n  }\n}\n\n<span class=\"hljs-keyword\">function</span> <span class=\"hljs-title function_\">createElement</span>(<span class=\"hljs-params\">type, props, ...children</span>) {\n  <span class=\"hljs-keyword\">return</span> {\n    type,\n    <span class=\"hljs-attr\">props</span>: {\n      ...props,\n      <span class=\"hljs-attr\">children</span>: children.<span class=\"hljs-title function_\">map</span>(<span class=\"hljs-function\">(<span class=\"hljs-params\">child</span>) =&gt;</span> <span class=\"hljs-keyword\">typeof</span> child === <span class=\"hljs-string\">&quot;object&quot;</span>\n        ? child\n        : <span class=\"hljs-title function_\">createTextElement</span>(child)\n      ),\n    },\n  }\n}\n</code></pre>\n<p>ç›®å‰Babelä»ç„¶ä½¿ç”¨<code>React.createElement</code>ï¼Œä¸ºäº†æ›¿æ¢å®ƒï¼Œè®©æˆ‘ä»¬ç»™è‡ªå·±çš„åº“èµ·ä¸ªåå­—ã€‚æˆ‘ä»¬éœ€è¦ä¸€ä¸ªå¬èµ·æ¥åƒReactçš„åå­—ï¼Œä½†ä¹Ÿæš—ç¤ºäº†å®ƒçš„æ•™å­¦ç›®çš„ï¼Œæˆ‘ä»¬å«å®ƒ<code>Didact</code>ã€‚</p>\n<p>è®©æˆ‘ä»¬ä½¿ç”¨<code>/** @jsx Didact.createElement */</code>æ¥å‘Šè¯‰Babelä½¿ç”¨æˆ‘ä»¬è‡ªå·±çš„<code>createElement</code>æ¥è½¬æ¢jsxä»£ç ï¼š</p>\n<pre><code class=\"hljs language-js\"><span class=\"hljs-comment\">/** <span class=\"hljs-doctag\">@jsx</span> Didact.createElement */</span>\n<span class=\"hljs-keyword\">const</span> element = (\n  <span class=\"language-xml\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">div</span> <span class=\"hljs-attr\">id</span>=<span class=\"hljs-string\">&quot;foo&quot;</span>&gt;</span>\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">a</span>&gt;</span>bar<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">a</span>&gt;</span>\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">b</span> /&gt;</span>\n  <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">div</span>&gt;</span></span>\n)\n</code></pre>\n\n      <h2>\n        <span class=\"prefix\"></span>\n        <span class=\"content\">ç¬¬äºŒæ­¥ï¼šredner å‡½æ•°</span>\n        <span class=\"suffix\"></span>\n      </h2>\n    <p>é¦–å…ˆä½¿ç”¨elementçš„<code>type</code>åˆ›å»ºDOMèŠ‚ç‚¹ï¼Œç„¶åå°†æ–°elementæ·»åŠ åˆ°<code>container</code>ä¸­ã€‚ç„¶åå¯¹æ¯ä¸ª<code>child</code>é€’å½’è°ƒç”¨<code>render</code>ï¼š</p>\n<pre><code class=\"hljs language-js\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title function_\">render</span>(<span class=\"hljs-params\">element, container</span>) {\n  <span class=\"hljs-keyword\">const</span> dom = <span class=\"hljs-variable language_\">document</span>.<span class=\"hljs-title function_\">createElement</span>(element.<span class=\"hljs-property\">type</span>);\n\n  element.<span class=\"hljs-property\">props</span>.<span class=\"hljs-property\">children</span>.<span class=\"hljs-title function_\">forEach</span>(<span class=\"hljs-function\">(<span class=\"hljs-params\">child</span>) =&gt;</span> <span class=\"hljs-title function_\">render</span>(child, dom))\n\n  container.<span class=\"hljs-title function_\">appendChild</span>(dom);\n}\n</code></pre>\n<p>å…¶æ¬¡ï¼Œæˆ‘ä»¬è¿˜éœ€è¦å¤„ç†æ–‡æœ¬èŠ‚ç‚¹ï¼Œå¦‚æœelementç±»å‹ä¸º<code>TEXT_ELEMENT</code>ï¼Œæˆ‘ä»¬å°†åˆ›å»ºæ–‡æœ¬èŠ‚ç‚¹è€Œä¸æ˜¯æ™®é€šèŠ‚ç‚¹ï¼š</p>\n<pre><code class=\"hljs language-js\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title function_\">render</span>(<span class=\"hljs-params\">element, container</span>) {\n  <span class=\"hljs-comment\">// ...</span>\n  <span class=\"hljs-keyword\">const</span> dom = element.<span class=\"hljs-property\">type</span> === <span class=\"hljs-string\">&quot;TEXT_ELEMENT&quot;</span>\n    ? <span class=\"hljs-variable language_\">document</span>.<span class=\"hljs-title function_\">createTextNode</span>(<span class=\"hljs-string\">&quot;&quot;</span>)\n    : <span class=\"hljs-variable language_\">document</span>.<span class=\"hljs-title function_\">createElmenet</span>(element.<span class=\"hljs-property\">type</span>);\n  <span class=\"hljs-comment\">//...</span>\n}\n</code></pre>\n<p>æœ€åï¼Œå°†<code>props</code>åˆ†é…ç»™elementï¼š</p>\n<pre><code class=\"hljs language-js\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title function_\">render</span>(<span class=\"hljs-params\">element, container</span>) {\n  <span class=\"hljs-comment\">// ...</span>\n  <span class=\"hljs-keyword\">const</span> <span class=\"hljs-title function_\">isProperty</span> = key =&gt; key === <span class=\"hljs-string\">&quot;children&quot;</span>;\n  <span class=\"hljs-title class_\">Reflect</span>.<span class=\"hljs-title function_\">ownkeys</span>(element.<span class=\"hljs-property\">props</span>)\n    .<span class=\"hljs-title function_\">filter</span>(isProperty)\n    .<span class=\"hljs-title function_\">forEach</span>(<span class=\"hljs-function\">(<span class=\"hljs-params\">name</span>) =&gt;</span> dom[name] = element.<span class=\"hljs-property\">props</span>[name]);\n  <span class=\"hljs-comment\">// ...</span>\n}\n</code></pre>\n<p>è¿™æ ·çš„è¯ï¼Œæˆ‘ä»¬å°±æœ‰äº†ä¸€ä¸ªå¯ä»¥å°†JSXå‘ˆç°åˆ°DOMçš„åº“ï¼š</p>\n<pre><code class=\"hljs language-js\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title function_\">createTextElement</span>(<span class=\"hljs-params\">text</span>) {\n  <span class=\"hljs-keyword\">return</span> {\n    <span class=\"hljs-attr\">type</span>: <span class=\"hljs-string\">&quot;TEXT_ELEMENT&quot;</span>,\n    <span class=\"hljs-attr\">props</span>: {\n      <span class=\"hljs-attr\">nodeValue</span>: text,\n      <span class=\"hljs-attr\">children</span>: []\n    }\n  };\n}\n\n<span class=\"hljs-keyword\">function</span> <span class=\"hljs-title function_\">createElement</span>(<span class=\"hljs-params\">type, props, ...children</span>) {\n  <span class=\"hljs-keyword\">return</span> {\n    type,\n    <span class=\"hljs-attr\">props</span>: {\n      ...props,\n      <span class=\"hljs-attr\">children</span>: children.<span class=\"hljs-title function_\">map</span>(<span class=\"hljs-function\">(<span class=\"hljs-params\">child</span>) =&gt;</span>\n        <span class=\"hljs-keyword\">typeof</span> child === <span class=\"hljs-string\">&quot;object&quot;</span> ? child : <span class=\"hljs-title function_\">createTextElement</span>(child)\n      )\n    }\n  };\n}\n\n<span class=\"hljs-keyword\">function</span> <span class=\"hljs-title function_\">render</span>(<span class=\"hljs-params\">element, container</span>) {\n  <span class=\"hljs-keyword\">const</span> dom =\n    element.<span class=\"hljs-property\">type</span> === <span class=\"hljs-string\">&quot;TEXT_ELEMENT&quot;</span>\n      ? <span class=\"hljs-variable language_\">document</span>.<span class=\"hljs-title function_\">createTextNode</span>(<span class=\"hljs-string\">&quot;&quot;</span>)\n      : <span class=\"hljs-variable language_\">document</span>.<span class=\"hljs-title function_\">createElement</span>(element.<span class=\"hljs-property\">type</span>);\n\n  <span class=\"hljs-keyword\">const</span> <span class=\"hljs-title function_\">isProperty</span> = (<span class=\"hljs-params\">key</span>) =&gt; key !== <span class=\"hljs-string\">&quot;children&quot;</span>;\n  <span class=\"hljs-title class_\">Reflect</span>.<span class=\"hljs-title function_\">ownKeys</span>(element.<span class=\"hljs-property\">props</span>)\n    .<span class=\"hljs-title function_\">filter</span>(isProperty)\n    .<span class=\"hljs-title function_\">forEach</span>(<span class=\"hljs-function\">(<span class=\"hljs-params\">name</span>) =&gt;</span> (dom[name] = element.<span class=\"hljs-property\">props</span>[name]));\n\n  element.<span class=\"hljs-property\">props</span>.<span class=\"hljs-property\">children</span>.<span class=\"hljs-title function_\">map</span>(<span class=\"hljs-function\">(<span class=\"hljs-params\">child</span>) =&gt;</span> <span class=\"hljs-title function_\">render</span>(child, dom));\n\n  container.<span class=\"hljs-title function_\">appendChild</span>(dom);\n}\n\n<span class=\"hljs-keyword\">const</span> <span class=\"hljs-title class_\">Didact</span> = {\n  createElement,\n  render\n};\n\n<span class=\"hljs-comment\">/** <span class=\"hljs-doctag\">@jsx</span> Didact.createElement */</span>\n<span class=\"hljs-keyword\">const</span> element = (\n  <span class=\"language-xml\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">div</span> <span class=\"hljs-attr\">id</span>=<span class=\"hljs-string\">&quot;foo&quot;</span>&gt;</span>\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">h1</span>&gt;</span>Hello STEP1-STEP2<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">h1</span>&gt;</span>\n  <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">div</span>&gt;</span></span>\n);\n\n<span class=\"hljs-keyword\">const</span> container = <span class=\"hljs-variable language_\">document</span>.<span class=\"hljs-title function_\">querySelector</span>(<span class=\"hljs-string\">&quot;#step1&quot;</span>);\n\n<span class=\"hljs-title class_\">Didact</span>.<span class=\"hljs-title function_\">render</span>(element, container);\n</code></pre>\n\n      <h2>\n        <span class=\"prefix\"></span>\n        <span class=\"content\">ç¬¬ä¸‰æ­¥Concurrent Mode</span>\n        <span class=\"suffix\"></span>\n      </h2>\n    <p>åœ¨å¼€å§‹æ·»åŠ æ›´å¤šä»£ç ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦é‡æ„ã€‚</p>\n<p>ä¸Šé¢çš„é€’å½’è°ƒç”¨å­˜åœ¨é—®é¢˜ã€‚å¼€å§‹æ¸²æŸ“åï¼Œç›´åˆ°æ¸²æŸ“å®Œå®Œæ•´çš„elementæ ‘ï¼Œæˆ‘ä»¬æ‰ä¼šåœæ­¢ã€‚ å¦‚æœelementæ ‘å¾ˆå¤§ï¼Œåˆ™å¯èƒ½ä¼šé˜»å¡ä¸»çº¿ç¨‹å¤ªé•¿æ—¶é—´ã€‚ é‚£ä¹ˆå¦‚æœæµè§ˆå™¨éœ€è¦æ‰§è¡Œé«˜ä¼˜å…ˆçº§çš„æ“ä½œï¼ˆä¾‹å¦‚å¤„ç†ç”¨æˆ·è¾“å…¥æˆ–ä¿æŒåŠ¨ç”»æµç•…ï¼‰ï¼Œåˆ™å®ƒå¿…é¡»ç­‰åˆ°æ¸²æŸ“å®Œæˆä¸ºæ­¢ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å°†å·¥ä½œåˆ†æˆå‡ ä¸ªå°éƒ¨åˆ†ï¼Œåœ¨å®Œæˆæ¯ä¸ªå•å…ƒåï¼Œå¦‚æœéœ€è¦æ‰§è¡Œå…¶ä»–ä»»ä½•æ“ä½œï¼Œæˆ‘ä»¬å°†è®©æµè§ˆå™¨ä¸­æ–­æ¸²æŸ“ã€‚</p>\n<p>æˆ‘ä»¬ä½¿ç”¨<code>requestIdleCallback</code>è¿›è¡Œå¾ªç¯ã€‚ æ‚¨å¯ä»¥å°†<code>requestIdleCallback</code>çœ‹ä½œ<code>setTimeout</code>ï¼Œä½†æ˜¯æµè§ˆå™¨å°†åœ¨ä¸»çº¿ç¨‹ç©ºé—²æ—¶è¿è¡Œå›è°ƒï¼Œè€Œä¸æ˜¯å‘Šè¯‰å®ƒä½•æ—¶è¿è¡Œã€‚Reactä¸å†ä½¿ç”¨<code>requestIdleCallback</code>ï¼Œç°åœ¨å®ƒä½¿ç”¨scheduler packageã€‚ ä½†æ˜¯å¯¹äºæ­¤ç”¨ä¾‹ï¼Œå®ƒåœ¨æ¦‚å¿µä¸Šæ˜¯ç›¸åŒçš„ã€‚<code>requestIdleCallback</code>è¿˜ä¸ºæˆ‘ä»¬æä¾›äº†<code>deadline</code>å‚æ•°ã€‚ æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å®ƒæ¥æ£€æŸ¥æµè§ˆå™¨éœ€è¦å†æ¬¡æ§åˆ¶ä¹‹å‰æœ‰å¤šå°‘æ—¶é—´ã€‚</p>\n<p>è¦å¼€å§‹ä½¿ç”¨å¾ªç¯ï¼Œæˆ‘ä»¬éœ€è¦è®¾ç½®ç¬¬ä¸€ä¸ªå·¥ä½œå•å…ƒï¼Œç„¶åç¼–å†™ä¸€ä¸ª<code>performUnitOfWork</code>å‡½æ•°ï¼Œè¯¥å‡½æ•°ä¸ä»…æ‰§è¡Œå·¥ä½œï¼Œè¿˜è¿”å›ä¸‹ä¸€ä¸ªå·¥ä½œå•å…ƒã€‚</p>\n\n      <h2>\n        <span class=\"prefix\"></span>\n        <span class=\"content\">ç¬¬å››æ­¥Fiber</span>\n        <span class=\"suffix\"></span>\n      </h2>\n    <p>è¦ç»„ç»‡å·¥ä½œå•å…ƒï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªæ•°æ®ç»“æ„--Fiberæ ‘ã€‚æˆ‘ä»¬å°†ä¸ºæ¯ä¸ªå…ƒç´ åˆ†é…ä¸€æ ¹Fiberï¼Œå¹¶ä¸”æ¯ä¸ªFiberå°†æˆä¸ºä¸€ä¸ªå·¥ä½œå•å…ƒã€‚</p>\n<p>å‡å¦‚æˆ‘ä»¬è¦æ¸²æŸ“å¦‚ä¸‹çš„elementæ ‘ï¼Œé‚£ä¹ˆFiberæ ‘å°±å¦‚ä¸‹æ‰€ç¤ºï¼š</p>\n<pre><code class=\"hljs language-js\"><span class=\"hljs-title class_\">Didact</span>.<span class=\"hljs-title function_\">render</span>(\n  <span class=\"language-xml\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">div</span>&gt;</span>\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">h1</span>&gt;</span>\n      <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">p</span> /&gt;</span>\n      <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">a</span> /&gt;</span>\n    <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">h1</span>&gt;</span>\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">h2</span> /&gt;</span>\n  <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">div</span>&gt;</span></span>,\n  container\n)\n</code></pre>\n<p><img src=\"https://pomb.us/static/a88a3ec01855349c14302f6da28e2b0c/ac667/fiber1.png\" alt=\"\"></p>\n<p>åœ¨renderå‡½æ•°ä¸­ï¼Œæˆ‘ä»¬å°†åˆ›å»ºroot Fiberå¹¶å°†å…¶è®¾ç½®ä¸º<code>nextUnitOfWork</code>ã€‚ å‰©ä¸‹çš„å·¥ä½œå°†åœ¨<code>performUnitOfWork</code>å‡½æ•°ä¸Šè¿›è¡Œï¼Œæˆ‘ä»¬å°†ä¸ºæ¯ä¸ªFiberåšä¸‰ä»¶äº‹ï¼š</p>\n<ol>\n<li>å°†elementæ·»åŠ åˆ°DOM</li>\n<li>ä¸ºelementçš„å­ä»£åˆ›å»ºFilber</li>\n<li>é€‰æ‹©ä¸‹ä¸€ä¸ªå·¥ä½œå•å…ƒ</li>\n</ol>\n<p>è¯¥æ•°æ®ç»“æ„çš„ç›®æ ‡ä¹‹ä¸€æ˜¯ä½¿æŸ¥æ‰¾ä¸‹ä¸€ä¸ªå·¥ä½œå•å…ƒå˜å¾—å®¹æ˜“ã€‚ è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæ¯ä¸ªFiberéƒ½é“¾æ¥åˆ°å…¶ç¬¬ä¸€ä¸ªå­èŠ‚ç‚¹ã€ä¸‹ä¸€ä¸ªå…„å¼ŸèŠ‚ç‚¹å’Œçˆ¶èŠ‚ç‚¹ã€‚</p>\n<ul>\n<li>å½“æˆ‘ä»¬å®Œæˆå¯¹å½“å‰Fiberçš„å·¥ä½œæ—¶ï¼Œå¦‚æœæœ‰childï¼Œé‚£ä¹ˆè¯¥childå¯¹åº”çš„Fiberå°†æ˜¯ä¸‹ä¸€ä¸ªå·¥ä½œå•å…ƒã€‚åœ¨æˆ‘ä»¬çš„ç¤ºä¾‹ä¸­ï¼Œå½“æˆ‘ä»¬å®Œæˆdiv Fiberçš„å·¥ä½œæ—¶ï¼Œä¸‹ä¸€ä¸ªå·¥ä½œå•å…ƒå°†æ˜¯h1 Fiberã€‚</li>\n<li>å¦‚æœå½“å‰Fiberæ²¡æœ‰childï¼Œæˆ‘ä»¬å°†å…¶siblingä½œä¸ºä¸‹ä¸€ä¸ªå·¥ä½œå•å…ƒã€‚ä¾‹å¦‚ï¼Œp Fiberæ²¡æœ‰childï¼Œå› æ­¤æˆ‘ä»¬åœ¨å®Œæˆå½“å‰ä¹‹åä¸‹ä¸€ä¸ªå·¥ä½œå•å…ƒå°†æ˜¯h1ã€‚</li>\n<li>å¦‚æœå½“å‰Fiberæ—¢æ²¡æœ‰childä¹Ÿæ²¡æœ‰siblingï¼Œé‚£ä¹ˆæˆ‘ä»¬å»â€œuncleâ€ï¼šçˆ¶æ¯çš„å…„å¼ŸèŠ‚ç‚¹ã€‚ å°±åƒç¤ºä¾‹ä¸­çš„aå’Œh2 Fiberä¸€æ ·ã€‚</li>\n<li>å¦‚æœparentæ²¡æœ‰siblingï¼Œæˆ‘ä»¬ä¼šä¸æ–­æ£€æŸ¥parentï¼Œç›´åˆ°æ‰¾åˆ°æœ‰siblingçš„parentï¼Œæˆ–è€…ç›´åˆ°æ‰¾åˆ°rootã€‚ å¦‚æœåˆ°è¾¾rootï¼Œåˆ™æ„å‘³ç€æˆ‘ä»¬å·²ç»å®Œæˆäº†æ­¤æ¸²æŸ“çš„æ‰€æœ‰å·¥ä½œã€‚</li>\n</ul>\n<p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬å¼€å§‹å†™ä»£ç ã€‚</p>\n<p>é¦–å…ˆï¼Œæ›´æ”¹<code>render</code>å‡½æ•°å¹¶åˆ›å»º<code>createDom</code>å‡½æ•°</p>\n<pre><code class=\"hljs language-js\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title function_\">render</span>(<span class=\"hljs-params\">element, container</span>) {\n  nextUnitOfWork = {\n    <span class=\"hljs-attr\">dom</span>: container,\n    <span class=\"hljs-attr\">props</span>: {\n      <span class=\"hljs-attr\">children</span>: [element],\n    },\n  }\n}\n\n<span class=\"hljs-keyword\">function</span> <span class=\"hljs-title function_\">createDom</span>(<span class=\"hljs-params\">fiber</span>) {\n  <span class=\"hljs-keyword\">const</span> dom =\n    fiber.<span class=\"hljs-property\">type</span> == <span class=\"hljs-string\">&quot;TEXT_ELEMENT&quot;</span>\n      ? <span class=\"hljs-variable language_\">document</span>.<span class=\"hljs-title function_\">createTextNode</span>(<span class=\"hljs-string\">&quot;&quot;</span>)\n      : <span class=\"hljs-variable language_\">document</span>.<span class=\"hljs-title function_\">createElement</span>(fiber.<span class=\"hljs-property\">type</span>)\n  <span class=\"hljs-keyword\">const</span> <span class=\"hljs-title function_\">isProperty</span> = key =&gt; key !== <span class=\"hljs-string\">&quot;children&quot;</span>\n  <span class=\"hljs-title class_\">Object</span>.<span class=\"hljs-title function_\">keys</span>(fiber.<span class=\"hljs-property\">props</span>)\n    .<span class=\"hljs-title function_\">filter</span>(isProperty)\n    .<span class=\"hljs-title function_\">forEach</span>(<span class=\"hljs-function\"><span class=\"hljs-params\">name</span> =&gt;</span> {\n      dom[name] = fiber.<span class=\"hljs-property\">props</span>[name]\n    })\n  <span class=\"hljs-keyword\">return</span> dom\n}\n</code></pre>\n<p>ç„¶åï¼Œå½“æµè§ˆå™¨å‡†å¤‡å°±ç»ªæ—¶ï¼Œå®ƒå°†è°ƒç”¨æˆ‘ä»¬çš„<code>workLoop</code>ï¼Œæˆ‘ä»¬å°†ä»<code>root</code>å¼€å§‹æ‰§è¡Œæ¸²æŸ“ã€‚</p>\n<pre><code class=\"hljs language-js\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title function_\">workLoop</span>(<span class=\"hljs-params\">deadline</span>) {\n  <span class=\"hljs-keyword\">let</span> shouldYield = <span class=\"hljs-literal\">false</span>\n  <span class=\"hljs-keyword\">while</span> (nextUnitOfWork &amp;&amp; !shouldYield) {\n    nextUnitOfWork = <span class=\"hljs-title function_\">performUnitOfWork</span>(\n      nextUnitOfWork\n    )\n    shouldYield = deadline.<span class=\"hljs-title function_\">timeRemaining</span>() &lt; <span class=\"hljs-number\">1</span>\n  }\n  <span class=\"hljs-title function_\">requestIdleCallback</span>(workLoop)\n}\n</code></pre>\n<p>é¦–å…ˆï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ–°nodeå¹¶å°†å…¶æ·»åŠ åˆ°DOMã€‚æˆ‘ä»¬åœ¨<code>fibre.dom</code>å±æ€§ä¸­è·Ÿè¸ªDOMèŠ‚ç‚¹ã€‚</p>\n<pre><code class=\"hljs language-js\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title function_\">performUnitOfWork</span>(<span class=\"hljs-params\">fiber</span>) {\n  <span class=\"hljs-keyword\">if</span> (!fiber.<span class=\"hljs-property\">dom</span>) {\n    fiber.<span class=\"hljs-property\">dom</span> = <span class=\"hljs-title function_\">createDom</span>(fiber)\n  }\n  <span class=\"hljs-keyword\">if</span> (fiber.<span class=\"hljs-property\">parent</span>) {\n    fiber.<span class=\"hljs-property\">parent</span>.<span class=\"hljs-property\">dom</span>.<span class=\"hljs-title function_\">appendChild</span>(fiber.<span class=\"hljs-property\">dom</span>)\n  }\n  <span class=\"hljs-comment\">// TODO create new fibers</span>\n  <span class=\"hljs-comment\">// TODO return next unit of work</span>\n}\n</code></pre>\n<p>ç„¶åå¯¹æ¯ä¸ª<code>child</code>åˆ›å»ºFiber</p>\n<pre><code class=\"hljs language-js\"><span class=\"hljs-keyword\">const</span> elements = fiber.<span class=\"hljs-property\">props</span>.<span class=\"hljs-property\">children</span>\n  <span class=\"hljs-keyword\">let</span> index = <span class=\"hljs-number\">0</span>\n  <span class=\"hljs-keyword\">let</span> prevSibling = <span class=\"hljs-literal\">null</span>\n  <span class=\"hljs-keyword\">while</span> (index &lt; elements.<span class=\"hljs-property\">length</span>) {\n    <span class=\"hljs-keyword\">const</span> element = elements[index]\n    <span class=\"hljs-keyword\">const</span> newFiber = {\n      <span class=\"hljs-attr\">type</span>: element.<span class=\"hljs-property\">type</span>,\n      <span class=\"hljs-attr\">props</span>: element.<span class=\"hljs-property\">props</span>,\n      <span class=\"hljs-attr\">parent</span>: fiber,\n      <span class=\"hljs-attr\">dom</span>: <span class=\"hljs-literal\">null</span>,\n    }\n  }\n</code></pre>\n<p>ç„¶åå°†å…¶æ·»åŠ åˆ°Fiberæ ‘ä¸­ï¼Œå°†å…¶è®¾ç½®ä¸º<code>child</code>è¿˜æ˜¯<code>sibing</code>ï¼Œå…·ä½“å–å†³äºå®ƒæ˜¯å¦æ˜¯ç¬¬ä¸€ä¸ªchildã€‚</p>\n<pre><code class=\"hljs language-js\"><span class=\"hljs-keyword\">if</span> (index === <span class=\"hljs-number\">0</span>) {\n      fiber.<span class=\"hljs-property\">child</span> = newFiber\n    } <span class=\"hljs-keyword\">else</span> {\n      prevSibling.<span class=\"hljs-property\">sibling</span> = newFiber\n    }\n}\nprevSibling = newFiber\nindex++\n</code></pre>\n<p>æœ€åï¼Œæˆ‘ä»¬æŒ‰ç…§child â˜ sibling â˜ uncleæ¥é€‰æ‹©ä¸‹ä¸€å·¥ä½œå•å…ƒã€‚</p>\n<pre><code class=\"hljs language-js\"><span class=\"hljs-keyword\">if</span> (fiber.<span class=\"hljs-property\">child</span>) {\n  <span class=\"hljs-keyword\">return</span> fiber.<span class=\"hljs-property\">child</span>\n}\n<span class=\"hljs-keyword\">let</span> nextFiber = fiber\n<span class=\"hljs-keyword\">while</span> (nextFiber) {\n  <span class=\"hljs-keyword\">if</span> (nextFiber.<span class=\"hljs-property\">sibling</span>) {\n    <span class=\"hljs-keyword\">return</span> nextFiber.<span class=\"hljs-property\">sibling</span>\n  }\n  nextFiber = nextFiber.<span class=\"hljs-property\">parent</span>\n}\n</code></pre>\n<p>å®Œæ•´çš„ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p>\n<pre><code class=\"hljs language-js\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title function_\">performUnitOfWork</span>(<span class=\"hljs-params\">fiber</span>) {\n  <span class=\"hljs-keyword\">if</span> (!fiber.<span class=\"hljs-property\">dom</span>) {\n    fiber.<span class=\"hljs-property\">dom</span> = <span class=\"hljs-title function_\">createDom</span>(fiber)\n  }\n\n  <span class=\"hljs-keyword\">if</span> (fiber.<span class=\"hljs-property\">parent</span>) {\n    fiber.<span class=\"hljs-property\">parent</span>.<span class=\"hljs-property\">dom</span>.<span class=\"hljs-title function_\">appendChild</span>(fiber.<span class=\"hljs-property\">dom</span>)\n  }\n\n  <span class=\"hljs-keyword\">const</span> elements = fiber.<span class=\"hljs-property\">props</span>.<span class=\"hljs-property\">children</span>\n  <span class=\"hljs-keyword\">let</span> index = <span class=\"hljs-number\">0</span>\n  <span class=\"hljs-keyword\">let</span> prevSibling = <span class=\"hljs-literal\">null</span>\n\n  <span class=\"hljs-keyword\">while</span> (index &lt; elements.<span class=\"hljs-property\">length</span>) {\n    <span class=\"hljs-keyword\">const</span> element = elements[index]\n\n    <span class=\"hljs-keyword\">const</span> newFiber = {\n      <span class=\"hljs-attr\">type</span>: element.<span class=\"hljs-property\">type</span>,\n      <span class=\"hljs-attr\">props</span>: element.<span class=\"hljs-property\">props</span>,\n      <span class=\"hljs-attr\">parent</span>: fiber,\n      <span class=\"hljs-attr\">dom</span>: <span class=\"hljs-literal\">null</span>,\n    }\n\n    <span class=\"hljs-keyword\">if</span> (index === <span class=\"hljs-number\">0</span>) {\n      fiber.<span class=\"hljs-property\">child</span> = newFiber\n    } <span class=\"hljs-keyword\">else</span> {\n      prevSibling.<span class=\"hljs-property\">sibling</span> = newFiber\n    }\n\n    prevSibling = newFiber\n    index++\n  }\n\n  <span class=\"hljs-keyword\">if</span> (fiber.<span class=\"hljs-property\">child</span>) {\n    <span class=\"hljs-keyword\">return</span> fiber.<span class=\"hljs-property\">child</span>\n  }\n  <span class=\"hljs-keyword\">let</span> nextFiber = fiber\n  <span class=\"hljs-keyword\">while</span> (nextFiber) {\n    <span class=\"hljs-keyword\">if</span> (nextFiber.<span class=\"hljs-property\">sibling</span>) {\n      <span class=\"hljs-keyword\">return</span> nextFiber.<span class=\"hljs-property\">sibling</span>\n    }\n    nextFiber = nextFiber.<span class=\"hljs-property\">parent</span>\n  }\n}\n</code></pre>\n\n      <h2>\n        <span class=\"prefix\"></span>\n        <span class=\"content\">æäº¤æ›´æ”¹</span>\n        <span class=\"suffix\"></span>\n      </h2>\n    <p>æˆ‘ä»¬è¿˜æœ‰ä¸€ä¸ªé—®é¢˜ã€‚æ¯æ¬¡å¤„ç†ä¸€ä¸ªå…ƒç´ æ—¶ï¼Œæˆ‘ä»¬éƒ½ä¼šå‘DOMæ·»åŠ ä¸€ä¸ªæ–°èŠ‚ç‚¹ã€‚è€Œä¸”ï¼Œè¯·è®°ä½ï¼Œæµè§ˆå™¨å¯èƒ½ä¼šåœ¨æˆ‘ä»¬å®Œæˆæ•´ä¸ªæ ‘çš„æ¸²æŸ“ä¹‹å‰ä¸­æ–­æˆ‘ä»¬çš„å·¥ä½œã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œç”¨æˆ·å°†çœ‹åˆ°ä¸€ä¸ªä¸å®Œæ•´çš„UIã€‚æˆ‘ä»¬ä¸æƒ³è¿™æ ·ã€‚</p>\n<p>å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦ä»<code>performUnitOfWork</code>é‡Œåˆ é™¤æ”¹å˜DOMçš„éƒ¨åˆ†ã€‚ç›¸åï¼Œæˆ‘ä»¬å°†è·Ÿè¸ªFiber treeã€‚æˆ‘ä»¬ç§°å®ƒä¸º<code>wipRoot</code>ã€‚ä¸€æ—¦æˆ‘ä»¬å®Œæˆäº†æ‰€æœ‰çš„å·¥ä½œ(æˆ‘ä»¬çŸ¥é“å®ƒæ˜¯å› ä¸ºæ²¡æœ‰ä¸‹ä¸€ä¸ªå·¥ä½œå•å…ƒ)ï¼Œæˆ‘ä»¬å°±å°†æ•´ä¸ªFiber treeæäº¤ç»™DOMã€‚æˆ‘ä»¬åœ¨<code>commitRoot</code>å‡½æ•°ä¸­å®Œæˆã€‚åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬é€’å½’åœ°å°†æ‰€æœ‰èŠ‚ç‚¹è¿½åŠ åˆ°domã€‚</p>\n\n      <h2>\n        <span class=\"prefix\"></span>\n        <span class=\"content\">Reconciliation</span>\n        <span class=\"suffix\"></span>\n      </h2>\n    <p>åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬åªå‘DOMæ·»åŠ äº†ä¸€äº›ä¸œè¥¿ï¼Œé‚£ä¹ˆæ›´æ–°æˆ–åˆ é™¤èŠ‚ç‚¹å‘¢? </p>\n<p>è¿™å°±æ˜¯æˆ‘ä»¬ç°åœ¨è¦åšçš„ï¼Œæˆ‘ä»¬éœ€è¦å°†<code>render</code>å‡½æ•°æ¥æ”¶åˆ°çš„å…ƒç´ ä¸æäº¤ç»™DOMçš„æœ€åä¸€ä¸ªFiber treeè¿›è¡Œæ¯”è¾ƒã€‚å› æ­¤ï¼Œåœ¨å®Œæˆ<code>commit</code>ä¹‹åï¼Œæˆ‘ä»¬éœ€è¦ä¿å­˜å¯¹<strong>æœ€åä¸€ä¸ªæäº¤åˆ°DOMçš„Fiber tree</strong>çš„å¼•ç”¨ã€‚æˆ‘ä»¬ç§°ä¹‹ä¸º<code>currentRoot</code>ã€‚æˆ‘ä»¬è¿˜åœ¨æ¯Fiberä¸­åŠ å…¥äº†<code>alternate</code>, æ­¤å±æ€§æ˜¯åˆ°æ—§Fiberçš„é“¾æ¥ï¼Œå³æˆ‘ä»¬åœ¨ä¸Šä¸€ä¸ªæäº¤é˜¶æ®µæäº¤ç»™DOMçš„Fiberã€‚</p>\n<p>ç°åœ¨è®©æˆ‘ä»¬ä»åˆ›å»ºæ–°Fiberçš„<code>performUnitOfWork</code>å‡½æ•°ä¸­æå–ä»£ç åˆ°<code>reconcileChildren</code> ã€‚åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å°†<code>reconcile</code>æ—§çš„fiberså’Œæ–°å…ƒç´ ã€‚æˆ‘ä»¬åŒæ—¶éå†æ—§Fiber tree(<code>wipFiber.alternate</code>)çš„å­å…ƒç´ å’Œæˆ‘ä»¬æƒ³è¦reconciliationçš„å…ƒç´ æ•°ç»„ã€‚å¦‚æœæˆ‘ä»¬å¿½ç•¥åŒæ—¶éå†æ•°ç»„å’Œé“¾è¡¨æ‰€éœ€çš„æ‰€æœ‰æ ·æ¿æ–‡ä»¶ï¼Œé‚£ä¹ˆæˆ‘ä»¬åªå‰©ä¸‹whileä¸­æœ€é‡è¦çš„éƒ¨åˆ†:oldFiberå’Œelementã€‚å…ƒç´ æ˜¯æˆ‘ä»¬æƒ³è¦æ¸²æŸ“åˆ°DOMçš„ä¸œè¥¿ï¼Œè€ŒoldFiberæ˜¯æˆ‘ä»¬ä¸Šæ¬¡æ¸²æŸ“çš„ä¸œè¥¿ã€‚æˆ‘ä»¬éœ€è¦æ¯”è¾ƒå®ƒä»¬ï¼Œçœ‹çœ‹æ˜¯å¦éœ€è¦å¯¹DOMè¿›è¡Œæ›´æ”¹ã€‚</p>\n<p>ä¸ºäº†æ¯”è¾ƒå®ƒä»¬ï¼Œæˆ‘ä»¬ä½¿ç”¨ç±»å‹:</p>\n<ul>\n<li>å¦‚æœæ—§çš„Fiberå’Œæ–°å…ƒç´ å…·æœ‰ç›¸åŒçš„ç±»å‹ï¼Œæˆ‘ä»¬å¯ä»¥ä¿ç•™DOMèŠ‚ç‚¹ï¼Œå¹¶ä½¿ç”¨æ–°çš„é“å…·æ›´æ–°å®ƒ</li>\n<li>å¦‚æœç±»å‹ä¸åŒï¼Œå¹¶ä¸”æœ‰ä¸€ä¸ªæ–°å…ƒç´ ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªæ–°çš„DOMèŠ‚ç‚¹</li>\n<li>å¦‚æœç±»å‹ä¸åŒï¼Œå¹¶ä¸”æœ‰ä¸€ä¸ªæ—§çš„å…‰çº¤ï¼Œæˆ‘ä»¬éœ€è¦åˆ é™¤æ—§çš„èŠ‚ç‚¹</li>\n</ul>\n<p>è¿™é‡ŒReactä¹Ÿä½¿ç”¨keyï¼Œè¿™æ ·å¯ä»¥æ›´å¥½çš„<code>reconcile</code>ã€‚ä¾‹å¦‚ï¼Œå®ƒæ£€æµ‹å­å…ƒç´ åœ¨å…ƒç´ æ•°ç»„ä¸­çš„ä½ç½®å‘ç”Ÿäº†å˜åŒ–ã€‚</p>\n<p>å½“æ—§Fiberå’Œå…ƒç´ å…·æœ‰ç›¸åŒçš„ç±»å‹æ—¶ï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ–°Fiberï¼Œä½¿DOMèŠ‚ç‚¹ä¸æ—§Fiberä¿æŒä¸€è‡´ï¼Œä½¿propsä¸elementä¿æŒä¸€è‡´ã€‚æˆ‘ä»¬è¿˜å‘Fiber æ·»åŠ äº†ä¸€ä¸ªæ–°å±æ€§:<code>effectTag</code>ã€‚æˆ‘ä»¬å°†åœ¨ç¨åçš„<code>commit</code>é˜¶æ®µä½¿ç”¨æ­¤å±æ€§ã€‚</p>\n<pre><code class=\"hljs language-js\"><span class=\"hljs-keyword\">const</span> sameType =\n      oldFiber &amp;&amp;\n      element &amp;&amp;\n      element.<span class=\"hljs-property\">type</span> == oldFiber.<span class=\"hljs-property\">type</span>\n<span class=\"hljs-keyword\">if</span> (sameType) {\n  newFiber = {\n    <span class=\"hljs-attr\">type</span>: oldFiber.<span class=\"hljs-property\">type</span>,\n    <span class=\"hljs-attr\">props</span>: element.<span class=\"hljs-property\">props</span>,\n    <span class=\"hljs-attr\">dom</span>: oldFiber.<span class=\"hljs-property\">dom</span>,\n    <span class=\"hljs-attr\">parent</span>: wipFiber,\n    <span class=\"hljs-attr\">alternate</span>: oldFiber,\n    <span class=\"hljs-attr\">effectTag</span>: <span class=\"hljs-string\">&quot;UPDATE&quot;</span>,\n  }\n}\n</code></pre>\n<p>å¯¹äºelementéœ€è¦ä¸€ä¸ªæ–°DOMèŠ‚ç‚¹çš„æƒ…å†µï¼Œæˆ‘ä»¬ç”¨<code>PLACEMENT</code>æ ‡è®°æ ‡è®°æ–°Fiberã€‚</p>\n<pre><code class=\"hljs language-js\"><span class=\"hljs-keyword\">if</span> (element &amp;&amp; !sameType) {\n  newFiber = {\n    <span class=\"hljs-attr\">type</span>: element.<span class=\"hljs-property\">type</span>,\n    <span class=\"hljs-attr\">props</span>: element.<span class=\"hljs-property\">props</span>,\n    <span class=\"hljs-attr\">dom</span>: <span class=\"hljs-literal\">null</span>,\n    <span class=\"hljs-attr\">parent</span>: wipFiber,\n    <span class=\"hljs-attr\">alternate</span>: <span class=\"hljs-literal\">null</span>,\n    <span class=\"hljs-attr\">effectTag</span>: <span class=\"hljs-string\">&quot;PLACEMENT&quot;</span>,\n  }\n}\n</code></pre>\n<p>å¯¹äºéœ€è¦åˆ é™¤èŠ‚ç‚¹çš„æƒ…å†µï¼Œæˆ‘ä»¬æ²¡æœ‰æ–°çš„Fiberï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨æ—§Fiberä¸Šæ·»åŠ effectæ ‡ç­¾ã€‚ä½†æ˜¯å½“æˆ‘ä»¬å°†Fiberæ ‘æäº¤åˆ°DOMæ—¶ï¼Œæˆ‘ä»¬ä»æ­£åœ¨è¿›è¡Œçš„æ ¹ç›®å½•æ‰§è¡Œï¼Œå®ƒæ²¡æœ‰æ—§çš„Fiber ã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¸€ä¸ªæ•°ç»„æ¥è·Ÿè¸ªè¦åˆ é™¤çš„èŠ‚ç‚¹ã€‚ç„¶åï¼Œå½“æˆ‘ä»¬å°†æ›´æ”¹æäº¤åˆ°DOMæ—¶ï¼Œæˆ‘ä»¬è¿˜ä½¿ç”¨äº†æ¥è‡ªè¯¥æ•°ç»„çš„Fiberã€‚</p>\n<pre><code class=\"hljs language-js\"><span class=\"hljs-keyword\">if</span> (oldFiber &amp;&amp; !sameType) {\n  oldFiber.<span class=\"hljs-property\">effectTag</span> = <span class=\"hljs-string\">&quot;DELETION&quot;</span>\n  deletions.<span class=\"hljs-title function_\">push</span>(oldFiber)\n}\n</code></pre>\n<p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬ä¿®æ”¹<code>commitWork</code>å‡½æ•°æ¥å¤„ç†æ–°çš„<code>effectTags</code>ã€‚</p>\n<pre><code class=\"hljs language-js\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title function_\">commitWork</span>(<span class=\"hljs-params\">fiber</span>) {\n  <span class=\"hljs-keyword\">if</span> (!fiber) {\n    <span class=\"hljs-keyword\">return</span>\n  }\n  <span class=\"hljs-keyword\">if</span> (\n    fiber.<span class=\"hljs-property\">effectTag</span> === <span class=\"hljs-string\">&quot;PLACEMENT&quot;</span> &amp;&amp;\n    fiber.<span class=\"hljs-property\">dom</span> != <span class=\"hljs-literal\">null</span>\n  ) {\n    domParent.<span class=\"hljs-title function_\">appendChild</span>(fiber.<span class=\"hljs-property\">dom</span>)\n  } <span class=\"hljs-keyword\">else</span> <span class=\"hljs-keyword\">if</span> (\n      fiber.<span class=\"hljs-property\">effectTag</span> === <span class=\"hljs-string\">&quot;UPDATE&quot;</span> &amp;&amp;\n      fiber.<span class=\"hljs-property\">dom</span> != <span class=\"hljs-literal\">null</span>\n    ) {\n      <span class=\"hljs-title function_\">updateDom</span>(\n        fiber.<span class=\"hljs-property\">dom</span>,\n        fiber.<span class=\"hljs-property\">alternate</span>.<span class=\"hljs-property\">props</span>,\n        fiber.<span class=\"hljs-property\">props</span>\n      )\n    } <span class=\"hljs-keyword\">else</span> <span class=\"hljs-keyword\">if</span> (fiber.<span class=\"hljs-property\">effectTag</span> === <span class=\"hljs-string\">&quot;DELETION&quot;</span>) {\n      domParent.<span class=\"hljs-title function_\">removeChild</span>(fiber.<span class=\"hljs-property\">dom</span>)\n  }\n  <span class=\"hljs-keyword\">const</span> domParent = fiber.<span class=\"hljs-property\">parent</span>.<span class=\"hljs-property\">dom</span>\n  domParent.<span class=\"hljs-title function_\">appendChild</span>(fiber.<span class=\"hljs-property\">dom</span>)\n  <span class=\"hljs-title function_\">commitWork</span>(fiber.<span class=\"hljs-property\">child</span>)\n  <span class=\"hljs-title function_\">commitWork</span>(fiber.<span class=\"hljs-property\">sibling</span>)\n}\n</code></pre>\n<ul>\n<li><p>å¦‚æœFiberæœ‰ä¸€ä¸ª<code>PLACEMENT</code>æ ‡ç­¾ï¼Œä»çˆ¶Fiberå°†DOMèŠ‚ç‚¹é™„åŠ åˆ°èŠ‚ç‚¹ã€‚</p>\n</li>\n<li><p>å¦‚æœæ˜¯<code>DELETION</code>ï¼Œåˆ™åšç›¸åçš„æ“ä½œï¼Œåˆ é™¤å­å…ƒç´ ã€‚</p>\n</li>\n<li><p>å¦‚æœæ˜¯<code>UPDATE</code>ï¼Œåˆ™éœ€è¦ä½¿ç”¨æ›´æ”¹åçš„propsæ›´æ–°ç°æœ‰DOMèŠ‚ç‚¹ã€‚æˆ‘ä»¬å°†åœ¨è¿™ä¸ª<code>updateDom</code>å‡½æ•°ä¸­å®Œæˆè¿™äº›æ“ä½œã€‚å°†æ—§Fiberä¸­çš„propsä¸æ–°Fiberä¸­çš„propsè¿›è¡Œæ¯”è¾ƒï¼Œå»æ‰ä¸å­˜åœ¨çš„propï¼Œè®¾ç½®æ–°çš„æˆ–æ›´æ¢çš„propã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœpropä»¥<code>on</code>å‰ç¼€å¼€å¤´ï¼Œæˆ‘ä»¬å°†ä»¥ä¸åŒçš„æ–¹å¼å¤„ç†å®ƒï¼šå¦‚æœevent handlerå‘ç”Ÿäº†æ›´æ”¹ï¼Œæˆ‘ä»¬å°†å…¶ä»èŠ‚ç‚¹ä¸­åˆ é™¤ï¼Œç„¶åå†æ·»åŠ æ–°çš„handlerã€‚</p>\n</li>\n</ul>\n<pre><code class=\"hljs language-js\"><span class=\"hljs-keyword\">const</span> <span class=\"hljs-title function_\">isEvent</span> = key =&gt; key.<span class=\"hljs-title function_\">startsWith</span>(<span class=\"hljs-string\">&quot;on&quot;</span>)\n<span class=\"hljs-keyword\">const</span> <span class=\"hljs-title function_\">isProperty</span> = key =&gt;\n      key !== <span class=\"hljs-string\">&quot;children&quot;</span> &amp;&amp; !<span class=\"hljs-title function_\">isEvent</span>(key)\n<span class=\"hljs-keyword\">const</span> <span class=\"hljs-title function_\">isNew</span> = (<span class=\"hljs-params\">prev, next</span>) =&gt; <span class=\"hljs-function\"><span class=\"hljs-params\">key</span> =&gt;</span>\n    prev[key] !== next[key]\n<span class=\"hljs-keyword\">const</span> <span class=\"hljs-title function_\">isGone</span> = (<span class=\"hljs-params\">prev, next</span>) =&gt; <span class=\"hljs-function\"><span class=\"hljs-params\">key</span> =&gt;</span> !(key <span class=\"hljs-keyword\">in</span> next)\n  \n<span class=\"hljs-keyword\">function</span> <span class=\"hljs-title function_\">updateDom</span>(<span class=\"hljs-params\">dom, prevProps, nextProps</span>) {\n  <span class=\"hljs-comment\">// Remove old properties</span>\n  <span class=\"hljs-title class_\">Object</span>.<span class=\"hljs-title function_\">keys</span>(prevProps)\n    .<span class=\"hljs-title function_\">filter</span>(isProperty)\n    .<span class=\"hljs-title function_\">filter</span>(<span class=\"hljs-title function_\">isGone</span>(prevProps, nextProps))\n    .<span class=\"hljs-title function_\">forEach</span>(<span class=\"hljs-function\"><span class=\"hljs-params\">name</span> =&gt;</span> {\n      dom[name] = <span class=\"hljs-string\">&quot;&quot;</span>\n  })\n\n  <span class=\"hljs-comment\">// Set new or changed properties</span>\n  <span class=\"hljs-title class_\">Object</span>.<span class=\"hljs-title function_\">keys</span>(nextProps)\n    .<span class=\"hljs-title function_\">filter</span>(isProperty)\n    .<span class=\"hljs-title function_\">filter</span>(<span class=\"hljs-title function_\">isNew</span>(prevProps, nextProps))\n    .<span class=\"hljs-title function_\">forEach</span>(<span class=\"hljs-function\"><span class=\"hljs-params\">name</span> =&gt;</span> {\n      dom[name] = nextProps[name]\n  })\n  \n  <span class=\"hljs-comment\">// Add event listeners</span>\n  <span class=\"hljs-title class_\">Object</span>.<span class=\"hljs-title function_\">keys</span>(nextProps)\n    .<span class=\"hljs-title function_\">filter</span>(isEvent)\n    .<span class=\"hljs-title function_\">filter</span>(<span class=\"hljs-title function_\">isNew</span>(prevProps, nextProps))\n    .<span class=\"hljs-title function_\">forEach</span>(<span class=\"hljs-function\"><span class=\"hljs-params\">name</span> =&gt;</span> {\n      <span class=\"hljs-keyword\">const</span> eventType = name\n        .<span class=\"hljs-title function_\">toLowerCase</span>()\n        .<span class=\"hljs-title function_\">substring</span>(<span class=\"hljs-number\">2</span>)\n      dom.<span class=\"hljs-title function_\">addEventListener</span>(\n        eventType,\n        nextProps[name]\n      )\n  })\n}\n</code></pre>\n"}},"__N_SSG":true}
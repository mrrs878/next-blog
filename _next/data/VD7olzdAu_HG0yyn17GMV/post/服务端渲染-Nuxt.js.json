{"pageProps":{"post":{"title":"服务端渲染-Nuxt.js","tags":["SSR"],"categories":"服务端渲染","description":"> Nuxt.js@2.13.6\n\n# 安装\n\n推荐使用官方脚手架\n\n`yarn create nuxt-app <project name>`\n\n# 使用\n\n## 如何引入三方UI库/框架\n\n[vant](https://youzan.github.io/vant/#/zh-CN/) 为例\n\n1. `~/plugins/`下新建`vant-ui.js`\n\n    ```js\n    // ~","createDate":"2020-07-28 11:15:28","updateDate":"2020-10-16 15:18:28","body":"<blockquote>\n<p><a href=\"mailto:&#78;&#x75;&#120;&#x74;&#46;&#x6a;&#115;&#x40;&#50;&#46;&#49;&#x33;&#x2e;&#x36;\">&#78;&#x75;&#120;&#x74;&#46;&#x6a;&#115;&#x40;&#50;&#46;&#49;&#x33;&#x2e;&#x36;</a></p>\n</blockquote>\n\n      <h1>\n        <span class=\"prefix\"></span>\n        <span class=\"content\">安装</span>\n        <span class=\"suffix\"></span>\n      </h1>\n    <p>推荐使用官方脚手架</p>\n<p><code>yarn create nuxt-app &lt;project name&gt;</code></p>\n\n      <h1>\n        <span class=\"prefix\"></span>\n        <span class=\"content\">使用</span>\n        <span class=\"suffix\"></span>\n      </h1>\n    \n      <h2>\n        <span class=\"prefix\"></span>\n        <span class=\"content\">如何引入三方UI库/框架</span>\n        <span class=\"suffix\"></span>\n      </h2>\n    <p><a href=\"https://youzan.github.io/vant/#/zh-CN/\">vant</a> 为例</p>\n<ol>\n<li><p><code>~/plugins/</code>下新建<code>vant-ui.js</code></p>\n<pre><code class=\"hljs language-js\"><span class=\"hljs-comment\">// ~/plugins/vant-ui.js</span>\n\n<span class=\"hljs-keyword\">import</span> <span class=\"hljs-title class_\">Vue</span> <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">&#x27;vue&#x27;</span>\n<span class=\"hljs-keyword\">import</span> { xxx } <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">&#x27;vant&#x27;</span>\n\n<span class=\"hljs-comment\">// 只能全局注册组件，局部注册会丢失样式！！！</span>\n<span class=\"hljs-title class_\">Vue</span>.<span class=\"hljs-title function_\">use</span>(xxx)\n</code></pre>\n</li>\n<li><p>安装<code>vant、less、less-loader</code></p>\n<pre><code class=\"hljs language-shell\">yarn add vant -S\nyarn add less less-loader -D\n</code></pre>\n</li>\n<li><p>配置<code>nuxt.config.js</code></p>\n<pre><code class=\"hljs language-js\"><span class=\"hljs-comment\">// nuxt.config.js</span>\n{\n    <span class=\"hljs-comment\">// ...</span>\n    <span class=\"hljs-attr\">build</span>: {\n        <span class=\"hljs-comment\">// ...</span>\n        <span class=\"hljs-attr\">transpile</span>: [<span class=\"hljs-regexp\">/vant.*?less/</span>],\n        <span class=\"hljs-attr\">babel</span>: {\n          <span class=\"hljs-attr\">plugins</span>: [\n            [<span class=\"hljs-string\">&#x27;import&#x27;</span>, {\n              <span class=\"hljs-attr\">libraryName</span>: <span class=\"hljs-string\">&#x27;vant&#x27;</span>,\n              <span class=\"hljs-attr\">style</span>: <span class=\"hljs-function\"><span class=\"hljs-params\">name</span> =&gt;</span> <span class=\"hljs-string\">`<span class=\"hljs-subst\">${name}</span>/style/less`</span>\n            }, <span class=\"hljs-string\">&#x27;vant&#x27;</span>]\n          ]\n        },\n        <span class=\"hljs-attr\">loaders</span>: {\n          <span class=\"hljs-comment\">// 修改默认样式</span>\n          <span class=\"hljs-attr\">less</span>: {\n            <span class=\"hljs-attr\">javascriptEnabled</span>: <span class=\"hljs-literal\">true</span>,\n            <span class=\"hljs-attr\">modifyVars</span>: {\n              <span class=\"hljs-string\">&#x27;button-primary-background-color&#x27;</span>: <span class=\"hljs-string\">&#x27;#ff6008&#x27;</span>,\n              <span class=\"hljs-string\">&#x27;button-primary-border-color&#x27;</span>: <span class=\"hljs-string\">&#x27;#ff6008&#x27;</span>,\n              <span class=\"hljs-string\">&#x27;nav-bar-text-color&#x27;</span>: <span class=\"hljs-string\">&#x27;#ff6008&#x27;</span>,\n              <span class=\"hljs-string\">&#x27;nav-bar-icon-color&#x27;</span>: <span class=\"hljs-string\">&#x27;#ff6008&#x27;</span>,\n            }\n          }\n        }\n    },\n    <span class=\"hljs-comment\">// ...</span>\n}\n</code></pre>\n</li>\n</ol>\n\n      <h2>\n        <span class=\"prefix\"></span>\n        <span class=\"content\">如何配置axios拦截器</span>\n        <span class=\"suffix\"></span>\n      </h2>\n    <p><code>~/plugins/</code>下新建<code>axios.js</code></p>\n<pre><code class=\"hljs language-js\"><span class=\"hljs-comment\">// ~/plugins/axios.js</span>\n<span class=\"hljs-keyword\">export</span> <span class=\"hljs-keyword\">default</span> <span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\">{ $axios }</span>) {\n  $axios.<span class=\"hljs-property\">interceptors</span>.<span class=\"hljs-property\">request</span>.<span class=\"hljs-title function_\">use</span>(<span class=\"hljs-function\">(<span class=\"hljs-params\">config</span>) =&gt;</span> {\n    <span class=\"hljs-comment\">// todo</span>\n    <span class=\"hljs-keyword\">return</span> config\n  })\n  $axios.<span class=\"hljs-property\">interceptors</span>.<span class=\"hljs-property\">response</span>.<span class=\"hljs-title function_\">use</span>(\n    <span class=\"hljs-function\"><span class=\"hljs-params\">response</span> =&gt;</span> response.<span class=\"hljs-property\">data</span>,\n    <span class=\"hljs-function\"><span class=\"hljs-params\">err</span> =&gt;</span> {\n      <span class=\"hljs-variable language_\">console</span>.<span class=\"hljs-title function_\">log</span>(err)\n    }\n  )\n}\n</code></pre>\n\n      <h2>\n        <span class=\"prefix\"></span>\n        <span class=\"content\">添加Node.js中间件（以日志中间件为例）</span>\n        <span class=\"suffix\"></span>\n      </h2>\n    <ol>\n<li><p>根目录下新建<code>serverMiddleware</code>文件夹</p>\n</li>\n<li><p>安装相关依赖<code>log4js</code>等</p>\n</li>\n<li><p>新建<code>logger.js</code></p>\n<pre><code class=\"hljs language-js\"><span class=\"hljs-keyword\">const</span> { join } = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">&#x27;path&#x27;</span>)\n<span class=\"hljs-keyword\">const</span> { configure, getLogger, connectLogger } = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">&#x27;log4js&#x27;</span>)\n\n<span class=\"hljs-keyword\">const</span> <span class=\"hljs-variable constant_\">LOG_PATH</span> = <span class=\"hljs-string\">&#x27;/opt/logs/gmm-node-h5ssrrelease/&#x27;</span>\n<span class=\"hljs-title function_\">configure</span>({\n  <span class=\"hljs-attr\">appenders</span>: {\n    <span class=\"hljs-attr\">ajaxError</span>: {\n      <span class=\"hljs-attr\">type</span>: <span class=\"hljs-string\">&#x27;dateFile&#x27;</span>,\n      <span class=\"hljs-attr\">pattern</span>: <span class=\"hljs-string\">&#x27;yyyy-MM-dd.log&#x27;</span>,\n      <span class=\"hljs-attr\">filename</span>: <span class=\"hljs-title function_\">join</span>(<span class=\"hljs-variable constant_\">LOG_PATH</span>, <span class=\"hljs-string\">&#x27;ajaxError&#x27;</span>),\n      <span class=\"hljs-attr\">maxLogSize</span>: <span class=\"hljs-number\">10</span> * <span class=\"hljs-number\">1000</span> * <span class=\"hljs-number\">1000</span>,\n      <span class=\"hljs-attr\">numBackups</span>: <span class=\"hljs-number\">3</span>,\n      <span class=\"hljs-attr\">alwaysIncludePattern</span>: <span class=\"hljs-literal\">true</span>\n    },\n    <span class=\"hljs-comment\">// ...</span>\n  },\n  <span class=\"hljs-attr\">categories</span>: {\n    <span class=\"hljs-attr\">default</span>: { <span class=\"hljs-attr\">appenders</span>: [<span class=\"hljs-string\">&#x27;console&#x27;</span>], <span class=\"hljs-attr\">level</span>: <span class=\"hljs-string\">&#x27;info&#x27;</span> },\n    <span class=\"hljs-comment\">// ...</span>\n  }\n})\n\n<span class=\"hljs-keyword\">export</span> <span class=\"hljs-keyword\">default</span> <span class=\"hljs-title function_\">connectLogger</span>(<span class=\"hljs-title function_\">getLogger</span>(<span class=\"hljs-string\">&#x27;application&#x27;</span>), { <span class=\"hljs-attr\">level</span>: <span class=\"hljs-string\">&#x27;info&#x27;</span> })\n</code></pre>\n</li>\n<li><p>修改<code>nuxt.config.js</code>配置</p>\n<pre><code class=\"hljs language-js\"><span class=\"hljs-keyword\">export</span> <span class=\"hljs-keyword\">default</span> {\n  <span class=\"hljs-comment\">// ...</span>\n  <span class=\"hljs-attr\">serverMiddleware</span>: [\n    <span class=\"hljs-string\">&#x27;~/serverMiddleware/bodyParser&#x27;</span>,\n    <span class=\"hljs-comment\">// ...</span>\n  ],\n  <span class=\"hljs-comment\">// ...</span>\n}\n</code></pre>\n</li>\n</ol>\n\n      <h1>\n        <span class=\"prefix\"></span>\n        <span class=\"content\">注意点</span>\n        <span class=\"suffix\"></span>\n      </h1>\n    <ol>\n<li>服务端只渲染需要做SEO的部分来加快访问速度</li>\n</ol>\n\n      <h1>\n        <span class=\"prefix\"></span>\n        <span class=\"content\">性能优化</span>\n        <span class=\"suffix\"></span>\n      </h1>\n    <ol>\n<li><p>如果网关已启用gzip则关闭框架自带压缩</p>\n<pre><code class=\"hljs language-js\"><span class=\"hljs-comment\">// nuxt.config.js</span>\n<span class=\"hljs-attr\">render</span>: {\n  <span class=\"hljs-attr\">compressor</span>: <span class=\"hljs-literal\">false</span>\n}\n</code></pre>\n</li>\n<li><p>缓存页面(<code>lru-cache</code>)</p>\n<pre><code class=\"hljs language-js\"><span class=\"hljs-comment\">// serverMiddleware/pageCache.js</span>\n<span class=\"hljs-keyword\">const</span> <span class=\"hljs-variable constant_\">LRU</span> = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">&#x27;lru-cache&#x27;</span>)\n<span class=\"hljs-keyword\">const</span> cachePage = <span class=\"hljs-keyword\">new</span> <span class=\"hljs-title function_\">LRU</span>({\n  <span class=\"hljs-attr\">max</span>: <span class=\"hljs-number\">100</span>,\n  <span class=\"hljs-attr\">maxAge</span>: <span class=\"hljs-number\">1000</span> * <span class=\"hljs-number\">60</span>\n})\n<span class=\"hljs-keyword\">export</span> <span class=\"hljs-keyword\">default</span> <span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\">req, res, next</span>) {\n  <span class=\"hljs-keyword\">const</span> url = req.<span class=\"hljs-property\">_parsedOriginalUrl</span>\n  <span class=\"hljs-keyword\">const</span> pathname = url.<span class=\"hljs-property\">pathname</span>\n  <span class=\"hljs-keyword\">if</span> ([<span class=\"hljs-string\">&#x27;/selectGame/1&#x27;</span>].<span class=\"hljs-title function_\">includes</span>(pathname)) {\n    <span class=\"hljs-keyword\">const</span> existsHtml = cachePage.<span class=\"hljs-title function_\">get</span>(<span class=\"hljs-string\">&#x27;selectGameData&#x27;</span>)\n    <span class=\"hljs-keyword\">if</span> (existsHtml) {\n      <span class=\"hljs-keyword\">return</span> res.<span class=\"hljs-title function_\">end</span>(existsHtml.<span class=\"hljs-property\">html</span>, <span class=\"hljs-string\">&#x27;utf-8&#x27;</span>)\n    } <span class=\"hljs-keyword\">else</span> {\n      res.<span class=\"hljs-property\">original_end</span> = res.<span class=\"hljs-property\">end</span>\n      res.<span class=\"hljs-property\">end</span> = <span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\">data</span>) {\n        <span class=\"hljs-keyword\">if</span> (res.<span class=\"hljs-property\">statusCode</span> === <span class=\"hljs-number\">200</span>) {\n          cachePage.<span class=\"hljs-title function_\">set</span>(<span class=\"hljs-string\">&#x27;selectGameData&#x27;</span>, { <span class=\"hljs-attr\">html</span>: data })\n        }\n        res.<span class=\"hljs-title function_\">original_end</span>(data, <span class=\"hljs-string\">&#x27;utf-8&#x27;</span>)\n      }\n    }\n  }\n  <span class=\"hljs-title function_\">next</span>()\n}\n</code></pre>\n</li>\n</ol>\n\n      <h1>\n        <span class=\"prefix\"></span>\n        <span class=\"content\">坑</span>\n        <span class=\"suffix\"></span>\n      </h1>\n    \n      <h2>\n        <span class=\"prefix\"></span>\n        <span class=\"content\">同一域名如何部署多个Nuxt.js服务</span>\n        <span class=\"suffix\"></span>\n      </h2>\n    <p>在<code>https://gmmsj.com/h5ssr</code>下部署Nuxt.js项目步骤：</p>\n<ol>\n<li><p>复制<code>nuxt_dist/serverMiddleware/static/nuxt.config.js/package.json</code>目录/文件至部署机</p>\n</li>\n<li><p>nuxt.config.js添加router配置</p>\n<pre><code class=\"hljs language-js\"><span class=\"hljs-comment\">// nuxt.config.js</span>\n{\n  <span class=\"hljs-comment\">// ...</span>\n  <span class=\"hljs-attr\">router</span>: {\n    <span class=\"hljs-attr\">base</span>: <span class=\"hljs-string\">&#x27;/h5ssr/&#x27;</span>\n  }\n  <span class=\"hljs-comment\">// ...</span>\n}\n</code></pre>\n</li>\n<li><p>Nginx添加配置</p>\n<pre><code class=\"hljs language-shell\"><span class=\"hljs-meta\"># </span><span class=\"language-bash\">nginx.conf</span>\nlocation /h5ssr {\n  proxy_pass http://127.0.0.1:8005/h5ssr ;\n  proxy_set_header Host $host;\n  proxy_set_header X-Forwarded-For $remote_addr;  \n}\n</code></pre>\n</li>\n</ol>\n"}},"__N_SSG":true}
---
title: "è®¾è®¡æ¨¡å¼-çŠ¶æ€æ¨¡å¼"
tags: "è®¾è®¡æ¨¡å¼ çŠ¶æ€æ¨¡å¼"
categories: "è®¾è®¡æ¨¡å¼"
description: ""
createDate: "2022-08-27 15:11:28"
updateDate: "2022-08-30 20:35:40"
---

å­¦ä¹ ä¸€ä¸‹ã€ŒçŠ¶æ€æ¨¡å¼ã€

## ä»ä¸€ä¸ªåœºæ™¯åˆ‡å…¥

ğŸ’¡ éœ€æ±‚ï¼šæŒ‰ä¸‹æŒ‰é’®ï¼Œæ ¹æ®å½“å‰çš„çŠ¶æ€ï¼Œç”µç¯ä¼šåˆ‡æ¢åˆ°æ–°çš„çŠ¶æ€ off->on/on->off

é’ˆå¯¹äºè¿™ä¸ªå°çš„éœ€æ±‚ï¼Œç¬¬ä¸€æ—¶é—´å¯èƒ½ä¼šå†™ä¸‹è¿™æ®µä»£ç 

```ts
enum State {
  on,
  off,
}

class Light {
  state: State;

  constructor() {
    this.state = State.off;
  }

  press() {
    if (this.state === State.on) {
      this.state = State.off;
    } else if (this.state === State.off) {
      this.state = State.on;
    }
  }
}
```

æµ‹è¯•ä¸€ä¸‹

```ts
const light = new Light();
console.assert(light.state === State.off);

light.press();
console.assert(light.state === State.on);

light.press();
console.assert(light.state === State.off);
```

çœ‹èµ·æ¥å®ç°äº†åŠŸèƒ½ï¼Œä½†å…¶å®æ˜¯å­˜åœ¨ä¸€äº›éšæ‚£ï¼ˆç¼ºé™·ï¼‰çš„ï¼šä¸€æ®µæ—¶é—´åï¼Œéœ€æ±‚å˜äº†ï¼Œç”µç¯å¢åŠ äº†ä¸€ç§çŠ¶æ€--å¼ºå…‰ï¼šåœ¨å…³é—­çš„æƒ…å†µä¸‹ï¼Œç¬¬ä¸€æ¬¡æ‰“å¼€æ˜¯æ­£å¸¸å…‰ï¼Œå†æŒ‰ä¸€ä¸‹ä¼šåˆ‡æ¢åˆ°å¼ºå…‰ï¼Œå†æŒ‰ä¸€ä¸‹æ‰æ˜¯å…³é—­ã€‚é’ˆå¯¹äºè¿™ä¸ªå˜åŠ¨ï¼Œæˆ‘ä»¬ä¸Šé¢çš„ä»£ç ç¨ä½œæ”¹åŠ¨ä¹Ÿèƒ½å¤„ç†ï¼š

```ts
// ...
press() {
  if (this.state === State.off) {
    this.state = State.on;
  } else if (this.state === State.on) {
    // æ‰“å¼€çš„æƒ…å†µä¸‹å†æ¬¡æŒ‰ä¸‹ä¼šåˆ‡æ¢åˆ°å¼ºå…‰
    this.state = State.superLight;
  } else if (this.state === State.superLight) {
    this.state = State.off;
  }
}
// ...
```

ä½†è¿™ä»…ä»…æ˜¯å¢åŠ äº†ä¸€ç§çŠ¶æ€ï¼Œé‚£å¦‚æœä»¥åå†æ·»åŠ ä¸€ç§å¼±å…‰ï¼Œå¼ºå¼ºå…‰ã€‚ã€‚ã€‚é‚£éƒ½è¦å»ä¿®æ”¹ `press` æ–¹æ³•ï¼Œä¸€æ¥è¯¥å‡½æ•°å°†ä¼šå˜å¾—æå…¶è‡ƒè‚¿ï¼›å†è€…ï¼Œè¯¥è®¾è®¡ä¹Ÿè¿åäº†å¼€é—­åŸåˆ™ï¼šæ¯æ¬¡æ–°å¢æˆ–ä¿®æ”¹ light çš„çŠ¶æ€ï¼Œéƒ½éœ€è¦ä¿®æ”¹ `press` æ–¹æ³•ï¼Œè¿™ä½¿å¾—è¯¥å‡½æ•°éå¸¸ä¸ç¨³å®šï¼Œéš¾ä»¥ç»´æŠ¤

## ä½¿ç”¨çŠ¶æ€æ¨¡å¼æ”¹è¿› ğŸ’¡ ç¨‹åº

**çŠ¶æ€æ¨¡å¼çš„å…³é”®æ˜¯æŠŠäº‹ç‰©çš„æ¯ç§çŠ¶æ€éƒ½å°è£…æˆå•ç‹¬çš„ç±»ï¼Œè·Ÿæ­¤ç§çŠ¶æ€æœ‰å…³çš„è¡Œä¸ºéƒ½è¢«å°è£…åœ¨è¿™ä¸ªç±»çš„å†…éƒ¨**

```ts
class State {
  light: Light;

  constructor(light: Light) {
    this.light = light;
  }

  press() {
    throw new Error("pressæ–¹æ³•å¿…é¡»è¢«é‡å†™");
  }
}

class OffLightState extends State {
  light: Light;

  press() {
    console.log("on");
    this.light.setState(this.light.onLightState);
  }
}

class OnLightState extends State {
  light: Light;

  press() {
    console.log("superLight");
    this.light.setState(this.light.superLightState);
  }
}

class SuperLightState extends State {
  light: Light;

  press() {
    console.log("off");
    this.light.setState(this.light.offLightState);
  }
}

class Light {
  state: State;

  offLightState: OffLightState;

  superLightState: SuperLightState;

  onLightState: OnLightState;

  constructor() {
    this.onLightState = new OnLightState(this);
    this.offLightState = new OffLightState(this);
    this.superLightState = new SuperLightState(this);
    this.state = this.offLightState;
  }

  setState(state: State) {
    this.state = state;
  }
}

const light = new Light();
console.assert(light.state instanceof OffLightState);

light.state.press();
console.assert(light.state instanceof OnLightState);

light.state.press();
console.assert(light.state instanceof SuperLightState);

light.state.press();
console.assert(light.state instanceof OffLightState);
```

åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬åˆ›å»ºäº†å‡ ä¸ªä¸åŒçš„ `State` ï¼Œè¿™ä¸ªçŠ¶æ€éƒ½æœ‰ä¸€ä¸ª `press` æ–¹æ³•ï¼Œä»£è¡¨å¼€å…³è¢«æŒ‰ä¸‹æ—¶æ‰§è¡Œçš„åŠ¨ä½œï¼šåˆ‡æ¢ä¸‹ä¸€ä¸ªçŠ¶æ€

ä½¿ç”¨çŠ¶æ€æ¨¡å¼åï¼Œ**ä»£ç é‡æ˜æ˜¾å¢åŠ **ï¼Œä½†è¿™æ ·çš„å¥½å¤„éå¸¸æ˜æ˜¾ï¼š**å®ƒå¯ä»¥ä½¿æ¯ä¸€ç§çŠ¶æ€å’Œå®ƒå¯¹åº”çš„è¡Œä¸ºä¹‹é—´çš„å…³ç³»å±€éƒ¨åŒ–ï¼Œè¿™äº›è¡Œä¸ºè¢«åˆ†æ•£å’Œå°è£…åœ¨å„è‡ªå¯¹åº”çš„çŠ¶æ€ç±»ä¸­ï¼Œä¾¿äºç®¡ç†ï¼›æ­¤å¤–ï¼Œç”±äºçŠ¶æ€ä¹‹é—´çš„åˆ‡æ¢éƒ½è¢«åˆ†å¸ƒåœ¨çŠ¶æ€ç±»å†…éƒ¨ï¼Œå› æ­¤æˆ‘ä»¬æ— éœ€ç¼–å†™è¿‡å¤šçš„ `if-else` æ¥æ§åˆ¶çŠ¶æ€ä¹‹é—´çš„è½¬æ¢**

å½“æˆ‘ä»¬éœ€è¦ä¸º light æ–°å¢ä¸€ç§çŠ¶æ€æ—¶ï¼Œåªéœ€è¦å¢åŠ ä¸€ä¸ªæ–°çš„ `State` ç„¶åæ”¹å˜ç›¸å…³è”çš„çŠ¶æ€ä¹‹å‰çš„åˆ‡æ¢è§„åˆ™å³å¯

## ä½¿ç”¨çŠ¶æ€æœºé‡æ„

å€ŸåŠ©äº `xstate` é‡æ„ ğŸ’¡ éœ€æ±‚

1. åˆ›å»ºçŠ¶æ€æœº

```js
import { createMachine } from "xstate";

const lightMachine = createMachine({
  id: "light",
  initial: "off",
  states: {
    off: {
      on: {
        press: "weak",
      },
    },
    weak: {
      on: {
        press: "normal",
      },
    },
    normal: {
      on: {
        press: "super",
      },
    },
    super: {
      on: {
        press: "off",
      },
    },
  },
});

export { lightMachine };
```

2. ä½¿ç”¨

```js
import { interpret } from "xstate";
import { lightMachine } from "./light.machine";

const lightService = interpret(lightMachine).onTransition(() => {
  console.log("lightService.state: ", lightService.state.value);
});

lightService.start();

console.assert(lightService.state.value === "off");

lightService.send("press");
console.assert(lightService.state.value === "weak");

lightService.send("press");
console.assert(lightService.state.value === "normal");

lightService.send("press");
console.assert(lightService.state.value === "super");

lightService.send("press");
console.assert(lightService.state.value === "off");
```

## æ€»ç»“

çŠ¶æ€æ¨¡å¼å®šä¹‰äº†çŠ¶æ€ä¸è¡Œä¸ºä¹‹é—´çš„å…³ç³»ï¼Œè¾ƒä¸ºç»†è‡´çš„åŒºåˆ†äº†äº‹ç‰©å†…éƒ¨çš„çŠ¶æ€ï¼Œå¹¶ä¸”å°†è·Ÿæ­¤ç§çŠ¶æ€ç›¸å…³çš„è¡Œä¸ºéƒ½å°è£…åœ¨è¿™ä¸ªçŠ¶æ€å†…éƒ¨ï¼ˆæ¯”å¦‚åˆ‡æ¢åˆ°æ–°çš„çŠ¶æ€ï¼‰ï¼Œé¿å…äº† Context æ— é™è†¨èƒ€ï¼Œæ–¹ä¾¿å¢åŠ æ–°çš„çŠ¶æ€å’Œè½¬æ¢ã€‚ä½†ç”±äºæ¯ä¸ªçŠ¶æ€éƒ½éœ€è¦ä¸€ä¸ªç±»ï¼Œè¾ƒä¸ºç¹çï¼Œå¹¶ä¸”ç”±äºé€»è¾‘åˆ†æ•£åœ¨å„ä¸ªçŠ¶æ€ç±»ä¸­ï¼Œæ— å½¢ä¸­å¢åŠ äº†å¯¹æ•´ä½“çš„çŠ¶æ€æœºé€»è¾‘çš„ç†è§£éš¾åº¦

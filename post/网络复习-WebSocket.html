<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><title>Mr.RS的个人博客-网络复习-WebSocket</title><meta name="next-head-count" content="3"/><link rel="preload" href="/next-blog/_next/static/css/1bf96eec8dc413e7.css" as="style"/><link rel="stylesheet" href="/next-blog/_next/static/css/1bf96eec8dc413e7.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/next-blog/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/next-blog/_next/static/chunks/webpack-cf185e4b59cdddcf.js" defer=""></script><script src="/next-blog/_next/static/chunks/framework-91d7f78b5b4003c8.js" defer=""></script><script src="/next-blog/_next/static/chunks/main-1c9e93b8392c1bc9.js" defer=""></script><script src="/next-blog/_next/static/chunks/pages/_app-ca6aae25bc99a05f.js" defer=""></script><script src="/next-blog/_next/static/chunks/899-1cd3a59abdb8ea18.js" defer=""></script><script src="/next-blog/_next/static/chunks/pages/post/%5Btitle%5D-406bad804ceffd1d.js" defer=""></script><script src="/next-blog/_next/static/CGe2LDJsj2ltDkpQbiUcG/_buildManifest.js" defer=""></script><script src="/next-blog/_next/static/CGe2LDJsj2ltDkpQbiUcG/_ssgManifest.js" defer=""></script><script src="/next-blog/_next/static/CGe2LDJsj2ltDkpQbiUcG/_middlewareManifest.js" defer=""></script></head><body><div id="__next" data-reactroot=""><header class="fixed top-0 py-4 left-0 right-0 h-auto px-10 shadow bg-white z-50"><nav><ul class="flex w-auto"><li class="mr-4 hover:text-yellow"><a href="/next-blog">首页</a></li><li class="mx-4 hover:text-yellow"><a href="/next-blog/categories">分类</a></li><li class="mx-4 hover:text-yellow"><a href="/next-blog/tags">标签</a></li><li class="ml-4 hover:text-yellow"><a href="/next-blog/timeline">归档</a></li></ul></nav></header><main class="mt-20 mb-4 mx-auto justify-center w-2/3"><div class="mx-auto lg:max-w-5xl md:max-w-3xl"><article class="flex flex-col justify-around pb-16 px-4 mx-auto space-y-10 text-base"><div class="flex flex-col space-y-4"><h1 class="inline pt-10 text-4xl text-skin-primary">网络复习-WebSocket</h1><div class="text-sm space-x-2 text-skin-muted"><span><svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 inline-block mr-1"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>2021-05-10 05:04:10</span><span><svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 inline-block mr-1"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>44</span></div></div><div class="mt-8 flex"><div class="w-full flex-auto custom-markdown-body"><div class="markdown-body" id="write"><h2 id="websocket是什么">WebSocket是什么</h2>
<p>HTML5开始提供的一种浏览器与服务器进行<strong>全双工通讯</strong>的网络技术，属于<strong>应用层协议</strong>、基于<strong>TCP</strong>、<strong>复用HTTP的握手通道</strong></p>
<h2 id="和长轮训的区别">和长轮训的区别</h2>
<p>长轮训就是客户端发起一个请求，服务器收到客户端发送的请求后，服务端不会直接进行响应，而是先将这个请求挂起，然后判断请求的数据是否有更新，如果有更新，则进行更新，如果一直没有数据，则等待一定的时间后返回</p>
<h2 id="如何建立连接">如何建立连接</h2>
<p><code>WebSocket</code>复用了<code>HTTP</code>的握手通道。客户端通过<code>HTTP</code>请求与<code>WebSocket</code>服务器协商<strong>升级协议</strong>，协议升级完成后，后续的数据交换则按照<code>WebSocket</code>的协议。</p>
<p>首先，客户端发起协议升级请求</p>
<pre><code class="hljs language-http"><span class="hljs-keyword">GET</span> <span class="hljs-string">ws://localhost:8080/</span> <span class="hljs-meta">HTTP/1.1</span>
<span class="hljs-attribute">Connection</span><span class="hljs-punctuation">: </span>Upgrade
<span class="hljs-attribute">Host</span><span class="hljs-punctuation">: </span>localhost:8080
<span class="hljs-attribute">Origin</span><span class="hljs-punctuation">: </span>http://localhost:3000
<span class="hljs-attribute">Sec-WebSocket-Extensions</span><span class="hljs-punctuation">: </span>permessage-deflate; client_max_window_bits
<span class="hljs-attribute">Sec-WebSocket-Key</span><span class="hljs-punctuation">: </span>wXE7gVKUV5flJWEnJLr8pw==
<span class="hljs-attribute">Sec-WebSocket-Version</span><span class="hljs-punctuation">: </span>13
<span class="hljs-attribute">Upgrade</span><span class="hljs-punctuation">: </span>websocket
</code></pre>
<p>然后服务端响应协议升级</p>
<pre><code class="hljs language-http"><span class="hljs-meta">HTTP/1.1</span> <span class="hljs-number">101</span> Switching Protocols
<span class="hljs-attribute">Upgrade</span><span class="hljs-punctuation">: </span>websocket
<span class="hljs-attribute">Connection</span><span class="hljs-punctuation">: </span>Upgrade
<span class="hljs-attribute">Sec-WebSocket-Accept</span><span class="hljs-punctuation">: </span>DeY5PvpKJhTquRvvA7TPBcinVBk=
</code></pre>
<p>代码演示：</p>
<p>服务端(使用<code>ws</code>库)：</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;express&quot;</span>);
<span class="hljs-keyword">const</span> ws = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;ws&quot;</span>);

<span class="hljs-keyword">const</span> app = <span class="hljs-title function_">express</span>();
<span class="hljs-keyword">const</span> wsServer = <span class="hljs-keyword">new</span> ws.<span class="hljs-title class_">Server</span>({ <span class="hljs-attr">port</span>: <span class="hljs-number">8080</span> });

wsServer.<span class="hljs-title function_">on</span>(<span class="hljs-string">&quot;connection&quot;</span>, <span class="hljs-function">(<span class="hljs-params">ws</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;server: connected to a client&quot;</span>);
  ws.<span class="hljs-title function_">on</span>(<span class="hljs-string">&quot;message&quot;</span>, <span class="hljs-function">(<span class="hljs-params">msg</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`server: message receive from client--<span class="hljs-subst">${msg}</span>`</span>);
  });
  ws.<span class="hljs-title function_">send</span>(<span class="hljs-string">&quot;hello client&quot;</span>);
  ws.<span class="hljs-title function_">ping</span>(<span class="hljs-string">&quot;&quot;</span>, <span class="hljs-literal">false</span>, <span class="hljs-function">() =&gt;</span> {});
});

app.<span class="hljs-title function_">get</span>(<span class="hljs-string">&quot;/&quot;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
  res.<span class="hljs-title function_">sendFile</span>(<span class="hljs-string">`<span class="hljs-subst">${__dirname}</span>/index.html`</span>);
})

app.<span class="hljs-title function_">listen</span>(<span class="hljs-number">3000</span>);
</code></pre>
<p>客户端：</p>
<pre><code class="hljs language-html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">&quot;en&quot;</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">http-equiv</span>=<span class="hljs-string">&quot;X-UA-Compatible&quot;</span> <span class="hljs-attr">content</span>=<span class="hljs-string">&quot;IE=edge&quot;</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;viewport&quot;</span> <span class="hljs-attr">content</span>=<span class="hljs-string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Document<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">main</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;container&quot;</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">&quot;sendMessage()&quot;</span>&gt;</span>sendMessage<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">main</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript">
    <span class="hljs-keyword">const</span> wsClient = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WebSocket</span>(<span class="hljs-string">&quot;ws://localhost:8080&quot;</span>);
    wsClient.<span class="hljs-property">onopen</span> = <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;client: connected to server&quot;</span>);
    }
    wsClient.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">msg</span>) =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`client: receive from server--<span class="hljs-subst">${msg.data}</span>`</span>);
    }

    <span class="hljs-keyword">function</span> <span class="hljs-title function_">sendMessage</span>(<span class="hljs-params"></span>) {
      wsClient.<span class="hljs-title function_">send</span>(<span class="hljs-string">&quot;hello server&quot;</span>);
    }
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p>运行结果：</p>
<pre><code class="hljs language-shell"><span class="hljs-meta"># </span><span class="language-bash">客户端</span>
client: connected to server
client: receive from server--hello client
<span class="hljs-meta">
# </span><span class="language-bash">服务端</span>
server: connected to a client
</code></pre>
<h2 id="数据交换">数据交换</h2>
<p>一旦<code>WebSocket</code>客户端、服务端建立连接后，后续的操作都是基于<strong>数据帧</strong>的传递</p>
<p><code>WebSocket</code>根据<code>opcode</code>来区分操作的类型。比如<code>0x8</code>表示断开连接，<code>0x0-0x2</code>表示数据交互</p>
<p>数据分片：</p>
<p><code>WebSocket</code>的每条消息可能被切分成多个数据帧。当<code>WebSocket</code>的接收方接收到一个数据帧时，会根据FIN的值进行判断，是否已经收到消息的最后一个数据帧</p>
<pre><code class="hljs language-http"># 一个完整的消息(FIN=1且opcode != 0x0)
<span class="hljs-attribute">Client</span><span class="hljs-punctuation">: </span>FIN=1, opcode=0x1, msg=&quot;hello&quot;
<span class="hljs-attribute">Server</span><span class="hljs-punctuation">: </span>(process complete message immediately) Hi.

# 文本消息且消息还没发送完成
<span class="hljs-attribute">Client</span><span class="hljs-punctuation">: </span>FIN=0, opcode=0x1, msg=&quot;and a&quot;
<span class="hljs-attribute">Server</span><span class="hljs-punctuation">: </span>(listening, new message containing text started)
# 延续帧
<span class="hljs-attribute">Client</span><span class="hljs-punctuation">: </span>FIN=0, opcode=0x0, msg=&quot;happy new&quot;
<span class="hljs-attribute">Server</span><span class="hljs-punctuation">: </span>(listening, payload concatenated to previous message)
# 最终帧
<span class="hljs-attribute">Client</span><span class="hljs-punctuation">: </span>FIN=1, opcode=0x0, msg=&quot;year!&quot;
<span class="hljs-attribute">Server</span><span class="hljs-punctuation">: </span>(process complete message) Happy new year to you too!
</code></pre>
<h2 id="心跳">心跳</h2>
<p>在Websocket中定义了<strong>心跳ping(0x9)</strong> 和 <strong>心跳pong(0xA)</strong> 的控制帧</p>
<h2 id="参考">参考</h2>
<p><a href="https://juejin.cn/post/6844903544978407431">WebSocket：5分钟从入门到精通
</a></p>
</div></div></div></article></div></main><footer class="flex flex-col items-center justify-center leading-8 text-sm w-full py-2 border-t text-skin-muted"><p>Designed &amp; developed by<a class="ml-1 text-yellow" target="_blank" href="https://github.com/mrrs878" rel="noreferrer">Mr.RS</a></p><p>©<!-- --> <!-- -->2022</p></footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"title":"网络复习-WebSocket","tags":["WebSocket"],"categories":"2021复习","description":"## WebSocket是什么\n\nHTML5开始提供的一种浏览器与服务器进行**全双工通讯**的网络技术，属于**应用层协议**、基于**TCP**、**复用HTTP的握手通道**\n\n## 和长轮训的区别\n\n长轮训就是客户端发起一个请求，服务器收到客户端发送的请求后，服务端不会直接进行响应，而是先将这个请求挂起，然后判断请求的数据是否有更新，如果有更新，则进行更新，如果一直没有数据，则等待一定","createDate":"2021-05-10 05:04:10","updateDate":"2021-05-10 18:53:03","body":"\u003ch2 id=\"websocket是什么\"\u003eWebSocket是什么\u003c/h2\u003e\n\u003cp\u003eHTML5开始提供的一种浏览器与服务器进行\u003cstrong\u003e全双工通讯\u003c/strong\u003e的网络技术，属于\u003cstrong\u003e应用层协议\u003c/strong\u003e、基于\u003cstrong\u003eTCP\u003c/strong\u003e、\u003cstrong\u003e复用HTTP的握手通道\u003c/strong\u003e\u003c/p\u003e\n\u003ch2 id=\"和长轮训的区别\"\u003e和长轮训的区别\u003c/h2\u003e\n\u003cp\u003e长轮训就是客户端发起一个请求，服务器收到客户端发送的请求后，服务端不会直接进行响应，而是先将这个请求挂起，然后判断请求的数据是否有更新，如果有更新，则进行更新，如果一直没有数据，则等待一定的时间后返回\u003c/p\u003e\n\u003ch2 id=\"如何建立连接\"\u003e如何建立连接\u003c/h2\u003e\n\u003cp\u003e\u003ccode\u003eWebSocket\u003c/code\u003e复用了\u003ccode\u003eHTTP\u003c/code\u003e的握手通道。客户端通过\u003ccode\u003eHTTP\u003c/code\u003e请求与\u003ccode\u003eWebSocket\u003c/code\u003e服务器协商\u003cstrong\u003e升级协议\u003c/strong\u003e，协议升级完成后，后续的数据交换则按照\u003ccode\u003eWebSocket\u003c/code\u003e的协议。\u003c/p\u003e\n\u003cp\u003e首先，客户端发起协议升级请求\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-http\"\u003e\u003cspan class=\"hljs-keyword\"\u003eGET\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003ews://localhost:8080/\u003c/span\u003e \u003cspan class=\"hljs-meta\"\u003eHTTP/1.1\u003c/span\u003e\n\u003cspan class=\"hljs-attribute\"\u003eConnection\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e: \u003c/span\u003eUpgrade\n\u003cspan class=\"hljs-attribute\"\u003eHost\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e: \u003c/span\u003elocalhost:8080\n\u003cspan class=\"hljs-attribute\"\u003eOrigin\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e: \u003c/span\u003ehttp://localhost:3000\n\u003cspan class=\"hljs-attribute\"\u003eSec-WebSocket-Extensions\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e: \u003c/span\u003epermessage-deflate; client_max_window_bits\n\u003cspan class=\"hljs-attribute\"\u003eSec-WebSocket-Key\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e: \u003c/span\u003ewXE7gVKUV5flJWEnJLr8pw==\n\u003cspan class=\"hljs-attribute\"\u003eSec-WebSocket-Version\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e: \u003c/span\u003e13\n\u003cspan class=\"hljs-attribute\"\u003eUpgrade\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e: \u003c/span\u003ewebsocket\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e然后服务端响应协议升级\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-http\"\u003e\u003cspan class=\"hljs-meta\"\u003eHTTP/1.1\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e101\u003c/span\u003e Switching Protocols\n\u003cspan class=\"hljs-attribute\"\u003eUpgrade\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e: \u003c/span\u003ewebsocket\n\u003cspan class=\"hljs-attribute\"\u003eConnection\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e: \u003c/span\u003eUpgrade\n\u003cspan class=\"hljs-attribute\"\u003eSec-WebSocket-Accept\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e: \u003c/span\u003eDeY5PvpKJhTquRvvA7TPBcinVBk=\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e代码演示：\u003c/p\u003e\n\u003cp\u003e服务端(使用\u003ccode\u003ews\u003c/code\u003e库)：\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003e\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e express = \u003cspan class=\"hljs-built_in\"\u003erequire\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;express\u0026quot;\u003c/span\u003e);\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e ws = \u003cspan class=\"hljs-built_in\"\u003erequire\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;ws\u0026quot;\u003c/span\u003e);\n\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e app = \u003cspan class=\"hljs-title function_\"\u003eexpress\u003c/span\u003e();\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e wsServer = \u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e ws.\u003cspan class=\"hljs-title class_\"\u003eServer\u003c/span\u003e({ \u003cspan class=\"hljs-attr\"\u003eport\u003c/span\u003e: \u003cspan class=\"hljs-number\"\u003e8080\u003c/span\u003e });\n\nwsServer.\u003cspan class=\"hljs-title function_\"\u003eon\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;connection\u0026quot;\u003c/span\u003e, \u003cspan class=\"hljs-function\"\u003e(\u003cspan class=\"hljs-params\"\u003ews\u003c/span\u003e) =\u0026gt;\u003c/span\u003e {\n  \u003cspan class=\"hljs-variable language_\"\u003econsole\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003elog\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;server: connected to a client\u0026quot;\u003c/span\u003e);\n  ws.\u003cspan class=\"hljs-title function_\"\u003eon\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;message\u0026quot;\u003c/span\u003e, \u003cspan class=\"hljs-function\"\u003e(\u003cspan class=\"hljs-params\"\u003emsg\u003c/span\u003e) =\u0026gt;\u003c/span\u003e {\n    \u003cspan class=\"hljs-variable language_\"\u003econsole\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003elog\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e`server: message receive from client--\u003cspan class=\"hljs-subst\"\u003e${msg}\u003c/span\u003e`\u003c/span\u003e);\n  });\n  ws.\u003cspan class=\"hljs-title function_\"\u003esend\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;hello client\u0026quot;\u003c/span\u003e);\n  ws.\u003cspan class=\"hljs-title function_\"\u003eping\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;\u0026quot;\u003c/span\u003e, \u003cspan class=\"hljs-literal\"\u003efalse\u003c/span\u003e, \u003cspan class=\"hljs-function\"\u003e() =\u0026gt;\u003c/span\u003e {});\n});\n\napp.\u003cspan class=\"hljs-title function_\"\u003eget\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;/\u0026quot;\u003c/span\u003e, \u003cspan class=\"hljs-function\"\u003e(\u003cspan class=\"hljs-params\"\u003ereq, res\u003c/span\u003e) =\u0026gt;\u003c/span\u003e {\n  res.\u003cspan class=\"hljs-title function_\"\u003esendFile\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e`\u003cspan class=\"hljs-subst\"\u003e${__dirname}\u003c/span\u003e/index.html`\u003c/span\u003e);\n})\n\napp.\u003cspan class=\"hljs-title function_\"\u003elisten\u003c/span\u003e(\u003cspan class=\"hljs-number\"\u003e3000\u003c/span\u003e);\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e客户端：\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-html\"\u003e\u003cspan class=\"hljs-meta\"\u003e\u0026lt;!DOCTYPE \u003cspan class=\"hljs-keyword\"\u003ehtml\u003c/span\u003e\u0026gt;\u003c/span\u003e\n\u003cspan class=\"hljs-tag\"\u003e\u0026lt;\u003cspan class=\"hljs-name\"\u003ehtml\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003elang\u003c/span\u003e=\u003cspan class=\"hljs-string\"\u003e\u0026quot;en\u0026quot;\u003c/span\u003e\u0026gt;\u003c/span\u003e\n\u003cspan class=\"hljs-tag\"\u003e\u0026lt;\u003cspan class=\"hljs-name\"\u003ehead\u003c/span\u003e\u0026gt;\u003c/span\u003e\n  \u003cspan class=\"hljs-tag\"\u003e\u0026lt;\u003cspan class=\"hljs-name\"\u003emeta\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003echarset\u003c/span\u003e=\u003cspan class=\"hljs-string\"\u003e\u0026quot;UTF-8\u0026quot;\u003c/span\u003e\u0026gt;\u003c/span\u003e\n  \u003cspan class=\"hljs-tag\"\u003e\u0026lt;\u003cspan class=\"hljs-name\"\u003emeta\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003ehttp-equiv\u003c/span\u003e=\u003cspan class=\"hljs-string\"\u003e\u0026quot;X-UA-Compatible\u0026quot;\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003econtent\u003c/span\u003e=\u003cspan class=\"hljs-string\"\u003e\u0026quot;IE=edge\u0026quot;\u003c/span\u003e\u0026gt;\u003c/span\u003e\n  \u003cspan class=\"hljs-tag\"\u003e\u0026lt;\u003cspan class=\"hljs-name\"\u003emeta\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003ename\u003c/span\u003e=\u003cspan class=\"hljs-string\"\u003e\u0026quot;viewport\u0026quot;\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003econtent\u003c/span\u003e=\u003cspan class=\"hljs-string\"\u003e\u0026quot;width=device-width, initial-scale=1.0\u0026quot;\u003c/span\u003e\u0026gt;\u003c/span\u003e\n  \u003cspan class=\"hljs-tag\"\u003e\u0026lt;\u003cspan class=\"hljs-name\"\u003etitle\u003c/span\u003e\u0026gt;\u003c/span\u003eDocument\u003cspan class=\"hljs-tag\"\u003e\u0026lt;/\u003cspan class=\"hljs-name\"\u003etitle\u003c/span\u003e\u0026gt;\u003c/span\u003e\n\u003cspan class=\"hljs-tag\"\u003e\u0026lt;/\u003cspan class=\"hljs-name\"\u003ehead\u003c/span\u003e\u0026gt;\u003c/span\u003e\n\u003cspan class=\"hljs-tag\"\u003e\u0026lt;\u003cspan class=\"hljs-name\"\u003ebody\u003c/span\u003e\u0026gt;\u003c/span\u003e\n  \u003cspan class=\"hljs-tag\"\u003e\u0026lt;\u003cspan class=\"hljs-name\"\u003emain\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003eclass\u003c/span\u003e=\u003cspan class=\"hljs-string\"\u003e\u0026quot;container\u0026quot;\u003c/span\u003e\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"hljs-tag\"\u003e\u0026lt;\u003cspan class=\"hljs-name\"\u003ebutton\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003eonclick\u003c/span\u003e=\u003cspan class=\"hljs-string\"\u003e\u0026quot;sendMessage()\u0026quot;\u003c/span\u003e\u0026gt;\u003c/span\u003esendMessage\u003cspan class=\"hljs-tag\"\u003e\u0026lt;/\u003cspan class=\"hljs-name\"\u003ebutton\u003c/span\u003e\u0026gt;\u003c/span\u003e\n  \u003cspan class=\"hljs-tag\"\u003e\u0026lt;/\u003cspan class=\"hljs-name\"\u003emain\u003c/span\u003e\u0026gt;\u003c/span\u003e\n  \u003cspan class=\"hljs-tag\"\u003e\u0026lt;\u003cspan class=\"hljs-name\"\u003escript\u003c/span\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"language-javascript\"\u003e\n    \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e wsClient = \u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eWebSocket\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;ws://localhost:8080\u0026quot;\u003c/span\u003e);\n    wsClient.\u003cspan class=\"hljs-property\"\u003eonopen\u003c/span\u003e = \u003cspan class=\"hljs-function\"\u003e() =\u0026gt;\u003c/span\u003e {\n      \u003cspan class=\"hljs-variable language_\"\u003econsole\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003elog\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;client: connected to server\u0026quot;\u003c/span\u003e);\n    }\n    wsClient.\u003cspan class=\"hljs-property\"\u003eonmessage\u003c/span\u003e = \u003cspan class=\"hljs-function\"\u003e(\u003cspan class=\"hljs-params\"\u003emsg\u003c/span\u003e) =\u0026gt;\u003c/span\u003e {\n      \u003cspan class=\"hljs-variable language_\"\u003econsole\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003elog\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e`client: receive from server--\u003cspan class=\"hljs-subst\"\u003e${msg.data}\u003c/span\u003e`\u003c/span\u003e);\n    }\n\n    \u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003esendMessage\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003e\u003c/span\u003e) {\n      wsClient.\u003cspan class=\"hljs-title function_\"\u003esend\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;hello server\u0026quot;\u003c/span\u003e);\n    }\n  \u003c/span\u003e\u003cspan class=\"hljs-tag\"\u003e\u0026lt;/\u003cspan class=\"hljs-name\"\u003escript\u003c/span\u003e\u0026gt;\u003c/span\u003e\n\u003cspan class=\"hljs-tag\"\u003e\u0026lt;/\u003cspan class=\"hljs-name\"\u003ebody\u003c/span\u003e\u0026gt;\u003c/span\u003e\n\u003cspan class=\"hljs-tag\"\u003e\u0026lt;/\u003cspan class=\"hljs-name\"\u003ehtml\u003c/span\u003e\u0026gt;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e运行结果：\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-shell\"\u003e\u003cspan class=\"hljs-meta\"\u003e# \u003c/span\u003e\u003cspan class=\"language-bash\"\u003e客户端\u003c/span\u003e\nclient: connected to server\nclient: receive from server--hello client\n\u003cspan class=\"hljs-meta\"\u003e\n# \u003c/span\u003e\u003cspan class=\"language-bash\"\u003e服务端\u003c/span\u003e\nserver: connected to a client\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch2 id=\"数据交换\"\u003e数据交换\u003c/h2\u003e\n\u003cp\u003e一旦\u003ccode\u003eWebSocket\u003c/code\u003e客户端、服务端建立连接后，后续的操作都是基于\u003cstrong\u003e数据帧\u003c/strong\u003e的传递\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003eWebSocket\u003c/code\u003e根据\u003ccode\u003eopcode\u003c/code\u003e来区分操作的类型。比如\u003ccode\u003e0x8\u003c/code\u003e表示断开连接，\u003ccode\u003e0x0-0x2\u003c/code\u003e表示数据交互\u003c/p\u003e\n\u003cp\u003e数据分片：\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003eWebSocket\u003c/code\u003e的每条消息可能被切分成多个数据帧。当\u003ccode\u003eWebSocket\u003c/code\u003e的接收方接收到一个数据帧时，会根据FIN的值进行判断，是否已经收到消息的最后一个数据帧\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-http\"\u003e# 一个完整的消息(FIN=1且opcode != 0x0)\n\u003cspan class=\"hljs-attribute\"\u003eClient\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e: \u003c/span\u003eFIN=1, opcode=0x1, msg=\u0026quot;hello\u0026quot;\n\u003cspan class=\"hljs-attribute\"\u003eServer\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e: \u003c/span\u003e(process complete message immediately) Hi.\n\n# 文本消息且消息还没发送完成\n\u003cspan class=\"hljs-attribute\"\u003eClient\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e: \u003c/span\u003eFIN=0, opcode=0x1, msg=\u0026quot;and a\u0026quot;\n\u003cspan class=\"hljs-attribute\"\u003eServer\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e: \u003c/span\u003e(listening, new message containing text started)\n# 延续帧\n\u003cspan class=\"hljs-attribute\"\u003eClient\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e: \u003c/span\u003eFIN=0, opcode=0x0, msg=\u0026quot;happy new\u0026quot;\n\u003cspan class=\"hljs-attribute\"\u003eServer\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e: \u003c/span\u003e(listening, payload concatenated to previous message)\n# 最终帧\n\u003cspan class=\"hljs-attribute\"\u003eClient\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e: \u003c/span\u003eFIN=1, opcode=0x0, msg=\u0026quot;year!\u0026quot;\n\u003cspan class=\"hljs-attribute\"\u003eServer\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e: \u003c/span\u003e(process complete message) Happy new year to you too!\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch2 id=\"心跳\"\u003e心跳\u003c/h2\u003e\n\u003cp\u003e在Websocket中定义了\u003cstrong\u003e心跳ping(0x9)\u003c/strong\u003e 和 \u003cstrong\u003e心跳pong(0xA)\u003c/strong\u003e 的控制帧\u003c/p\u003e\n\u003ch2 id=\"参考\"\u003e参考\u003c/h2\u003e\n\u003cp\u003e\u003ca href=\"https://juejin.cn/post/6844903544978407431\"\u003eWebSocket：5分钟从入门到精通\n\u003c/a\u003e\u003c/p\u003e\n"}},"__N_SSG":true},"page":"/post/[title]","query":{"title":"网络复习-WebSocket"},"buildId":"CGe2LDJsj2ltDkpQbiUcG","assetPrefix":"/next-blog","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>
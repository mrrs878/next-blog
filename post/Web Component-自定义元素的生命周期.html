<!DOCTYPE html><html><head><link rel="icon" href="https://mrrsblog.oss-cn-shanghai.aliyuncs.com/avatar.jpg"/><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><title>Mr.RS的个人博客-Web Component-自定义元素的生命周期</title><meta name="next-head-count" content="3"/><link rel="preload" href="/_next/static/css/d3bd3b56eb8829d9.css" as="style"/><link rel="stylesheet" href="/_next/static/css/d3bd3b56eb8829d9.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-514908bffb652963.js" defer=""></script><script src="/_next/static/chunks/framework-91d7f78b5b4003c8.js" defer=""></script><script src="/_next/static/chunks/main-1e7421553b9673ee.js" defer=""></script><script src="/_next/static/chunks/pages/_app-ca6aae25bc99a05f.js" defer=""></script><script src="/_next/static/chunks/899-1cd3a59abdb8ea18.js" defer=""></script><script src="/_next/static/chunks/pages/post/%5Btitle%5D-216eae5ddb3b6d26.js" defer=""></script><script src="/_next/static/OgI6Xyd2y4cH2beo6SuyV/_buildManifest.js" defer=""></script><script src="/_next/static/OgI6Xyd2y4cH2beo6SuyV/_ssgManifest.js" defer=""></script><script src="/_next/static/OgI6Xyd2y4cH2beo6SuyV/_middlewareManifest.js" defer=""></script></head><body><div id="__next" data-reactroot=""><header class="fixed top-0 py-4 left-0 right-0 h-auto px-10 shadow bg-white z-50"><nav><ul class="flex w-auto"><li class="mr-4 hover:text-yellow"><a href="/">首页</a></li><li class="mx-4 hover:text-yellow"><a href="/categories">分类</a></li><li class="mx-4 hover:text-yellow"><a href="/tags">标签</a></li><li class="ml-4 hover:text-yellow"><a href="/timeline">归档</a></li></ul></nav></header><main class="mt-20 mb-4 mx-auto justify-center w-2/3"><div class="mx-auto lg:max-w-5xl md:max-w-3xl"><article class="flex flex-col justify-around pb-16 px-4 mx-auto space-y-10 text-base"><div class="flex flex-col space-y-4"><h1 class="inline pt-10 text-4xl text-skin-primary">Web Component-自定义元素的生命周期</h1><div class="text-sm space-x-2 text-skin-muted grid grid-cols-5"><span class="flex align-middle"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 inline-block mr-1"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>2022-04-21 21:06:23</span><span class="flex align-middle"><svg class="w-5 h-5 inline-block mr-1" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1903" width="20" height="20"><path d="M257.7 752c2 0 4-0.2 6-0.5L431.9 722c2-0.4 3.9-1.3 5.3-2.8l423.9-423.9c3.9-3.9 3.9-10.2 0-14.1L694.9 114.9c-1.9-1.9-4.4-2.9-7.1-2.9s-5.2 1-7.1 2.9L256.8 538.8c-1.5 1.5-2.4 3.3-2.8 5.3l-29.5 168.2c-1.9 11.1 1.5 21.9 9.4 29.8 6.6 6.4 14.9 9.9 23.8 9.9z m67.4-174.4L687.8 215l73.3 73.3-362.7 362.6-88.9 15.7 15.6-89zM880 836H144c-17.7 0-32 14.3-32 32v36c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-36c0-17.7-14.3-32-32-32z" p-id="1904"></path></svg>2022-01-08 22:40:37</span><span class="flex align-middle"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 inline-block mr-1"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>44</span></div></div><div class="mt-8 flex"><div class="w-full flex-auto custom-markdown-body"><div class="markdown-body" id="write"><p>在之前大概了解了 Web Component，知道是怎么玩的，不过在查阅资料后发现之前有些错误</p>
<h2 id="nodeclonenode-的局限性">Node.cloneNode 的局限性</h2>
<p>在之前，使用的是<code>template.content.cloneNode(true);</code>来创建出一个新的节点，这种方法有一些局限性：会复制原节点的所有属性及属性值，其中就包括<code>id</code>，这样页面中就有多个<code>id</code>一样的元素了</p>
<blockquote>
<p>拷贝它所有的属性以及属性值,当然也就包括了属性上绑定的事件(比如 onclick=&quot;alert(1)&quot;),但不会拷贝那些使用 addEventListener()方法或者 node.onclick = fn 这种用 JavaScript 动态绑定的事件. --mdn</p>
</blockquote>
<p>MDN 同样也给出警告</p>
<blockquote>
<p>注意:为了防止一个文档中出现两个 ID 重复的元素,使用 cloneNode()方法克隆的节点在需要时应该指定另外一个与原 ID 值不同的 ID</p>
</blockquote>
<p>而且，生成的节点的<code>ownerDocument</code>仍然指向源节点的<code>ownerDocument</code></p>
<p>既然这个方法有一定的局限性，那么有没有更好的方法呢？有的！</p>
<h2 id="documentimportnode">document.importNode</h2>
<blockquote>
<p><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Document/importNode">document.importNode</a>将外部文档的一个节点拷贝一份,然后可以把这个拷贝的节点插入到当前文档中</p>
</blockquote>
<p>使用方式</p>
<pre><code class="hljs language-js"><span class="hljs-comment">// deep参数表示是否递归复制源节点的所有子节点</span>
<span class="hljs-keyword">const</span> node = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">importNode</span>(externalNode, deep);
</code></pre>
<p>注意：</p>
<p>新生成节点的 <code>parentNode</code> 是 <code>null</code>，因为它还没有插入当前文档的文档树中，<strong>属于游离状态</strong>，因此无法对其进行操作</p>
<p>这样的话我们就可以很方便的修改新节点的<code>ownerDocument</code>（在<code>append</code>之后自动指向当前<code>document</code>）</p>
<p>试试新的 api 来创建<em>组件</em></p>
<pre><code class="hljs language-html"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript">
  <span class="hljs-keyword">class</span> <span class="hljs-title class_">MHeader</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">HTMLElement</span> {
    <span class="hljs-title function_">constructor</span>(<span class="hljs-params"></span>) {
      <span class="hljs-variable language_">super</span>();
      <span class="hljs-comment">// ...</span>
      <span class="hljs-keyword">const</span> content = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">importNode</span>(template.<span class="hljs-property">content</span>, <span class="hljs-literal">true</span>);
      <span class="hljs-comment">/**
       * 注意，要先将节点插入到shadowRoot后才能对其进行操作
       */</span>
      shadowRoot.<span class="hljs-title function_">appendChild</span>(content);
      <span class="hljs-comment">// ...</span>
    }
  }
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<h2 id="htmlelement-的生命周期">HTMLElement 的生命周期</h2>
<p>在之前，我们都是将各种操作直接写在构造函数里，这显然有些臃肿，那么有没有一些办法可以将这些逻辑分发出去呢？有的！</p>
<p>在<code>HTMLElement</code>内，有一些<a href="https://developer.mozilla.org/zh-CN/docs/Web/Web_Components/Using_custom_elements#%E4%BD%BF%E7%94%A8%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E5%9B%9E%E8%B0%83%E5%87%BD%E6%95%B0">生命周期</a></p>
<ul>
<li><p><code>connectedCallback</code>，当 <code>custom element</code> 首次被插入文档 DOM 时被调用</p>
</li>
<li><p><code>disconnectedCallback</code>，当 <code>custom element</code>从文档 DOM 中删除时被调用</p>
</li>
<li><p><code>adoptedCallback</code>， 当 <code>custom element</code>被移动到新的文档时被调用</p>
</li>
<li><p><code>attributeChangedCallback</code>，当 <code>custom element</code>增加、删除、修改自身属性时被调用</p>
</li>
</ul>
<p>据此，我们可以重构一下之前的<em>组件</em></p>
<pre><code class="hljs language-html"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript">
  <span class="hljs-keyword">class</span> <span class="hljs-title class_">MHeader</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">HTMLElement</span> {
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">get</span> <span class="hljs-title function_">observedAttributes</span>() {
      <span class="hljs-keyword">return</span> [<span class="hljs-string">&quot;title&quot;</span>];
    }
    <span class="hljs-title function_">constructor</span>(<span class="hljs-params"></span>) {
      <span class="hljs-variable language_">super</span>();
      <span class="hljs-comment">// 会自动向this上挂载一个shadowRoot</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">attachShadow</span>({ <span class="hljs-attr">mode</span>: <span class="hljs-string">&quot;open&quot;</span> });
      <span class="hljs-keyword">const</span> template = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">&quot;#mHeaderTemplate&quot;</span>);
      <span class="hljs-comment">// const content = template.content.cloneNode(true);</span>
      <span class="hljs-keyword">const</span> content = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">importNode</span>(template.<span class="hljs-property">content</span>, <span class="hljs-literal">true</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">shadowRoot</span>.<span class="hljs-title function_">appendChild</span>(content);
    }

    <span class="hljs-title function_">connectedCallback</span>(<span class="hljs-params"></span>) {
      <span class="hljs-keyword">const</span> loginBtn = <span class="hljs-variable language_">this</span>.<span class="hljs-property">shadowRoot</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">&quot;#login&quot;</span>);
      loginBtn.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&quot;click&quot;</span>, <span class="hljs-function">() =&gt;</span> {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">&quot;title&quot;</span>, <span class="hljs-string">&quot;登录成功&quot;</span>);
      });
    }

    <span class="hljs-title function_">attributeChangedCallback</span>(<span class="hljs-params">name, oldValue, newValue</span>) {
      <span class="hljs-keyword">if</span> (name === <span class="hljs-string">&quot;title&quot;</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">shadowRoot</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">&quot;#content&quot;</span>).<span class="hljs-property">innerText</span> = newValue;
      }
    }
  }
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>在这里，我们使用<code>attributeChangedCallback</code>来监听<em>组件</em>属性变化，在<code>title</code>属性发生变化时，更新元素的值。该回调会返回三个参数：</p>
<ul>
<li><p><code>name</code>，变化的属性的名字</p>
</li>
<li><p><code>oldValue</code>，属性之前的值</p>
</li>
<li><p><code>newValue</code>，要设置的值</p>
</li>
</ul>
<p>（react 写的多了，有点梦回 vue 的感觉 🤔）</p>
<p>此外有一点要注意：</p>
<p>需要在<code>static get observedAttributes</code>函数里声明一下要监听的属性名</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">static</span> <span class="hljs-keyword">get</span> <span class="hljs-title function_">observedAttributes</span>() {
  <span class="hljs-keyword">return</span> [<span class="hljs-string">&quot;title&quot;</span>];
}
</code></pre>
<p>完整代码</p>
<pre><code class="hljs language-html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">&quot;en&quot;</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;UTF-8&quot;</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">http-equiv</span>=<span class="hljs-string">&quot;X-UA-Compatible&quot;</span> <span class="hljs-attr">content</span>=<span class="hljs-string">&quot;IE=edge&quot;</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;viewport&quot;</span> <span class="hljs-attr">content</span>=<span class="hljs-string">&quot;width=device-width, initial-scale=1.0&quot;</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Document<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>

  <span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">template</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;mHeaderTemplate&quot;</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="language-css">
        <span class="hljs-selector-pseudo">:host</span> {
          <span class="hljs-attribute">font-size</span>: <span class="hljs-number">32px</span>;
        }

        <span class="hljs-selector-class">.content</span> {
          <span class="hljs-attribute">color</span>: <span class="hljs-number">#f00</span>;
        }
      </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;content&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;content&quot;</span>&gt;</span>我是头部<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;login&quot;</span>&gt;</span>login<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">m-header</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;mHeader&quot;</span> <span class="hljs-attr">title</span>=<span class="hljs-string">&quot;hello&quot;</span> /&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript">
      <span class="hljs-keyword">class</span> <span class="hljs-title class_">MHeader</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">HTMLElement</span> {
        <span class="hljs-keyword">static</span> <span class="hljs-keyword">get</span> <span class="hljs-title function_">observedAttributes</span>() {
          <span class="hljs-keyword">return</span> [<span class="hljs-string">&quot;title&quot;</span>];
        }
        <span class="hljs-title function_">constructor</span>(<span class="hljs-params"></span>) {
          <span class="hljs-variable language_">super</span>();
          <span class="hljs-comment">// 会自动向this上挂载一个shadowRoot</span>
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">attachShadow</span>({ <span class="hljs-attr">mode</span>: <span class="hljs-string">&quot;open&quot;</span> });
          <span class="hljs-keyword">const</span> template = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">&quot;#mHeaderTemplate&quot;</span>);
          <span class="hljs-comment">// const content = template.content.cloneNode(true);</span>
          <span class="hljs-keyword">const</span> content = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">importNode</span>(template.<span class="hljs-property">content</span>, <span class="hljs-literal">true</span>);
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">shadowRoot</span>.<span class="hljs-title function_">appendChild</span>(content);
        }

        <span class="hljs-title function_">connectedCallback</span>(<span class="hljs-params"></span>) {
          <span class="hljs-keyword">const</span> loginBtn = <span class="hljs-variable language_">this</span>.<span class="hljs-property">shadowRoot</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">&quot;#login&quot;</span>);
          loginBtn.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&quot;click&quot;</span>, <span class="hljs-function">() =&gt;</span> {
            <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">&quot;title&quot;</span>, <span class="hljs-string">&quot;登录成功&quot;</span>);
          });
        }

        <span class="hljs-title function_">attributeChangedCallback</span>(<span class="hljs-params">name, oldValue, newValue</span>) {
          <span class="hljs-keyword">if</span> (name === <span class="hljs-string">&quot;title&quot;</span>) {
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">shadowRoot</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">&quot;#content&quot;</span>).<span class="hljs-property">innerText</span> = newValue;
          }
        }
      }

      <span class="hljs-variable language_">window</span>.<span class="hljs-property">customElements</span>.<span class="hljs-title function_">define</span>(<span class="hljs-string">&quot;m-header&quot;</span>, <span class="hljs-title class_">MHeader</span>);

      <span class="hljs-keyword">const</span> mHeader = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">&quot;#mHeader&quot;</span>);
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<h2 id="总结">总结</h2>
<p>由于<code>Node.cloneNode</code>仍默认保留新节点的<code>ownerDocument</code>，因此使用起来没法放开，有些需要注意的地方。不过我们可以使用<code>document.importNode</code>来实现相同的功能，该API创建的节点处于游离状态，在进行<code>append</code>操作后会自动修正<code>ownerDocument</code>的指向</p>
<p>通过使用<code>custom elements</code>提供的生命周期函数，我们可以很方便地监听属性变化来做一些逻辑，但还是那句话书写起来有些不够便捷，需要用到原生 dom 操作 api，没准 jQuery 会借着 Web Components 再重新活跃起来</p>
<h2 id="参考">参考</h2>
<p><a href="https://developer.mozilla.org/zh-CN/docs/Web/Web_Components">MDN-Web Components</a></p>
<p><a href="https://github.com/mdn/web-components-examples">MDN/web-components-examples</a></p>
<p><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Node/cloneNode">Node.cloneNode(deep)</a></p>
<p><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Document/importNode">document.importNode</a></p>
<p><a href="https://developer.mozilla.org/zh-CN/docs/Web/Web_Components/Using_custom_elements#%E4%BD%BF%E7%94%A8%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E5%9B%9E%E8%B0%83%E5%87%BD%E6%95%B0">使用 custom elements</a></p>
</div></div></div></article></div></main><footer class="flex flex-col items-center justify-center leading-8 text-sm w-full py-2 border-t text-skin-muted"><p>Designed &amp; developed by<a class="ml-1 text-yellow" target="_blank" href="https://github.com/mrrs878" rel="noreferrer">Mr.RS</a></p><p>©<!-- --> <!-- -->2022</p></footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"title":"Web Component-自定义元素的生命周期","tags":["微前端","WebComponent"],"categories":"微前端","description":"在之前大概了解了 Web Component，知道是怎么玩的，不过在查阅资料后发现之前有些错误\n\n## Node.cloneNode 的局限性\n\n在之前，使用的是`template.content.cloneNode(true);`来创建出一个新的节点，这种方法有一些局限性：会复制原节点的所有属性及属性值，其中就包括`id`，这样页面中就有多个`id`一样的元素了\n\n\u003e 拷贝它所有的属性以及属性","createDate":"2022-04-21 21:06:23","updateDate":"2022-01-08 22:40:37","body":"\u003cp\u003e在之前大概了解了 Web Component，知道是怎么玩的，不过在查阅资料后发现之前有些错误\u003c/p\u003e\n\u003ch2 id=\"nodeclonenode-的局限性\"\u003eNode.cloneNode 的局限性\u003c/h2\u003e\n\u003cp\u003e在之前，使用的是\u003ccode\u003etemplate.content.cloneNode(true);\u003c/code\u003e来创建出一个新的节点，这种方法有一些局限性：会复制原节点的所有属性及属性值，其中就包括\u003ccode\u003eid\u003c/code\u003e，这样页面中就有多个\u003ccode\u003eid\u003c/code\u003e一样的元素了\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003e拷贝它所有的属性以及属性值,当然也就包括了属性上绑定的事件(比如 onclick=\u0026quot;alert(1)\u0026quot;),但不会拷贝那些使用 addEventListener()方法或者 node.onclick = fn 这种用 JavaScript 动态绑定的事件. --mdn\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003eMDN 同样也给出警告\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003e注意:为了防止一个文档中出现两个 ID 重复的元素,使用 cloneNode()方法克隆的节点在需要时应该指定另外一个与原 ID 值不同的 ID\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003e而且，生成的节点的\u003ccode\u003eownerDocument\u003c/code\u003e仍然指向源节点的\u003ccode\u003eownerDocument\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003e既然这个方法有一定的局限性，那么有没有更好的方法呢？有的！\u003c/p\u003e\n\u003ch2 id=\"documentimportnode\"\u003edocument.importNode\u003c/h2\u003e\n\u003cblockquote\u003e\n\u003cp\u003e\u003ca href=\"https://developer.mozilla.org/zh-CN/docs/Web/API/Document/importNode\"\u003edocument.importNode\u003c/a\u003e将外部文档的一个节点拷贝一份,然后可以把这个拷贝的节点插入到当前文档中\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003e使用方式\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003e\u003cspan class=\"hljs-comment\"\u003e// deep参数表示是否递归复制源节点的所有子节点\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e node = \u003cspan class=\"hljs-variable language_\"\u003edocument\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003eimportNode\u003c/span\u003e(externalNode, deep);\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e注意：\u003c/p\u003e\n\u003cp\u003e新生成节点的 \u003ccode\u003eparentNode\u003c/code\u003e 是 \u003ccode\u003enull\u003c/code\u003e，因为它还没有插入当前文档的文档树中，\u003cstrong\u003e属于游离状态\u003c/strong\u003e，因此无法对其进行操作\u003c/p\u003e\n\u003cp\u003e这样的话我们就可以很方便的修改新节点的\u003ccode\u003eownerDocument\u003c/code\u003e（在\u003ccode\u003eappend\u003c/code\u003e之后自动指向当前\u003ccode\u003edocument\u003c/code\u003e）\u003c/p\u003e\n\u003cp\u003e试试新的 api 来创建\u003cem\u003e组件\u003c/em\u003e\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-html\"\u003e\u003cspan class=\"hljs-tag\"\u003e\u0026lt;\u003cspan class=\"hljs-name\"\u003escript\u003c/span\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"language-javascript\"\u003e\n  \u003cspan class=\"hljs-keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eMHeader\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eextends\u003c/span\u003e \u003cspan class=\"hljs-title class_ inherited__\"\u003eHTMLElement\u003c/span\u003e {\n    \u003cspan class=\"hljs-title function_\"\u003econstructor\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003e\u003c/span\u003e) {\n      \u003cspan class=\"hljs-variable language_\"\u003esuper\u003c/span\u003e();\n      \u003cspan class=\"hljs-comment\"\u003e// ...\u003c/span\u003e\n      \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e content = \u003cspan class=\"hljs-variable language_\"\u003edocument\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003eimportNode\u003c/span\u003e(template.\u003cspan class=\"hljs-property\"\u003econtent\u003c/span\u003e, \u003cspan class=\"hljs-literal\"\u003etrue\u003c/span\u003e);\n      \u003cspan class=\"hljs-comment\"\u003e/**\n       * 注意，要先将节点插入到shadowRoot后才能对其进行操作\n       */\u003c/span\u003e\n      shadowRoot.\u003cspan class=\"hljs-title function_\"\u003eappendChild\u003c/span\u003e(content);\n      \u003cspan class=\"hljs-comment\"\u003e// ...\u003c/span\u003e\n    }\n  }\n\u003c/span\u003e\u003cspan class=\"hljs-tag\"\u003e\u0026lt;/\u003cspan class=\"hljs-name\"\u003escript\u003c/span\u003e\u0026gt;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch2 id=\"htmlelement-的生命周期\"\u003eHTMLElement 的生命周期\u003c/h2\u003e\n\u003cp\u003e在之前，我们都是将各种操作直接写在构造函数里，这显然有些臃肿，那么有没有一些办法可以将这些逻辑分发出去呢？有的！\u003c/p\u003e\n\u003cp\u003e在\u003ccode\u003eHTMLElement\u003c/code\u003e内，有一些\u003ca href=\"https://developer.mozilla.org/zh-CN/docs/Web/Web_Components/Using_custom_elements#%E4%BD%BF%E7%94%A8%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E5%9B%9E%E8%B0%83%E5%87%BD%E6%95%B0\"\u003e生命周期\u003c/a\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cp\u003e\u003ccode\u003econnectedCallback\u003c/code\u003e，当 \u003ccode\u003ecustom element\u003c/code\u003e 首次被插入文档 DOM 时被调用\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003cp\u003e\u003ccode\u003edisconnectedCallback\u003c/code\u003e，当 \u003ccode\u003ecustom element\u003c/code\u003e从文档 DOM 中删除时被调用\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003cp\u003e\u003ccode\u003eadoptedCallback\u003c/code\u003e， 当 \u003ccode\u003ecustom element\u003c/code\u003e被移动到新的文档时被调用\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003cp\u003e\u003ccode\u003eattributeChangedCallback\u003c/code\u003e，当 \u003ccode\u003ecustom element\u003c/code\u003e增加、删除、修改自身属性时被调用\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e据此，我们可以重构一下之前的\u003cem\u003e组件\u003c/em\u003e\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-html\"\u003e\u003cspan class=\"hljs-tag\"\u003e\u0026lt;\u003cspan class=\"hljs-name\"\u003escript\u003c/span\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"language-javascript\"\u003e\n  \u003cspan class=\"hljs-keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eMHeader\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eextends\u003c/span\u003e \u003cspan class=\"hljs-title class_ inherited__\"\u003eHTMLElement\u003c/span\u003e {\n    \u003cspan class=\"hljs-keyword\"\u003estatic\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eget\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003eobservedAttributes\u003c/span\u003e() {\n      \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e [\u003cspan class=\"hljs-string\"\u003e\u0026quot;title\u0026quot;\u003c/span\u003e];\n    }\n    \u003cspan class=\"hljs-title function_\"\u003econstructor\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003e\u003c/span\u003e) {\n      \u003cspan class=\"hljs-variable language_\"\u003esuper\u003c/span\u003e();\n      \u003cspan class=\"hljs-comment\"\u003e// 会自动向this上挂载一个shadowRoot\u003c/span\u003e\n      \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003eattachShadow\u003c/span\u003e({ \u003cspan class=\"hljs-attr\"\u003emode\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\u0026quot;open\u0026quot;\u003c/span\u003e });\n      \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e template = \u003cspan class=\"hljs-variable language_\"\u003edocument\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003equerySelector\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;#mHeaderTemplate\u0026quot;\u003c/span\u003e);\n      \u003cspan class=\"hljs-comment\"\u003e// const content = template.content.cloneNode(true);\u003c/span\u003e\n      \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e content = \u003cspan class=\"hljs-variable language_\"\u003edocument\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003eimportNode\u003c/span\u003e(template.\u003cspan class=\"hljs-property\"\u003econtent\u003c/span\u003e, \u003cspan class=\"hljs-literal\"\u003etrue\u003c/span\u003e);\n      \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eshadowRoot\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003eappendChild\u003c/span\u003e(content);\n    }\n\n    \u003cspan class=\"hljs-title function_\"\u003econnectedCallback\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003e\u003c/span\u003e) {\n      \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e loginBtn = \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eshadowRoot\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003equerySelector\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;#login\u0026quot;\u003c/span\u003e);\n      loginBtn.\u003cspan class=\"hljs-title function_\"\u003eaddEventListener\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;click\u0026quot;\u003c/span\u003e, \u003cspan class=\"hljs-function\"\u003e() =\u0026gt;\u003c/span\u003e {\n        \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003esetAttribute\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;title\u0026quot;\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e\u0026quot;登录成功\u0026quot;\u003c/span\u003e);\n      });\n    }\n\n    \u003cspan class=\"hljs-title function_\"\u003eattributeChangedCallback\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003ename, oldValue, newValue\u003c/span\u003e) {\n      \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (name === \u003cspan class=\"hljs-string\"\u003e\u0026quot;title\u0026quot;\u003c/span\u003e) {\n        \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eshadowRoot\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003equerySelector\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;#content\u0026quot;\u003c/span\u003e).\u003cspan class=\"hljs-property\"\u003einnerText\u003c/span\u003e = newValue;\n      }\n    }\n  }\n\u003c/span\u003e\u003cspan class=\"hljs-tag\"\u003e\u0026lt;/\u003cspan class=\"hljs-name\"\u003escript\u003c/span\u003e\u0026gt;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e在这里，我们使用\u003ccode\u003eattributeChangedCallback\u003c/code\u003e来监听\u003cem\u003e组件\u003c/em\u003e属性变化，在\u003ccode\u003etitle\u003c/code\u003e属性发生变化时，更新元素的值。该回调会返回三个参数：\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cp\u003e\u003ccode\u003ename\u003c/code\u003e，变化的属性的名字\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003cp\u003e\u003ccode\u003eoldValue\u003c/code\u003e，属性之前的值\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003cp\u003e\u003ccode\u003enewValue\u003c/code\u003e，要设置的值\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e（react 写的多了，有点梦回 vue 的感觉 🤔）\u003c/p\u003e\n\u003cp\u003e此外有一点要注意：\u003c/p\u003e\n\u003cp\u003e需要在\u003ccode\u003estatic get observedAttributes\u003c/code\u003e函数里声明一下要监听的属性名\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003e\u003cspan class=\"hljs-keyword\"\u003estatic\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eget\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003eobservedAttributes\u003c/span\u003e() {\n  \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e [\u003cspan class=\"hljs-string\"\u003e\u0026quot;title\u0026quot;\u003c/span\u003e];\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e完整代码\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-html\"\u003e\u003cspan class=\"hljs-meta\"\u003e\u0026lt;!DOCTYPE \u003cspan class=\"hljs-keyword\"\u003ehtml\u003c/span\u003e\u0026gt;\u003c/span\u003e\n\u003cspan class=\"hljs-tag\"\u003e\u0026lt;\u003cspan class=\"hljs-name\"\u003ehtml\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003elang\u003c/span\u003e=\u003cspan class=\"hljs-string\"\u003e\u0026quot;en\u0026quot;\u003c/span\u003e\u0026gt;\u003c/span\u003e\n  \u003cspan class=\"hljs-tag\"\u003e\u0026lt;\u003cspan class=\"hljs-name\"\u003ehead\u003c/span\u003e\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"hljs-tag\"\u003e\u0026lt;\u003cspan class=\"hljs-name\"\u003emeta\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003echarset\u003c/span\u003e=\u003cspan class=\"hljs-string\"\u003e\u0026quot;UTF-8\u0026quot;\u003c/span\u003e /\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"hljs-tag\"\u003e\u0026lt;\u003cspan class=\"hljs-name\"\u003emeta\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003ehttp-equiv\u003c/span\u003e=\u003cspan class=\"hljs-string\"\u003e\u0026quot;X-UA-Compatible\u0026quot;\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003econtent\u003c/span\u003e=\u003cspan class=\"hljs-string\"\u003e\u0026quot;IE=edge\u0026quot;\u003c/span\u003e /\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"hljs-tag\"\u003e\u0026lt;\u003cspan class=\"hljs-name\"\u003emeta\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003ename\u003c/span\u003e=\u003cspan class=\"hljs-string\"\u003e\u0026quot;viewport\u0026quot;\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003econtent\u003c/span\u003e=\u003cspan class=\"hljs-string\"\u003e\u0026quot;width=device-width, initial-scale=1.0\u0026quot;\u003c/span\u003e /\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"hljs-tag\"\u003e\u0026lt;\u003cspan class=\"hljs-name\"\u003etitle\u003c/span\u003e\u0026gt;\u003c/span\u003eDocument\u003cspan class=\"hljs-tag\"\u003e\u0026lt;/\u003cspan class=\"hljs-name\"\u003etitle\u003c/span\u003e\u0026gt;\u003c/span\u003e\n  \u003cspan class=\"hljs-tag\"\u003e\u0026lt;/\u003cspan class=\"hljs-name\"\u003ehead\u003c/span\u003e\u0026gt;\u003c/span\u003e\n\n  \u003cspan class=\"hljs-tag\"\u003e\u0026lt;\u003cspan class=\"hljs-name\"\u003ebody\u003c/span\u003e\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"hljs-tag\"\u003e\u0026lt;\u003cspan class=\"hljs-name\"\u003etemplate\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003eid\u003c/span\u003e=\u003cspan class=\"hljs-string\"\u003e\u0026quot;mHeaderTemplate\u0026quot;\u003c/span\u003e\u0026gt;\u003c/span\u003e\n      \u003cspan class=\"hljs-tag\"\u003e\u0026lt;\u003cspan class=\"hljs-name\"\u003estyle\u003c/span\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"language-css\"\u003e\n        \u003cspan class=\"hljs-selector-pseudo\"\u003e:host\u003c/span\u003e {\n          \u003cspan class=\"hljs-attribute\"\u003efont-size\u003c/span\u003e: \u003cspan class=\"hljs-number\"\u003e32px\u003c/span\u003e;\n        }\n\n        \u003cspan class=\"hljs-selector-class\"\u003e.content\u003c/span\u003e {\n          \u003cspan class=\"hljs-attribute\"\u003ecolor\u003c/span\u003e: \u003cspan class=\"hljs-number\"\u003e#f00\u003c/span\u003e;\n        }\n      \u003c/span\u003e\u003cspan class=\"hljs-tag\"\u003e\u0026lt;/\u003cspan class=\"hljs-name\"\u003estyle\u003c/span\u003e\u0026gt;\u003c/span\u003e\n      \u003cspan class=\"hljs-tag\"\u003e\u0026lt;\u003cspan class=\"hljs-name\"\u003ediv\u003c/span\u003e\u0026gt;\u003c/span\u003e\n        \u003cspan class=\"hljs-tag\"\u003e\u0026lt;\u003cspan class=\"hljs-name\"\u003espan\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003eclass\u003c/span\u003e=\u003cspan class=\"hljs-string\"\u003e\u0026quot;content\u0026quot;\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003eid\u003c/span\u003e=\u003cspan class=\"hljs-string\"\u003e\u0026quot;content\u0026quot;\u003c/span\u003e\u0026gt;\u003c/span\u003e我是头部\u003cspan class=\"hljs-tag\"\u003e\u0026lt;/\u003cspan class=\"hljs-name\"\u003espan\u003c/span\u003e\u0026gt;\u003c/span\u003e\n        \u003cspan class=\"hljs-tag\"\u003e\u0026lt;\u003cspan class=\"hljs-name\"\u003ebutton\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003eid\u003c/span\u003e=\u003cspan class=\"hljs-string\"\u003e\u0026quot;login\u0026quot;\u003c/span\u003e\u0026gt;\u003c/span\u003elogin\u003cspan class=\"hljs-tag\"\u003e\u0026lt;/\u003cspan class=\"hljs-name\"\u003ebutton\u003c/span\u003e\u0026gt;\u003c/span\u003e\n      \u003cspan class=\"hljs-tag\"\u003e\u0026lt;/\u003cspan class=\"hljs-name\"\u003ediv\u003c/span\u003e\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"hljs-tag\"\u003e\u0026lt;/\u003cspan class=\"hljs-name\"\u003etemplate\u003c/span\u003e\u0026gt;\u003c/span\u003e\n\n    \u003cspan class=\"hljs-tag\"\u003e\u0026lt;\u003cspan class=\"hljs-name\"\u003em-header\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003eid\u003c/span\u003e=\u003cspan class=\"hljs-string\"\u003e\u0026quot;mHeader\u0026quot;\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003etitle\u003c/span\u003e=\u003cspan class=\"hljs-string\"\u003e\u0026quot;hello\u0026quot;\u003c/span\u003e /\u0026gt;\u003c/span\u003e\n\n    \u003cspan class=\"hljs-tag\"\u003e\u0026lt;\u003cspan class=\"hljs-name\"\u003escript\u003c/span\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"language-javascript\"\u003e\n      \u003cspan class=\"hljs-keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eMHeader\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eextends\u003c/span\u003e \u003cspan class=\"hljs-title class_ inherited__\"\u003eHTMLElement\u003c/span\u003e {\n        \u003cspan class=\"hljs-keyword\"\u003estatic\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eget\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003eobservedAttributes\u003c/span\u003e() {\n          \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e [\u003cspan class=\"hljs-string\"\u003e\u0026quot;title\u0026quot;\u003c/span\u003e];\n        }\n        \u003cspan class=\"hljs-title function_\"\u003econstructor\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003e\u003c/span\u003e) {\n          \u003cspan class=\"hljs-variable language_\"\u003esuper\u003c/span\u003e();\n          \u003cspan class=\"hljs-comment\"\u003e// 会自动向this上挂载一个shadowRoot\u003c/span\u003e\n          \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003eattachShadow\u003c/span\u003e({ \u003cspan class=\"hljs-attr\"\u003emode\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\u0026quot;open\u0026quot;\u003c/span\u003e });\n          \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e template = \u003cspan class=\"hljs-variable language_\"\u003edocument\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003equerySelector\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;#mHeaderTemplate\u0026quot;\u003c/span\u003e);\n          \u003cspan class=\"hljs-comment\"\u003e// const content = template.content.cloneNode(true);\u003c/span\u003e\n          \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e content = \u003cspan class=\"hljs-variable language_\"\u003edocument\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003eimportNode\u003c/span\u003e(template.\u003cspan class=\"hljs-property\"\u003econtent\u003c/span\u003e, \u003cspan class=\"hljs-literal\"\u003etrue\u003c/span\u003e);\n          \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eshadowRoot\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003eappendChild\u003c/span\u003e(content);\n        }\n\n        \u003cspan class=\"hljs-title function_\"\u003econnectedCallback\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003e\u003c/span\u003e) {\n          \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e loginBtn = \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eshadowRoot\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003equerySelector\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;#login\u0026quot;\u003c/span\u003e);\n          loginBtn.\u003cspan class=\"hljs-title function_\"\u003eaddEventListener\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;click\u0026quot;\u003c/span\u003e, \u003cspan class=\"hljs-function\"\u003e() =\u0026gt;\u003c/span\u003e {\n            \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003esetAttribute\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;title\u0026quot;\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e\u0026quot;登录成功\u0026quot;\u003c/span\u003e);\n          });\n        }\n\n        \u003cspan class=\"hljs-title function_\"\u003eattributeChangedCallback\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003ename, oldValue, newValue\u003c/span\u003e) {\n          \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (name === \u003cspan class=\"hljs-string\"\u003e\u0026quot;title\u0026quot;\u003c/span\u003e) {\n            \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eshadowRoot\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003equerySelector\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;#content\u0026quot;\u003c/span\u003e).\u003cspan class=\"hljs-property\"\u003einnerText\u003c/span\u003e = newValue;\n          }\n        }\n      }\n\n      \u003cspan class=\"hljs-variable language_\"\u003ewindow\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003ecustomElements\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003edefine\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;m-header\u0026quot;\u003c/span\u003e, \u003cspan class=\"hljs-title class_\"\u003eMHeader\u003c/span\u003e);\n\n      \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e mHeader = \u003cspan class=\"hljs-variable language_\"\u003edocument\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003equerySelector\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;#mHeader\u0026quot;\u003c/span\u003e);\n    \u003c/span\u003e\u003cspan class=\"hljs-tag\"\u003e\u0026lt;/\u003cspan class=\"hljs-name\"\u003escript\u003c/span\u003e\u0026gt;\u003c/span\u003e\n  \u003cspan class=\"hljs-tag\"\u003e\u0026lt;/\u003cspan class=\"hljs-name\"\u003ebody\u003c/span\u003e\u0026gt;\u003c/span\u003e\n\u003cspan class=\"hljs-tag\"\u003e\u0026lt;/\u003cspan class=\"hljs-name\"\u003ehtml\u003c/span\u003e\u0026gt;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch2 id=\"总结\"\u003e总结\u003c/h2\u003e\n\u003cp\u003e由于\u003ccode\u003eNode.cloneNode\u003c/code\u003e仍默认保留新节点的\u003ccode\u003eownerDocument\u003c/code\u003e，因此使用起来没法放开，有些需要注意的地方。不过我们可以使用\u003ccode\u003edocument.importNode\u003c/code\u003e来实现相同的功能，该API创建的节点处于游离状态，在进行\u003ccode\u003eappend\u003c/code\u003e操作后会自动修正\u003ccode\u003eownerDocument\u003c/code\u003e的指向\u003c/p\u003e\n\u003cp\u003e通过使用\u003ccode\u003ecustom elements\u003c/code\u003e提供的生命周期函数，我们可以很方便地监听属性变化来做一些逻辑，但还是那句话书写起来有些不够便捷，需要用到原生 dom 操作 api，没准 jQuery 会借着 Web Components 再重新活跃起来\u003c/p\u003e\n\u003ch2 id=\"参考\"\u003e参考\u003c/h2\u003e\n\u003cp\u003e\u003ca href=\"https://developer.mozilla.org/zh-CN/docs/Web/Web_Components\"\u003eMDN-Web Components\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/mdn/web-components-examples\"\u003eMDN/web-components-examples\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://developer.mozilla.org/zh-CN/docs/Web/API/Node/cloneNode\"\u003eNode.cloneNode(deep)\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://developer.mozilla.org/zh-CN/docs/Web/API/Document/importNode\"\u003edocument.importNode\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://developer.mozilla.org/zh-CN/docs/Web/Web_Components/Using_custom_elements#%E4%BD%BF%E7%94%A8%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E5%9B%9E%E8%B0%83%E5%87%BD%E6%95%B0\"\u003e使用 custom elements\u003c/a\u003e\u003c/p\u003e\n"}},"__N_SSG":true},"page":"/post/[title]","query":{"title":"Web Component-自定义元素的生命周期"},"buildId":"OgI6Xyd2y4cH2beo6SuyV","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>
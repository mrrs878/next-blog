<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><title>Mr.RS的个人博客-服务端渲染-Nuxt.js</title><meta name="next-head-count" content="3"/><link rel="preload" href="/next-blog/_next/static/css/69a53a8e7e466837.css" as="style"/><link rel="stylesheet" href="/next-blog/_next/static/css/69a53a8e7e466837.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/next-blog/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/next-blog/_next/static/chunks/webpack-cf185e4b59cdddcf.js" defer=""></script><script src="/next-blog/_next/static/chunks/framework-91d7f78b5b4003c8.js" defer=""></script><script src="/next-blog/_next/static/chunks/main-1c9e93b8392c1bc9.js" defer=""></script><script src="/next-blog/_next/static/chunks/pages/_app-ca6aae25bc99a05f.js" defer=""></script><script src="/next-blog/_next/static/chunks/899-865d0f25be8776b8.js" defer=""></script><script src="/next-blog/_next/static/chunks/pages/post/%5Btitle%5D-406bad804ceffd1d.js" defer=""></script><script src="/next-blog/_next/static/tZvMitr2gJlzbBX_OxPbz/_buildManifest.js" defer=""></script><script src="/next-blog/_next/static/tZvMitr2gJlzbBX_OxPbz/_ssgManifest.js" defer=""></script><script src="/next-blog/_next/static/tZvMitr2gJlzbBX_OxPbz/_middlewareManifest.js" defer=""></script></head><body><div id="__next" data-reactroot=""><header class="fixed top-0 py-4 left-0 right-0 h-auto px-10 shadow bg-white z-50"><nav><ul class="flex w-auto"><li class="mr-4 hover:text-yellow"><a href="/next-blog">首页</a></li><li class="mx-4 hover:text-yellow"><a href="/next-blog/categories">分类</a></li><li class="ml-4 hover:text-yellow"><a href="/next-blog/timeline">归档</a></li></ul></nav></header><main class="mt-20 mb-4 mx-auto justify-center w-2/3"><div class="mx-auto lg:max-w-5xl md:max-w-3xl"><article class="flex flex-col justify-around pb-16 px-4 mx-auto space-y-10 text-base"><div class="flex flex-col space-y-4"><h1 class="inline pt-10 text-4xl text-skin-primary">服务端渲染-Nuxt.js</h1><div class="text-sm space-x-2 text-skin-muted"><span><svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 inline-block mr-1"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>2020-07-28 11:15:28</span><span><svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 inline-block mr-1"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>44</span></div></div><div class="mt-8 flex"><div class="w-full flex-auto custom-markdown-body"><div class="markdown-body" id="write"><blockquote>
<p><a href="mailto:&#78;&#x75;&#x78;&#x74;&#x2e;&#106;&#x73;&#x40;&#50;&#x2e;&#49;&#51;&#x2e;&#x36;">&#78;&#x75;&#x78;&#x74;&#x2e;&#106;&#x73;&#x40;&#50;&#x2e;&#49;&#51;&#x2e;&#x36;</a></p>
</blockquote>
<h1 id="安装">安装</h1>
<p>推荐使用官方脚手架</p>
<p><code>yarn create nuxt-app &lt;project name&gt;</code></p>
<h1 id="使用">使用</h1>
<h2 id="如何引入三方ui库框架">如何引入三方UI库/框架</h2>
<p><a href="https://youzan.github.io/vant/#/zh-CN/">vant</a> 为例</p>
<ol>
<li><p><code>~/plugins/</code>下新建<code>vant-ui.js</code></p>
<pre><code class="hljs language-js"><span class="hljs-comment">// ~/plugins/vant-ui.js</span>

<span class="hljs-keyword">import</span> <span class="hljs-title class_">Vue</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;vue&#x27;</span>
<span class="hljs-keyword">import</span> { xxx } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;vant&#x27;</span>

<span class="hljs-comment">// 只能全局注册组件，局部注册会丢失样式！！！</span>
<span class="hljs-title class_">Vue</span>.<span class="hljs-title function_">use</span>(xxx)
</code></pre>
</li>
<li><p>安装<code>vant、less、less-loader</code></p>
<pre><code class="hljs language-shell">yarn add vant -S
yarn add less less-loader -D
</code></pre>
</li>
<li><p>配置<code>nuxt.config.js</code></p>
<pre><code class="hljs language-js"><span class="hljs-comment">// nuxt.config.js</span>
{
    <span class="hljs-comment">// ...</span>
    <span class="hljs-attr">build</span>: {
        <span class="hljs-comment">// ...</span>
        <span class="hljs-attr">transpile</span>: [<span class="hljs-regexp">/vant.*?less/</span>],
        <span class="hljs-attr">babel</span>: {
          <span class="hljs-attr">plugins</span>: [
            [<span class="hljs-string">&#x27;import&#x27;</span>, {
              <span class="hljs-attr">libraryName</span>: <span class="hljs-string">&#x27;vant&#x27;</span>,
              <span class="hljs-attr">style</span>: <span class="hljs-function"><span class="hljs-params">name</span> =&gt;</span> <span class="hljs-string">`<span class="hljs-subst">${name}</span>/style/less`</span>
            }, <span class="hljs-string">&#x27;vant&#x27;</span>]
          ]
        },
        <span class="hljs-attr">loaders</span>: {
          <span class="hljs-comment">// 修改默认样式</span>
          <span class="hljs-attr">less</span>: {
            <span class="hljs-attr">javascriptEnabled</span>: <span class="hljs-literal">true</span>,
            <span class="hljs-attr">modifyVars</span>: {
              <span class="hljs-string">&#x27;button-primary-background-color&#x27;</span>: <span class="hljs-string">&#x27;#ff6008&#x27;</span>,
              <span class="hljs-string">&#x27;button-primary-border-color&#x27;</span>: <span class="hljs-string">&#x27;#ff6008&#x27;</span>,
              <span class="hljs-string">&#x27;nav-bar-text-color&#x27;</span>: <span class="hljs-string">&#x27;#ff6008&#x27;</span>,
              <span class="hljs-string">&#x27;nav-bar-icon-color&#x27;</span>: <span class="hljs-string">&#x27;#ff6008&#x27;</span>,
            }
          }
        }
    },
    <span class="hljs-comment">// ...</span>
}
</code></pre>
</li>
</ol>
<h2 id="如何配置axios拦截器">如何配置axios拦截器</h2>
<p><code>~/plugins/</code>下新建<code>axios.js</code></p>
<pre><code class="hljs language-js"><span class="hljs-comment">// ~/plugins/axios.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> (<span class="hljs-params">{ $axios }</span>) {
  $axios.<span class="hljs-property">interceptors</span>.<span class="hljs-property">request</span>.<span class="hljs-title function_">use</span>(<span class="hljs-function">(<span class="hljs-params">config</span>) =&gt;</span> {
    <span class="hljs-comment">// todo</span>
    <span class="hljs-keyword">return</span> config
  })
  $axios.<span class="hljs-property">interceptors</span>.<span class="hljs-property">response</span>.<span class="hljs-title function_">use</span>(
    <span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> response.<span class="hljs-property">data</span>,
    <span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(err)
    }
  )
}
</code></pre>
<h2 id="添加nodejs中间件（以日志中间件为例）">添加Node.js中间件（以日志中间件为例）</h2>
<ol>
<li><p>根目录下新建<code>serverMiddleware</code>文件夹</p>
</li>
<li><p>安装相关依赖<code>log4js</code>等</p>
</li>
<li><p>新建<code>logger.js</code></p>
<pre><code class="hljs language-js"><span class="hljs-keyword">const</span> { join } = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;path&#x27;</span>)
<span class="hljs-keyword">const</span> { configure, getLogger, connectLogger } = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;log4js&#x27;</span>)

<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">LOG_PATH</span> = <span class="hljs-string">&#x27;/opt/logs/gmm-node-h5ssrrelease/&#x27;</span>
<span class="hljs-title function_">configure</span>({
  <span class="hljs-attr">appenders</span>: {
    <span class="hljs-attr">ajaxError</span>: {
      <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;dateFile&#x27;</span>,
      <span class="hljs-attr">pattern</span>: <span class="hljs-string">&#x27;yyyy-MM-dd.log&#x27;</span>,
      <span class="hljs-attr">filename</span>: <span class="hljs-title function_">join</span>(<span class="hljs-variable constant_">LOG_PATH</span>, <span class="hljs-string">&#x27;ajaxError&#x27;</span>),
      <span class="hljs-attr">maxLogSize</span>: <span class="hljs-number">10</span> * <span class="hljs-number">1000</span> * <span class="hljs-number">1000</span>,
      <span class="hljs-attr">numBackups</span>: <span class="hljs-number">3</span>,
      <span class="hljs-attr">alwaysIncludePattern</span>: <span class="hljs-literal">true</span>
    },
    <span class="hljs-comment">// ...</span>
  },
  <span class="hljs-attr">categories</span>: {
    <span class="hljs-attr">default</span>: { <span class="hljs-attr">appenders</span>: [<span class="hljs-string">&#x27;console&#x27;</span>], <span class="hljs-attr">level</span>: <span class="hljs-string">&#x27;info&#x27;</span> },
    <span class="hljs-comment">// ...</span>
  }
})

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">connectLogger</span>(<span class="hljs-title function_">getLogger</span>(<span class="hljs-string">&#x27;application&#x27;</span>), { <span class="hljs-attr">level</span>: <span class="hljs-string">&#x27;info&#x27;</span> })
</code></pre>
</li>
<li><p>修改<code>nuxt.config.js</code>配置</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-comment">// ...</span>
  <span class="hljs-attr">serverMiddleware</span>: [
    <span class="hljs-string">&#x27;~/serverMiddleware/bodyParser&#x27;</span>,
    <span class="hljs-comment">// ...</span>
  ],
  <span class="hljs-comment">// ...</span>
}
</code></pre>
</li>
</ol>
<h1 id="注意点">注意点</h1>
<ol>
<li>服务端只渲染需要做SEO的部分来加快访问速度</li>
</ol>
<h1 id="性能优化">性能优化</h1>
<ol>
<li><p>如果网关已启用gzip则关闭框架自带压缩</p>
<pre><code class="hljs language-js"><span class="hljs-comment">// nuxt.config.js</span>
<span class="hljs-attr">render</span>: {
  <span class="hljs-attr">compressor</span>: <span class="hljs-literal">false</span>
}
</code></pre>
</li>
<li><p>缓存页面(<code>lru-cache</code>)</p>
<pre><code class="hljs language-js"><span class="hljs-comment">// serverMiddleware/pageCache.js</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">LRU</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;lru-cache&#x27;</span>)
<span class="hljs-keyword">const</span> cachePage = <span class="hljs-keyword">new</span> <span class="hljs-title function_">LRU</span>({
  <span class="hljs-attr">max</span>: <span class="hljs-number">100</span>,
  <span class="hljs-attr">maxAge</span>: <span class="hljs-number">1000</span> * <span class="hljs-number">60</span>
})
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> (<span class="hljs-params">req, res, next</span>) {
  <span class="hljs-keyword">const</span> url = req.<span class="hljs-property">_parsedOriginalUrl</span>
  <span class="hljs-keyword">const</span> pathname = url.<span class="hljs-property">pathname</span>
  <span class="hljs-keyword">if</span> ([<span class="hljs-string">&#x27;/selectGame/1&#x27;</span>].<span class="hljs-title function_">includes</span>(pathname)) {
    <span class="hljs-keyword">const</span> existsHtml = cachePage.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;selectGameData&#x27;</span>)
    <span class="hljs-keyword">if</span> (existsHtml) {
      <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">end</span>(existsHtml.<span class="hljs-property">html</span>, <span class="hljs-string">&#x27;utf-8&#x27;</span>)
    } <span class="hljs-keyword">else</span> {
      res.<span class="hljs-property">original_end</span> = res.<span class="hljs-property">end</span>
      res.<span class="hljs-property">end</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">data</span>) {
        <span class="hljs-keyword">if</span> (res.<span class="hljs-property">statusCode</span> === <span class="hljs-number">200</span>) {
          cachePage.<span class="hljs-title function_">set</span>(<span class="hljs-string">&#x27;selectGameData&#x27;</span>, { <span class="hljs-attr">html</span>: data })
        }
        res.<span class="hljs-title function_">original_end</span>(data, <span class="hljs-string">&#x27;utf-8&#x27;</span>)
      }
    }
  }
  <span class="hljs-title function_">next</span>()
}
</code></pre>
</li>
</ol>
<h1 id="坑">坑</h1>
<h2 id="同一域名如何部署多个nuxtjs服务">同一域名如何部署多个Nuxt.js服务</h2>
<p>在<code>https://gmmsj.com/h5ssr</code>下部署Nuxt.js项目步骤：</p>
<ol>
<li><p>复制<code>nuxt_dist/serverMiddleware/static/nuxt.config.js/package.json</code>目录/文件至部署机</p>
</li>
<li><p>nuxt.config.js添加router配置</p>
<pre><code class="hljs language-js"><span class="hljs-comment">// nuxt.config.js</span>
{
  <span class="hljs-comment">// ...</span>
  <span class="hljs-attr">router</span>: {
    <span class="hljs-attr">base</span>: <span class="hljs-string">&#x27;/h5ssr/&#x27;</span>
  }
  <span class="hljs-comment">// ...</span>
}
</code></pre>
</li>
<li><p>Nginx添加配置</p>
<pre><code class="hljs language-shell"><span class="hljs-meta"># </span><span class="language-bash">nginx.conf</span>
location /h5ssr {
  proxy_pass http://127.0.0.1:8005/h5ssr ;
  proxy_set_header Host $host;
  proxy_set_header X-Forwarded-For $remote_addr;  
}
</code></pre>
</li>
</ol>
</div></div></div></article></div></main><footer class="flex flex-col items-center justify-center leading-8 text-sm w-full py-2 border-t text-skin-muted"><p>Designed &amp; developed by<a class="ml-1 text-yellow" target="_blank" href="https://github.com/mrrs878" rel="noreferrer">Mr.RS</a></p><p>©<!-- --> <!-- -->2022</p></footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"title":"服务端渲染-Nuxt.js","tags":["SSR"],"categories":"服务端渲染","description":"\u003e Nuxt.js@2.13.6\n\n# 安装\n\n推荐使用官方脚手架\n\n`yarn create nuxt-app \u003cproject name\u003e`\n\n# 使用\n\n## 如何引入三方UI库/框架\n\n[vant](https://youzan.github.io/vant/#/zh-CN/) 为例\n\n1. `~/plugins/`下新建`vant-ui.js`\n\n    ```js\n    // ~","createDate":"2020-07-28 11:15:28","updateDate":"2020-10-16 15:18:28","body":"\u003cblockquote\u003e\n\u003cp\u003e\u003ca href=\"mailto:\u0026#78;\u0026#x75;\u0026#x78;\u0026#x74;\u0026#x2e;\u0026#106;\u0026#x73;\u0026#x40;\u0026#50;\u0026#x2e;\u0026#49;\u0026#51;\u0026#x2e;\u0026#x36;\"\u003e\u0026#78;\u0026#x75;\u0026#x78;\u0026#x74;\u0026#x2e;\u0026#106;\u0026#x73;\u0026#x40;\u0026#50;\u0026#x2e;\u0026#49;\u0026#51;\u0026#x2e;\u0026#x36;\u003c/a\u003e\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003ch1 id=\"安装\"\u003e安装\u003c/h1\u003e\n\u003cp\u003e推荐使用官方脚手架\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003eyarn create nuxt-app \u0026lt;project name\u0026gt;\u003c/code\u003e\u003c/p\u003e\n\u003ch1 id=\"使用\"\u003e使用\u003c/h1\u003e\n\u003ch2 id=\"如何引入三方ui库框架\"\u003e如何引入三方UI库/框架\u003c/h2\u003e\n\u003cp\u003e\u003ca href=\"https://youzan.github.io/vant/#/zh-CN/\"\u003evant\u003c/a\u003e 为例\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\u003cp\u003e\u003ccode\u003e~/plugins/\u003c/code\u003e下新建\u003ccode\u003evant-ui.js\u003c/code\u003e\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003e\u003cspan class=\"hljs-comment\"\u003e// ~/plugins/vant-ui.js\u003c/span\u003e\n\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eVue\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026#x27;vue\u0026#x27;\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e { xxx } \u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026#x27;vant\u0026#x27;\u003c/span\u003e\n\n\u003cspan class=\"hljs-comment\"\u003e// 只能全局注册组件，局部注册会丢失样式！！！\u003c/span\u003e\n\u003cspan class=\"hljs-title class_\"\u003eVue\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003euse\u003c/span\u003e(xxx)\n\u003c/code\u003e\u003c/pre\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003cp\u003e安装\u003ccode\u003evant、less、less-loader\u003c/code\u003e\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-shell\"\u003eyarn add vant -S\nyarn add less less-loader -D\n\u003c/code\u003e\u003c/pre\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003cp\u003e配置\u003ccode\u003enuxt.config.js\u003c/code\u003e\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003e\u003cspan class=\"hljs-comment\"\u003e// nuxt.config.js\u003c/span\u003e\n{\n    \u003cspan class=\"hljs-comment\"\u003e// ...\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003ebuild\u003c/span\u003e: {\n        \u003cspan class=\"hljs-comment\"\u003e// ...\u003c/span\u003e\n        \u003cspan class=\"hljs-attr\"\u003etranspile\u003c/span\u003e: [\u003cspan class=\"hljs-regexp\"\u003e/vant.*?less/\u003c/span\u003e],\n        \u003cspan class=\"hljs-attr\"\u003ebabel\u003c/span\u003e: {\n          \u003cspan class=\"hljs-attr\"\u003eplugins\u003c/span\u003e: [\n            [\u003cspan class=\"hljs-string\"\u003e\u0026#x27;import\u0026#x27;\u003c/span\u003e, {\n              \u003cspan class=\"hljs-attr\"\u003elibraryName\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\u0026#x27;vant\u0026#x27;\u003c/span\u003e,\n              \u003cspan class=\"hljs-attr\"\u003estyle\u003c/span\u003e: \u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-params\"\u003ename\u003c/span\u003e =\u0026gt;\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e`\u003cspan class=\"hljs-subst\"\u003e${name}\u003c/span\u003e/style/less`\u003c/span\u003e\n            }, \u003cspan class=\"hljs-string\"\u003e\u0026#x27;vant\u0026#x27;\u003c/span\u003e]\n          ]\n        },\n        \u003cspan class=\"hljs-attr\"\u003eloaders\u003c/span\u003e: {\n          \u003cspan class=\"hljs-comment\"\u003e// 修改默认样式\u003c/span\u003e\n          \u003cspan class=\"hljs-attr\"\u003eless\u003c/span\u003e: {\n            \u003cspan class=\"hljs-attr\"\u003ejavascriptEnabled\u003c/span\u003e: \u003cspan class=\"hljs-literal\"\u003etrue\u003c/span\u003e,\n            \u003cspan class=\"hljs-attr\"\u003emodifyVars\u003c/span\u003e: {\n              \u003cspan class=\"hljs-string\"\u003e\u0026#x27;button-primary-background-color\u0026#x27;\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\u0026#x27;#ff6008\u0026#x27;\u003c/span\u003e,\n              \u003cspan class=\"hljs-string\"\u003e\u0026#x27;button-primary-border-color\u0026#x27;\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\u0026#x27;#ff6008\u0026#x27;\u003c/span\u003e,\n              \u003cspan class=\"hljs-string\"\u003e\u0026#x27;nav-bar-text-color\u0026#x27;\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\u0026#x27;#ff6008\u0026#x27;\u003c/span\u003e,\n              \u003cspan class=\"hljs-string\"\u003e\u0026#x27;nav-bar-icon-color\u0026#x27;\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\u0026#x27;#ff6008\u0026#x27;\u003c/span\u003e,\n            }\n          }\n        }\n    },\n    \u003cspan class=\"hljs-comment\"\u003e// ...\u003c/span\u003e\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch2 id=\"如何配置axios拦截器\"\u003e如何配置axios拦截器\u003c/h2\u003e\n\u003cp\u003e\u003ccode\u003e~/plugins/\u003c/code\u003e下新建\u003ccode\u003eaxios.js\u003c/code\u003e\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003e\u003cspan class=\"hljs-comment\"\u003e// ~/plugins/axios.js\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003edefault\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e (\u003cspan class=\"hljs-params\"\u003e{ $axios }\u003c/span\u003e) {\n  $axios.\u003cspan class=\"hljs-property\"\u003einterceptors\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003erequest\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003euse\u003c/span\u003e(\u003cspan class=\"hljs-function\"\u003e(\u003cspan class=\"hljs-params\"\u003econfig\u003c/span\u003e) =\u0026gt;\u003c/span\u003e {\n    \u003cspan class=\"hljs-comment\"\u003e// todo\u003c/span\u003e\n    \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e config\n  })\n  $axios.\u003cspan class=\"hljs-property\"\u003einterceptors\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eresponse\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003euse\u003c/span\u003e(\n    \u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-params\"\u003eresponse\u003c/span\u003e =\u0026gt;\u003c/span\u003e response.\u003cspan class=\"hljs-property\"\u003edata\u003c/span\u003e,\n    \u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-params\"\u003eerr\u003c/span\u003e =\u0026gt;\u003c/span\u003e {\n      \u003cspan class=\"hljs-variable language_\"\u003econsole\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003elog\u003c/span\u003e(err)\n    }\n  )\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch2 id=\"添加nodejs中间件（以日志中间件为例）\"\u003e添加Node.js中间件（以日志中间件为例）\u003c/h2\u003e\n\u003col\u003e\n\u003cli\u003e\u003cp\u003e根目录下新建\u003ccode\u003eserverMiddleware\u003c/code\u003e文件夹\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003cp\u003e安装相关依赖\u003ccode\u003elog4js\u003c/code\u003e等\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003cp\u003e新建\u003ccode\u003elogger.js\u003c/code\u003e\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003e\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e { join } = \u003cspan class=\"hljs-built_in\"\u003erequire\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026#x27;path\u0026#x27;\u003c/span\u003e)\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e { configure, getLogger, connectLogger } = \u003cspan class=\"hljs-built_in\"\u003erequire\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026#x27;log4js\u0026#x27;\u003c/span\u003e)\n\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-variable constant_\"\u003eLOG_PATH\u003c/span\u003e = \u003cspan class=\"hljs-string\"\u003e\u0026#x27;/opt/logs/gmm-node-h5ssrrelease/\u0026#x27;\u003c/span\u003e\n\u003cspan class=\"hljs-title function_\"\u003econfigure\u003c/span\u003e({\n  \u003cspan class=\"hljs-attr\"\u003eappenders\u003c/span\u003e: {\n    \u003cspan class=\"hljs-attr\"\u003eajaxError\u003c/span\u003e: {\n      \u003cspan class=\"hljs-attr\"\u003etype\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\u0026#x27;dateFile\u0026#x27;\u003c/span\u003e,\n      \u003cspan class=\"hljs-attr\"\u003epattern\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\u0026#x27;yyyy-MM-dd.log\u0026#x27;\u003c/span\u003e,\n      \u003cspan class=\"hljs-attr\"\u003efilename\u003c/span\u003e: \u003cspan class=\"hljs-title function_\"\u003ejoin\u003c/span\u003e(\u003cspan class=\"hljs-variable constant_\"\u003eLOG_PATH\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e\u0026#x27;ajaxError\u0026#x27;\u003c/span\u003e),\n      \u003cspan class=\"hljs-attr\"\u003emaxLogSize\u003c/span\u003e: \u003cspan class=\"hljs-number\"\u003e10\u003c/span\u003e * \u003cspan class=\"hljs-number\"\u003e1000\u003c/span\u003e * \u003cspan class=\"hljs-number\"\u003e1000\u003c/span\u003e,\n      \u003cspan class=\"hljs-attr\"\u003enumBackups\u003c/span\u003e: \u003cspan class=\"hljs-number\"\u003e3\u003c/span\u003e,\n      \u003cspan class=\"hljs-attr\"\u003ealwaysIncludePattern\u003c/span\u003e: \u003cspan class=\"hljs-literal\"\u003etrue\u003c/span\u003e\n    },\n    \u003cspan class=\"hljs-comment\"\u003e// ...\u003c/span\u003e\n  },\n  \u003cspan class=\"hljs-attr\"\u003ecategories\u003c/span\u003e: {\n    \u003cspan class=\"hljs-attr\"\u003edefault\u003c/span\u003e: { \u003cspan class=\"hljs-attr\"\u003eappenders\u003c/span\u003e: [\u003cspan class=\"hljs-string\"\u003e\u0026#x27;console\u0026#x27;\u003c/span\u003e], \u003cspan class=\"hljs-attr\"\u003elevel\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\u0026#x27;info\u0026#x27;\u003c/span\u003e },\n    \u003cspan class=\"hljs-comment\"\u003e// ...\u003c/span\u003e\n  }\n})\n\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003edefault\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003econnectLogger\u003c/span\u003e(\u003cspan class=\"hljs-title function_\"\u003egetLogger\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026#x27;application\u0026#x27;\u003c/span\u003e), { \u003cspan class=\"hljs-attr\"\u003elevel\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\u0026#x27;info\u0026#x27;\u003c/span\u003e })\n\u003c/code\u003e\u003c/pre\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003cp\u003e修改\u003ccode\u003enuxt.config.js\u003c/code\u003e配置\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003e\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003edefault\u003c/span\u003e {\n  \u003cspan class=\"hljs-comment\"\u003e// ...\u003c/span\u003e\n  \u003cspan class=\"hljs-attr\"\u003eserverMiddleware\u003c/span\u003e: [\n    \u003cspan class=\"hljs-string\"\u003e\u0026#x27;~/serverMiddleware/bodyParser\u0026#x27;\u003c/span\u003e,\n    \u003cspan class=\"hljs-comment\"\u003e// ...\u003c/span\u003e\n  ],\n  \u003cspan class=\"hljs-comment\"\u003e// ...\u003c/span\u003e\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch1 id=\"注意点\"\u003e注意点\u003c/h1\u003e\n\u003col\u003e\n\u003cli\u003e服务端只渲染需要做SEO的部分来加快访问速度\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch1 id=\"性能优化\"\u003e性能优化\u003c/h1\u003e\n\u003col\u003e\n\u003cli\u003e\u003cp\u003e如果网关已启用gzip则关闭框架自带压缩\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003e\u003cspan class=\"hljs-comment\"\u003e// nuxt.config.js\u003c/span\u003e\n\u003cspan class=\"hljs-attr\"\u003erender\u003c/span\u003e: {\n  \u003cspan class=\"hljs-attr\"\u003ecompressor\u003c/span\u003e: \u003cspan class=\"hljs-literal\"\u003efalse\u003c/span\u003e\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003cp\u003e缓存页面(\u003ccode\u003elru-cache\u003c/code\u003e)\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003e\u003cspan class=\"hljs-comment\"\u003e// serverMiddleware/pageCache.js\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-variable constant_\"\u003eLRU\u003c/span\u003e = \u003cspan class=\"hljs-built_in\"\u003erequire\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026#x27;lru-cache\u0026#x27;\u003c/span\u003e)\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e cachePage = \u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003eLRU\u003c/span\u003e({\n  \u003cspan class=\"hljs-attr\"\u003emax\u003c/span\u003e: \u003cspan class=\"hljs-number\"\u003e100\u003c/span\u003e,\n  \u003cspan class=\"hljs-attr\"\u003emaxAge\u003c/span\u003e: \u003cspan class=\"hljs-number\"\u003e1000\u003c/span\u003e * \u003cspan class=\"hljs-number\"\u003e60\u003c/span\u003e\n})\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003edefault\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e (\u003cspan class=\"hljs-params\"\u003ereq, res, next\u003c/span\u003e) {\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e url = req.\u003cspan class=\"hljs-property\"\u003e_parsedOriginalUrl\u003c/span\u003e\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e pathname = url.\u003cspan class=\"hljs-property\"\u003epathname\u003c/span\u003e\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e ([\u003cspan class=\"hljs-string\"\u003e\u0026#x27;/selectGame/1\u0026#x27;\u003c/span\u003e].\u003cspan class=\"hljs-title function_\"\u003eincludes\u003c/span\u003e(pathname)) {\n    \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e existsHtml = cachePage.\u003cspan class=\"hljs-title function_\"\u003eget\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026#x27;selectGameData\u0026#x27;\u003c/span\u003e)\n    \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (existsHtml) {\n      \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e res.\u003cspan class=\"hljs-title function_\"\u003eend\u003c/span\u003e(existsHtml.\u003cspan class=\"hljs-property\"\u003ehtml\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e\u0026#x27;utf-8\u0026#x27;\u003c/span\u003e)\n    } \u003cspan class=\"hljs-keyword\"\u003eelse\u003c/span\u003e {\n      res.\u003cspan class=\"hljs-property\"\u003eoriginal_end\u003c/span\u003e = res.\u003cspan class=\"hljs-property\"\u003eend\u003c/span\u003e\n      res.\u003cspan class=\"hljs-property\"\u003eend\u003c/span\u003e = \u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e (\u003cspan class=\"hljs-params\"\u003edata\u003c/span\u003e) {\n        \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (res.\u003cspan class=\"hljs-property\"\u003estatusCode\u003c/span\u003e === \u003cspan class=\"hljs-number\"\u003e200\u003c/span\u003e) {\n          cachePage.\u003cspan class=\"hljs-title function_\"\u003eset\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026#x27;selectGameData\u0026#x27;\u003c/span\u003e, { \u003cspan class=\"hljs-attr\"\u003ehtml\u003c/span\u003e: data })\n        }\n        res.\u003cspan class=\"hljs-title function_\"\u003eoriginal_end\u003c/span\u003e(data, \u003cspan class=\"hljs-string\"\u003e\u0026#x27;utf-8\u0026#x27;\u003c/span\u003e)\n      }\n    }\n  }\n  \u003cspan class=\"hljs-title function_\"\u003enext\u003c/span\u003e()\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch1 id=\"坑\"\u003e坑\u003c/h1\u003e\n\u003ch2 id=\"同一域名如何部署多个nuxtjs服务\"\u003e同一域名如何部署多个Nuxt.js服务\u003c/h2\u003e\n\u003cp\u003e在\u003ccode\u003ehttps://gmmsj.com/h5ssr\u003c/code\u003e下部署Nuxt.js项目步骤：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\u003cp\u003e复制\u003ccode\u003enuxt_dist/serverMiddleware/static/nuxt.config.js/package.json\u003c/code\u003e目录/文件至部署机\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003cp\u003enuxt.config.js添加router配置\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003e\u003cspan class=\"hljs-comment\"\u003e// nuxt.config.js\u003c/span\u003e\n{\n  \u003cspan class=\"hljs-comment\"\u003e// ...\u003c/span\u003e\n  \u003cspan class=\"hljs-attr\"\u003erouter\u003c/span\u003e: {\n    \u003cspan class=\"hljs-attr\"\u003ebase\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\u0026#x27;/h5ssr/\u0026#x27;\u003c/span\u003e\n  }\n  \u003cspan class=\"hljs-comment\"\u003e// ...\u003c/span\u003e\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003cp\u003eNginx添加配置\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-shell\"\u003e\u003cspan class=\"hljs-meta\"\u003e# \u003c/span\u003e\u003cspan class=\"language-bash\"\u003enginx.conf\u003c/span\u003e\nlocation /h5ssr {\n  proxy_pass http://127.0.0.1:8005/h5ssr ;\n  proxy_set_header Host $host;\n  proxy_set_header X-Forwarded-For $remote_addr;  \n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003c/li\u003e\n\u003c/ol\u003e\n"}},"__N_SSG":true},"page":"/post/[title]","query":{"title":"服务端渲染-Nuxt.js"},"buildId":"tZvMitr2gJlzbBX_OxPbz","assetPrefix":"/next-blog","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>
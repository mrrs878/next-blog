<!DOCTYPE html><html><head><link rel="icon" href="https://mrrsblog.oss-cn-shanghai.aliyuncs.com/avatar.jpg"/><script async="" src="/js/L2Dwidget.min.js"></script><script async="" src="/js/initL2D.js"></script><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><title>Mr.RSçš„ä¸ªäººåšå®¢-(ç¿»è¯‘)åˆ›å»ºä½ è‡ªå·±çš„React</title><meta name="next-head-count" content="3"/><link rel="preload" href="/_next/static/css/cd72816920092dcb.css" as="style"/><link rel="stylesheet" href="/_next/static/css/cd72816920092dcb.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-b927671265afed5e.js" defer=""></script><script src="/_next/static/chunks/framework-91d7f78b5b4003c8.js" defer=""></script><script src="/_next/static/chunks/main-1e7421553b9673ee.js" defer=""></script><script src="/_next/static/chunks/pages/_app-ca6aae25bc99a05f.js" defer=""></script><script src="/_next/static/chunks/899-1cd3a59abdb8ea18.js" defer=""></script><script src="/_next/static/chunks/pages/post/%5Btitle%5D-216eae5ddb3b6d26.js" defer=""></script><script src="/_next/static/_q5ru5NemgZT2swXpl15Q/_buildManifest.js" defer=""></script><script src="/_next/static/_q5ru5NemgZT2swXpl15Q/_ssgManifest.js" defer=""></script><script src="/_next/static/_q5ru5NemgZT2swXpl15Q/_middlewareManifest.js" defer=""></script></head><body><div id="__next" data-reactroot=""><header class="fixed top-0 py-4 left-0 right-0 h-auto px-10 shadow bg-white z-50"><nav><ul class="flex w-auto"><li class="mr-4 hover:text-yellow"><a href="/">é¦–é¡µ</a></li><li class="mx-4 hover:text-yellow"><a href="/categories">åˆ†ç±»</a></li><li class="mx-4 hover:text-yellow"><a href="/tags">æ ‡ç­¾</a></li><li class="ml-4 hover:text-yellow"><a href="/timeline">å½’æ¡£</a></li></ul></nav></header><main class="mt-20 mb-4 mx-auto justify-center w-2/3"><div class="mx-auto lg:max-w-5xl md:max-w-3xl"><article class="flex flex-col justify-around pb-16 px-4 mx-auto space-y-10 text-base"><div class="flex flex-col space-y-4"><h1 class="inline pt-10 text-4xl text-skin-primary">(ç¿»è¯‘)åˆ›å»ºä½ è‡ªå·±çš„React</h1><div class="text-sm space-x-2 text-skin-muted grid grid-cols-5"><span class="flex align-middle"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 inline-block mr-1"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>2020-11-02 14:25:18</span><span class="flex align-middle"><svg class="w-5 h-5 inline-block mr-1" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1903" width="20" height="20"><path d="M257.7 752c2 0 4-0.2 6-0.5L431.9 722c2-0.4 3.9-1.3 5.3-2.8l423.9-423.9c3.9-3.9 3.9-10.2 0-14.1L694.9 114.9c-1.9-1.9-4.4-2.9-7.1-2.9s-5.2 1-7.1 2.9L256.8 538.8c-1.5 1.5-2.4 3.3-2.8 5.3l-29.5 168.2c-1.9 11.1 1.5 21.9 9.4 29.8 6.6 6.4 14.9 9.9 23.8 9.9z m67.4-174.4L687.8 215l73.3 73.3-362.7 362.6-88.9 15.7 15.6-89zM880 836H144c-17.7 0-32 14.3-32 32v36c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-36c0-17.7-14.3-32-32-32z" p-id="1904"></path></svg>2020-11-11 15:00:53</span><span class="flex align-middle"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 inline-block mr-1"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>44</span></div></div><div class="mt-8 flex"><div class="w-full flex-auto custom-markdown-body"><div class="markdown-body" id="write"><blockquote>
<p>åŸæ–‡é“¾æ¥:<a href="https://pomb.us/build-your-own-react/">https://pomb.us/build-your-own-react/</a></p>
</blockquote>

      <h1>
        <span class="prefix"></span>
        <span class="content">Build your own React</span>
        <span class="suffix"></span>
      </h1>
    <p>æˆ‘ä»¬å°†ä»å¤´å¼€å§‹é‡å†™Reactã€‚ ä¸€æ­¥æ­¥ã€‚ éµå¾ªçœŸå®çš„Reactä»£ç ä¸­çš„æ¶æ„ï¼Œä½†æ²¡æœ‰æ‰€æœ‰çš„ä¼˜åŒ–å’Œéå¿…è¦çš„åŠŸèƒ½ã€‚</p>
<p>å¦‚æœæ‚¨é˜…è¯»è¿‡<a href="https://engineering.hexacta.com/didact-learning-how-react-works-by-building-it-from-scratch-51007984e5c5">æˆ‘ä»¥å‰çš„ä»»ä½•â€œæ„å»ºè‡ªå·±çš„Reactâ€æ–‡ç« </a>ï¼Œä¸åŒä¹‹å¤„åœ¨äºè¯¥æ–‡ç« åŸºäºReact 16.8ï¼Œå› æ­¤æˆ‘ä»¬ç°åœ¨å¯ä»¥ä½¿ç”¨<code>hook</code>å¹¶åˆ é™¤æ‰€æœ‰ä¸<code>class</code>ç›¸å…³çš„ä»£ç ã€‚</p>
<p>æ‚¨å¯ä»¥åœ¨æ—§åšå®¢æ–‡ç« ä¸­æ‰¾åˆ°å†å²è®°å½•ï¼Œå¹¶åœ¨<a href="https://github.com/pomber/didact">Didactä»“åº“</a>ä¸­æ‰¾åˆ°ä»£ç ã€‚ è¿˜æœ‰ä¸€ä¸ªæ¼”è®²æ¶‰åŠç›¸åŒçš„å†…å®¹ã€‚</p>
<p>ä»¥ä¸‹è¿™äº›éƒ½æ˜¯æˆ‘ä»¬å°†ä¸€ä¸€æ·»åŠ åˆ°æˆ‘ä»¬çš„Reactç‰ˆæœ¬ä¸­çš„å†…å®¹ï¼š</p>
<ul>
<li>ç¬¬ä¸€æ­¥: <code>createElement</code> å‡½æ•°</li>
<li>ç¬¬äºŒæ­¥: <code>render</code> å‡½æ•°</li>
<li>ç¬¬ä¸‰æ­¥: Concurrent Mode</li>
<li>ç¬¬å››æ­¥: Fibers</li>
<li>ç¬¬äº”æ­¥: Render and Commit Phases</li>
<li>ç¬¬å…­æ­¥: Reconciliation</li>
<li>ç¬¬ä¸ƒæ­¥: å‡½æ•°å¼ç»„ä»¶</li>
<li>ç¬¬å…«æ­¥: Hooks</li>
</ul>

      <h2>
        <span class="prefix"></span>
        <span class="content">ç¬¬é›¶æ­¥</span>
        <span class="suffix"></span>
      </h2>
    <p>å¦‚æœæ‚¨å·²ç»å¯¹Reactï¼ŒJSXå’ŒDOMèŠ‚ç‚¹çš„å·¥ä½œæ–¹å¼æœ‰äº†å¾ˆå¥½çš„äº†è§£ï¼Œåˆ™å¯ä»¥è·³è¿‡æ­¤æ­¥éª¤ã€‚é¦–å…ˆè®©æˆ‘ä»¬å›é¡¾ä¸€äº›åŸºæœ¬æ¦‚å¿µï¼Œæˆ‘ä»¬å°†ä½¿ç”¨åªæœ‰ä¸‰è¡Œä»£ç çš„Reactåº”ç”¨ç¨‹åºï¼šç¬¬ä¸€ä¸ªå®šä¹‰ä¸€ä¸ªReactèŠ‚ç‚¹ï¼Œä¸‹ä¸€ä¸ªä»DOMè·å–ä¸€ä¸ªèŠ‚ç‚¹ï¼Œæœ€åä¸€ä¸ªå°†ReactèŠ‚ç‚¹æ¸²æŸ“åˆ°å®¹å™¨ä¸­ã€‚ç„¶åï¼Œæˆ‘ä»¬ä¼šåˆ é™¤æ‰€æœ‰ç‰¹å®šäºReactçš„ä»£ç å°†å…¶æ›¿æ¢ä¸ºåŸå§‹JavaScriptã€‚</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">const</span> element = <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">h1</span> <span class="hljs-attr">title</span>=<span class="hljs-string">&quot;foo&quot;</span>&gt;</span>Hello<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span>
<span class="hljs-keyword">const</span> container = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&quot;root&quot;</span>)
<span class="hljs-title class_">ReactDOM</span>.<span class="hljs-title function_">render</span>(element, container)
</code></pre>
<p>åœ¨ç¬¬ä¸€è¡Œä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨JSXå®šä¹‰äº†èŠ‚ç‚¹ã€‚ å®ƒä¸æ˜¯æœ‰æ•ˆçš„JavaScriptï¼Œå› æ­¤è¦ç”¨åŸç”ŸJSå–ä»£å®ƒã€‚é€šè¿‡Babelç­‰æ„å»ºå·¥å…·ï¼ŒJSXè½¬æ¢ä¸ºJSã€‚ è½¬æ¢é€šå¸¸å¾ˆç®€å•ï¼šä½¿ç”¨å¯¹<code>createElement</code>çš„è°ƒç”¨æ¥æ›¿æ¢æ ‡ç­¾å†…çš„ä»£ç ï¼Œå¹¶å°†æ ‡ç­¾<code>type</code>ã€<code>props</code>ã€<code>children</code>ä½œä¸ºå‚æ•°ä¼ é€’ã€‚<code>React.createElement</code>æ ¹æ®å…¶å‚æ•°åˆ›å»ºä¸€ä¸ªå¯¹è±¡ï¼Œé™¤äº†ä¸€äº›éªŒè¯ä¹‹å¤–ï¼Œè¿™å°±æ˜¯å…¨éƒ¨ã€‚ å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥å®‰å…¨åœ°å°†å‡½æ•°è°ƒç”¨æ›¿æ¢ä¸ºå…¶è¾“å‡ºã€‚</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">const</span> element = <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">h1</span> <span class="hljs-attr">title</span>=<span class="hljs-string">&quot;foo&quot;</span>&gt;</span>Hello<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span>

ğŸ‘‡

<span class="hljs-keyword">const</span> element = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">createElement</span>(
  <span class="hljs-string">&quot;h1&quot;</span>,
  { <span class="hljs-attr">title</span>: <span class="hljs-string">&quot;foo&quot;</span> },
  <span class="hljs-string">&quot;Hello&quot;</span>
)
</code></pre>
<p>è¿™å°±æ˜¯ä¸€ä¸ªèŠ‚ç‚¹ï¼Œä¸€ä¸ªå…·æœ‰ä¸¤ä¸ªå±æ€§çš„å¯¹è±¡ï¼š<code>type</code>å’Œ<code>props</code>ï¼ˆå—¯ï¼Œ<a href="https://github.com/facebook/react/blob/f4cc45ce962adc9f307690e1d5cfa28a288418eb/packages/react/src/ReactElement.js#L111">å®ƒæœ‰æ›´å¤šçš„å±æ€§</a>ï¼Œä½†æ˜¯æˆ‘ä»¬åªå…³å¿ƒè¿™ä¸¤ä¸ªå±æ€§ï¼‰ã€‚<code>type</code>æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œç”¨äºæŒ‡å®šæˆ‘ä»¬è¦åˆ›å»ºçš„DOMèŠ‚ç‚¹çš„ç±»å‹ï¼Œå®ƒæ˜¯æ‚¨è¦åˆ›å»ºHTMLèŠ‚ç‚¹æ—¶ä¼ é€’ç»™<code>document.createElement</code>çš„<code>tagName</code>ã€‚ å®ƒä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œä½†æˆ‘ä»¬å°†å…¶ç•™ç»™æ­¥éª¤VIIã€‚<code>props</code>æ˜¯å¦ä¸€ä¸ªå¯¹è±¡ï¼Œå®ƒå…·æœ‰JSXå±æ€§ä¸­çš„æ‰€æœ‰é”®å’Œå€¼ã€‚ å®ƒè¿˜æœ‰ä¸€ä¸ªç‰¹æ®Šçš„å±æ€§ï¼š<code>children</code>ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œ<code>children</code>æ˜¯å­—ç¬¦ä¸²ï¼Œä½†é€šå¸¸æ˜¯åŒ…å«æ›´å¤šèŠ‚ç‚¹çš„æ•°ç»„ï¼ˆè¿™å°±æ˜¯ä¸ºä»€ä¹ˆèŠ‚ç‚¹ä¹Ÿæ˜¯æ ‘çš„åŸå› ï¼‰ã€‚</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">const</span> element = {
  <span class="hljs-attr">type</span>: <span class="hljs-string">&quot;h1&quot;</span>,
  <span class="hljs-attr">props</span>: {
    <span class="hljs-attr">title</span>: <span class="hljs-string">&quot;foo&quot;</span>,
    <span class="hljs-attr">children</span>: <span class="hljs-string">&quot;Hello&quot;</span>,
  },
}
</code></pre>
<p>æˆ‘ä»¬éœ€è¦æ›¿æ¢çš„å¦ä¸€éƒ¨åˆ†Reactä»£ç æ˜¯å¯¹<code>ReactDOM.render</code>çš„è°ƒç”¨ã€‚<code>render</code>æ˜¯Reactæ›´æ–°DOMçš„åœ°æ–¹ï¼Œç°åœ¨ç”¨æˆ‘ä»¬è‡ªå·±çš„ä»£ç è¿›è¡Œæ“ä½œã€‚</p>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬ä½¿ç”¨èŠ‚ç‚¹<code>type</code>ï¼ˆåœ¨æœ¬ä¾‹ä¸­ä¸º<code>h1</code>ï¼‰åˆ›å»ºä¸€ä¸ª<code>node*</code>ã€‚ç„¶åï¼Œæˆ‘ä»¬å°†æ‰€æœ‰èŠ‚ç‚¹å±æ€§åˆ†é…ç»™è¯¥èŠ‚ç‚¹ã€‚ è¿™é‡Œåªæœ‰ä¸€ä¸ª<code>title</code>ã€‚*ä¸ºé¿å…æ··æ·†ï¼Œæˆ‘å°†ä½¿ç”¨<code>element</code>æ¥æŒ‡ä»£ReactèŠ‚ç‚¹ï¼Œå¹¶ä½¿ç”¨<code>node</code>æ¥æŒ‡ä»£DOMèŠ‚ç‚¹ã€‚</p>
<p>ç„¶åï¼Œæˆ‘ä»¬ä¸º<code>children</code>åˆ›å»ºèŠ‚ç‚¹ã€‚ æˆ‘ä»¬åªæœ‰ä¸€ä¸ªå­—ç¬¦ä¸²ä½œä¸º<code>children</code>ï¼Œå› æ­¤æˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªæ–‡æœ¬èŠ‚ç‚¹ã€‚ä½¿ç”¨<code>textNode</code>è€Œä¸æ˜¯è®¾ç½®<code>innerText</code>å°†å…è®¸æˆ‘ä»¬ä»¥åä»¥ç›¸åŒçš„æ–¹å¼å¯¹å¾…æ‰€æœ‰èŠ‚ç‚¹ã€‚å¦è¯·æ³¨æ„ï¼Œæˆ‘ä»¬åƒè®¾ç½®<code>h1</code>æ ‡é¢˜ä¸€æ ·è®¾ç½®<code>nodeValue</code>ï¼Œå°±åƒå­—ç¬¦ä¸²ä¸­å¸¦æœ‰<code>props: {nodeValue: &quot;hello&quot;}</code>ã€‚æœ€åï¼Œæˆ‘ä»¬å°†<code>textNode</code>æ·»åŠ åˆ°<code>h1</code>å¹¶å°†<code>h1</code>æ·»åŠ åˆ°<code>container</code>ã€‚</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">const</span> element = {
  <span class="hljs-attr">type</span>: <span class="hljs-string">&quot;h1&quot;</span>,
  <span class="hljs-attr">props</span>: {
    <span class="hljs-attr">title</span>: <span class="hljs-string">&quot;foo&quot;</span>,
    <span class="hljs-attr">children</span>: <span class="hljs-string">&quot;Hello&quot;</span>,
  },
}

<span class="hljs-keyword">const</span> container = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&quot;root&quot;</span>)

<span class="hljs-keyword">const</span> node = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(element.<span class="hljs-property">type</span>)
node[<span class="hljs-string">&quot;title&quot;</span>] = element.<span class="hljs-property">props</span>.<span class="hljs-property">title</span>

<span class="hljs-keyword">const</span> text = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createTextNode</span>(<span class="hljs-string">&quot;&quot;</span>)
text[<span class="hljs-string">&quot;nodeValue&quot;</span>] = element.<span class="hljs-property">props</span>.<span class="hljs-property">children</span>

node.<span class="hljs-title function_">appendChild</span>(text)
container.<span class="hljs-title function_">appendChild</span>(node)
</code></pre>

      <h2>
        <span class="prefix"></span>
        <span class="content">ç¬¬ä¸€æ­¥: createElement å‡½æ•°</span>
        <span class="suffix"></span>
      </h2>
    <p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬åˆ‡æ¢åˆ°å¦ä¸€ä¸ªAppï¼šè‡ªå·±å®ç°çš„ç®€æ˜“Reactã€‚</p>
<p>é¦–å…ˆï¼Œä»ç¼–å†™<code>createElement</code>å¼€å§‹ï¼Œå°†JSXè½¬æ¢ä¸ºJSã€‚æ­£å¦‚åœ¨ä¸Šä¸€æ­¥ä¸­çœ‹åˆ°çš„ï¼Œ<code>element</code>æ˜¯å…·æœ‰ç±»å‹å’Œå±æ€§çš„å¯¹è±¡ã€‚<code>createElement</code>å”¯ä¸€éœ€è¦åšçš„å°±æ˜¯åˆ›å»ºè¯¥å¯¹è±¡ã€‚</p>
<p>å› ä¸º<code>children</code>ä¹Ÿå¯ä»¥åŒ…å«åŸå§‹æ•°æ®ç±»å‹ï¼Œæ¯”å¦‚å­—ç¬¦ä¸²æˆ–æ•°å­—ï¼Œæ‰€ä»¥å¯¹ä¸æ˜¯<code>object</code>çš„<code>child</code>åˆ›å»ºç‰¹æ®ŠèŠ‚ç‚¹ç±»å‹ï¼š<code>TEXT_ELEMENT</code>ã€‚è¿™æ ·åšæ˜¯å› ä¸ºå¯ä»¥ç®€åŒ–ä»£ç ã€‚å¯¹äºæˆ‘ä»¬çš„åº“ï¼Œæˆ‘æ›´å–œæ¬¢ç®€å•è€Œä¸æ˜¯é«˜æ€§èƒ½ä»£ç ã€‚</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">createTextElement</span>(<span class="hljs-params">text</span>) {
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">type</span>: <span class="hljs-string">&quot;TEXT_ELEMENT&quot;</span>,
    <span class="hljs-attr">props</span>: {
      <span class="hljs-attr">nodeValue</span>: text,
      <span class="hljs-attr">children</span>: [],
    },
  }
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">createElement</span>(<span class="hljs-params">type, props, ...children</span>) {
  <span class="hljs-keyword">return</span> {
    type,
    <span class="hljs-attr">props</span>: {
      ...props,
      <span class="hljs-attr">children</span>: children.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">child</span>) =&gt;</span> <span class="hljs-keyword">typeof</span> child === <span class="hljs-string">&quot;object&quot;</span>
        ? child
        : <span class="hljs-title function_">createTextElement</span>(child)
      ),
    },
  }
}
</code></pre>
<p>ç›®å‰Babelä»ç„¶ä½¿ç”¨<code>React.createElement</code>ï¼Œä¸ºäº†æ›¿æ¢å®ƒï¼Œè®©æˆ‘ä»¬ç»™è‡ªå·±çš„åº“èµ·ä¸ªåå­—ã€‚æˆ‘ä»¬éœ€è¦ä¸€ä¸ªå¬èµ·æ¥åƒReactçš„åå­—ï¼Œä½†ä¹Ÿæš—ç¤ºäº†å®ƒçš„æ•™å­¦ç›®çš„ï¼Œæˆ‘ä»¬å«å®ƒ<code>Didact</code>ã€‚</p>
<p>è®©æˆ‘ä»¬ä½¿ç”¨<code>/** @jsx Didact.createElement */</code>æ¥å‘Šè¯‰Babelä½¿ç”¨æˆ‘ä»¬è‡ªå·±çš„<code>createElement</code>æ¥è½¬æ¢jsxä»£ç ï¼š</p>
<pre><code class="hljs language-js"><span class="hljs-comment">/** <span class="hljs-doctag">@jsx</span> Didact.createElement */</span>
<span class="hljs-keyword">const</span> element = (
  <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;foo&quot;</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">a</span>&gt;</span>bar<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">b</span> /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
)
</code></pre>

      <h2>
        <span class="prefix"></span>
        <span class="content">ç¬¬äºŒæ­¥ï¼šredner å‡½æ•°</span>
        <span class="suffix"></span>
      </h2>
    <p>é¦–å…ˆä½¿ç”¨elementçš„<code>type</code>åˆ›å»ºDOMèŠ‚ç‚¹ï¼Œç„¶åå°†æ–°elementæ·»åŠ åˆ°<code>container</code>ä¸­ã€‚ç„¶åå¯¹æ¯ä¸ª<code>child</code>é€’å½’è°ƒç”¨<code>render</code>ï¼š</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">render</span>(<span class="hljs-params">element, container</span>) {
  <span class="hljs-keyword">const</span> dom = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(element.<span class="hljs-property">type</span>);

  element.<span class="hljs-property">props</span>.<span class="hljs-property">children</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">child</span>) =&gt;</span> <span class="hljs-title function_">render</span>(child, dom))

  container.<span class="hljs-title function_">appendChild</span>(dom);
}
</code></pre>
<p>å…¶æ¬¡ï¼Œæˆ‘ä»¬è¿˜éœ€è¦å¤„ç†æ–‡æœ¬èŠ‚ç‚¹ï¼Œå¦‚æœelementç±»å‹ä¸º<code>TEXT_ELEMENT</code>ï¼Œæˆ‘ä»¬å°†åˆ›å»ºæ–‡æœ¬èŠ‚ç‚¹è€Œä¸æ˜¯æ™®é€šèŠ‚ç‚¹ï¼š</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">render</span>(<span class="hljs-params">element, container</span>) {
  <span class="hljs-comment">// ...</span>
  <span class="hljs-keyword">const</span> dom = element.<span class="hljs-property">type</span> === <span class="hljs-string">&quot;TEXT_ELEMENT&quot;</span>
    ? <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createTextNode</span>(<span class="hljs-string">&quot;&quot;</span>)
    : <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElmenet</span>(element.<span class="hljs-property">type</span>);
  <span class="hljs-comment">//...</span>
}
</code></pre>
<p>æœ€åï¼Œå°†<code>props</code>åˆ†é…ç»™elementï¼š</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">render</span>(<span class="hljs-params">element, container</span>) {
  <span class="hljs-comment">// ...</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">isProperty</span> = key =&gt; key === <span class="hljs-string">&quot;children&quot;</span>;
  <span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">ownkeys</span>(element.<span class="hljs-property">props</span>)
    .<span class="hljs-title function_">filter</span>(isProperty)
    .<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">name</span>) =&gt;</span> dom[name] = element.<span class="hljs-property">props</span>[name]);
  <span class="hljs-comment">// ...</span>
}
</code></pre>
<p>è¿™æ ·çš„è¯ï¼Œæˆ‘ä»¬å°±æœ‰äº†ä¸€ä¸ªå¯ä»¥å°†JSXå‘ˆç°åˆ°DOMçš„åº“ï¼š</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">createTextElement</span>(<span class="hljs-params">text</span>) {
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">type</span>: <span class="hljs-string">&quot;TEXT_ELEMENT&quot;</span>,
    <span class="hljs-attr">props</span>: {
      <span class="hljs-attr">nodeValue</span>: text,
      <span class="hljs-attr">children</span>: []
    }
  };
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">createElement</span>(<span class="hljs-params">type, props, ...children</span>) {
  <span class="hljs-keyword">return</span> {
    type,
    <span class="hljs-attr">props</span>: {
      ...props,
      <span class="hljs-attr">children</span>: children.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">child</span>) =&gt;</span>
        <span class="hljs-keyword">typeof</span> child === <span class="hljs-string">&quot;object&quot;</span> ? child : <span class="hljs-title function_">createTextElement</span>(child)
      )
    }
  };
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">render</span>(<span class="hljs-params">element, container</span>) {
  <span class="hljs-keyword">const</span> dom =
    element.<span class="hljs-property">type</span> === <span class="hljs-string">&quot;TEXT_ELEMENT&quot;</span>
      ? <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createTextNode</span>(<span class="hljs-string">&quot;&quot;</span>)
      : <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(element.<span class="hljs-property">type</span>);

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">isProperty</span> = (<span class="hljs-params">key</span>) =&gt; key !== <span class="hljs-string">&quot;children&quot;</span>;
  <span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">ownKeys</span>(element.<span class="hljs-property">props</span>)
    .<span class="hljs-title function_">filter</span>(isProperty)
    .<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">name</span>) =&gt;</span> (dom[name] = element.<span class="hljs-property">props</span>[name]));

  element.<span class="hljs-property">props</span>.<span class="hljs-property">children</span>.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">child</span>) =&gt;</span> <span class="hljs-title function_">render</span>(child, dom));

  container.<span class="hljs-title function_">appendChild</span>(dom);
}

<span class="hljs-keyword">const</span> <span class="hljs-title class_">Didact</span> = {
  createElement,
  render
};

<span class="hljs-comment">/** <span class="hljs-doctag">@jsx</span> Didact.createElement */</span>
<span class="hljs-keyword">const</span> element = (
  <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;foo&quot;</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Hello STEP1-STEP2<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
);

<span class="hljs-keyword">const</span> container = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">&quot;#step1&quot;</span>);

<span class="hljs-title class_">Didact</span>.<span class="hljs-title function_">render</span>(element, container);
</code></pre>

      <h2>
        <span class="prefix"></span>
        <span class="content">ç¬¬ä¸‰æ­¥Concurrent Mode</span>
        <span class="suffix"></span>
      </h2>
    <p>åœ¨å¼€å§‹æ·»åŠ æ›´å¤šä»£ç ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦é‡æ„ã€‚</p>
<p>ä¸Šé¢çš„é€’å½’è°ƒç”¨å­˜åœ¨é—®é¢˜ã€‚å¼€å§‹æ¸²æŸ“åï¼Œç›´åˆ°æ¸²æŸ“å®Œå®Œæ•´çš„elementæ ‘ï¼Œæˆ‘ä»¬æ‰ä¼šåœæ­¢ã€‚ å¦‚æœelementæ ‘å¾ˆå¤§ï¼Œåˆ™å¯èƒ½ä¼šé˜»å¡ä¸»çº¿ç¨‹å¤ªé•¿æ—¶é—´ã€‚ é‚£ä¹ˆå¦‚æœæµè§ˆå™¨éœ€è¦æ‰§è¡Œé«˜ä¼˜å…ˆçº§çš„æ“ä½œï¼ˆä¾‹å¦‚å¤„ç†ç”¨æˆ·è¾“å…¥æˆ–ä¿æŒåŠ¨ç”»æµç•…ï¼‰ï¼Œåˆ™å®ƒå¿…é¡»ç­‰åˆ°æ¸²æŸ“å®Œæˆä¸ºæ­¢ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å°†å·¥ä½œåˆ†æˆå‡ ä¸ªå°éƒ¨åˆ†ï¼Œåœ¨å®Œæˆæ¯ä¸ªå•å…ƒåï¼Œå¦‚æœéœ€è¦æ‰§è¡Œå…¶ä»–ä»»ä½•æ“ä½œï¼Œæˆ‘ä»¬å°†è®©æµè§ˆå™¨ä¸­æ–­æ¸²æŸ“ã€‚</p>
<p>æˆ‘ä»¬ä½¿ç”¨<code>requestIdleCallback</code>è¿›è¡Œå¾ªç¯ã€‚ æ‚¨å¯ä»¥å°†<code>requestIdleCallback</code>çœ‹ä½œ<code>setTimeout</code>ï¼Œä½†æ˜¯æµè§ˆå™¨å°†åœ¨ä¸»çº¿ç¨‹ç©ºé—²æ—¶è¿è¡Œå›è°ƒï¼Œè€Œä¸æ˜¯å‘Šè¯‰å®ƒä½•æ—¶è¿è¡Œã€‚Reactä¸å†ä½¿ç”¨<code>requestIdleCallback</code>ï¼Œç°åœ¨å®ƒä½¿ç”¨scheduler packageã€‚ ä½†æ˜¯å¯¹äºæ­¤ç”¨ä¾‹ï¼Œå®ƒåœ¨æ¦‚å¿µä¸Šæ˜¯ç›¸åŒçš„ã€‚<code>requestIdleCallback</code>è¿˜ä¸ºæˆ‘ä»¬æä¾›äº†<code>deadline</code>å‚æ•°ã€‚ æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å®ƒæ¥æ£€æŸ¥æµè§ˆå™¨éœ€è¦å†æ¬¡æ§åˆ¶ä¹‹å‰æœ‰å¤šå°‘æ—¶é—´ã€‚</p>
<p>è¦å¼€å§‹ä½¿ç”¨å¾ªç¯ï¼Œæˆ‘ä»¬éœ€è¦è®¾ç½®ç¬¬ä¸€ä¸ªå·¥ä½œå•å…ƒï¼Œç„¶åç¼–å†™ä¸€ä¸ª<code>performUnitOfWork</code>å‡½æ•°ï¼Œè¯¥å‡½æ•°ä¸ä»…æ‰§è¡Œå·¥ä½œï¼Œè¿˜è¿”å›ä¸‹ä¸€ä¸ªå·¥ä½œå•å…ƒã€‚</p>

      <h2>
        <span class="prefix"></span>
        <span class="content">ç¬¬å››æ­¥Fiber</span>
        <span class="suffix"></span>
      </h2>
    <p>è¦ç»„ç»‡å·¥ä½œå•å…ƒï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªæ•°æ®ç»“æ„--Fiberæ ‘ã€‚æˆ‘ä»¬å°†ä¸ºæ¯ä¸ªå…ƒç´ åˆ†é…ä¸€æ ¹Fiberï¼Œå¹¶ä¸”æ¯ä¸ªFiberå°†æˆä¸ºä¸€ä¸ªå·¥ä½œå•å…ƒã€‚</p>
<p>å‡å¦‚æˆ‘ä»¬è¦æ¸²æŸ“å¦‚ä¸‹çš„elementæ ‘ï¼Œé‚£ä¹ˆFiberæ ‘å°±å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre><code class="hljs language-js"><span class="hljs-title class_">Didact</span>.<span class="hljs-title function_">render</span>(
  <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span> /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">a</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h2</span> /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>,
  container
)
</code></pre>
<p><img src="https://pomb.us/static/a88a3ec01855349c14302f6da28e2b0c/ac667/fiber1.png" alt=""></p>
<p>åœ¨renderå‡½æ•°ä¸­ï¼Œæˆ‘ä»¬å°†åˆ›å»ºroot Fiberå¹¶å°†å…¶è®¾ç½®ä¸º<code>nextUnitOfWork</code>ã€‚ å‰©ä¸‹çš„å·¥ä½œå°†åœ¨<code>performUnitOfWork</code>å‡½æ•°ä¸Šè¿›è¡Œï¼Œæˆ‘ä»¬å°†ä¸ºæ¯ä¸ªFiberåšä¸‰ä»¶äº‹ï¼š</p>
<ol>
<li>å°†elementæ·»åŠ åˆ°DOM</li>
<li>ä¸ºelementçš„å­ä»£åˆ›å»ºFilber</li>
<li>é€‰æ‹©ä¸‹ä¸€ä¸ªå·¥ä½œå•å…ƒ</li>
</ol>
<p>è¯¥æ•°æ®ç»“æ„çš„ç›®æ ‡ä¹‹ä¸€æ˜¯ä½¿æŸ¥æ‰¾ä¸‹ä¸€ä¸ªå·¥ä½œå•å…ƒå˜å¾—å®¹æ˜“ã€‚ è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæ¯ä¸ªFiberéƒ½é“¾æ¥åˆ°å…¶ç¬¬ä¸€ä¸ªå­èŠ‚ç‚¹ã€ä¸‹ä¸€ä¸ªå…„å¼ŸèŠ‚ç‚¹å’Œçˆ¶èŠ‚ç‚¹ã€‚</p>
<ul>
<li>å½“æˆ‘ä»¬å®Œæˆå¯¹å½“å‰Fiberçš„å·¥ä½œæ—¶ï¼Œå¦‚æœæœ‰childï¼Œé‚£ä¹ˆè¯¥childå¯¹åº”çš„Fiberå°†æ˜¯ä¸‹ä¸€ä¸ªå·¥ä½œå•å…ƒã€‚åœ¨æˆ‘ä»¬çš„ç¤ºä¾‹ä¸­ï¼Œå½“æˆ‘ä»¬å®Œæˆdiv Fiberçš„å·¥ä½œæ—¶ï¼Œä¸‹ä¸€ä¸ªå·¥ä½œå•å…ƒå°†æ˜¯h1 Fiberã€‚</li>
<li>å¦‚æœå½“å‰Fiberæ²¡æœ‰childï¼Œæˆ‘ä»¬å°†å…¶siblingä½œä¸ºä¸‹ä¸€ä¸ªå·¥ä½œå•å…ƒã€‚ä¾‹å¦‚ï¼Œp Fiberæ²¡æœ‰childï¼Œå› æ­¤æˆ‘ä»¬åœ¨å®Œæˆå½“å‰ä¹‹åä¸‹ä¸€ä¸ªå·¥ä½œå•å…ƒå°†æ˜¯h1ã€‚</li>
<li>å¦‚æœå½“å‰Fiberæ—¢æ²¡æœ‰childä¹Ÿæ²¡æœ‰siblingï¼Œé‚£ä¹ˆæˆ‘ä»¬å»â€œuncleâ€ï¼šçˆ¶æ¯çš„å…„å¼ŸèŠ‚ç‚¹ã€‚ å°±åƒç¤ºä¾‹ä¸­çš„aå’Œh2 Fiberä¸€æ ·ã€‚</li>
<li>å¦‚æœparentæ²¡æœ‰siblingï¼Œæˆ‘ä»¬ä¼šä¸æ–­æ£€æŸ¥parentï¼Œç›´åˆ°æ‰¾åˆ°æœ‰siblingçš„parentï¼Œæˆ–è€…ç›´åˆ°æ‰¾åˆ°rootã€‚ å¦‚æœåˆ°è¾¾rootï¼Œåˆ™æ„å‘³ç€æˆ‘ä»¬å·²ç»å®Œæˆäº†æ­¤æ¸²æŸ“çš„æ‰€æœ‰å·¥ä½œã€‚</li>
</ul>
<p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬å¼€å§‹å†™ä»£ç ã€‚</p>
<p>é¦–å…ˆï¼Œæ›´æ”¹<code>render</code>å‡½æ•°å¹¶åˆ›å»º<code>createDom</code>å‡½æ•°</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">render</span>(<span class="hljs-params">element, container</span>) {
  nextUnitOfWork = {
    <span class="hljs-attr">dom</span>: container,
    <span class="hljs-attr">props</span>: {
      <span class="hljs-attr">children</span>: [element],
    },
  }
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">createDom</span>(<span class="hljs-params">fiber</span>) {
  <span class="hljs-keyword">const</span> dom =
    fiber.<span class="hljs-property">type</span> == <span class="hljs-string">&quot;TEXT_ELEMENT&quot;</span>
      ? <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createTextNode</span>(<span class="hljs-string">&quot;&quot;</span>)
      : <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(fiber.<span class="hljs-property">type</span>)
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">isProperty</span> = key =&gt; key !== <span class="hljs-string">&quot;children&quot;</span>
  <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(fiber.<span class="hljs-property">props</span>)
    .<span class="hljs-title function_">filter</span>(isProperty)
    .<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">name</span> =&gt;</span> {
      dom[name] = fiber.<span class="hljs-property">props</span>[name]
    })
  <span class="hljs-keyword">return</span> dom
}
</code></pre>
<p>ç„¶åï¼Œå½“æµè§ˆå™¨å‡†å¤‡å°±ç»ªæ—¶ï¼Œå®ƒå°†è°ƒç”¨æˆ‘ä»¬çš„<code>workLoop</code>ï¼Œæˆ‘ä»¬å°†ä»<code>root</code>å¼€å§‹æ‰§è¡Œæ¸²æŸ“ã€‚</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">workLoop</span>(<span class="hljs-params">deadline</span>) {
  <span class="hljs-keyword">let</span> shouldYield = <span class="hljs-literal">false</span>
  <span class="hljs-keyword">while</span> (nextUnitOfWork &amp;&amp; !shouldYield) {
    nextUnitOfWork = <span class="hljs-title function_">performUnitOfWork</span>(
      nextUnitOfWork
    )
    shouldYield = deadline.<span class="hljs-title function_">timeRemaining</span>() &lt; <span class="hljs-number">1</span>
  }
  <span class="hljs-title function_">requestIdleCallback</span>(workLoop)
}
</code></pre>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ–°nodeå¹¶å°†å…¶æ·»åŠ åˆ°DOMã€‚æˆ‘ä»¬åœ¨<code>fibre.dom</code>å±æ€§ä¸­è·Ÿè¸ªDOMèŠ‚ç‚¹ã€‚</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">performUnitOfWork</span>(<span class="hljs-params">fiber</span>) {
  <span class="hljs-keyword">if</span> (!fiber.<span class="hljs-property">dom</span>) {
    fiber.<span class="hljs-property">dom</span> = <span class="hljs-title function_">createDom</span>(fiber)
  }
  <span class="hljs-keyword">if</span> (fiber.<span class="hljs-property">parent</span>) {
    fiber.<span class="hljs-property">parent</span>.<span class="hljs-property">dom</span>.<span class="hljs-title function_">appendChild</span>(fiber.<span class="hljs-property">dom</span>)
  }
  <span class="hljs-comment">// TODO create new fibers</span>
  <span class="hljs-comment">// TODO return next unit of work</span>
}
</code></pre>
<p>ç„¶åå¯¹æ¯ä¸ª<code>child</code>åˆ›å»ºFiber</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">const</span> elements = fiber.<span class="hljs-property">props</span>.<span class="hljs-property">children</span>
  <span class="hljs-keyword">let</span> index = <span class="hljs-number">0</span>
  <span class="hljs-keyword">let</span> prevSibling = <span class="hljs-literal">null</span>
  <span class="hljs-keyword">while</span> (index &lt; elements.<span class="hljs-property">length</span>) {
    <span class="hljs-keyword">const</span> element = elements[index]
    <span class="hljs-keyword">const</span> newFiber = {
      <span class="hljs-attr">type</span>: element.<span class="hljs-property">type</span>,
      <span class="hljs-attr">props</span>: element.<span class="hljs-property">props</span>,
      <span class="hljs-attr">parent</span>: fiber,
      <span class="hljs-attr">dom</span>: <span class="hljs-literal">null</span>,
    }
  }
</code></pre>
<p>ç„¶åå°†å…¶æ·»åŠ åˆ°Fiberæ ‘ä¸­ï¼Œå°†å…¶è®¾ç½®ä¸º<code>child</code>è¿˜æ˜¯<code>sibing</code>ï¼Œå…·ä½“å–å†³äºå®ƒæ˜¯å¦æ˜¯ç¬¬ä¸€ä¸ªchildã€‚</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">if</span> (index === <span class="hljs-number">0</span>) {
      fiber.<span class="hljs-property">child</span> = newFiber
    } <span class="hljs-keyword">else</span> {
      prevSibling.<span class="hljs-property">sibling</span> = newFiber
    }
}
prevSibling = newFiber
index++
</code></pre>
<p>æœ€åï¼Œæˆ‘ä»¬æŒ‰ç…§child â˜ sibling â˜ uncleæ¥é€‰æ‹©ä¸‹ä¸€å·¥ä½œå•å…ƒã€‚</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">if</span> (fiber.<span class="hljs-property">child</span>) {
  <span class="hljs-keyword">return</span> fiber.<span class="hljs-property">child</span>
}
<span class="hljs-keyword">let</span> nextFiber = fiber
<span class="hljs-keyword">while</span> (nextFiber) {
  <span class="hljs-keyword">if</span> (nextFiber.<span class="hljs-property">sibling</span>) {
    <span class="hljs-keyword">return</span> nextFiber.<span class="hljs-property">sibling</span>
  }
  nextFiber = nextFiber.<span class="hljs-property">parent</span>
}
</code></pre>
<p>å®Œæ•´çš„ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">performUnitOfWork</span>(<span class="hljs-params">fiber</span>) {
  <span class="hljs-keyword">if</span> (!fiber.<span class="hljs-property">dom</span>) {
    fiber.<span class="hljs-property">dom</span> = <span class="hljs-title function_">createDom</span>(fiber)
  }

  <span class="hljs-keyword">if</span> (fiber.<span class="hljs-property">parent</span>) {
    fiber.<span class="hljs-property">parent</span>.<span class="hljs-property">dom</span>.<span class="hljs-title function_">appendChild</span>(fiber.<span class="hljs-property">dom</span>)
  }

  <span class="hljs-keyword">const</span> elements = fiber.<span class="hljs-property">props</span>.<span class="hljs-property">children</span>
  <span class="hljs-keyword">let</span> index = <span class="hljs-number">0</span>
  <span class="hljs-keyword">let</span> prevSibling = <span class="hljs-literal">null</span>

  <span class="hljs-keyword">while</span> (index &lt; elements.<span class="hljs-property">length</span>) {
    <span class="hljs-keyword">const</span> element = elements[index]

    <span class="hljs-keyword">const</span> newFiber = {
      <span class="hljs-attr">type</span>: element.<span class="hljs-property">type</span>,
      <span class="hljs-attr">props</span>: element.<span class="hljs-property">props</span>,
      <span class="hljs-attr">parent</span>: fiber,
      <span class="hljs-attr">dom</span>: <span class="hljs-literal">null</span>,
    }

    <span class="hljs-keyword">if</span> (index === <span class="hljs-number">0</span>) {
      fiber.<span class="hljs-property">child</span> = newFiber
    } <span class="hljs-keyword">else</span> {
      prevSibling.<span class="hljs-property">sibling</span> = newFiber
    }

    prevSibling = newFiber
    index++
  }

  <span class="hljs-keyword">if</span> (fiber.<span class="hljs-property">child</span>) {
    <span class="hljs-keyword">return</span> fiber.<span class="hljs-property">child</span>
  }
  <span class="hljs-keyword">let</span> nextFiber = fiber
  <span class="hljs-keyword">while</span> (nextFiber) {
    <span class="hljs-keyword">if</span> (nextFiber.<span class="hljs-property">sibling</span>) {
      <span class="hljs-keyword">return</span> nextFiber.<span class="hljs-property">sibling</span>
    }
    nextFiber = nextFiber.<span class="hljs-property">parent</span>
  }
}
</code></pre>

      <h2>
        <span class="prefix"></span>
        <span class="content">æäº¤æ›´æ”¹</span>
        <span class="suffix"></span>
      </h2>
    <p>æˆ‘ä»¬è¿˜æœ‰ä¸€ä¸ªé—®é¢˜ã€‚æ¯æ¬¡å¤„ç†ä¸€ä¸ªå…ƒç´ æ—¶ï¼Œæˆ‘ä»¬éƒ½ä¼šå‘DOMæ·»åŠ ä¸€ä¸ªæ–°èŠ‚ç‚¹ã€‚è€Œä¸”ï¼Œè¯·è®°ä½ï¼Œæµè§ˆå™¨å¯èƒ½ä¼šåœ¨æˆ‘ä»¬å®Œæˆæ•´ä¸ªæ ‘çš„æ¸²æŸ“ä¹‹å‰ä¸­æ–­æˆ‘ä»¬çš„å·¥ä½œã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œç”¨æˆ·å°†çœ‹åˆ°ä¸€ä¸ªä¸å®Œæ•´çš„UIã€‚æˆ‘ä»¬ä¸æƒ³è¿™æ ·ã€‚</p>
<p>å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦ä»<code>performUnitOfWork</code>é‡Œåˆ é™¤æ”¹å˜DOMçš„éƒ¨åˆ†ã€‚ç›¸åï¼Œæˆ‘ä»¬å°†è·Ÿè¸ªFiber treeã€‚æˆ‘ä»¬ç§°å®ƒä¸º<code>wipRoot</code>ã€‚ä¸€æ—¦æˆ‘ä»¬å®Œæˆäº†æ‰€æœ‰çš„å·¥ä½œ(æˆ‘ä»¬çŸ¥é“å®ƒæ˜¯å› ä¸ºæ²¡æœ‰ä¸‹ä¸€ä¸ªå·¥ä½œå•å…ƒ)ï¼Œæˆ‘ä»¬å°±å°†æ•´ä¸ªFiber treeæäº¤ç»™DOMã€‚æˆ‘ä»¬åœ¨<code>commitRoot</code>å‡½æ•°ä¸­å®Œæˆã€‚åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬é€’å½’åœ°å°†æ‰€æœ‰èŠ‚ç‚¹è¿½åŠ åˆ°domã€‚</p>

      <h2>
        <span class="prefix"></span>
        <span class="content">Reconciliation</span>
        <span class="suffix"></span>
      </h2>
    <p>åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬åªå‘DOMæ·»åŠ äº†ä¸€äº›ä¸œè¥¿ï¼Œé‚£ä¹ˆæ›´æ–°æˆ–åˆ é™¤èŠ‚ç‚¹å‘¢? </p>
<p>è¿™å°±æ˜¯æˆ‘ä»¬ç°åœ¨è¦åšçš„ï¼Œæˆ‘ä»¬éœ€è¦å°†<code>render</code>å‡½æ•°æ¥æ”¶åˆ°çš„å…ƒç´ ä¸æäº¤ç»™DOMçš„æœ€åä¸€ä¸ªFiber treeè¿›è¡Œæ¯”è¾ƒã€‚å› æ­¤ï¼Œåœ¨å®Œæˆ<code>commit</code>ä¹‹åï¼Œæˆ‘ä»¬éœ€è¦ä¿å­˜å¯¹<strong>æœ€åä¸€ä¸ªæäº¤åˆ°DOMçš„Fiber tree</strong>çš„å¼•ç”¨ã€‚æˆ‘ä»¬ç§°ä¹‹ä¸º<code>currentRoot</code>ã€‚æˆ‘ä»¬è¿˜åœ¨æ¯Fiberä¸­åŠ å…¥äº†<code>alternate</code>, æ­¤å±æ€§æ˜¯åˆ°æ—§Fiberçš„é“¾æ¥ï¼Œå³æˆ‘ä»¬åœ¨ä¸Šä¸€ä¸ªæäº¤é˜¶æ®µæäº¤ç»™DOMçš„Fiberã€‚</p>
<p>ç°åœ¨è®©æˆ‘ä»¬ä»åˆ›å»ºæ–°Fiberçš„<code>performUnitOfWork</code>å‡½æ•°ä¸­æå–ä»£ç åˆ°<code>reconcileChildren</code> ã€‚åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å°†<code>reconcile</code>æ—§çš„fiberså’Œæ–°å…ƒç´ ã€‚æˆ‘ä»¬åŒæ—¶éå†æ—§Fiber tree(<code>wipFiber.alternate</code>)çš„å­å…ƒç´ å’Œæˆ‘ä»¬æƒ³è¦reconciliationçš„å…ƒç´ æ•°ç»„ã€‚å¦‚æœæˆ‘ä»¬å¿½ç•¥åŒæ—¶éå†æ•°ç»„å’Œé“¾è¡¨æ‰€éœ€çš„æ‰€æœ‰æ ·æ¿æ–‡ä»¶ï¼Œé‚£ä¹ˆæˆ‘ä»¬åªå‰©ä¸‹whileä¸­æœ€é‡è¦çš„éƒ¨åˆ†:oldFiberå’Œelementã€‚å…ƒç´ æ˜¯æˆ‘ä»¬æƒ³è¦æ¸²æŸ“åˆ°DOMçš„ä¸œè¥¿ï¼Œè€ŒoldFiberæ˜¯æˆ‘ä»¬ä¸Šæ¬¡æ¸²æŸ“çš„ä¸œè¥¿ã€‚æˆ‘ä»¬éœ€è¦æ¯”è¾ƒå®ƒä»¬ï¼Œçœ‹çœ‹æ˜¯å¦éœ€è¦å¯¹DOMè¿›è¡Œæ›´æ”¹ã€‚</p>
<p>ä¸ºäº†æ¯”è¾ƒå®ƒä»¬ï¼Œæˆ‘ä»¬ä½¿ç”¨ç±»å‹:</p>
<ul>
<li>å¦‚æœæ—§çš„Fiberå’Œæ–°å…ƒç´ å…·æœ‰ç›¸åŒçš„ç±»å‹ï¼Œæˆ‘ä»¬å¯ä»¥ä¿ç•™DOMèŠ‚ç‚¹ï¼Œå¹¶ä½¿ç”¨æ–°çš„é“å…·æ›´æ–°å®ƒ</li>
<li>å¦‚æœç±»å‹ä¸åŒï¼Œå¹¶ä¸”æœ‰ä¸€ä¸ªæ–°å…ƒç´ ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªæ–°çš„DOMèŠ‚ç‚¹</li>
<li>å¦‚æœç±»å‹ä¸åŒï¼Œå¹¶ä¸”æœ‰ä¸€ä¸ªæ—§çš„å…‰çº¤ï¼Œæˆ‘ä»¬éœ€è¦åˆ é™¤æ—§çš„èŠ‚ç‚¹</li>
</ul>
<p>è¿™é‡ŒReactä¹Ÿä½¿ç”¨keyï¼Œè¿™æ ·å¯ä»¥æ›´å¥½çš„<code>reconcile</code>ã€‚ä¾‹å¦‚ï¼Œå®ƒæ£€æµ‹å­å…ƒç´ åœ¨å…ƒç´ æ•°ç»„ä¸­çš„ä½ç½®å‘ç”Ÿäº†å˜åŒ–ã€‚</p>
<p>å½“æ—§Fiberå’Œå…ƒç´ å…·æœ‰ç›¸åŒçš„ç±»å‹æ—¶ï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ–°Fiberï¼Œä½¿DOMèŠ‚ç‚¹ä¸æ—§Fiberä¿æŒä¸€è‡´ï¼Œä½¿propsä¸elementä¿æŒä¸€è‡´ã€‚æˆ‘ä»¬è¿˜å‘Fiber æ·»åŠ äº†ä¸€ä¸ªæ–°å±æ€§:<code>effectTag</code>ã€‚æˆ‘ä»¬å°†åœ¨ç¨åçš„<code>commit</code>é˜¶æ®µä½¿ç”¨æ­¤å±æ€§ã€‚</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">const</span> sameType =
      oldFiber &amp;&amp;
      element &amp;&amp;
      element.<span class="hljs-property">type</span> == oldFiber.<span class="hljs-property">type</span>
<span class="hljs-keyword">if</span> (sameType) {
  newFiber = {
    <span class="hljs-attr">type</span>: oldFiber.<span class="hljs-property">type</span>,
    <span class="hljs-attr">props</span>: element.<span class="hljs-property">props</span>,
    <span class="hljs-attr">dom</span>: oldFiber.<span class="hljs-property">dom</span>,
    <span class="hljs-attr">parent</span>: wipFiber,
    <span class="hljs-attr">alternate</span>: oldFiber,
    <span class="hljs-attr">effectTag</span>: <span class="hljs-string">&quot;UPDATE&quot;</span>,
  }
}
</code></pre>
<p>å¯¹äºelementéœ€è¦ä¸€ä¸ªæ–°DOMèŠ‚ç‚¹çš„æƒ…å†µï¼Œæˆ‘ä»¬ç”¨<code>PLACEMENT</code>æ ‡è®°æ ‡è®°æ–°Fiberã€‚</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">if</span> (element &amp;&amp; !sameType) {
  newFiber = {
    <span class="hljs-attr">type</span>: element.<span class="hljs-property">type</span>,
    <span class="hljs-attr">props</span>: element.<span class="hljs-property">props</span>,
    <span class="hljs-attr">dom</span>: <span class="hljs-literal">null</span>,
    <span class="hljs-attr">parent</span>: wipFiber,
    <span class="hljs-attr">alternate</span>: <span class="hljs-literal">null</span>,
    <span class="hljs-attr">effectTag</span>: <span class="hljs-string">&quot;PLACEMENT&quot;</span>,
  }
}
</code></pre>
<p>å¯¹äºéœ€è¦åˆ é™¤èŠ‚ç‚¹çš„æƒ…å†µï¼Œæˆ‘ä»¬æ²¡æœ‰æ–°çš„Fiberï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨æ—§Fiberä¸Šæ·»åŠ effectæ ‡ç­¾ã€‚ä½†æ˜¯å½“æˆ‘ä»¬å°†Fiberæ ‘æäº¤åˆ°DOMæ—¶ï¼Œæˆ‘ä»¬ä»æ­£åœ¨è¿›è¡Œçš„æ ¹ç›®å½•æ‰§è¡Œï¼Œå®ƒæ²¡æœ‰æ—§çš„Fiber ã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¸€ä¸ªæ•°ç»„æ¥è·Ÿè¸ªè¦åˆ é™¤çš„èŠ‚ç‚¹ã€‚ç„¶åï¼Œå½“æˆ‘ä»¬å°†æ›´æ”¹æäº¤åˆ°DOMæ—¶ï¼Œæˆ‘ä»¬è¿˜ä½¿ç”¨äº†æ¥è‡ªè¯¥æ•°ç»„çš„Fiberã€‚</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">if</span> (oldFiber &amp;&amp; !sameType) {
  oldFiber.<span class="hljs-property">effectTag</span> = <span class="hljs-string">&quot;DELETION&quot;</span>
  deletions.<span class="hljs-title function_">push</span>(oldFiber)
}
</code></pre>
<p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬ä¿®æ”¹<code>commitWork</code>å‡½æ•°æ¥å¤„ç†æ–°çš„<code>effectTags</code>ã€‚</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">commitWork</span>(<span class="hljs-params">fiber</span>) {
  <span class="hljs-keyword">if</span> (!fiber) {
    <span class="hljs-keyword">return</span>
  }
  <span class="hljs-keyword">if</span> (
    fiber.<span class="hljs-property">effectTag</span> === <span class="hljs-string">&quot;PLACEMENT&quot;</span> &amp;&amp;
    fiber.<span class="hljs-property">dom</span> != <span class="hljs-literal">null</span>
  ) {
    domParent.<span class="hljs-title function_">appendChild</span>(fiber.<span class="hljs-property">dom</span>)
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (
      fiber.<span class="hljs-property">effectTag</span> === <span class="hljs-string">&quot;UPDATE&quot;</span> &amp;&amp;
      fiber.<span class="hljs-property">dom</span> != <span class="hljs-literal">null</span>
    ) {
      <span class="hljs-title function_">updateDom</span>(
        fiber.<span class="hljs-property">dom</span>,
        fiber.<span class="hljs-property">alternate</span>.<span class="hljs-property">props</span>,
        fiber.<span class="hljs-property">props</span>
      )
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (fiber.<span class="hljs-property">effectTag</span> === <span class="hljs-string">&quot;DELETION&quot;</span>) {
      domParent.<span class="hljs-title function_">removeChild</span>(fiber.<span class="hljs-property">dom</span>)
  }
  <span class="hljs-keyword">const</span> domParent = fiber.<span class="hljs-property">parent</span>.<span class="hljs-property">dom</span>
  domParent.<span class="hljs-title function_">appendChild</span>(fiber.<span class="hljs-property">dom</span>)
  <span class="hljs-title function_">commitWork</span>(fiber.<span class="hljs-property">child</span>)
  <span class="hljs-title function_">commitWork</span>(fiber.<span class="hljs-property">sibling</span>)
}
</code></pre>
<ul>
<li><p>å¦‚æœFiberæœ‰ä¸€ä¸ª<code>PLACEMENT</code>æ ‡ç­¾ï¼Œä»çˆ¶Fiberå°†DOMèŠ‚ç‚¹é™„åŠ åˆ°èŠ‚ç‚¹ã€‚</p>
</li>
<li><p>å¦‚æœæ˜¯<code>DELETION</code>ï¼Œåˆ™åšç›¸åçš„æ“ä½œï¼Œåˆ é™¤å­å…ƒç´ ã€‚</p>
</li>
<li><p>å¦‚æœæ˜¯<code>UPDATE</code>ï¼Œåˆ™éœ€è¦ä½¿ç”¨æ›´æ”¹åçš„propsæ›´æ–°ç°æœ‰DOMèŠ‚ç‚¹ã€‚æˆ‘ä»¬å°†åœ¨è¿™ä¸ª<code>updateDom</code>å‡½æ•°ä¸­å®Œæˆè¿™äº›æ“ä½œã€‚å°†æ—§Fiberä¸­çš„propsä¸æ–°Fiberä¸­çš„propsè¿›è¡Œæ¯”è¾ƒï¼Œå»æ‰ä¸å­˜åœ¨çš„propï¼Œè®¾ç½®æ–°çš„æˆ–æ›´æ¢çš„propã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœpropä»¥<code>on</code>å‰ç¼€å¼€å¤´ï¼Œæˆ‘ä»¬å°†ä»¥ä¸åŒçš„æ–¹å¼å¤„ç†å®ƒï¼šå¦‚æœevent handlerå‘ç”Ÿäº†æ›´æ”¹ï¼Œæˆ‘ä»¬å°†å…¶ä»èŠ‚ç‚¹ä¸­åˆ é™¤ï¼Œç„¶åå†æ·»åŠ æ–°çš„handlerã€‚</p>
</li>
</ul>
<pre><code class="hljs language-js"><span class="hljs-keyword">const</span> <span class="hljs-title function_">isEvent</span> = key =&gt; key.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">&quot;on&quot;</span>)
<span class="hljs-keyword">const</span> <span class="hljs-title function_">isProperty</span> = key =&gt;
      key !== <span class="hljs-string">&quot;children&quot;</span> &amp;&amp; !<span class="hljs-title function_">isEvent</span>(key)
<span class="hljs-keyword">const</span> <span class="hljs-title function_">isNew</span> = (<span class="hljs-params">prev, next</span>) =&gt; <span class="hljs-function"><span class="hljs-params">key</span> =&gt;</span>
    prev[key] !== next[key]
<span class="hljs-keyword">const</span> <span class="hljs-title function_">isGone</span> = (<span class="hljs-params">prev, next</span>) =&gt; <span class="hljs-function"><span class="hljs-params">key</span> =&gt;</span> !(key <span class="hljs-keyword">in</span> next)
  
<span class="hljs-keyword">function</span> <span class="hljs-title function_">updateDom</span>(<span class="hljs-params">dom, prevProps, nextProps</span>) {
  <span class="hljs-comment">// Remove old properties</span>
  <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(prevProps)
    .<span class="hljs-title function_">filter</span>(isProperty)
    .<span class="hljs-title function_">filter</span>(<span class="hljs-title function_">isGone</span>(prevProps, nextProps))
    .<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">name</span> =&gt;</span> {
      dom[name] = <span class="hljs-string">&quot;&quot;</span>
  })

  <span class="hljs-comment">// Set new or changed properties</span>
  <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(nextProps)
    .<span class="hljs-title function_">filter</span>(isProperty)
    .<span class="hljs-title function_">filter</span>(<span class="hljs-title function_">isNew</span>(prevProps, nextProps))
    .<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">name</span> =&gt;</span> {
      dom[name] = nextProps[name]
  })
  
  <span class="hljs-comment">// Add event listeners</span>
  <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(nextProps)
    .<span class="hljs-title function_">filter</span>(isEvent)
    .<span class="hljs-title function_">filter</span>(<span class="hljs-title function_">isNew</span>(prevProps, nextProps))
    .<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">name</span> =&gt;</span> {
      <span class="hljs-keyword">const</span> eventType = name
        .<span class="hljs-title function_">toLowerCase</span>()
        .<span class="hljs-title function_">substring</span>(<span class="hljs-number">2</span>)
      dom.<span class="hljs-title function_">addEventListener</span>(
        eventType,
        nextProps[name]
      )
  })
}
</code></pre>
</div></div></div></article></div></main><footer class="flex flex-col items-center justify-center leading-8 text-sm w-full py-2 border-t text-skin-muted"><p>Designed &amp; developed by<a class="ml-1 text-yellow" target="_blank" href="https://github.com/mrrs878" rel="noreferrer">Mr.RS</a></p><p>Â©<!-- --> <!-- -->2022</p></footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"title":"(ç¿»è¯‘)åˆ›å»ºä½ è‡ªå·±çš„React","tags":["React.js"],"categories":"React.js","description":"\u003e åŸæ–‡é“¾æ¥:https://pomb.us/build-your-own-react/\n\n# Build your own React\n\næˆ‘ä»¬å°†ä»å¤´å¼€å§‹é‡å†™Reactã€‚ ä¸€æ­¥æ­¥ã€‚ éµå¾ªçœŸå®çš„Reactä»£ç ä¸­çš„æ¶æ„ï¼Œä½†æ²¡æœ‰æ‰€æœ‰çš„ä¼˜åŒ–å’Œéå¿…è¦çš„åŠŸèƒ½ã€‚\n\nå¦‚æœæ‚¨é˜…è¯»è¿‡[æˆ‘ä»¥å‰çš„ä»»ä½•â€œæ„å»ºè‡ªå·±çš„Reactâ€æ–‡ç« ](https://engineering.hexacta.com/didact-lear","createDate":"2020-11-02 14:25:18","updateDate":"2020-11-11 15:00:53","body":"\u003cblockquote\u003e\n\u003cp\u003eåŸæ–‡é“¾æ¥:\u003ca href=\"https://pomb.us/build-your-own-react/\"\u003ehttps://pomb.us/build-your-own-react/\u003c/a\u003e\u003c/p\u003e\n\u003c/blockquote\u003e\n\n      \u003ch1\u003e\n        \u003cspan class=\"prefix\"\u003e\u003c/span\u003e\n        \u003cspan class=\"content\"\u003eBuild your own React\u003c/span\u003e\n        \u003cspan class=\"suffix\"\u003e\u003c/span\u003e\n      \u003c/h1\u003e\n    \u003cp\u003eæˆ‘ä»¬å°†ä»å¤´å¼€å§‹é‡å†™Reactã€‚ ä¸€æ­¥æ­¥ã€‚ éµå¾ªçœŸå®çš„Reactä»£ç ä¸­çš„æ¶æ„ï¼Œä½†æ²¡æœ‰æ‰€æœ‰çš„ä¼˜åŒ–å’Œéå¿…è¦çš„åŠŸèƒ½ã€‚\u003c/p\u003e\n\u003cp\u003eå¦‚æœæ‚¨é˜…è¯»è¿‡\u003ca href=\"https://engineering.hexacta.com/didact-learning-how-react-works-by-building-it-from-scratch-51007984e5c5\"\u003eæˆ‘ä»¥å‰çš„ä»»ä½•â€œæ„å»ºè‡ªå·±çš„Reactâ€æ–‡ç« \u003c/a\u003eï¼Œä¸åŒä¹‹å¤„åœ¨äºè¯¥æ–‡ç« åŸºäºReact 16.8ï¼Œå› æ­¤æˆ‘ä»¬ç°åœ¨å¯ä»¥ä½¿ç”¨\u003ccode\u003ehook\u003c/code\u003eå¹¶åˆ é™¤æ‰€æœ‰ä¸\u003ccode\u003eclass\u003c/code\u003eç›¸å…³çš„ä»£ç ã€‚\u003c/p\u003e\n\u003cp\u003eæ‚¨å¯ä»¥åœ¨æ—§åšå®¢æ–‡ç« ä¸­æ‰¾åˆ°å†å²è®°å½•ï¼Œå¹¶åœ¨\u003ca href=\"https://github.com/pomber/didact\"\u003eDidactä»“åº“\u003c/a\u003eä¸­æ‰¾åˆ°ä»£ç ã€‚ è¿˜æœ‰ä¸€ä¸ªæ¼”è®²æ¶‰åŠç›¸åŒçš„å†…å®¹ã€‚\u003c/p\u003e\n\u003cp\u003eä»¥ä¸‹è¿™äº›éƒ½æ˜¯æˆ‘ä»¬å°†ä¸€ä¸€æ·»åŠ åˆ°æˆ‘ä»¬çš„Reactç‰ˆæœ¬ä¸­çš„å†…å®¹ï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eç¬¬ä¸€æ­¥: \u003ccode\u003ecreateElement\u003c/code\u003e å‡½æ•°\u003c/li\u003e\n\u003cli\u003eç¬¬äºŒæ­¥: \u003ccode\u003erender\u003c/code\u003e å‡½æ•°\u003c/li\u003e\n\u003cli\u003eç¬¬ä¸‰æ­¥: Concurrent Mode\u003c/li\u003e\n\u003cli\u003eç¬¬å››æ­¥: Fibers\u003c/li\u003e\n\u003cli\u003eç¬¬äº”æ­¥: Render and Commit Phases\u003c/li\u003e\n\u003cli\u003eç¬¬å…­æ­¥: Reconciliation\u003c/li\u003e\n\u003cli\u003eç¬¬ä¸ƒæ­¥: å‡½æ•°å¼ç»„ä»¶\u003c/li\u003e\n\u003cli\u003eç¬¬å…«æ­¥: Hooks\u003c/li\u003e\n\u003c/ul\u003e\n\n      \u003ch2\u003e\n        \u003cspan class=\"prefix\"\u003e\u003c/span\u003e\n        \u003cspan class=\"content\"\u003eç¬¬é›¶æ­¥\u003c/span\u003e\n        \u003cspan class=\"suffix\"\u003e\u003c/span\u003e\n      \u003c/h2\u003e\n    \u003cp\u003eå¦‚æœæ‚¨å·²ç»å¯¹Reactï¼ŒJSXå’ŒDOMèŠ‚ç‚¹çš„å·¥ä½œæ–¹å¼æœ‰äº†å¾ˆå¥½çš„äº†è§£ï¼Œåˆ™å¯ä»¥è·³è¿‡æ­¤æ­¥éª¤ã€‚é¦–å…ˆè®©æˆ‘ä»¬å›é¡¾ä¸€äº›åŸºæœ¬æ¦‚å¿µï¼Œæˆ‘ä»¬å°†ä½¿ç”¨åªæœ‰ä¸‰è¡Œä»£ç çš„Reactåº”ç”¨ç¨‹åºï¼šç¬¬ä¸€ä¸ªå®šä¹‰ä¸€ä¸ªReactèŠ‚ç‚¹ï¼Œä¸‹ä¸€ä¸ªä»DOMè·å–ä¸€ä¸ªèŠ‚ç‚¹ï¼Œæœ€åä¸€ä¸ªå°†ReactèŠ‚ç‚¹æ¸²æŸ“åˆ°å®¹å™¨ä¸­ã€‚ç„¶åï¼Œæˆ‘ä»¬ä¼šåˆ é™¤æ‰€æœ‰ç‰¹å®šäºReactçš„ä»£ç å°†å…¶æ›¿æ¢ä¸ºåŸå§‹JavaScriptã€‚\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003e\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e element = \u003cspan class=\"language-xml\"\u003e\u003cspan class=\"hljs-tag\"\u003e\u0026lt;\u003cspan class=\"hljs-name\"\u003eh1\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003etitle\u003c/span\u003e=\u003cspan class=\"hljs-string\"\u003e\u0026quot;foo\u0026quot;\u003c/span\u003e\u0026gt;\u003c/span\u003eHello\u003cspan class=\"hljs-tag\"\u003e\u0026lt;/\u003cspan class=\"hljs-name\"\u003eh1\u003c/span\u003e\u0026gt;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e container = \u003cspan class=\"hljs-variable language_\"\u003edocument\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003egetElementById\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;root\u0026quot;\u003c/span\u003e)\n\u003cspan class=\"hljs-title class_\"\u003eReactDOM\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003erender\u003c/span\u003e(element, container)\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eåœ¨ç¬¬ä¸€è¡Œä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨JSXå®šä¹‰äº†èŠ‚ç‚¹ã€‚ å®ƒä¸æ˜¯æœ‰æ•ˆçš„JavaScriptï¼Œå› æ­¤è¦ç”¨åŸç”ŸJSå–ä»£å®ƒã€‚é€šè¿‡Babelç­‰æ„å»ºå·¥å…·ï¼ŒJSXè½¬æ¢ä¸ºJSã€‚ è½¬æ¢é€šå¸¸å¾ˆç®€å•ï¼šä½¿ç”¨å¯¹\u003ccode\u003ecreateElement\u003c/code\u003eçš„è°ƒç”¨æ¥æ›¿æ¢æ ‡ç­¾å†…çš„ä»£ç ï¼Œå¹¶å°†æ ‡ç­¾\u003ccode\u003etype\u003c/code\u003eã€\u003ccode\u003eprops\u003c/code\u003eã€\u003ccode\u003echildren\u003c/code\u003eä½œä¸ºå‚æ•°ä¼ é€’ã€‚\u003ccode\u003eReact.createElement\u003c/code\u003eæ ¹æ®å…¶å‚æ•°åˆ›å»ºä¸€ä¸ªå¯¹è±¡ï¼Œé™¤äº†ä¸€äº›éªŒè¯ä¹‹å¤–ï¼Œè¿™å°±æ˜¯å…¨éƒ¨ã€‚ å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥å®‰å…¨åœ°å°†å‡½æ•°è°ƒç”¨æ›¿æ¢ä¸ºå…¶è¾“å‡ºã€‚\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003e\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e element = \u003cspan class=\"language-xml\"\u003e\u003cspan class=\"hljs-tag\"\u003e\u0026lt;\u003cspan class=\"hljs-name\"\u003eh1\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003etitle\u003c/span\u003e=\u003cspan class=\"hljs-string\"\u003e\u0026quot;foo\u0026quot;\u003c/span\u003e\u0026gt;\u003c/span\u003eHello\u003cspan class=\"hljs-tag\"\u003e\u0026lt;/\u003cspan class=\"hljs-name\"\u003eh1\u003c/span\u003e\u0026gt;\u003c/span\u003e\u003c/span\u003e\n\nğŸ‘‡\n\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e element = \u003cspan class=\"hljs-title class_\"\u003eReact\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003ecreateElement\u003c/span\u003e(\n  \u003cspan class=\"hljs-string\"\u003e\u0026quot;h1\u0026quot;\u003c/span\u003e,\n  { \u003cspan class=\"hljs-attr\"\u003etitle\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\u0026quot;foo\u0026quot;\u003c/span\u003e },\n  \u003cspan class=\"hljs-string\"\u003e\u0026quot;Hello\u0026quot;\u003c/span\u003e\n)\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eè¿™å°±æ˜¯ä¸€ä¸ªèŠ‚ç‚¹ï¼Œä¸€ä¸ªå…·æœ‰ä¸¤ä¸ªå±æ€§çš„å¯¹è±¡ï¼š\u003ccode\u003etype\u003c/code\u003eå’Œ\u003ccode\u003eprops\u003c/code\u003eï¼ˆå—¯ï¼Œ\u003ca href=\"https://github.com/facebook/react/blob/f4cc45ce962adc9f307690e1d5cfa28a288418eb/packages/react/src/ReactElement.js#L111\"\u003eå®ƒæœ‰æ›´å¤šçš„å±æ€§\u003c/a\u003eï¼Œä½†æ˜¯æˆ‘ä»¬åªå…³å¿ƒè¿™ä¸¤ä¸ªå±æ€§ï¼‰ã€‚\u003ccode\u003etype\u003c/code\u003eæ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œç”¨äºæŒ‡å®šæˆ‘ä»¬è¦åˆ›å»ºçš„DOMèŠ‚ç‚¹çš„ç±»å‹ï¼Œå®ƒæ˜¯æ‚¨è¦åˆ›å»ºHTMLèŠ‚ç‚¹æ—¶ä¼ é€’ç»™\u003ccode\u003edocument.createElement\u003c/code\u003eçš„\u003ccode\u003etagName\u003c/code\u003eã€‚ å®ƒä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œä½†æˆ‘ä»¬å°†å…¶ç•™ç»™æ­¥éª¤VIIã€‚\u003ccode\u003eprops\u003c/code\u003eæ˜¯å¦ä¸€ä¸ªå¯¹è±¡ï¼Œå®ƒå…·æœ‰JSXå±æ€§ä¸­çš„æ‰€æœ‰é”®å’Œå€¼ã€‚ å®ƒè¿˜æœ‰ä¸€ä¸ªç‰¹æ®Šçš„å±æ€§ï¼š\u003ccode\u003echildren\u003c/code\u003eã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œ\u003ccode\u003echildren\u003c/code\u003eæ˜¯å­—ç¬¦ä¸²ï¼Œä½†é€šå¸¸æ˜¯åŒ…å«æ›´å¤šèŠ‚ç‚¹çš„æ•°ç»„ï¼ˆè¿™å°±æ˜¯ä¸ºä»€ä¹ˆèŠ‚ç‚¹ä¹Ÿæ˜¯æ ‘çš„åŸå› ï¼‰ã€‚\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003e\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e element = {\n  \u003cspan class=\"hljs-attr\"\u003etype\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\u0026quot;h1\u0026quot;\u003c/span\u003e,\n  \u003cspan class=\"hljs-attr\"\u003eprops\u003c/span\u003e: {\n    \u003cspan class=\"hljs-attr\"\u003etitle\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\u0026quot;foo\u0026quot;\u003c/span\u003e,\n    \u003cspan class=\"hljs-attr\"\u003echildren\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\u0026quot;Hello\u0026quot;\u003c/span\u003e,\n  },\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eæˆ‘ä»¬éœ€è¦æ›¿æ¢çš„å¦ä¸€éƒ¨åˆ†Reactä»£ç æ˜¯å¯¹\u003ccode\u003eReactDOM.render\u003c/code\u003eçš„è°ƒç”¨ã€‚\u003ccode\u003erender\u003c/code\u003eæ˜¯Reactæ›´æ–°DOMçš„åœ°æ–¹ï¼Œç°åœ¨ç”¨æˆ‘ä»¬è‡ªå·±çš„ä»£ç è¿›è¡Œæ“ä½œã€‚\u003c/p\u003e\n\u003cp\u003eé¦–å…ˆï¼Œæˆ‘ä»¬ä½¿ç”¨èŠ‚ç‚¹\u003ccode\u003etype\u003c/code\u003eï¼ˆåœ¨æœ¬ä¾‹ä¸­ä¸º\u003ccode\u003eh1\u003c/code\u003eï¼‰åˆ›å»ºä¸€ä¸ª\u003ccode\u003enode*\u003c/code\u003eã€‚ç„¶åï¼Œæˆ‘ä»¬å°†æ‰€æœ‰èŠ‚ç‚¹å±æ€§åˆ†é…ç»™è¯¥èŠ‚ç‚¹ã€‚ è¿™é‡Œåªæœ‰ä¸€ä¸ª\u003ccode\u003etitle\u003c/code\u003eã€‚*ä¸ºé¿å…æ··æ·†ï¼Œæˆ‘å°†ä½¿ç”¨\u003ccode\u003eelement\u003c/code\u003eæ¥æŒ‡ä»£ReactèŠ‚ç‚¹ï¼Œå¹¶ä½¿ç”¨\u003ccode\u003enode\u003c/code\u003eæ¥æŒ‡ä»£DOMèŠ‚ç‚¹ã€‚\u003c/p\u003e\n\u003cp\u003eç„¶åï¼Œæˆ‘ä»¬ä¸º\u003ccode\u003echildren\u003c/code\u003eåˆ›å»ºèŠ‚ç‚¹ã€‚ æˆ‘ä»¬åªæœ‰ä¸€ä¸ªå­—ç¬¦ä¸²ä½œä¸º\u003ccode\u003echildren\u003c/code\u003eï¼Œå› æ­¤æˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªæ–‡æœ¬èŠ‚ç‚¹ã€‚ä½¿ç”¨\u003ccode\u003etextNode\u003c/code\u003eè€Œä¸æ˜¯è®¾ç½®\u003ccode\u003einnerText\u003c/code\u003eå°†å…è®¸æˆ‘ä»¬ä»¥åä»¥ç›¸åŒçš„æ–¹å¼å¯¹å¾…æ‰€æœ‰èŠ‚ç‚¹ã€‚å¦è¯·æ³¨æ„ï¼Œæˆ‘ä»¬åƒè®¾ç½®\u003ccode\u003eh1\u003c/code\u003eæ ‡é¢˜ä¸€æ ·è®¾ç½®\u003ccode\u003enodeValue\u003c/code\u003eï¼Œå°±åƒå­—ç¬¦ä¸²ä¸­å¸¦æœ‰\u003ccode\u003eprops: {nodeValue: \u0026quot;hello\u0026quot;}\u003c/code\u003eã€‚æœ€åï¼Œæˆ‘ä»¬å°†\u003ccode\u003etextNode\u003c/code\u003eæ·»åŠ åˆ°\u003ccode\u003eh1\u003c/code\u003eå¹¶å°†\u003ccode\u003eh1\u003c/code\u003eæ·»åŠ åˆ°\u003ccode\u003econtainer\u003c/code\u003eã€‚\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003e\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e element = {\n  \u003cspan class=\"hljs-attr\"\u003etype\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\u0026quot;h1\u0026quot;\u003c/span\u003e,\n  \u003cspan class=\"hljs-attr\"\u003eprops\u003c/span\u003e: {\n    \u003cspan class=\"hljs-attr\"\u003etitle\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\u0026quot;foo\u0026quot;\u003c/span\u003e,\n    \u003cspan class=\"hljs-attr\"\u003echildren\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\u0026quot;Hello\u0026quot;\u003c/span\u003e,\n  },\n}\n\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e container = \u003cspan class=\"hljs-variable language_\"\u003edocument\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003egetElementById\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;root\u0026quot;\u003c/span\u003e)\n\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e node = \u003cspan class=\"hljs-variable language_\"\u003edocument\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003ecreateElement\u003c/span\u003e(element.\u003cspan class=\"hljs-property\"\u003etype\u003c/span\u003e)\nnode[\u003cspan class=\"hljs-string\"\u003e\u0026quot;title\u0026quot;\u003c/span\u003e] = element.\u003cspan class=\"hljs-property\"\u003eprops\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003etitle\u003c/span\u003e\n\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e text = \u003cspan class=\"hljs-variable language_\"\u003edocument\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003ecreateTextNode\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;\u0026quot;\u003c/span\u003e)\ntext[\u003cspan class=\"hljs-string\"\u003e\u0026quot;nodeValue\u0026quot;\u003c/span\u003e] = element.\u003cspan class=\"hljs-property\"\u003eprops\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003echildren\u003c/span\u003e\n\nnode.\u003cspan class=\"hljs-title function_\"\u003eappendChild\u003c/span\u003e(text)\ncontainer.\u003cspan class=\"hljs-title function_\"\u003eappendChild\u003c/span\u003e(node)\n\u003c/code\u003e\u003c/pre\u003e\n\n      \u003ch2\u003e\n        \u003cspan class=\"prefix\"\u003e\u003c/span\u003e\n        \u003cspan class=\"content\"\u003eç¬¬ä¸€æ­¥: createElement å‡½æ•°\u003c/span\u003e\n        \u003cspan class=\"suffix\"\u003e\u003c/span\u003e\n      \u003c/h2\u003e\n    \u003cp\u003eç°åœ¨ï¼Œè®©æˆ‘ä»¬åˆ‡æ¢åˆ°å¦ä¸€ä¸ªAppï¼šè‡ªå·±å®ç°çš„ç®€æ˜“Reactã€‚\u003c/p\u003e\n\u003cp\u003eé¦–å…ˆï¼Œä»ç¼–å†™\u003ccode\u003ecreateElement\u003c/code\u003eå¼€å§‹ï¼Œå°†JSXè½¬æ¢ä¸ºJSã€‚æ­£å¦‚åœ¨ä¸Šä¸€æ­¥ä¸­çœ‹åˆ°çš„ï¼Œ\u003ccode\u003eelement\u003c/code\u003eæ˜¯å…·æœ‰ç±»å‹å’Œå±æ€§çš„å¯¹è±¡ã€‚\u003ccode\u003ecreateElement\u003c/code\u003eå”¯ä¸€éœ€è¦åšçš„å°±æ˜¯åˆ›å»ºè¯¥å¯¹è±¡ã€‚\u003c/p\u003e\n\u003cp\u003eå› ä¸º\u003ccode\u003echildren\u003c/code\u003eä¹Ÿå¯ä»¥åŒ…å«åŸå§‹æ•°æ®ç±»å‹ï¼Œæ¯”å¦‚å­—ç¬¦ä¸²æˆ–æ•°å­—ï¼Œæ‰€ä»¥å¯¹ä¸æ˜¯\u003ccode\u003eobject\u003c/code\u003eçš„\u003ccode\u003echild\u003c/code\u003eåˆ›å»ºç‰¹æ®ŠèŠ‚ç‚¹ç±»å‹ï¼š\u003ccode\u003eTEXT_ELEMENT\u003c/code\u003eã€‚è¿™æ ·åšæ˜¯å› ä¸ºå¯ä»¥ç®€åŒ–ä»£ç ã€‚å¯¹äºæˆ‘ä»¬çš„åº“ï¼Œæˆ‘æ›´å–œæ¬¢ç®€å•è€Œä¸æ˜¯é«˜æ€§èƒ½ä»£ç ã€‚\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003e\u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003ecreateTextElement\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003etext\u003c/span\u003e) {\n  \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e {\n    \u003cspan class=\"hljs-attr\"\u003etype\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\u0026quot;TEXT_ELEMENT\u0026quot;\u003c/span\u003e,\n    \u003cspan class=\"hljs-attr\"\u003eprops\u003c/span\u003e: {\n      \u003cspan class=\"hljs-attr\"\u003enodeValue\u003c/span\u003e: text,\n      \u003cspan class=\"hljs-attr\"\u003echildren\u003c/span\u003e: [],\n    },\n  }\n}\n\n\u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003ecreateElement\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003etype, props, ...children\u003c/span\u003e) {\n  \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e {\n    type,\n    \u003cspan class=\"hljs-attr\"\u003eprops\u003c/span\u003e: {\n      ...props,\n      \u003cspan class=\"hljs-attr\"\u003echildren\u003c/span\u003e: children.\u003cspan class=\"hljs-title function_\"\u003emap\u003c/span\u003e(\u003cspan class=\"hljs-function\"\u003e(\u003cspan class=\"hljs-params\"\u003echild\u003c/span\u003e) =\u0026gt;\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003etypeof\u003c/span\u003e child === \u003cspan class=\"hljs-string\"\u003e\u0026quot;object\u0026quot;\u003c/span\u003e\n        ? child\n        : \u003cspan class=\"hljs-title function_\"\u003ecreateTextElement\u003c/span\u003e(child)\n      ),\n    },\n  }\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eç›®å‰Babelä»ç„¶ä½¿ç”¨\u003ccode\u003eReact.createElement\u003c/code\u003eï¼Œä¸ºäº†æ›¿æ¢å®ƒï¼Œè®©æˆ‘ä»¬ç»™è‡ªå·±çš„åº“èµ·ä¸ªåå­—ã€‚æˆ‘ä»¬éœ€è¦ä¸€ä¸ªå¬èµ·æ¥åƒReactçš„åå­—ï¼Œä½†ä¹Ÿæš—ç¤ºäº†å®ƒçš„æ•™å­¦ç›®çš„ï¼Œæˆ‘ä»¬å«å®ƒ\u003ccode\u003eDidact\u003c/code\u003eã€‚\u003c/p\u003e\n\u003cp\u003eè®©æˆ‘ä»¬ä½¿ç”¨\u003ccode\u003e/** @jsx Didact.createElement */\u003c/code\u003eæ¥å‘Šè¯‰Babelä½¿ç”¨æˆ‘ä»¬è‡ªå·±çš„\u003ccode\u003ecreateElement\u003c/code\u003eæ¥è½¬æ¢jsxä»£ç ï¼š\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003e\u003cspan class=\"hljs-comment\"\u003e/** \u003cspan class=\"hljs-doctag\"\u003e@jsx\u003c/span\u003e Didact.createElement */\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e element = (\n  \u003cspan class=\"language-xml\"\u003e\u003cspan class=\"hljs-tag\"\u003e\u0026lt;\u003cspan class=\"hljs-name\"\u003ediv\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003eid\u003c/span\u003e=\u003cspan class=\"hljs-string\"\u003e\u0026quot;foo\u0026quot;\u003c/span\u003e\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"hljs-tag\"\u003e\u0026lt;\u003cspan class=\"hljs-name\"\u003ea\u003c/span\u003e\u0026gt;\u003c/span\u003ebar\u003cspan class=\"hljs-tag\"\u003e\u0026lt;/\u003cspan class=\"hljs-name\"\u003ea\u003c/span\u003e\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"hljs-tag\"\u003e\u0026lt;\u003cspan class=\"hljs-name\"\u003eb\u003c/span\u003e /\u0026gt;\u003c/span\u003e\n  \u003cspan class=\"hljs-tag\"\u003e\u0026lt;/\u003cspan class=\"hljs-name\"\u003ediv\u003c/span\u003e\u0026gt;\u003c/span\u003e\u003c/span\u003e\n)\n\u003c/code\u003e\u003c/pre\u003e\n\n      \u003ch2\u003e\n        \u003cspan class=\"prefix\"\u003e\u003c/span\u003e\n        \u003cspan class=\"content\"\u003eç¬¬äºŒæ­¥ï¼šredner å‡½æ•°\u003c/span\u003e\n        \u003cspan class=\"suffix\"\u003e\u003c/span\u003e\n      \u003c/h2\u003e\n    \u003cp\u003eé¦–å…ˆä½¿ç”¨elementçš„\u003ccode\u003etype\u003c/code\u003eåˆ›å»ºDOMèŠ‚ç‚¹ï¼Œç„¶åå°†æ–°elementæ·»åŠ åˆ°\u003ccode\u003econtainer\u003c/code\u003eä¸­ã€‚ç„¶åå¯¹æ¯ä¸ª\u003ccode\u003echild\u003c/code\u003eé€’å½’è°ƒç”¨\u003ccode\u003erender\u003c/code\u003eï¼š\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003e\u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003erender\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003eelement, container\u003c/span\u003e) {\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e dom = \u003cspan class=\"hljs-variable language_\"\u003edocument\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003ecreateElement\u003c/span\u003e(element.\u003cspan class=\"hljs-property\"\u003etype\u003c/span\u003e);\n\n  element.\u003cspan class=\"hljs-property\"\u003eprops\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003echildren\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003eforEach\u003c/span\u003e(\u003cspan class=\"hljs-function\"\u003e(\u003cspan class=\"hljs-params\"\u003echild\u003c/span\u003e) =\u0026gt;\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003erender\u003c/span\u003e(child, dom))\n\n  container.\u003cspan class=\"hljs-title function_\"\u003eappendChild\u003c/span\u003e(dom);\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eå…¶æ¬¡ï¼Œæˆ‘ä»¬è¿˜éœ€è¦å¤„ç†æ–‡æœ¬èŠ‚ç‚¹ï¼Œå¦‚æœelementç±»å‹ä¸º\u003ccode\u003eTEXT_ELEMENT\u003c/code\u003eï¼Œæˆ‘ä»¬å°†åˆ›å»ºæ–‡æœ¬èŠ‚ç‚¹è€Œä¸æ˜¯æ™®é€šèŠ‚ç‚¹ï¼š\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003e\u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003erender\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003eelement, container\u003c/span\u003e) {\n  \u003cspan class=\"hljs-comment\"\u003e// ...\u003c/span\u003e\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e dom = element.\u003cspan class=\"hljs-property\"\u003etype\u003c/span\u003e === \u003cspan class=\"hljs-string\"\u003e\u0026quot;TEXT_ELEMENT\u0026quot;\u003c/span\u003e\n    ? \u003cspan class=\"hljs-variable language_\"\u003edocument\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003ecreateTextNode\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;\u0026quot;\u003c/span\u003e)\n    : \u003cspan class=\"hljs-variable language_\"\u003edocument\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003ecreateElmenet\u003c/span\u003e(element.\u003cspan class=\"hljs-property\"\u003etype\u003c/span\u003e);\n  \u003cspan class=\"hljs-comment\"\u003e//...\u003c/span\u003e\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eæœ€åï¼Œå°†\u003ccode\u003eprops\u003c/code\u003eåˆ†é…ç»™elementï¼š\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003e\u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003erender\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003eelement, container\u003c/span\u003e) {\n  \u003cspan class=\"hljs-comment\"\u003e// ...\u003c/span\u003e\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003eisProperty\u003c/span\u003e = key =\u0026gt; key === \u003cspan class=\"hljs-string\"\u003e\u0026quot;children\u0026quot;\u003c/span\u003e;\n  \u003cspan class=\"hljs-title class_\"\u003eReflect\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003eownkeys\u003c/span\u003e(element.\u003cspan class=\"hljs-property\"\u003eprops\u003c/span\u003e)\n    .\u003cspan class=\"hljs-title function_\"\u003efilter\u003c/span\u003e(isProperty)\n    .\u003cspan class=\"hljs-title function_\"\u003eforEach\u003c/span\u003e(\u003cspan class=\"hljs-function\"\u003e(\u003cspan class=\"hljs-params\"\u003ename\u003c/span\u003e) =\u0026gt;\u003c/span\u003e dom[name] = element.\u003cspan class=\"hljs-property\"\u003eprops\u003c/span\u003e[name]);\n  \u003cspan class=\"hljs-comment\"\u003e// ...\u003c/span\u003e\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eè¿™æ ·çš„è¯ï¼Œæˆ‘ä»¬å°±æœ‰äº†ä¸€ä¸ªå¯ä»¥å°†JSXå‘ˆç°åˆ°DOMçš„åº“ï¼š\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003e\u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003ecreateTextElement\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003etext\u003c/span\u003e) {\n  \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e {\n    \u003cspan class=\"hljs-attr\"\u003etype\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\u0026quot;TEXT_ELEMENT\u0026quot;\u003c/span\u003e,\n    \u003cspan class=\"hljs-attr\"\u003eprops\u003c/span\u003e: {\n      \u003cspan class=\"hljs-attr\"\u003enodeValue\u003c/span\u003e: text,\n      \u003cspan class=\"hljs-attr\"\u003echildren\u003c/span\u003e: []\n    }\n  };\n}\n\n\u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003ecreateElement\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003etype, props, ...children\u003c/span\u003e) {\n  \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e {\n    type,\n    \u003cspan class=\"hljs-attr\"\u003eprops\u003c/span\u003e: {\n      ...props,\n      \u003cspan class=\"hljs-attr\"\u003echildren\u003c/span\u003e: children.\u003cspan class=\"hljs-title function_\"\u003emap\u003c/span\u003e(\u003cspan class=\"hljs-function\"\u003e(\u003cspan class=\"hljs-params\"\u003echild\u003c/span\u003e) =\u0026gt;\u003c/span\u003e\n        \u003cspan class=\"hljs-keyword\"\u003etypeof\u003c/span\u003e child === \u003cspan class=\"hljs-string\"\u003e\u0026quot;object\u0026quot;\u003c/span\u003e ? child : \u003cspan class=\"hljs-title function_\"\u003ecreateTextElement\u003c/span\u003e(child)\n      )\n    }\n  };\n}\n\n\u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003erender\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003eelement, container\u003c/span\u003e) {\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e dom =\n    element.\u003cspan class=\"hljs-property\"\u003etype\u003c/span\u003e === \u003cspan class=\"hljs-string\"\u003e\u0026quot;TEXT_ELEMENT\u0026quot;\u003c/span\u003e\n      ? \u003cspan class=\"hljs-variable language_\"\u003edocument\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003ecreateTextNode\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;\u0026quot;\u003c/span\u003e)\n      : \u003cspan class=\"hljs-variable language_\"\u003edocument\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003ecreateElement\u003c/span\u003e(element.\u003cspan class=\"hljs-property\"\u003etype\u003c/span\u003e);\n\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003eisProperty\u003c/span\u003e = (\u003cspan class=\"hljs-params\"\u003ekey\u003c/span\u003e) =\u0026gt; key !== \u003cspan class=\"hljs-string\"\u003e\u0026quot;children\u0026quot;\u003c/span\u003e;\n  \u003cspan class=\"hljs-title class_\"\u003eReflect\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003eownKeys\u003c/span\u003e(element.\u003cspan class=\"hljs-property\"\u003eprops\u003c/span\u003e)\n    .\u003cspan class=\"hljs-title function_\"\u003efilter\u003c/span\u003e(isProperty)\n    .\u003cspan class=\"hljs-title function_\"\u003eforEach\u003c/span\u003e(\u003cspan class=\"hljs-function\"\u003e(\u003cspan class=\"hljs-params\"\u003ename\u003c/span\u003e) =\u0026gt;\u003c/span\u003e (dom[name] = element.\u003cspan class=\"hljs-property\"\u003eprops\u003c/span\u003e[name]));\n\n  element.\u003cspan class=\"hljs-property\"\u003eprops\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003echildren\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003emap\u003c/span\u003e(\u003cspan class=\"hljs-function\"\u003e(\u003cspan class=\"hljs-params\"\u003echild\u003c/span\u003e) =\u0026gt;\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003erender\u003c/span\u003e(child, dom));\n\n  container.\u003cspan class=\"hljs-title function_\"\u003eappendChild\u003c/span\u003e(dom);\n}\n\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eDidact\u003c/span\u003e = {\n  createElement,\n  render\n};\n\n\u003cspan class=\"hljs-comment\"\u003e/** \u003cspan class=\"hljs-doctag\"\u003e@jsx\u003c/span\u003e Didact.createElement */\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e element = (\n  \u003cspan class=\"language-xml\"\u003e\u003cspan class=\"hljs-tag\"\u003e\u0026lt;\u003cspan class=\"hljs-name\"\u003ediv\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003eid\u003c/span\u003e=\u003cspan class=\"hljs-string\"\u003e\u0026quot;foo\u0026quot;\u003c/span\u003e\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"hljs-tag\"\u003e\u0026lt;\u003cspan class=\"hljs-name\"\u003eh1\u003c/span\u003e\u0026gt;\u003c/span\u003eHello STEP1-STEP2\u003cspan class=\"hljs-tag\"\u003e\u0026lt;/\u003cspan class=\"hljs-name\"\u003eh1\u003c/span\u003e\u0026gt;\u003c/span\u003e\n  \u003cspan class=\"hljs-tag\"\u003e\u0026lt;/\u003cspan class=\"hljs-name\"\u003ediv\u003c/span\u003e\u0026gt;\u003c/span\u003e\u003c/span\u003e\n);\n\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e container = \u003cspan class=\"hljs-variable language_\"\u003edocument\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003equerySelector\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;#step1\u0026quot;\u003c/span\u003e);\n\n\u003cspan class=\"hljs-title class_\"\u003eDidact\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003erender\u003c/span\u003e(element, container);\n\u003c/code\u003e\u003c/pre\u003e\n\n      \u003ch2\u003e\n        \u003cspan class=\"prefix\"\u003e\u003c/span\u003e\n        \u003cspan class=\"content\"\u003eç¬¬ä¸‰æ­¥Concurrent Mode\u003c/span\u003e\n        \u003cspan class=\"suffix\"\u003e\u003c/span\u003e\n      \u003c/h2\u003e\n    \u003cp\u003eåœ¨å¼€å§‹æ·»åŠ æ›´å¤šä»£ç ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦é‡æ„ã€‚\u003c/p\u003e\n\u003cp\u003eä¸Šé¢çš„é€’å½’è°ƒç”¨å­˜åœ¨é—®é¢˜ã€‚å¼€å§‹æ¸²æŸ“åï¼Œç›´åˆ°æ¸²æŸ“å®Œå®Œæ•´çš„elementæ ‘ï¼Œæˆ‘ä»¬æ‰ä¼šåœæ­¢ã€‚ å¦‚æœelementæ ‘å¾ˆå¤§ï¼Œåˆ™å¯èƒ½ä¼šé˜»å¡ä¸»çº¿ç¨‹å¤ªé•¿æ—¶é—´ã€‚ é‚£ä¹ˆå¦‚æœæµè§ˆå™¨éœ€è¦æ‰§è¡Œé«˜ä¼˜å…ˆçº§çš„æ“ä½œï¼ˆä¾‹å¦‚å¤„ç†ç”¨æˆ·è¾“å…¥æˆ–ä¿æŒåŠ¨ç”»æµç•…ï¼‰ï¼Œåˆ™å®ƒå¿…é¡»ç­‰åˆ°æ¸²æŸ“å®Œæˆä¸ºæ­¢ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å°†å·¥ä½œåˆ†æˆå‡ ä¸ªå°éƒ¨åˆ†ï¼Œåœ¨å®Œæˆæ¯ä¸ªå•å…ƒåï¼Œå¦‚æœéœ€è¦æ‰§è¡Œå…¶ä»–ä»»ä½•æ“ä½œï¼Œæˆ‘ä»¬å°†è®©æµè§ˆå™¨ä¸­æ–­æ¸²æŸ“ã€‚\u003c/p\u003e\n\u003cp\u003eæˆ‘ä»¬ä½¿ç”¨\u003ccode\u003erequestIdleCallback\u003c/code\u003eè¿›è¡Œå¾ªç¯ã€‚ æ‚¨å¯ä»¥å°†\u003ccode\u003erequestIdleCallback\u003c/code\u003eçœ‹ä½œ\u003ccode\u003esetTimeout\u003c/code\u003eï¼Œä½†æ˜¯æµè§ˆå™¨å°†åœ¨ä¸»çº¿ç¨‹ç©ºé—²æ—¶è¿è¡Œå›è°ƒï¼Œè€Œä¸æ˜¯å‘Šè¯‰å®ƒä½•æ—¶è¿è¡Œã€‚Reactä¸å†ä½¿ç”¨\u003ccode\u003erequestIdleCallback\u003c/code\u003eï¼Œç°åœ¨å®ƒä½¿ç”¨scheduler packageã€‚ ä½†æ˜¯å¯¹äºæ­¤ç”¨ä¾‹ï¼Œå®ƒåœ¨æ¦‚å¿µä¸Šæ˜¯ç›¸åŒçš„ã€‚\u003ccode\u003erequestIdleCallback\u003c/code\u003eè¿˜ä¸ºæˆ‘ä»¬æä¾›äº†\u003ccode\u003edeadline\u003c/code\u003eå‚æ•°ã€‚ æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å®ƒæ¥æ£€æŸ¥æµè§ˆå™¨éœ€è¦å†æ¬¡æ§åˆ¶ä¹‹å‰æœ‰å¤šå°‘æ—¶é—´ã€‚\u003c/p\u003e\n\u003cp\u003eè¦å¼€å§‹ä½¿ç”¨å¾ªç¯ï¼Œæˆ‘ä»¬éœ€è¦è®¾ç½®ç¬¬ä¸€ä¸ªå·¥ä½œå•å…ƒï¼Œç„¶åç¼–å†™ä¸€ä¸ª\u003ccode\u003eperformUnitOfWork\u003c/code\u003eå‡½æ•°ï¼Œè¯¥å‡½æ•°ä¸ä»…æ‰§è¡Œå·¥ä½œï¼Œè¿˜è¿”å›ä¸‹ä¸€ä¸ªå·¥ä½œå•å…ƒã€‚\u003c/p\u003e\n\n      \u003ch2\u003e\n        \u003cspan class=\"prefix\"\u003e\u003c/span\u003e\n        \u003cspan class=\"content\"\u003eç¬¬å››æ­¥Fiber\u003c/span\u003e\n        \u003cspan class=\"suffix\"\u003e\u003c/span\u003e\n      \u003c/h2\u003e\n    \u003cp\u003eè¦ç»„ç»‡å·¥ä½œå•å…ƒï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªæ•°æ®ç»“æ„--Fiberæ ‘ã€‚æˆ‘ä»¬å°†ä¸ºæ¯ä¸ªå…ƒç´ åˆ†é…ä¸€æ ¹Fiberï¼Œå¹¶ä¸”æ¯ä¸ªFiberå°†æˆä¸ºä¸€ä¸ªå·¥ä½œå•å…ƒã€‚\u003c/p\u003e\n\u003cp\u003eå‡å¦‚æˆ‘ä»¬è¦æ¸²æŸ“å¦‚ä¸‹çš„elementæ ‘ï¼Œé‚£ä¹ˆFiberæ ‘å°±å¦‚ä¸‹æ‰€ç¤ºï¼š\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003e\u003cspan class=\"hljs-title class_\"\u003eDidact\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003erender\u003c/span\u003e(\n  \u003cspan class=\"language-xml\"\u003e\u003cspan class=\"hljs-tag\"\u003e\u0026lt;\u003cspan class=\"hljs-name\"\u003ediv\u003c/span\u003e\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"hljs-tag\"\u003e\u0026lt;\u003cspan class=\"hljs-name\"\u003eh1\u003c/span\u003e\u0026gt;\u003c/span\u003e\n      \u003cspan class=\"hljs-tag\"\u003e\u0026lt;\u003cspan class=\"hljs-name\"\u003ep\u003c/span\u003e /\u0026gt;\u003c/span\u003e\n      \u003cspan class=\"hljs-tag\"\u003e\u0026lt;\u003cspan class=\"hljs-name\"\u003ea\u003c/span\u003e /\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"hljs-tag\"\u003e\u0026lt;/\u003cspan class=\"hljs-name\"\u003eh1\u003c/span\u003e\u0026gt;\u003c/span\u003e\n    \u003cspan class=\"hljs-tag\"\u003e\u0026lt;\u003cspan class=\"hljs-name\"\u003eh2\u003c/span\u003e /\u0026gt;\u003c/span\u003e\n  \u003cspan class=\"hljs-tag\"\u003e\u0026lt;/\u003cspan class=\"hljs-name\"\u003ediv\u003c/span\u003e\u0026gt;\u003c/span\u003e\u003c/span\u003e,\n  container\n)\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003cimg src=\"https://pomb.us/static/a88a3ec01855349c14302f6da28e2b0c/ac667/fiber1.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003cp\u003eåœ¨renderå‡½æ•°ä¸­ï¼Œæˆ‘ä»¬å°†åˆ›å»ºroot Fiberå¹¶å°†å…¶è®¾ç½®ä¸º\u003ccode\u003enextUnitOfWork\u003c/code\u003eã€‚ å‰©ä¸‹çš„å·¥ä½œå°†åœ¨\u003ccode\u003eperformUnitOfWork\u003c/code\u003eå‡½æ•°ä¸Šè¿›è¡Œï¼Œæˆ‘ä»¬å°†ä¸ºæ¯ä¸ªFiberåšä¸‰ä»¶äº‹ï¼š\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eå°†elementæ·»åŠ åˆ°DOM\u003c/li\u003e\n\u003cli\u003eä¸ºelementçš„å­ä»£åˆ›å»ºFilber\u003c/li\u003e\n\u003cli\u003eé€‰æ‹©ä¸‹ä¸€ä¸ªå·¥ä½œå•å…ƒ\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eè¯¥æ•°æ®ç»“æ„çš„ç›®æ ‡ä¹‹ä¸€æ˜¯ä½¿æŸ¥æ‰¾ä¸‹ä¸€ä¸ªå·¥ä½œå•å…ƒå˜å¾—å®¹æ˜“ã€‚ è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæ¯ä¸ªFiberéƒ½é“¾æ¥åˆ°å…¶ç¬¬ä¸€ä¸ªå­èŠ‚ç‚¹ã€ä¸‹ä¸€ä¸ªå…„å¼ŸèŠ‚ç‚¹å’Œçˆ¶èŠ‚ç‚¹ã€‚\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eå½“æˆ‘ä»¬å®Œæˆå¯¹å½“å‰Fiberçš„å·¥ä½œæ—¶ï¼Œå¦‚æœæœ‰childï¼Œé‚£ä¹ˆè¯¥childå¯¹åº”çš„Fiberå°†æ˜¯ä¸‹ä¸€ä¸ªå·¥ä½œå•å…ƒã€‚åœ¨æˆ‘ä»¬çš„ç¤ºä¾‹ä¸­ï¼Œå½“æˆ‘ä»¬å®Œæˆdiv Fiberçš„å·¥ä½œæ—¶ï¼Œä¸‹ä¸€ä¸ªå·¥ä½œå•å…ƒå°†æ˜¯h1 Fiberã€‚\u003c/li\u003e\n\u003cli\u003eå¦‚æœå½“å‰Fiberæ²¡æœ‰childï¼Œæˆ‘ä»¬å°†å…¶siblingä½œä¸ºä¸‹ä¸€ä¸ªå·¥ä½œå•å…ƒã€‚ä¾‹å¦‚ï¼Œp Fiberæ²¡æœ‰childï¼Œå› æ­¤æˆ‘ä»¬åœ¨å®Œæˆå½“å‰ä¹‹åä¸‹ä¸€ä¸ªå·¥ä½œå•å…ƒå°†æ˜¯h1ã€‚\u003c/li\u003e\n\u003cli\u003eå¦‚æœå½“å‰Fiberæ—¢æ²¡æœ‰childä¹Ÿæ²¡æœ‰siblingï¼Œé‚£ä¹ˆæˆ‘ä»¬å»â€œuncleâ€ï¼šçˆ¶æ¯çš„å…„å¼ŸèŠ‚ç‚¹ã€‚ å°±åƒç¤ºä¾‹ä¸­çš„aå’Œh2 Fiberä¸€æ ·ã€‚\u003c/li\u003e\n\u003cli\u003eå¦‚æœparentæ²¡æœ‰siblingï¼Œæˆ‘ä»¬ä¼šä¸æ–­æ£€æŸ¥parentï¼Œç›´åˆ°æ‰¾åˆ°æœ‰siblingçš„parentï¼Œæˆ–è€…ç›´åˆ°æ‰¾åˆ°rootã€‚ å¦‚æœåˆ°è¾¾rootï¼Œåˆ™æ„å‘³ç€æˆ‘ä»¬å·²ç»å®Œæˆäº†æ­¤æ¸²æŸ“çš„æ‰€æœ‰å·¥ä½œã€‚\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eç°åœ¨ï¼Œè®©æˆ‘ä»¬å¼€å§‹å†™ä»£ç ã€‚\u003c/p\u003e\n\u003cp\u003eé¦–å…ˆï¼Œæ›´æ”¹\u003ccode\u003erender\u003c/code\u003eå‡½æ•°å¹¶åˆ›å»º\u003ccode\u003ecreateDom\u003c/code\u003eå‡½æ•°\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003e\u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003erender\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003eelement, container\u003c/span\u003e) {\n  nextUnitOfWork = {\n    \u003cspan class=\"hljs-attr\"\u003edom\u003c/span\u003e: container,\n    \u003cspan class=\"hljs-attr\"\u003eprops\u003c/span\u003e: {\n      \u003cspan class=\"hljs-attr\"\u003echildren\u003c/span\u003e: [element],\n    },\n  }\n}\n\n\u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003ecreateDom\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003efiber\u003c/span\u003e) {\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e dom =\n    fiber.\u003cspan class=\"hljs-property\"\u003etype\u003c/span\u003e == \u003cspan class=\"hljs-string\"\u003e\u0026quot;TEXT_ELEMENT\u0026quot;\u003c/span\u003e\n      ? \u003cspan class=\"hljs-variable language_\"\u003edocument\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003ecreateTextNode\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;\u0026quot;\u003c/span\u003e)\n      : \u003cspan class=\"hljs-variable language_\"\u003edocument\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003ecreateElement\u003c/span\u003e(fiber.\u003cspan class=\"hljs-property\"\u003etype\u003c/span\u003e)\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003eisProperty\u003c/span\u003e = key =\u0026gt; key !== \u003cspan class=\"hljs-string\"\u003e\u0026quot;children\u0026quot;\u003c/span\u003e\n  \u003cspan class=\"hljs-title class_\"\u003eObject\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003ekeys\u003c/span\u003e(fiber.\u003cspan class=\"hljs-property\"\u003eprops\u003c/span\u003e)\n    .\u003cspan class=\"hljs-title function_\"\u003efilter\u003c/span\u003e(isProperty)\n    .\u003cspan class=\"hljs-title function_\"\u003eforEach\u003c/span\u003e(\u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-params\"\u003ename\u003c/span\u003e =\u0026gt;\u003c/span\u003e {\n      dom[name] = fiber.\u003cspan class=\"hljs-property\"\u003eprops\u003c/span\u003e[name]\n    })\n  \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e dom\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eç„¶åï¼Œå½“æµè§ˆå™¨å‡†å¤‡å°±ç»ªæ—¶ï¼Œå®ƒå°†è°ƒç”¨æˆ‘ä»¬çš„\u003ccode\u003eworkLoop\u003c/code\u003eï¼Œæˆ‘ä»¬å°†ä»\u003ccode\u003eroot\u003c/code\u003eå¼€å§‹æ‰§è¡Œæ¸²æŸ“ã€‚\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003e\u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003eworkLoop\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003edeadline\u003c/span\u003e) {\n  \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e shouldYield = \u003cspan class=\"hljs-literal\"\u003efalse\u003c/span\u003e\n  \u003cspan class=\"hljs-keyword\"\u003ewhile\u003c/span\u003e (nextUnitOfWork \u0026amp;\u0026amp; !shouldYield) {\n    nextUnitOfWork = \u003cspan class=\"hljs-title function_\"\u003eperformUnitOfWork\u003c/span\u003e(\n      nextUnitOfWork\n    )\n    shouldYield = deadline.\u003cspan class=\"hljs-title function_\"\u003etimeRemaining\u003c/span\u003e() \u0026lt; \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e\n  }\n  \u003cspan class=\"hljs-title function_\"\u003erequestIdleCallback\u003c/span\u003e(workLoop)\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eé¦–å…ˆï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ–°nodeå¹¶å°†å…¶æ·»åŠ åˆ°DOMã€‚æˆ‘ä»¬åœ¨\u003ccode\u003efibre.dom\u003c/code\u003eå±æ€§ä¸­è·Ÿè¸ªDOMèŠ‚ç‚¹ã€‚\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003e\u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003eperformUnitOfWork\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003efiber\u003c/span\u003e) {\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (!fiber.\u003cspan class=\"hljs-property\"\u003edom\u003c/span\u003e) {\n    fiber.\u003cspan class=\"hljs-property\"\u003edom\u003c/span\u003e = \u003cspan class=\"hljs-title function_\"\u003ecreateDom\u003c/span\u003e(fiber)\n  }\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (fiber.\u003cspan class=\"hljs-property\"\u003eparent\u003c/span\u003e) {\n    fiber.\u003cspan class=\"hljs-property\"\u003eparent\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003edom\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003eappendChild\u003c/span\u003e(fiber.\u003cspan class=\"hljs-property\"\u003edom\u003c/span\u003e)\n  }\n  \u003cspan class=\"hljs-comment\"\u003e// TODO create new fibers\u003c/span\u003e\n  \u003cspan class=\"hljs-comment\"\u003e// TODO return next unit of work\u003c/span\u003e\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eç„¶åå¯¹æ¯ä¸ª\u003ccode\u003echild\u003c/code\u003eåˆ›å»ºFiber\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003e\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e elements = fiber.\u003cspan class=\"hljs-property\"\u003eprops\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003echildren\u003c/span\u003e\n  \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e index = \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e\n  \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e prevSibling = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e\n  \u003cspan class=\"hljs-keyword\"\u003ewhile\u003c/span\u003e (index \u0026lt; elements.\u003cspan class=\"hljs-property\"\u003elength\u003c/span\u003e) {\n    \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e element = elements[index]\n    \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e newFiber = {\n      \u003cspan class=\"hljs-attr\"\u003etype\u003c/span\u003e: element.\u003cspan class=\"hljs-property\"\u003etype\u003c/span\u003e,\n      \u003cspan class=\"hljs-attr\"\u003eprops\u003c/span\u003e: element.\u003cspan class=\"hljs-property\"\u003eprops\u003c/span\u003e,\n      \u003cspan class=\"hljs-attr\"\u003eparent\u003c/span\u003e: fiber,\n      \u003cspan class=\"hljs-attr\"\u003edom\u003c/span\u003e: \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e,\n    }\n  }\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eç„¶åå°†å…¶æ·»åŠ åˆ°Fiberæ ‘ä¸­ï¼Œå°†å…¶è®¾ç½®ä¸º\u003ccode\u003echild\u003c/code\u003eè¿˜æ˜¯\u003ccode\u003esibing\u003c/code\u003eï¼Œå…·ä½“å–å†³äºå®ƒæ˜¯å¦æ˜¯ç¬¬ä¸€ä¸ªchildã€‚\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003e\u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (index === \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e) {\n      fiber.\u003cspan class=\"hljs-property\"\u003echild\u003c/span\u003e = newFiber\n    } \u003cspan class=\"hljs-keyword\"\u003eelse\u003c/span\u003e {\n      prevSibling.\u003cspan class=\"hljs-property\"\u003esibling\u003c/span\u003e = newFiber\n    }\n}\nprevSibling = newFiber\nindex++\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eæœ€åï¼Œæˆ‘ä»¬æŒ‰ç…§child â˜ sibling â˜ uncleæ¥é€‰æ‹©ä¸‹ä¸€å·¥ä½œå•å…ƒã€‚\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003e\u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (fiber.\u003cspan class=\"hljs-property\"\u003echild\u003c/span\u003e) {\n  \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e fiber.\u003cspan class=\"hljs-property\"\u003echild\u003c/span\u003e\n}\n\u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e nextFiber = fiber\n\u003cspan class=\"hljs-keyword\"\u003ewhile\u003c/span\u003e (nextFiber) {\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (nextFiber.\u003cspan class=\"hljs-property\"\u003esibling\u003c/span\u003e) {\n    \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e nextFiber.\u003cspan class=\"hljs-property\"\u003esibling\u003c/span\u003e\n  }\n  nextFiber = nextFiber.\u003cspan class=\"hljs-property\"\u003eparent\u003c/span\u003e\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eå®Œæ•´çš„ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003e\u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003eperformUnitOfWork\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003efiber\u003c/span\u003e) {\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (!fiber.\u003cspan class=\"hljs-property\"\u003edom\u003c/span\u003e) {\n    fiber.\u003cspan class=\"hljs-property\"\u003edom\u003c/span\u003e = \u003cspan class=\"hljs-title function_\"\u003ecreateDom\u003c/span\u003e(fiber)\n  }\n\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (fiber.\u003cspan class=\"hljs-property\"\u003eparent\u003c/span\u003e) {\n    fiber.\u003cspan class=\"hljs-property\"\u003eparent\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003edom\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003eappendChild\u003c/span\u003e(fiber.\u003cspan class=\"hljs-property\"\u003edom\u003c/span\u003e)\n  }\n\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e elements = fiber.\u003cspan class=\"hljs-property\"\u003eprops\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003echildren\u003c/span\u003e\n  \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e index = \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e\n  \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e prevSibling = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e\n\n  \u003cspan class=\"hljs-keyword\"\u003ewhile\u003c/span\u003e (index \u0026lt; elements.\u003cspan class=\"hljs-property\"\u003elength\u003c/span\u003e) {\n    \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e element = elements[index]\n\n    \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e newFiber = {\n      \u003cspan class=\"hljs-attr\"\u003etype\u003c/span\u003e: element.\u003cspan class=\"hljs-property\"\u003etype\u003c/span\u003e,\n      \u003cspan class=\"hljs-attr\"\u003eprops\u003c/span\u003e: element.\u003cspan class=\"hljs-property\"\u003eprops\u003c/span\u003e,\n      \u003cspan class=\"hljs-attr\"\u003eparent\u003c/span\u003e: fiber,\n      \u003cspan class=\"hljs-attr\"\u003edom\u003c/span\u003e: \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e,\n    }\n\n    \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (index === \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e) {\n      fiber.\u003cspan class=\"hljs-property\"\u003echild\u003c/span\u003e = newFiber\n    } \u003cspan class=\"hljs-keyword\"\u003eelse\u003c/span\u003e {\n      prevSibling.\u003cspan class=\"hljs-property\"\u003esibling\u003c/span\u003e = newFiber\n    }\n\n    prevSibling = newFiber\n    index++\n  }\n\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (fiber.\u003cspan class=\"hljs-property\"\u003echild\u003c/span\u003e) {\n    \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e fiber.\u003cspan class=\"hljs-property\"\u003echild\u003c/span\u003e\n  }\n  \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e nextFiber = fiber\n  \u003cspan class=\"hljs-keyword\"\u003ewhile\u003c/span\u003e (nextFiber) {\n    \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (nextFiber.\u003cspan class=\"hljs-property\"\u003esibling\u003c/span\u003e) {\n      \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e nextFiber.\u003cspan class=\"hljs-property\"\u003esibling\u003c/span\u003e\n    }\n    nextFiber = nextFiber.\u003cspan class=\"hljs-property\"\u003eparent\u003c/span\u003e\n  }\n}\n\u003c/code\u003e\u003c/pre\u003e\n\n      \u003ch2\u003e\n        \u003cspan class=\"prefix\"\u003e\u003c/span\u003e\n        \u003cspan class=\"content\"\u003eæäº¤æ›´æ”¹\u003c/span\u003e\n        \u003cspan class=\"suffix\"\u003e\u003c/span\u003e\n      \u003c/h2\u003e\n    \u003cp\u003eæˆ‘ä»¬è¿˜æœ‰ä¸€ä¸ªé—®é¢˜ã€‚æ¯æ¬¡å¤„ç†ä¸€ä¸ªå…ƒç´ æ—¶ï¼Œæˆ‘ä»¬éƒ½ä¼šå‘DOMæ·»åŠ ä¸€ä¸ªæ–°èŠ‚ç‚¹ã€‚è€Œä¸”ï¼Œè¯·è®°ä½ï¼Œæµè§ˆå™¨å¯èƒ½ä¼šåœ¨æˆ‘ä»¬å®Œæˆæ•´ä¸ªæ ‘çš„æ¸²æŸ“ä¹‹å‰ä¸­æ–­æˆ‘ä»¬çš„å·¥ä½œã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œç”¨æˆ·å°†çœ‹åˆ°ä¸€ä¸ªä¸å®Œæ•´çš„UIã€‚æˆ‘ä»¬ä¸æƒ³è¿™æ ·ã€‚\u003c/p\u003e\n\u003cp\u003eå› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦ä»\u003ccode\u003eperformUnitOfWork\u003c/code\u003eé‡Œåˆ é™¤æ”¹å˜DOMçš„éƒ¨åˆ†ã€‚ç›¸åï¼Œæˆ‘ä»¬å°†è·Ÿè¸ªFiber treeã€‚æˆ‘ä»¬ç§°å®ƒä¸º\u003ccode\u003ewipRoot\u003c/code\u003eã€‚ä¸€æ—¦æˆ‘ä»¬å®Œæˆäº†æ‰€æœ‰çš„å·¥ä½œ(æˆ‘ä»¬çŸ¥é“å®ƒæ˜¯å› ä¸ºæ²¡æœ‰ä¸‹ä¸€ä¸ªå·¥ä½œå•å…ƒ)ï¼Œæˆ‘ä»¬å°±å°†æ•´ä¸ªFiber treeæäº¤ç»™DOMã€‚æˆ‘ä»¬åœ¨\u003ccode\u003ecommitRoot\u003c/code\u003eå‡½æ•°ä¸­å®Œæˆã€‚åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬é€’å½’åœ°å°†æ‰€æœ‰èŠ‚ç‚¹è¿½åŠ åˆ°domã€‚\u003c/p\u003e\n\n      \u003ch2\u003e\n        \u003cspan class=\"prefix\"\u003e\u003c/span\u003e\n        \u003cspan class=\"content\"\u003eReconciliation\u003c/span\u003e\n        \u003cspan class=\"suffix\"\u003e\u003c/span\u003e\n      \u003c/h2\u003e\n    \u003cp\u003eåˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬åªå‘DOMæ·»åŠ äº†ä¸€äº›ä¸œè¥¿ï¼Œé‚£ä¹ˆæ›´æ–°æˆ–åˆ é™¤èŠ‚ç‚¹å‘¢? \u003c/p\u003e\n\u003cp\u003eè¿™å°±æ˜¯æˆ‘ä»¬ç°åœ¨è¦åšçš„ï¼Œæˆ‘ä»¬éœ€è¦å°†\u003ccode\u003erender\u003c/code\u003eå‡½æ•°æ¥æ”¶åˆ°çš„å…ƒç´ ä¸æäº¤ç»™DOMçš„æœ€åä¸€ä¸ªFiber treeè¿›è¡Œæ¯”è¾ƒã€‚å› æ­¤ï¼Œåœ¨å®Œæˆ\u003ccode\u003ecommit\u003c/code\u003eä¹‹åï¼Œæˆ‘ä»¬éœ€è¦ä¿å­˜å¯¹\u003cstrong\u003eæœ€åä¸€ä¸ªæäº¤åˆ°DOMçš„Fiber tree\u003c/strong\u003eçš„å¼•ç”¨ã€‚æˆ‘ä»¬ç§°ä¹‹ä¸º\u003ccode\u003ecurrentRoot\u003c/code\u003eã€‚æˆ‘ä»¬è¿˜åœ¨æ¯Fiberä¸­åŠ å…¥äº†\u003ccode\u003ealternate\u003c/code\u003e, æ­¤å±æ€§æ˜¯åˆ°æ—§Fiberçš„é“¾æ¥ï¼Œå³æˆ‘ä»¬åœ¨ä¸Šä¸€ä¸ªæäº¤é˜¶æ®µæäº¤ç»™DOMçš„Fiberã€‚\u003c/p\u003e\n\u003cp\u003eç°åœ¨è®©æˆ‘ä»¬ä»åˆ›å»ºæ–°Fiberçš„\u003ccode\u003eperformUnitOfWork\u003c/code\u003eå‡½æ•°ä¸­æå–ä»£ç åˆ°\u003ccode\u003ereconcileChildren\u003c/code\u003e ã€‚åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å°†\u003ccode\u003ereconcile\u003c/code\u003eæ—§çš„fiberså’Œæ–°å…ƒç´ ã€‚æˆ‘ä»¬åŒæ—¶éå†æ—§Fiber tree(\u003ccode\u003ewipFiber.alternate\u003c/code\u003e)çš„å­å…ƒç´ å’Œæˆ‘ä»¬æƒ³è¦reconciliationçš„å…ƒç´ æ•°ç»„ã€‚å¦‚æœæˆ‘ä»¬å¿½ç•¥åŒæ—¶éå†æ•°ç»„å’Œé“¾è¡¨æ‰€éœ€çš„æ‰€æœ‰æ ·æ¿æ–‡ä»¶ï¼Œé‚£ä¹ˆæˆ‘ä»¬åªå‰©ä¸‹whileä¸­æœ€é‡è¦çš„éƒ¨åˆ†:oldFiberå’Œelementã€‚å…ƒç´ æ˜¯æˆ‘ä»¬æƒ³è¦æ¸²æŸ“åˆ°DOMçš„ä¸œè¥¿ï¼Œè€ŒoldFiberæ˜¯æˆ‘ä»¬ä¸Šæ¬¡æ¸²æŸ“çš„ä¸œè¥¿ã€‚æˆ‘ä»¬éœ€è¦æ¯”è¾ƒå®ƒä»¬ï¼Œçœ‹çœ‹æ˜¯å¦éœ€è¦å¯¹DOMè¿›è¡Œæ›´æ”¹ã€‚\u003c/p\u003e\n\u003cp\u003eä¸ºäº†æ¯”è¾ƒå®ƒä»¬ï¼Œæˆ‘ä»¬ä½¿ç”¨ç±»å‹:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eå¦‚æœæ—§çš„Fiberå’Œæ–°å…ƒç´ å…·æœ‰ç›¸åŒçš„ç±»å‹ï¼Œæˆ‘ä»¬å¯ä»¥ä¿ç•™DOMèŠ‚ç‚¹ï¼Œå¹¶ä½¿ç”¨æ–°çš„é“å…·æ›´æ–°å®ƒ\u003c/li\u003e\n\u003cli\u003eå¦‚æœç±»å‹ä¸åŒï¼Œå¹¶ä¸”æœ‰ä¸€ä¸ªæ–°å…ƒç´ ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªæ–°çš„DOMèŠ‚ç‚¹\u003c/li\u003e\n\u003cli\u003eå¦‚æœç±»å‹ä¸åŒï¼Œå¹¶ä¸”æœ‰ä¸€ä¸ªæ—§çš„å…‰çº¤ï¼Œæˆ‘ä»¬éœ€è¦åˆ é™¤æ—§çš„èŠ‚ç‚¹\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eè¿™é‡ŒReactä¹Ÿä½¿ç”¨keyï¼Œè¿™æ ·å¯ä»¥æ›´å¥½çš„\u003ccode\u003ereconcile\u003c/code\u003eã€‚ä¾‹å¦‚ï¼Œå®ƒæ£€æµ‹å­å…ƒç´ åœ¨å…ƒç´ æ•°ç»„ä¸­çš„ä½ç½®å‘ç”Ÿäº†å˜åŒ–ã€‚\u003c/p\u003e\n\u003cp\u003eå½“æ—§Fiberå’Œå…ƒç´ å…·æœ‰ç›¸åŒçš„ç±»å‹æ—¶ï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ–°Fiberï¼Œä½¿DOMèŠ‚ç‚¹ä¸æ—§Fiberä¿æŒä¸€è‡´ï¼Œä½¿propsä¸elementä¿æŒä¸€è‡´ã€‚æˆ‘ä»¬è¿˜å‘Fiber æ·»åŠ äº†ä¸€ä¸ªæ–°å±æ€§:\u003ccode\u003eeffectTag\u003c/code\u003eã€‚æˆ‘ä»¬å°†åœ¨ç¨åçš„\u003ccode\u003ecommit\u003c/code\u003eé˜¶æ®µä½¿ç”¨æ­¤å±æ€§ã€‚\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003e\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e sameType =\n      oldFiber \u0026amp;\u0026amp;\n      element \u0026amp;\u0026amp;\n      element.\u003cspan class=\"hljs-property\"\u003etype\u003c/span\u003e == oldFiber.\u003cspan class=\"hljs-property\"\u003etype\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (sameType) {\n  newFiber = {\n    \u003cspan class=\"hljs-attr\"\u003etype\u003c/span\u003e: oldFiber.\u003cspan class=\"hljs-property\"\u003etype\u003c/span\u003e,\n    \u003cspan class=\"hljs-attr\"\u003eprops\u003c/span\u003e: element.\u003cspan class=\"hljs-property\"\u003eprops\u003c/span\u003e,\n    \u003cspan class=\"hljs-attr\"\u003edom\u003c/span\u003e: oldFiber.\u003cspan class=\"hljs-property\"\u003edom\u003c/span\u003e,\n    \u003cspan class=\"hljs-attr\"\u003eparent\u003c/span\u003e: wipFiber,\n    \u003cspan class=\"hljs-attr\"\u003ealternate\u003c/span\u003e: oldFiber,\n    \u003cspan class=\"hljs-attr\"\u003eeffectTag\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\u0026quot;UPDATE\u0026quot;\u003c/span\u003e,\n  }\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eå¯¹äºelementéœ€è¦ä¸€ä¸ªæ–°DOMèŠ‚ç‚¹çš„æƒ…å†µï¼Œæˆ‘ä»¬ç”¨\u003ccode\u003ePLACEMENT\u003c/code\u003eæ ‡è®°æ ‡è®°æ–°Fiberã€‚\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003e\u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (element \u0026amp;\u0026amp; !sameType) {\n  newFiber = {\n    \u003cspan class=\"hljs-attr\"\u003etype\u003c/span\u003e: element.\u003cspan class=\"hljs-property\"\u003etype\u003c/span\u003e,\n    \u003cspan class=\"hljs-attr\"\u003eprops\u003c/span\u003e: element.\u003cspan class=\"hljs-property\"\u003eprops\u003c/span\u003e,\n    \u003cspan class=\"hljs-attr\"\u003edom\u003c/span\u003e: \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e,\n    \u003cspan class=\"hljs-attr\"\u003eparent\u003c/span\u003e: wipFiber,\n    \u003cspan class=\"hljs-attr\"\u003ealternate\u003c/span\u003e: \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e,\n    \u003cspan class=\"hljs-attr\"\u003eeffectTag\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\u0026quot;PLACEMENT\u0026quot;\u003c/span\u003e,\n  }\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eå¯¹äºéœ€è¦åˆ é™¤èŠ‚ç‚¹çš„æƒ…å†µï¼Œæˆ‘ä»¬æ²¡æœ‰æ–°çš„Fiberï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨æ—§Fiberä¸Šæ·»åŠ effectæ ‡ç­¾ã€‚ä½†æ˜¯å½“æˆ‘ä»¬å°†Fiberæ ‘æäº¤åˆ°DOMæ—¶ï¼Œæˆ‘ä»¬ä»æ­£åœ¨è¿›è¡Œçš„æ ¹ç›®å½•æ‰§è¡Œï¼Œå®ƒæ²¡æœ‰æ—§çš„Fiber ã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¸€ä¸ªæ•°ç»„æ¥è·Ÿè¸ªè¦åˆ é™¤çš„èŠ‚ç‚¹ã€‚ç„¶åï¼Œå½“æˆ‘ä»¬å°†æ›´æ”¹æäº¤åˆ°DOMæ—¶ï¼Œæˆ‘ä»¬è¿˜ä½¿ç”¨äº†æ¥è‡ªè¯¥æ•°ç»„çš„Fiberã€‚\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003e\u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (oldFiber \u0026amp;\u0026amp; !sameType) {\n  oldFiber.\u003cspan class=\"hljs-property\"\u003eeffectTag\u003c/span\u003e = \u003cspan class=\"hljs-string\"\u003e\u0026quot;DELETION\u0026quot;\u003c/span\u003e\n  deletions.\u003cspan class=\"hljs-title function_\"\u003epush\u003c/span\u003e(oldFiber)\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eç°åœ¨ï¼Œè®©æˆ‘ä»¬ä¿®æ”¹\u003ccode\u003ecommitWork\u003c/code\u003eå‡½æ•°æ¥å¤„ç†æ–°çš„\u003ccode\u003eeffectTags\u003c/code\u003eã€‚\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003e\u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003ecommitWork\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003efiber\u003c/span\u003e) {\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (!fiber) {\n    \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e\n  }\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (\n    fiber.\u003cspan class=\"hljs-property\"\u003eeffectTag\u003c/span\u003e === \u003cspan class=\"hljs-string\"\u003e\u0026quot;PLACEMENT\u0026quot;\u003c/span\u003e \u0026amp;\u0026amp;\n    fiber.\u003cspan class=\"hljs-property\"\u003edom\u003c/span\u003e != \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e\n  ) {\n    domParent.\u003cspan class=\"hljs-title function_\"\u003eappendChild\u003c/span\u003e(fiber.\u003cspan class=\"hljs-property\"\u003edom\u003c/span\u003e)\n  } \u003cspan class=\"hljs-keyword\"\u003eelse\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (\n      fiber.\u003cspan class=\"hljs-property\"\u003eeffectTag\u003c/span\u003e === \u003cspan class=\"hljs-string\"\u003e\u0026quot;UPDATE\u0026quot;\u003c/span\u003e \u0026amp;\u0026amp;\n      fiber.\u003cspan class=\"hljs-property\"\u003edom\u003c/span\u003e != \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e\n    ) {\n      \u003cspan class=\"hljs-title function_\"\u003eupdateDom\u003c/span\u003e(\n        fiber.\u003cspan class=\"hljs-property\"\u003edom\u003c/span\u003e,\n        fiber.\u003cspan class=\"hljs-property\"\u003ealternate\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eprops\u003c/span\u003e,\n        fiber.\u003cspan class=\"hljs-property\"\u003eprops\u003c/span\u003e\n      )\n    } \u003cspan class=\"hljs-keyword\"\u003eelse\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (fiber.\u003cspan class=\"hljs-property\"\u003eeffectTag\u003c/span\u003e === \u003cspan class=\"hljs-string\"\u003e\u0026quot;DELETION\u0026quot;\u003c/span\u003e) {\n      domParent.\u003cspan class=\"hljs-title function_\"\u003eremoveChild\u003c/span\u003e(fiber.\u003cspan class=\"hljs-property\"\u003edom\u003c/span\u003e)\n  }\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e domParent = fiber.\u003cspan class=\"hljs-property\"\u003eparent\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003edom\u003c/span\u003e\n  domParent.\u003cspan class=\"hljs-title function_\"\u003eappendChild\u003c/span\u003e(fiber.\u003cspan class=\"hljs-property\"\u003edom\u003c/span\u003e)\n  \u003cspan class=\"hljs-title function_\"\u003ecommitWork\u003c/span\u003e(fiber.\u003cspan class=\"hljs-property\"\u003echild\u003c/span\u003e)\n  \u003cspan class=\"hljs-title function_\"\u003ecommitWork\u003c/span\u003e(fiber.\u003cspan class=\"hljs-property\"\u003esibling\u003c/span\u003e)\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cp\u003eå¦‚æœFiberæœ‰ä¸€ä¸ª\u003ccode\u003ePLACEMENT\u003c/code\u003eæ ‡ç­¾ï¼Œä»çˆ¶Fiberå°†DOMèŠ‚ç‚¹é™„åŠ åˆ°èŠ‚ç‚¹ã€‚\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003cp\u003eå¦‚æœæ˜¯\u003ccode\u003eDELETION\u003c/code\u003eï¼Œåˆ™åšç›¸åçš„æ“ä½œï¼Œåˆ é™¤å­å…ƒç´ ã€‚\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003cp\u003eå¦‚æœæ˜¯\u003ccode\u003eUPDATE\u003c/code\u003eï¼Œåˆ™éœ€è¦ä½¿ç”¨æ›´æ”¹åçš„propsæ›´æ–°ç°æœ‰DOMèŠ‚ç‚¹ã€‚æˆ‘ä»¬å°†åœ¨è¿™ä¸ª\u003ccode\u003eupdateDom\u003c/code\u003eå‡½æ•°ä¸­å®Œæˆè¿™äº›æ“ä½œã€‚å°†æ—§Fiberä¸­çš„propsä¸æ–°Fiberä¸­çš„propsè¿›è¡Œæ¯”è¾ƒï¼Œå»æ‰ä¸å­˜åœ¨çš„propï¼Œè®¾ç½®æ–°çš„æˆ–æ›´æ¢çš„propã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœpropä»¥\u003ccode\u003eon\u003c/code\u003eå‰ç¼€å¼€å¤´ï¼Œæˆ‘ä»¬å°†ä»¥ä¸åŒçš„æ–¹å¼å¤„ç†å®ƒï¼šå¦‚æœevent handlerå‘ç”Ÿäº†æ›´æ”¹ï¼Œæˆ‘ä»¬å°†å…¶ä»èŠ‚ç‚¹ä¸­åˆ é™¤ï¼Œç„¶åå†æ·»åŠ æ–°çš„handlerã€‚\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003e\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003eisEvent\u003c/span\u003e = key =\u0026gt; key.\u003cspan class=\"hljs-title function_\"\u003estartsWith\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;on\u0026quot;\u003c/span\u003e)\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003eisProperty\u003c/span\u003e = key =\u0026gt;\n      key !== \u003cspan class=\"hljs-string\"\u003e\u0026quot;children\u0026quot;\u003c/span\u003e \u0026amp;\u0026amp; !\u003cspan class=\"hljs-title function_\"\u003eisEvent\u003c/span\u003e(key)\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003eisNew\u003c/span\u003e = (\u003cspan class=\"hljs-params\"\u003eprev, next\u003c/span\u003e) =\u0026gt; \u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-params\"\u003ekey\u003c/span\u003e =\u0026gt;\u003c/span\u003e\n    prev[key] !== next[key]\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003eisGone\u003c/span\u003e = (\u003cspan class=\"hljs-params\"\u003eprev, next\u003c/span\u003e) =\u0026gt; \u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-params\"\u003ekey\u003c/span\u003e =\u0026gt;\u003c/span\u003e !(key \u003cspan class=\"hljs-keyword\"\u003ein\u003c/span\u003e next)\n  \n\u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003eupdateDom\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003edom, prevProps, nextProps\u003c/span\u003e) {\n  \u003cspan class=\"hljs-comment\"\u003e// Remove old properties\u003c/span\u003e\n  \u003cspan class=\"hljs-title class_\"\u003eObject\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003ekeys\u003c/span\u003e(prevProps)\n    .\u003cspan class=\"hljs-title function_\"\u003efilter\u003c/span\u003e(isProperty)\n    .\u003cspan class=\"hljs-title function_\"\u003efilter\u003c/span\u003e(\u003cspan class=\"hljs-title function_\"\u003eisGone\u003c/span\u003e(prevProps, nextProps))\n    .\u003cspan class=\"hljs-title function_\"\u003eforEach\u003c/span\u003e(\u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-params\"\u003ename\u003c/span\u003e =\u0026gt;\u003c/span\u003e {\n      dom[name] = \u003cspan class=\"hljs-string\"\u003e\u0026quot;\u0026quot;\u003c/span\u003e\n  })\n\n  \u003cspan class=\"hljs-comment\"\u003e// Set new or changed properties\u003c/span\u003e\n  \u003cspan class=\"hljs-title class_\"\u003eObject\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003ekeys\u003c/span\u003e(nextProps)\n    .\u003cspan class=\"hljs-title function_\"\u003efilter\u003c/span\u003e(isProperty)\n    .\u003cspan class=\"hljs-title function_\"\u003efilter\u003c/span\u003e(\u003cspan class=\"hljs-title function_\"\u003eisNew\u003c/span\u003e(prevProps, nextProps))\n    .\u003cspan class=\"hljs-title function_\"\u003eforEach\u003c/span\u003e(\u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-params\"\u003ename\u003c/span\u003e =\u0026gt;\u003c/span\u003e {\n      dom[name] = nextProps[name]\n  })\n  \n  \u003cspan class=\"hljs-comment\"\u003e// Add event listeners\u003c/span\u003e\n  \u003cspan class=\"hljs-title class_\"\u003eObject\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003ekeys\u003c/span\u003e(nextProps)\n    .\u003cspan class=\"hljs-title function_\"\u003efilter\u003c/span\u003e(isEvent)\n    .\u003cspan class=\"hljs-title function_\"\u003efilter\u003c/span\u003e(\u003cspan class=\"hljs-title function_\"\u003eisNew\u003c/span\u003e(prevProps, nextProps))\n    .\u003cspan class=\"hljs-title function_\"\u003eforEach\u003c/span\u003e(\u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-params\"\u003ename\u003c/span\u003e =\u0026gt;\u003c/span\u003e {\n      \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e eventType = name\n        .\u003cspan class=\"hljs-title function_\"\u003etoLowerCase\u003c/span\u003e()\n        .\u003cspan class=\"hljs-title function_\"\u003esubstring\u003c/span\u003e(\u003cspan class=\"hljs-number\"\u003e2\u003c/span\u003e)\n      dom.\u003cspan class=\"hljs-title function_\"\u003eaddEventListener\u003c/span\u003e(\n        eventType,\n        nextProps[name]\n      )\n  })\n}\n\u003c/code\u003e\u003c/pre\u003e\n"}},"__N_SSG":true},"page":"/post/[title]","query":{"title":"(ç¿»è¯‘)åˆ›å»ºä½ è‡ªå·±çš„React"},"buildId":"_q5ru5NemgZT2swXpl15Q","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>
<!DOCTYPE html><html><head><link rel="icon" href="https://mrrsblog.oss-cn-shanghai.aliyuncs.com/avatar.jpg"/><script async="" src="/js/L2Dwidget.min.js"></script><script async="" src="/js/initL2D.js"></script><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><title>Mr.RS的个人博客-JavaScript复习-异步</title><meta name="next-head-count" content="3"/><link rel="preload" href="/_next/static/css/15773988a510c3d3.css" as="style"/><link rel="stylesheet" href="/_next/static/css/15773988a510c3d3.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-b927671265afed5e.js" defer=""></script><script src="/_next/static/chunks/framework-91d7f78b5b4003c8.js" defer=""></script><script src="/_next/static/chunks/main-1e7421553b9673ee.js" defer=""></script><script src="/_next/static/chunks/pages/_app-ca6aae25bc99a05f.js" defer=""></script><script src="/_next/static/chunks/899-1cd3a59abdb8ea18.js" defer=""></script><script src="/_next/static/chunks/pages/post/%5Btitle%5D-d89e1712c82a34ac.js" defer=""></script><script src="/_next/static/6Z6s6-Ql91pBaqq4AHUDJ/_buildManifest.js" defer=""></script><script src="/_next/static/6Z6s6-Ql91pBaqq4AHUDJ/_ssgManifest.js" defer=""></script><script src="/_next/static/6Z6s6-Ql91pBaqq4AHUDJ/_middlewareManifest.js" defer=""></script></head><body><div id="__next" data-reactroot=""><header class="fixed top-0 py-4 left-0 right-0 h-auto px-10 shadow bg-white z-50"><nav><ul class="flex w-auto"><li class="mr-4 hover:text-yellow"><a href="/">首页</a></li><li class="mx-4 hover:text-yellow"><a href="/categories">分类</a></li><li class="mx-4 hover:text-yellow"><a href="/tags">标签</a></li><li class="ml-4 hover:text-yellow"><a href="/timeline">归档</a></li></ul></nav></header><main class="mt-20 mb-4 mx-auto justify-center w-2/3"><div class="mx-auto lg:max-w-5xl md:max-w-3xl"><article class="flex flex-col justify-around pb-16 px-4 mx-auto space-y-10 text-base"><div class="flex flex-col space-y-4"><h1 class="inline pt-10 text-4xl text-skin-primary">JavaScript复习-异步</h1><div class="text-sm space-x-2 text-skin-muted grid grid-cols-5"><span class="flex align-middle"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 inline-block mr-1"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>2021-05-12 10:36:56</span><span class="flex align-middle"><svg class="w-5 h-5 inline-block mr-1" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1903" width="20" height="20"><path d="M257.7 752c2 0 4-0.2 6-0.5L431.9 722c2-0.4 3.9-1.3 5.3-2.8l423.9-423.9c3.9-3.9 3.9-10.2 0-14.1L694.9 114.9c-1.9-1.9-4.4-2.9-7.1-2.9s-5.2 1-7.1 2.9L256.8 538.8c-1.5 1.5-2.4 3.3-2.8 5.3l-29.5 168.2c-1.9 11.1 1.5 21.9 9.4 29.8 6.6 6.4 14.9 9.9 23.8 9.9z m67.4-174.4L687.8 215l73.3 73.3-362.7 362.6-88.9 15.7 15.6-89zM880 836H144c-17.7 0-32 14.3-32 32v36c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-36c0-17.7-14.3-32-32-32z" p-id="1904"></path></svg>2021-06-24 18:47:28</span></div></div><div class="mt-8 flex"><div class="w-full flex-auto custom-markdown-body"><div class="markdown-body" id="write"><p>JavaScript为异步非阻塞，ES6之前主要靠回调函数来实现异步，但由于回调函数容易出现回调地狱等问题，于是ES6+提供了了<code>Generator</code>、<code>Promise</code>、<code>async/await</code>这些API来降低异步编程的难度与复杂度。</p>

      <h2>
        <span class="prefix"></span>
        <span class="content">回调函数</span>
        <span class="suffix"></span>
      </h2>
    <p>回调函数容易出现回调地狱，可读性差</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">ajax</span>(<span class="hljs-params">url, options, onSuccess</span>) {
    <span class="hljs-comment">// ...</span>
}

<span class="hljs-title function_">ajax</span>(<span class="hljs-string">&#x27;/api/xxx&#x27;</span>, {}, <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) {
    <span class="hljs-title function_">ajax</span>(<span class="hljs-string">&#x27;/api/yyy&#x27;</span>, {}, <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) {
        <span class="hljs-title function_">ajax</span>(<span class="hljs-string">&#x27;/api/zzz&#x27;</span>, (), <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) {
        })
    })
})
</code></pre>

      <h3>
        <span class="prefix"></span>
        <span class="content">Generator</span>
        <span class="suffix"></span>
      </h3>
    <p>形式上，<code>generator</code>函数是一个状态机，封装了多个内部状态。执行<code>generator</code>函数会返回一个<strong>遍历器对象</strong></p>
<p>语法上，<code>generator</code>函数是一个普通函数。<code>function</code>关键字与函数名之间有一个<code>*</code>；函数体内使用<code>yield</code>表达式定义不同的内部状态</p>
<p>与普通函数不同，<code>generator</code>函数被调用后<strong>并不执行</strong>，返回的是一个指向内部状态的指针对象，也就是<strong>遍历器对象</strong>。下一步，<strong>必须调用遍历器对象的<code>next</code>方法</strong>使得指针移向下一个状态，也就是说每次调用<code>next</code>方法，内部指针就从函数头部或上一次停下来的地方开始执行，直到遇到下一个<code>yield</code>或<code>return</code></p>
<pre><code class="hljs language-js"><span class="hljs-keyword">function</span>* <span class="hljs-title function_">gen</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">const</span> str1 = <span class="hljs-keyword">yield</span> <span class="hljs-string">&quot;hello&quot;</span>
  <span class="hljs-comment">// str1 = 222</span>
  <span class="hljs-keyword">const</span> str2 = <span class="hljs-keyword">yield</span> <span class="hljs-string">&quot;world&quot;</span>
  <span class="hljs-comment">// str2 = 333</span>
  <span class="hljs-keyword">return</span> str2
}

<span class="hljs-keyword">const</span> iter = <span class="hljs-title function_">gen</span>()
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(iter.<span class="hljs-title function_">next</span>())
<span class="hljs-comment">// { value: &quot;hello&quot;, done: false }</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(iter.<span class="hljs-title function_">next</span>(<span class="hljs-number">222</span>))
<span class="hljs-comment">// { value: &quot;world&quot;, done: false }</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(iter.<span class="hljs-title function_">next</span>(<span class="hljs-number">333</span>))
<span class="hljs-comment">// { value: 333, done: false }</span>
</code></pre>
<p>第一次调用，<code>generator</code>函数开始执行，直到遇到第一个<code>yield</code>表达式为止。<code>next</code>方法返回一个对象，它的<code>value</code>值就是当前<code>yield</code>表达式的值，<code>done</code>的值为<code>false</code></p>
<p>第二次调用，<code>generator</code>从上次<code>yield</code>表达式停下来的地方一直执行到下一个<code>yield</code>表达式 👆 ……</p>
<p>第三次调用，<code>generator</code>函数从上次<code>yield</code>表达式停下来的地方一直执行到<code>return</code>语句，<code>next</code>返回的<code>value</code>值就是<code>return</code>后面表达式的值，<code>done</code>为<code>true</code></p>
<p><code>yield</code>表达式本身没有返回值（或者说总是返回<code>undefined</code>）。<code>next</code>方法可以带一个参数，该参数会被当作<strong>上一个</strong><code>yield</code>表达式的返回值</p>

      <h2>
        <span class="prefix"></span>
        <span class="content">Promise</span>
        <span class="suffix"></span>
      </h2>
    <p>ES6提供的一种异步编程方案</p>
<p>一个<code>Promise</code>对象必然处于以下三种状态：</p>
<ul>
<li>pending，初始状态</li>
<li>fulfilled，成功</li>
<li>rejected，失败</li>
</ul>
<p><code>pending</code>状态的<code>Promise</code>对象可以转换为<code>fulfilled</code>或<code>rejected</code>状态，而且此过程是不可逆的。当状态变更时，<code>then()</code>方法注册的回调就会被调用</p>
<p><code>then()</code> 或者 <code>catch()</code> 的参数期望是函数，传⼊⾮函数则会发⽣值透传<code>(value =&gt; value)</code></p>
<pre><code class="hljs language-js"><span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-number">1</span>)
 .<span class="hljs-title function_">then</span>(<span class="hljs-number">2</span>) <span class="hljs-comment">// .then(1 =&gt; 1)</span>
 .<span class="hljs-title function_">then</span>(<span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-number">3</span>)) <span class="hljs-comment">// .then(1 =&gt; 1)</span>
 .<span class="hljs-title function_">then</span>(<span class="hljs-variable language_">console</span>.<span class="hljs-property">log</span>)
<span class="hljs-comment">// 1</span>
</code></pre>
<pre><code class="hljs language-js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-params">url, options = {}</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> xhr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">XMLHttpRequest</span>();
    xhr.<span class="hljs-title function_">open</span>(options.<span class="hljs-property">method</span> || <span class="hljs-string">&#x27;GET&#x27;</span>, url);
    <span class="hljs-keyword">const</span> headers = { <span class="hljs-string">&#x27;Content-Type&#x27;</span>: <span class="hljs-string">&#x27;application/json&#x27;</span>, ...options.<span class="hljs-property">headers</span> || {} };
    <span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">ownKeys</span>(headers)
      .<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">header</span>) =&gt;</span> xhr.<span class="hljs-title function_">setRequestHeader</span>(header, headers[header]));
    xhr.<span class="hljs-title function_">send</span>(options.<span class="hljs-property">method</span> === <span class="hljs-string">&#x27;POST&#x27;</span> ? <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(options.<span class="hljs-property">data</span> || {}) : <span class="hljs-literal">null</span>);
    xhr.<span class="hljs-property">onerror</span> = <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> <span class="hljs-title function_">reject</span>(e);
    xhr.<span class="hljs-property">onreadystatechange</span> = <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">if</span> (xhr.<span class="hljs-property">readyState</span> === <span class="hljs-title class_">XMLHttpRequest</span>.<span class="hljs-property">DONE</span>
        &amp;&amp; [<span class="hljs-number">200</span>, <span class="hljs-number">201</span>, <span class="hljs-number">301</span>, <span class="hljs-number">302</span>, <span class="hljs-number">304</span>].<span class="hljs-title function_">includes</span>(xhr.<span class="hljs-property">status</span>)) {
        <span class="hljs-title function_">resolve</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(xhr.<span class="hljs-property">responseText</span>));
      }
    };
  });
}
<span class="hljs-title function_">fetch</span>(<span class="hljs-string">&#x27;http://localhost:3004/get&#x27;</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res);
}).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(e);
})
</code></pre>
<pre><code class="hljs language-js"><span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve,reject</span>)=&gt;</span>{
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;1&quot;</span>)
    <span class="hljs-title function_">resolve</span>();
}).<span class="hljs-title function_">then</span>(<span class="hljs-function">()=&gt;</span>{
    <span class="hljs-comment">// 外部第1个then</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;2&quot;</span>)
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve,reject</span>)=&gt;</span>{
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;3&quot;</span>)
        <span class="hljs-title function_">resolve</span>();
    }).<span class="hljs-title function_">then</span>(<span class="hljs-function">()=&gt;</span>{
        <span class="hljs-comment">// 内部第1个then</span>
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;4&quot;</span>)
    }).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-comment">// 内部第2个then</span>
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;5&quot;</span>)
    })
}).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">res</span>)=&gt;</span>{
    <span class="hljs-comment">// 外部第2个then</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;6&quot;</span>)
})
</code></pre>
<p>简单来讲就是then回调的注册需要上一个then里面的同步代码执行完毕</p>
<p>拿上面的代码来讲，当外部第1个then里的resovle()执行完毕后，该Promise的状态已经更改，会将内部第1个then回调添加（注册）到微任务队列中；内部第2个then由于上一个then回调没有执行完毕，因此不会注册。此时外部第1个then里的同步代码执行完毕，会注册外部第2个then回调</p>
<p>整理一下：then回调注册的顺序是：外部第1个then --&gt; 内部第1个then --&gt; 外部第2个then --&gt; 内部第2个then</p>
<p>ps: 如果将外部第1个then里的new Promise(xxx)改为return new Promise(xxx)的话内部第2个then的注册将早于* 外部第2个then*</p>

      <h2>
        <span class="prefix"></span>
        <span class="content">async/await</span>
        <span class="suffix"></span>
      </h2>
    <p>目前来讲，最为优秀的一种异步编程方案，与ES2017提出</p>
<p>实现上是<code>Generator</code>+<code>Promise</code>的语法糖</p>
<p>通过在<code>onFulFilled()</code>里调用<code>next()</code>、在<code>next()</code>里调用<code>onFulfilled()</code>形成一个自执行器，只有当全部代码执行完毕后才会终止</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">fn</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">&#x27;http://localhost:3004/get&#x27;</span>);
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res);
    } <span class="hljs-keyword">catch</span> (e) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(e);
    }
}
</code></pre>
<p><code>async/await</code>原理: <strong>自动执行generator函数</strong></p>
<pre><code class="hljs language-js"><span class="hljs-keyword">const</span> <span class="hljs-title function_">getData</span> = (<span class="hljs-params"></span>) =&gt;
  <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">resolve</span>(<span class="hljs-string">&quot;data&quot;</span>), <span class="hljs-number">1000</span>));

<span class="hljs-keyword">function</span>* <span class="hljs-title function_">testG</span>(<span class="hljs-params"></span>) {
  <span class="hljs-comment">// await被编译成了yield</span>
  <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">yield</span> <span class="hljs-title function_">getData</span>();
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;data: &quot;</span>, data);
  <span class="hljs-keyword">const</span> data2 = <span class="hljs-keyword">yield</span> <span class="hljs-title function_">getData</span>();
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;data2: &quot;</span>, data2);
  <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;success&quot;</span>;
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">asyncToGenerator</span>(<span class="hljs-params">generatorFunc</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span> (<span class="hljs-params">...args</span>) {
    <span class="hljs-keyword">const</span> gen = generatorFunc.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, args);

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
      <span class="hljs-keyword">function</span> <span class="hljs-title function_">step</span>(<span class="hljs-params">key, arg</span>) {
        <span class="hljs-keyword">let</span> generatorResult;
        <span class="hljs-keyword">try</span> {
          generatorResult = gen[key](arg);
        } <span class="hljs-keyword">catch</span> (error) {
          <span class="hljs-keyword">return</span> <span class="hljs-title function_">reject</span>(error);
        }

        <span class="hljs-keyword">const</span> { value, done } = generatorResult;

        <span class="hljs-keyword">if</span> (done) {
          <span class="hljs-keyword">return</span> <span class="hljs-title function_">resolve</span>(value);
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(value).<span class="hljs-title function_">then</span>(
            <span class="hljs-keyword">function</span> <span class="hljs-title function_">onResolve</span>(<span class="hljs-params">val</span>) {
              <span class="hljs-title function_">step</span>(<span class="hljs-string">&quot;next&quot;</span>, val);
            },
            <span class="hljs-keyword">function</span> <span class="hljs-title function_">onReject</span>(<span class="hljs-params">err</span>) {
              <span class="hljs-title function_">step</span>(<span class="hljs-string">&quot;throw&quot;</span>, err);
            }
          );
        }
      }
      <span class="hljs-title function_">step</span>(<span class="hljs-string">&quot;next&quot;</span>);
    });
  };
}

<span class="hljs-keyword">const</span> testGAsync = <span class="hljs-title function_">asyncToGenerator</span>(testG);
<span class="hljs-title function_">testGAsync</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">result</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(result);
});
</code></pre>

      <h2>
        <span class="prefix"></span>
        <span class="content">参考</span>
        <span class="suffix"></span>
      </h2>
    <p><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Promise">MDN-Promise</a></p>
<p><a href="https://github.com/imtaotao/co-share">co-share</a></p>
</div></div></div></article></div></main><footer class="flex flex-col items-center justify-center leading-8 text-sm w-full py-2 border-t text-skin-muted"><p>Designed &amp; developed by<a class="ml-1 text-yellow" target="_blank" href="https://github.com/mrrs878" rel="noreferrer">Mr.RS</a></p><p>©<!-- --> <!-- -->2024</p></footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"title":"JavaScript复习-异步","tags":["JavaScript","Promise","Generator","Promise"],"categories":"2021复习","description":"JavaScript为异步非阻塞，ES6之前主要靠回调函数来实现异步，但由于回调函数容易出现回调地狱等问题，于是ES6+提供了了`Generator`、`Promise`、`async/await`这些API来降低异步编程的难度与复杂度。\n\n## 回调函数\n\n回调函数容易出现回调地狱，可读性差\n\n``` js\nfunction ajax(url, options, onSuccess) {","createDate":"2021-05-12 10:36:56","updateDate":"2021-06-24 18:47:28","body":"\u003cp\u003eJavaScript为异步非阻塞，ES6之前主要靠回调函数来实现异步，但由于回调函数容易出现回调地狱等问题，于是ES6+提供了了\u003ccode\u003eGenerator\u003c/code\u003e、\u003ccode\u003ePromise\u003c/code\u003e、\u003ccode\u003easync/await\u003c/code\u003e这些API来降低异步编程的难度与复杂度。\u003c/p\u003e\n\n      \u003ch2\u003e\n        \u003cspan class=\"prefix\"\u003e\u003c/span\u003e\n        \u003cspan class=\"content\"\u003e回调函数\u003c/span\u003e\n        \u003cspan class=\"suffix\"\u003e\u003c/span\u003e\n      \u003c/h2\u003e\n    \u003cp\u003e回调函数容易出现回调地狱，可读性差\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003e\u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003eajax\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003eurl, options, onSuccess\u003c/span\u003e) {\n    \u003cspan class=\"hljs-comment\"\u003e// ...\u003c/span\u003e\n}\n\n\u003cspan class=\"hljs-title function_\"\u003eajax\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026#x27;/api/xxx\u0026#x27;\u003c/span\u003e, {}, \u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e (\u003cspan class=\"hljs-params\"\u003e\u003c/span\u003e) {\n    \u003cspan class=\"hljs-title function_\"\u003eajax\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026#x27;/api/yyy\u0026#x27;\u003c/span\u003e, {}, \u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e (\u003cspan class=\"hljs-params\"\u003e\u003c/span\u003e) {\n        \u003cspan class=\"hljs-title function_\"\u003eajax\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026#x27;/api/zzz\u0026#x27;\u003c/span\u003e, (), \u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e (\u003cspan class=\"hljs-params\"\u003e\u003c/span\u003e) {\n        })\n    })\n})\n\u003c/code\u003e\u003c/pre\u003e\n\n      \u003ch3\u003e\n        \u003cspan class=\"prefix\"\u003e\u003c/span\u003e\n        \u003cspan class=\"content\"\u003eGenerator\u003c/span\u003e\n        \u003cspan class=\"suffix\"\u003e\u003c/span\u003e\n      \u003c/h3\u003e\n    \u003cp\u003e形式上，\u003ccode\u003egenerator\u003c/code\u003e函数是一个状态机，封装了多个内部状态。执行\u003ccode\u003egenerator\u003c/code\u003e函数会返回一个\u003cstrong\u003e遍历器对象\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e语法上，\u003ccode\u003egenerator\u003c/code\u003e函数是一个普通函数。\u003ccode\u003efunction\u003c/code\u003e关键字与函数名之间有一个\u003ccode\u003e*\u003c/code\u003e；函数体内使用\u003ccode\u003eyield\u003c/code\u003e表达式定义不同的内部状态\u003c/p\u003e\n\u003cp\u003e与普通函数不同，\u003ccode\u003egenerator\u003c/code\u003e函数被调用后\u003cstrong\u003e并不执行\u003c/strong\u003e，返回的是一个指向内部状态的指针对象，也就是\u003cstrong\u003e遍历器对象\u003c/strong\u003e。下一步，\u003cstrong\u003e必须调用遍历器对象的\u003ccode\u003enext\u003c/code\u003e方法\u003c/strong\u003e使得指针移向下一个状态，也就是说每次调用\u003ccode\u003enext\u003c/code\u003e方法，内部指针就从函数头部或上一次停下来的地方开始执行，直到遇到下一个\u003ccode\u003eyield\u003c/code\u003e或\u003ccode\u003ereturn\u003c/code\u003e\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003e\u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e* \u003cspan class=\"hljs-title function_\"\u003egen\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003e\u003c/span\u003e) {\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e str1 = \u003cspan class=\"hljs-keyword\"\u003eyield\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026quot;hello\u0026quot;\u003c/span\u003e\n  \u003cspan class=\"hljs-comment\"\u003e// str1 = 222\u003c/span\u003e\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e str2 = \u003cspan class=\"hljs-keyword\"\u003eyield\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026quot;world\u0026quot;\u003c/span\u003e\n  \u003cspan class=\"hljs-comment\"\u003e// str2 = 333\u003c/span\u003e\n  \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e str2\n}\n\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e iter = \u003cspan class=\"hljs-title function_\"\u003egen\u003c/span\u003e()\n\u003cspan class=\"hljs-variable language_\"\u003econsole\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003elog\u003c/span\u003e(iter.\u003cspan class=\"hljs-title function_\"\u003enext\u003c/span\u003e())\n\u003cspan class=\"hljs-comment\"\u003e// { value: \u0026quot;hello\u0026quot;, done: false }\u003c/span\u003e\n\u003cspan class=\"hljs-variable language_\"\u003econsole\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003elog\u003c/span\u003e(iter.\u003cspan class=\"hljs-title function_\"\u003enext\u003c/span\u003e(\u003cspan class=\"hljs-number\"\u003e222\u003c/span\u003e))\n\u003cspan class=\"hljs-comment\"\u003e// { value: \u0026quot;world\u0026quot;, done: false }\u003c/span\u003e\n\u003cspan class=\"hljs-variable language_\"\u003econsole\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003elog\u003c/span\u003e(iter.\u003cspan class=\"hljs-title function_\"\u003enext\u003c/span\u003e(\u003cspan class=\"hljs-number\"\u003e333\u003c/span\u003e))\n\u003cspan class=\"hljs-comment\"\u003e// { value: 333, done: false }\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e第一次调用，\u003ccode\u003egenerator\u003c/code\u003e函数开始执行，直到遇到第一个\u003ccode\u003eyield\u003c/code\u003e表达式为止。\u003ccode\u003enext\u003c/code\u003e方法返回一个对象，它的\u003ccode\u003evalue\u003c/code\u003e值就是当前\u003ccode\u003eyield\u003c/code\u003e表达式的值，\u003ccode\u003edone\u003c/code\u003e的值为\u003ccode\u003efalse\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003e第二次调用，\u003ccode\u003egenerator\u003c/code\u003e从上次\u003ccode\u003eyield\u003c/code\u003e表达式停下来的地方一直执行到下一个\u003ccode\u003eyield\u003c/code\u003e表达式 👆 ……\u003c/p\u003e\n\u003cp\u003e第三次调用，\u003ccode\u003egenerator\u003c/code\u003e函数从上次\u003ccode\u003eyield\u003c/code\u003e表达式停下来的地方一直执行到\u003ccode\u003ereturn\u003c/code\u003e语句，\u003ccode\u003enext\u003c/code\u003e返回的\u003ccode\u003evalue\u003c/code\u003e值就是\u003ccode\u003ereturn\u003c/code\u003e后面表达式的值，\u003ccode\u003edone\u003c/code\u003e为\u003ccode\u003etrue\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003eyield\u003c/code\u003e表达式本身没有返回值（或者说总是返回\u003ccode\u003eundefined\u003c/code\u003e）。\u003ccode\u003enext\u003c/code\u003e方法可以带一个参数，该参数会被当作\u003cstrong\u003e上一个\u003c/strong\u003e\u003ccode\u003eyield\u003c/code\u003e表达式的返回值\u003c/p\u003e\n\n      \u003ch2\u003e\n        \u003cspan class=\"prefix\"\u003e\u003c/span\u003e\n        \u003cspan class=\"content\"\u003ePromise\u003c/span\u003e\n        \u003cspan class=\"suffix\"\u003e\u003c/span\u003e\n      \u003c/h2\u003e\n    \u003cp\u003eES6提供的一种异步编程方案\u003c/p\u003e\n\u003cp\u003e一个\u003ccode\u003ePromise\u003c/code\u003e对象必然处于以下三种状态：\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003epending，初始状态\u003c/li\u003e\n\u003cli\u003efulfilled，成功\u003c/li\u003e\n\u003cli\u003erejected，失败\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003ccode\u003epending\u003c/code\u003e状态的\u003ccode\u003ePromise\u003c/code\u003e对象可以转换为\u003ccode\u003efulfilled\u003c/code\u003e或\u003ccode\u003erejected\u003c/code\u003e状态，而且此过程是不可逆的。当状态变更时，\u003ccode\u003ethen()\u003c/code\u003e方法注册的回调就会被调用\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003ethen()\u003c/code\u003e 或者 \u003ccode\u003ecatch()\u003c/code\u003e 的参数期望是函数，传⼊⾮函数则会发⽣值透传\u003ccode\u003e(value =\u0026gt; value)\u003c/code\u003e\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003e\u003cspan class=\"hljs-title class_\"\u003ePromise\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003eresolve\u003c/span\u003e(\u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e)\n .\u003cspan class=\"hljs-title function_\"\u003ethen\u003c/span\u003e(\u003cspan class=\"hljs-number\"\u003e2\u003c/span\u003e) \u003cspan class=\"hljs-comment\"\u003e// .then(1 =\u0026gt; 1)\u003c/span\u003e\n .\u003cspan class=\"hljs-title function_\"\u003ethen\u003c/span\u003e(\u003cspan class=\"hljs-title class_\"\u003ePromise\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003eresolve\u003c/span\u003e(\u003cspan class=\"hljs-number\"\u003e3\u003c/span\u003e)) \u003cspan class=\"hljs-comment\"\u003e// .then(1 =\u0026gt; 1)\u003c/span\u003e\n .\u003cspan class=\"hljs-title function_\"\u003ethen\u003c/span\u003e(\u003cspan class=\"hljs-variable language_\"\u003econsole\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003elog\u003c/span\u003e)\n\u003cspan class=\"hljs-comment\"\u003e// 1\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003e\u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003efetch\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003eurl, options = {}\u003c/span\u003e) {\n  \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003ePromise\u003c/span\u003e(\u003cspan class=\"hljs-function\"\u003e(\u003cspan class=\"hljs-params\"\u003eresolve, reject\u003c/span\u003e) =\u0026gt;\u003c/span\u003e {\n    \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e xhr = \u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eXMLHttpRequest\u003c/span\u003e();\n    xhr.\u003cspan class=\"hljs-title function_\"\u003eopen\u003c/span\u003e(options.\u003cspan class=\"hljs-property\"\u003emethod\u003c/span\u003e || \u003cspan class=\"hljs-string\"\u003e\u0026#x27;GET\u0026#x27;\u003c/span\u003e, url);\n    \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e headers = { \u003cspan class=\"hljs-string\"\u003e\u0026#x27;Content-Type\u0026#x27;\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\u0026#x27;application/json\u0026#x27;\u003c/span\u003e, ...options.\u003cspan class=\"hljs-property\"\u003eheaders\u003c/span\u003e || {} };\n    \u003cspan class=\"hljs-title class_\"\u003eReflect\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003eownKeys\u003c/span\u003e(headers)\n      .\u003cspan class=\"hljs-title function_\"\u003eforEach\u003c/span\u003e(\u003cspan class=\"hljs-function\"\u003e(\u003cspan class=\"hljs-params\"\u003eheader\u003c/span\u003e) =\u0026gt;\u003c/span\u003e xhr.\u003cspan class=\"hljs-title function_\"\u003esetRequestHeader\u003c/span\u003e(header, headers[header]));\n    xhr.\u003cspan class=\"hljs-title function_\"\u003esend\u003c/span\u003e(options.\u003cspan class=\"hljs-property\"\u003emethod\u003c/span\u003e === \u003cspan class=\"hljs-string\"\u003e\u0026#x27;POST\u0026#x27;\u003c/span\u003e ? \u003cspan class=\"hljs-title class_\"\u003eJSON\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003estringify\u003c/span\u003e(options.\u003cspan class=\"hljs-property\"\u003edata\u003c/span\u003e || {}) : \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e);\n    xhr.\u003cspan class=\"hljs-property\"\u003eonerror\u003c/span\u003e = \u003cspan class=\"hljs-function\"\u003e(\u003cspan class=\"hljs-params\"\u003ee\u003c/span\u003e) =\u0026gt;\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003ereject\u003c/span\u003e(e);\n    xhr.\u003cspan class=\"hljs-property\"\u003eonreadystatechange\u003c/span\u003e = \u003cspan class=\"hljs-function\"\u003e() =\u0026gt;\u003c/span\u003e {\n      \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (xhr.\u003cspan class=\"hljs-property\"\u003ereadyState\u003c/span\u003e === \u003cspan class=\"hljs-title class_\"\u003eXMLHttpRequest\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eDONE\u003c/span\u003e\n        \u0026amp;\u0026amp; [\u003cspan class=\"hljs-number\"\u003e200\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e201\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e301\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e302\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e304\u003c/span\u003e].\u003cspan class=\"hljs-title function_\"\u003eincludes\u003c/span\u003e(xhr.\u003cspan class=\"hljs-property\"\u003estatus\u003c/span\u003e)) {\n        \u003cspan class=\"hljs-title function_\"\u003eresolve\u003c/span\u003e(\u003cspan class=\"hljs-title class_\"\u003eJSON\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003eparse\u003c/span\u003e(xhr.\u003cspan class=\"hljs-property\"\u003eresponseText\u003c/span\u003e));\n      }\n    };\n  });\n}\n\u003cspan class=\"hljs-title function_\"\u003efetch\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026#x27;http://localhost:3004/get\u0026#x27;\u003c/span\u003e).\u003cspan class=\"hljs-title function_\"\u003ethen\u003c/span\u003e(\u003cspan class=\"hljs-function\"\u003e(\u003cspan class=\"hljs-params\"\u003eres\u003c/span\u003e) =\u0026gt;\u003c/span\u003e {\n    \u003cspan class=\"hljs-variable language_\"\u003econsole\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003elog\u003c/span\u003e(res);\n}).\u003cspan class=\"hljs-title function_\"\u003ecatch\u003c/span\u003e(\u003cspan class=\"hljs-function\"\u003e(\u003cspan class=\"hljs-params\"\u003ee\u003c/span\u003e) =\u0026gt;\u003c/span\u003e {\n    \u003cspan class=\"hljs-variable language_\"\u003econsole\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003eerror\u003c/span\u003e(e);\n})\n\u003c/code\u003e\u003c/pre\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003e\u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003ePromise\u003c/span\u003e(\u003cspan class=\"hljs-function\"\u003e(\u003cspan class=\"hljs-params\"\u003eresolve,reject\u003c/span\u003e)=\u0026gt;\u003c/span\u003e{\n    \u003cspan class=\"hljs-variable language_\"\u003econsole\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003elog\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;1\u0026quot;\u003c/span\u003e)\n    \u003cspan class=\"hljs-title function_\"\u003eresolve\u003c/span\u003e();\n}).\u003cspan class=\"hljs-title function_\"\u003ethen\u003c/span\u003e(\u003cspan class=\"hljs-function\"\u003e()=\u0026gt;\u003c/span\u003e{\n    \u003cspan class=\"hljs-comment\"\u003e// 外部第1个then\u003c/span\u003e\n    \u003cspan class=\"hljs-variable language_\"\u003econsole\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003elog\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;2\u0026quot;\u003c/span\u003e)\n    \u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003ePromise\u003c/span\u003e(\u003cspan class=\"hljs-function\"\u003e(\u003cspan class=\"hljs-params\"\u003eresolve,reject\u003c/span\u003e)=\u0026gt;\u003c/span\u003e{\n        \u003cspan class=\"hljs-variable language_\"\u003econsole\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003elog\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;3\u0026quot;\u003c/span\u003e)\n        \u003cspan class=\"hljs-title function_\"\u003eresolve\u003c/span\u003e();\n    }).\u003cspan class=\"hljs-title function_\"\u003ethen\u003c/span\u003e(\u003cspan class=\"hljs-function\"\u003e()=\u0026gt;\u003c/span\u003e{\n        \u003cspan class=\"hljs-comment\"\u003e// 内部第1个then\u003c/span\u003e\n        \u003cspan class=\"hljs-variable language_\"\u003econsole\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003elog\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;4\u0026quot;\u003c/span\u003e)\n    }).\u003cspan class=\"hljs-title function_\"\u003ethen\u003c/span\u003e(\u003cspan class=\"hljs-function\"\u003e() =\u0026gt;\u003c/span\u003e {\n        \u003cspan class=\"hljs-comment\"\u003e// 内部第2个then\u003c/span\u003e\n        \u003cspan class=\"hljs-variable language_\"\u003econsole\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003elog\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;5\u0026quot;\u003c/span\u003e)\n    })\n}).\u003cspan class=\"hljs-title function_\"\u003ethen\u003c/span\u003e(\u003cspan class=\"hljs-function\"\u003e(\u003cspan class=\"hljs-params\"\u003eres\u003c/span\u003e)=\u0026gt;\u003c/span\u003e{\n    \u003cspan class=\"hljs-comment\"\u003e// 外部第2个then\u003c/span\u003e\n    \u003cspan class=\"hljs-variable language_\"\u003econsole\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003elog\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;6\u0026quot;\u003c/span\u003e)\n})\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e简单来讲就是then回调的注册需要上一个then里面的同步代码执行完毕\u003c/p\u003e\n\u003cp\u003e拿上面的代码来讲，当外部第1个then里的resovle()执行完毕后，该Promise的状态已经更改，会将内部第1个then回调添加（注册）到微任务队列中；内部第2个then由于上一个then回调没有执行完毕，因此不会注册。此时外部第1个then里的同步代码执行完毕，会注册外部第2个then回调\u003c/p\u003e\n\u003cp\u003e整理一下：then回调注册的顺序是：外部第1个then --\u0026gt; 内部第1个then --\u0026gt; 外部第2个then --\u0026gt; 内部第2个then\u003c/p\u003e\n\u003cp\u003eps: 如果将外部第1个then里的new Promise(xxx)改为return new Promise(xxx)的话内部第2个then的注册将早于* 外部第2个then*\u003c/p\u003e\n\n      \u003ch2\u003e\n        \u003cspan class=\"prefix\"\u003e\u003c/span\u003e\n        \u003cspan class=\"content\"\u003easync/await\u003c/span\u003e\n        \u003cspan class=\"suffix\"\u003e\u003c/span\u003e\n      \u003c/h2\u003e\n    \u003cp\u003e目前来讲，最为优秀的一种异步编程方案，与ES2017提出\u003c/p\u003e\n\u003cp\u003e实现上是\u003ccode\u003eGenerator\u003c/code\u003e+\u003ccode\u003ePromise\u003c/code\u003e的语法糖\u003c/p\u003e\n\u003cp\u003e通过在\u003ccode\u003eonFulFilled()\u003c/code\u003e里调用\u003ccode\u003enext()\u003c/code\u003e、在\u003ccode\u003enext()\u003c/code\u003e里调用\u003ccode\u003eonFulfilled()\u003c/code\u003e形成一个自执行器，只有当全部代码执行完毕后才会终止\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003e\u003cspan class=\"hljs-keyword\"\u003easync\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003efn\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003e\u003c/span\u003e) {\n    \u003cspan class=\"hljs-keyword\"\u003etry\u003c/span\u003e {\n        \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e res = \u003cspan class=\"hljs-keyword\"\u003eawait\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003efetch\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026#x27;http://localhost:3004/get\u0026#x27;\u003c/span\u003e);\n        \u003cspan class=\"hljs-variable language_\"\u003econsole\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003elog\u003c/span\u003e(res);\n    } \u003cspan class=\"hljs-keyword\"\u003ecatch\u003c/span\u003e (e) {\n        \u003cspan class=\"hljs-variable language_\"\u003econsole\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003eerror\u003c/span\u003e(e);\n    }\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003ccode\u003easync/await\u003c/code\u003e原理: \u003cstrong\u003e自动执行generator函数\u003c/strong\u003e\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003e\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003egetData\u003c/span\u003e = (\u003cspan class=\"hljs-params\"\u003e\u003c/span\u003e) =\u0026gt;\n  \u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003ePromise\u003c/span\u003e(\u003cspan class=\"hljs-function\"\u003e(\u003cspan class=\"hljs-params\"\u003eresolve\u003c/span\u003e) =\u0026gt;\u003c/span\u003e \u003cspan class=\"hljs-built_in\"\u003esetTimeout\u003c/span\u003e(\u003cspan class=\"hljs-function\"\u003e() =\u0026gt;\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003eresolve\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;data\u0026quot;\u003c/span\u003e), \u003cspan class=\"hljs-number\"\u003e1000\u003c/span\u003e));\n\n\u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e* \u003cspan class=\"hljs-title function_\"\u003etestG\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003e\u003c/span\u003e) {\n  \u003cspan class=\"hljs-comment\"\u003e// await被编译成了yield\u003c/span\u003e\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e data = \u003cspan class=\"hljs-keyword\"\u003eyield\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003egetData\u003c/span\u003e();\n  \u003cspan class=\"hljs-variable language_\"\u003econsole\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003elog\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;data: \u0026quot;\u003c/span\u003e, data);\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e data2 = \u003cspan class=\"hljs-keyword\"\u003eyield\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003egetData\u003c/span\u003e();\n  \u003cspan class=\"hljs-variable language_\"\u003econsole\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003elog\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;data2: \u0026quot;\u003c/span\u003e, data2);\n  \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026quot;success\u0026quot;\u003c/span\u003e;\n}\n\n\u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003easyncToGenerator\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003egeneratorFunc\u003c/span\u003e) {\n  \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e (\u003cspan class=\"hljs-params\"\u003e...args\u003c/span\u003e) {\n    \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e gen = generatorFunc.\u003cspan class=\"hljs-title function_\"\u003eapply\u003c/span\u003e(\u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e, args);\n\n    \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003ePromise\u003c/span\u003e(\u003cspan class=\"hljs-function\"\u003e(\u003cspan class=\"hljs-params\"\u003eresolve, reject\u003c/span\u003e) =\u0026gt;\u003c/span\u003e {\n      \u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003estep\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003ekey, arg\u003c/span\u003e) {\n        \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e generatorResult;\n        \u003cspan class=\"hljs-keyword\"\u003etry\u003c/span\u003e {\n          generatorResult = gen[key](arg);\n        } \u003cspan class=\"hljs-keyword\"\u003ecatch\u003c/span\u003e (error) {\n          \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003ereject\u003c/span\u003e(error);\n        }\n\n        \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e { value, done } = generatorResult;\n\n        \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (done) {\n          \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003eresolve\u003c/span\u003e(value);\n        } \u003cspan class=\"hljs-keyword\"\u003eelse\u003c/span\u003e {\n          \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003ePromise\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003eresolve\u003c/span\u003e(value).\u003cspan class=\"hljs-title function_\"\u003ethen\u003c/span\u003e(\n            \u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003eonResolve\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003eval\u003c/span\u003e) {\n              \u003cspan class=\"hljs-title function_\"\u003estep\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;next\u0026quot;\u003c/span\u003e, val);\n            },\n            \u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003eonReject\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003eerr\u003c/span\u003e) {\n              \u003cspan class=\"hljs-title function_\"\u003estep\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;throw\u0026quot;\u003c/span\u003e, err);\n            }\n          );\n        }\n      }\n      \u003cspan class=\"hljs-title function_\"\u003estep\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;next\u0026quot;\u003c/span\u003e);\n    });\n  };\n}\n\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e testGAsync = \u003cspan class=\"hljs-title function_\"\u003easyncToGenerator\u003c/span\u003e(testG);\n\u003cspan class=\"hljs-title function_\"\u003etestGAsync\u003c/span\u003e().\u003cspan class=\"hljs-title function_\"\u003ethen\u003c/span\u003e(\u003cspan class=\"hljs-function\"\u003e(\u003cspan class=\"hljs-params\"\u003eresult\u003c/span\u003e) =\u0026gt;\u003c/span\u003e {\n  \u003cspan class=\"hljs-variable language_\"\u003econsole\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003elog\u003c/span\u003e(result);\n});\n\u003c/code\u003e\u003c/pre\u003e\n\n      \u003ch2\u003e\n        \u003cspan class=\"prefix\"\u003e\u003c/span\u003e\n        \u003cspan class=\"content\"\u003e参考\u003c/span\u003e\n        \u003cspan class=\"suffix\"\u003e\u003c/span\u003e\n      \u003c/h2\u003e\n    \u003cp\u003e\u003ca href=\"https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Promise\"\u003eMDN-Promise\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/imtaotao/co-share\"\u003eco-share\u003c/a\u003e\u003c/p\u003e\n"}},"__N_SSG":true},"page":"/post/[title]","query":{"title":"JavaScript复习-异步"},"buildId":"6Z6s6-Ql91pBaqq4AHUDJ","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>
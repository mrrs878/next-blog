<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><title>Mr.RS的个人博客-异常监控-异常捕获</title><meta name="next-head-count" content="3"/><link rel="preload" href="/next-blog/_next/static/css/1bf96eec8dc413e7.css" as="style"/><link rel="stylesheet" href="/next-blog/_next/static/css/1bf96eec8dc413e7.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/next-blog/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/next-blog/_next/static/chunks/webpack-cf185e4b59cdddcf.js" defer=""></script><script src="/next-blog/_next/static/chunks/framework-91d7f78b5b4003c8.js" defer=""></script><script src="/next-blog/_next/static/chunks/main-1c9e93b8392c1bc9.js" defer=""></script><script src="/next-blog/_next/static/chunks/pages/_app-ca6aae25bc99a05f.js" defer=""></script><script src="/next-blog/_next/static/chunks/899-1cd3a59abdb8ea18.js" defer=""></script><script src="/next-blog/_next/static/chunks/pages/post/%5Btitle%5D-406bad804ceffd1d.js" defer=""></script><script src="/next-blog/_next/static/ZYBT_GVMR4rRyxQKNqnGG/_buildManifest.js" defer=""></script><script src="/next-blog/_next/static/ZYBT_GVMR4rRyxQKNqnGG/_ssgManifest.js" defer=""></script><script src="/next-blog/_next/static/ZYBT_GVMR4rRyxQKNqnGG/_middlewareManifest.js" defer=""></script></head><body><div id="__next" data-reactroot=""><header class="fixed top-0 py-4 left-0 right-0 h-auto px-10 shadow bg-white z-50"><nav><ul class="flex w-auto"><li class="mr-4 hover:text-yellow"><a href="/next-blog">首页</a></li><li class="mx-4 hover:text-yellow"><a href="/next-blog/categories">分类</a></li><li class="mx-4 hover:text-yellow"><a href="/next-blog/tags">标签</a></li><li class="ml-4 hover:text-yellow"><a href="/next-blog/timeline">归档</a></li></ul></nav></header><main class="mt-20 mb-4 mx-auto justify-center w-2/3"><div class="mx-auto lg:max-w-5xl md:max-w-3xl"><article class="flex flex-col justify-around pb-16 px-4 mx-auto space-y-10 text-base"><div class="flex flex-col space-y-4"><h1 class="inline pt-10 text-4xl text-skin-primary">异常监控-异常捕获</h1><div class="text-sm space-x-2 text-skin-muted"><span><svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 inline-block mr-1"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>2020-07-28 11:15:28</span><span><svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 inline-block mr-1"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>44</span></div></div><div class="mt-8 flex"><div class="w-full flex-auto custom-markdown-body"><div class="markdown-body" id="write"><h2 id="异常分类">异常分类</h2>
<ul>
<li>编译时异常/运行时异常</li>
</ul>
<p><strong>着重处理运行时异常</strong></p>
<h2 id="要处理的异常">要处理的异常</h2>
<ul>
<li>js运行时异常</li>
<li>静态资源加载异常</li>
<li>Promise异常</li>
<li>ajax请求异常</li>
<li>崩溃和卡顿</li>
</ul>
<h2 id="捕获异常">捕获异常</h2>
<h3 id="普通前端项目">普通前端项目</h3>
<pre><code class="hljs language-js"><span class="hljs-comment">// monitor.ts</span>

interface <span class="hljs-title class_">ConfigI</span> {
  <span class="hljs-attr">reportUrl</span>: string;
}

interface <span class="hljs-title class_">BaseinfoI</span> {
  <span class="hljs-attr">title</span>: string;
  <span class="hljs-attr">location</span>: string;
  <span class="hljs-attr">message</span>: string;
  <span class="hljs-attr">kind</span>: string;
  <span class="hljs-attr">type</span>: string;
  <span class="hljs-attr">errorType</span>: string;
}

interface <span class="hljs-title class_">JSRunTimeErrorEventI</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseinfoI</span> {
  <span class="hljs-attr">filename</span>: string;
  <span class="hljs-attr">position</span>: string;
  <span class="hljs-attr">stack</span>: string;
  <span class="hljs-attr">selector</span>: string;
}

interface <span class="hljs-title class_">AssetsErrorI</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseinfoI</span> {
  <span class="hljs-attr">url</span>: string;
  <span class="hljs-attr">nodeName</span>: string;
}

interface <span class="hljs-title class_">AjaxErrorEventI</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseinfoI</span> {
  <span class="hljs-attr">response</span>: string;
  <span class="hljs-attr">status</span>: number;
  <span class="hljs-attr">method</span>: string;
  <span class="hljs-attr">url</span>: string;
}

interface <span class="hljs-title class_">PromiseErrorI</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseinfoI</span> {
  <span class="hljs-attr">message</span>: string;
  <span class="hljs-attr">stack</span>: string;
}

<span class="hljs-keyword">const</span> <span class="hljs-attr">config</span>: <span class="hljs-title class_">ConfigI</span> = { <span class="hljs-attr">reportUrl</span>: <span class="hljs-string">&#x27;/&#x27;</span> };

<span class="hljs-keyword">function</span> <span class="hljs-title function_">getLastEvent</span>(<span class="hljs-params"></span>): <span class="hljs-literal">undefined</span> | <span class="hljs-title class_">Event</span> {
  <span class="hljs-keyword">let</span> lastEvent;
  [<span class="hljs-string">&#x27;click&#x27;</span>, <span class="hljs-string">&#x27;touchstart&#x27;</span>, <span class="hljs-string">&#x27;mousedown&#x27;</span>, <span class="hljs-string">&#x27;keydown&#x27;</span>, <span class="hljs-string">&#x27;mouseover&#x27;</span>].<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">eventType</span>) =&gt;</span> <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(eventType, <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
    lastEvent = event;
  }, {
    <span class="hljs-attr">capture</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">passive</span>: <span class="hljs-literal">true</span>,
  }));
  <span class="hljs-keyword">return</span> lastEvent;
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">getSelector</span>(<span class="hljs-params">path: <span class="hljs-built_in">Array</span>&lt;EventTarget&gt;</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;&#x27;</span>;
}

<span class="hljs-keyword">function</span> report&lt;T&gt;(<span class="hljs-attr">data</span>: { <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;JSRunTimeErrorI&#x27;</span> | <span class="hljs-string">&#x27;PromiseErrorT&#x27;</span> | <span class="hljs-string">&#x27;AssetsErrorI&#x27;</span> | <span class="hljs-string">&#x27;AjaxErrorEventI&#x27;</span>; <span class="hljs-attr">info</span>: T }) {
  <span class="hljs-keyword">const</span> image = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Image</span>();
  image.<span class="hljs-property">src</span> = <span class="hljs-string">`<span class="hljs-subst">${config.reportUrl}</span>?error=<span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(data.info)}</span>`</span>;
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">getCommonInfoFromEvent</span>(<span class="hljs-params">event?: Event</span>) {
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">title</span>: <span class="hljs-variable language_">document</span>.<span class="hljs-property">title</span>.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/&amp;/</span>, <span class="hljs-string">&#x27;&#x27;</span>),
    <span class="hljs-attr">location</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">href</span>.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/&amp;/</span>, <span class="hljs-string">&#x27;&#x27;</span>),
    <span class="hljs-attr">kind</span>: <span class="hljs-string">&#x27;stability&#x27;</span>,
    <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;error&#x27;</span>,
  };
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">getLines</span>(<span class="hljs-params">stack: string | <span class="hljs-literal">undefined</span></span>) {
  <span class="hljs-keyword">return</span> stack?.<span class="hljs-title function_">split</span>(<span class="hljs-string">&#x27;\n&#x27;</span>).<span class="hljs-title function_">slice</span>(<span class="hljs-number">1</span>).<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> item.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/^\s+at\s+/g</span>, <span class="hljs-string">&#x27;&#x27;</span>)).<span class="hljs-title function_">join</span>(<span class="hljs-string">&#x27;&#x27;</span>) || <span class="hljs-string">&#x27;&#x27;</span>;
}

<span class="hljs-comment">// Promise异常</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">promiseError</span>(<span class="hljs-params"></span>) {
  <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;unhandledrejection&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">event: PromiseRejectionEvent</span>) =&gt;</span> {
    event.<span class="hljs-title function_">preventDefault</span>();
    <span class="hljs-keyword">let</span> message = <span class="hljs-string">&#x27;&#x27;</span>;
    <span class="hljs-keyword">let</span> stack = <span class="hljs-string">&#x27;&#x27;</span>;
    message = event.<span class="hljs-property">reason</span>;
    <span class="hljs-keyword">const</span> { reason } = event;
    <span class="hljs-keyword">if</span> (reason <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Error</span>) {
      message = reason.<span class="hljs-property">message</span>;
      stack = <span class="hljs-title function_">getLines</span>(reason.<span class="hljs-property">stack</span>);
    }

    report&lt;<span class="hljs-title class_">PromiseErrorI</span>&gt;({ <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;PromiseErrorT&#x27;</span>, <span class="hljs-attr">info</span>: { <span class="hljs-attr">errorType</span>: event.<span class="hljs-property">type</span>, message, stack, ...<span class="hljs-title function_">getCommonInfoFromEvent</span>() } });
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  }, <span class="hljs-literal">true</span>);
}

<span class="hljs-comment">// 静态资源加载异常&amp;JSRuntime异常</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">assetsError</span>(<span class="hljs-params"></span>) {
  <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;error&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">event: ErrorEvent</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> { target } = event;
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(event);
    <span class="hljs-keyword">const</span> isElementTarget = target <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">HTMLScriptElement</span> || target <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">HTMLLinkElement</span> || target <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">HTMLImageElement</span>;
    <span class="hljs-keyword">if</span> (!isElementTarget) {
      <span class="hljs-keyword">const</span> { message, filename, lineno, colno, error, type } = event;
      <span class="hljs-keyword">const</span> position = <span class="hljs-string">`<span class="hljs-subst">${lineno}</span>:<span class="hljs-subst">${colno}</span>`</span>;
      <span class="hljs-keyword">const</span> stack = <span class="hljs-title function_">getLines</span>(error <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Error</span> ? error.<span class="hljs-property">stack</span> : <span class="hljs-string">&#x27;&#x27;</span>);
      <span class="hljs-keyword">const</span> lastEvent = <span class="hljs-title function_">getLastEvent</span>();
      <span class="hljs-keyword">const</span> selector = lastEvent ? <span class="hljs-title function_">getSelector</span>(lastEvent.<span class="hljs-title function_">composedPath</span>()) : <span class="hljs-string">&#x27;&#x27;</span>;
      report&lt;<span class="hljs-title class_">JSRunTimeErrorEventI</span>&gt;({
        <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;JSRunTimeErrorI&#x27;</span>,
        <span class="hljs-attr">info</span>: { ...<span class="hljs-title function_">getCommonInfoFromEvent</span>(), message, <span class="hljs-attr">errorType</span>: type, filename, position, stack, selector },
      });
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">let</span> url = <span class="hljs-string">&#x27;&#x27;</span>;
      <span class="hljs-keyword">let</span> nodeName = <span class="hljs-string">&#x27;&#x27;</span>;
      <span class="hljs-keyword">if</span> (target <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">HTMLImageElement</span> || target <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">HTMLScriptElement</span>) {
        url = target.<span class="hljs-property">src</span>;
        nodeName = target.<span class="hljs-property">nodeName</span>;
      }
      <span class="hljs-keyword">if</span> (target <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">HTMLLinkElement</span>) {
        url = target.<span class="hljs-property">href</span>;
        nodeName = target.<span class="hljs-property">nodeName</span>;
      }

      report&lt;<span class="hljs-title class_">AssetsErrorI</span>&gt;({ <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;AssetsErrorI&#x27;</span>,
        <span class="hljs-attr">info</span>: {
          url,
          <span class="hljs-attr">errorType</span>: event.<span class="hljs-property">type</span>,
          nodeName,
          <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;&#x27;</span>,
          ...<span class="hljs-title function_">getCommonInfoFromEvent</span>() } });
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  }, <span class="hljs-literal">true</span>);
}

<span class="hljs-comment">// ajax请求异常</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">ajaxError</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">const</span> { protocol } = <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>;
  <span class="hljs-keyword">if</span> (protocol === <span class="hljs-string">&#x27;file:&#x27;</span>) <span class="hljs-keyword">return</span>;
  <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">window</span>.<span class="hljs-property">XMLHttpRequest</span>) <span class="hljs-keyword">return</span>;
  <span class="hljs-keyword">const</span> xmlReq = <span class="hljs-variable language_">window</span>.<span class="hljs-property">XMLHttpRequest</span>;
  <span class="hljs-keyword">const</span> oldSend = xmlReq.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">send</span>;
  <span class="hljs-keyword">const</span> oldOpen = xmlReq.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">open</span>;
  <span class="hljs-keyword">const</span> oldArgs = { <span class="hljs-attr">method</span>: <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-attr">url</span>: <span class="hljs-string">&#x27;&#x27;</span> };
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleEvent</span>(<span class="hljs-params">event: any</span>) {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">if</span> (event &amp;&amp; event.<span class="hljs-property">currentTarget</span> &amp;&amp; event.<span class="hljs-property">currentTarget</span>.<span class="hljs-property">status</span> !== <span class="hljs-number">200</span>) {
        <span class="hljs-keyword">const</span> { response, status, statusText } = event.<span class="hljs-property">currentTarget</span>;
        <span class="hljs-keyword">const</span> { method, url } = oldArgs;
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(event);

        report&lt;<span class="hljs-title class_">AjaxErrorEventI</span>&gt;({
          <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;AjaxErrorEventI&#x27;</span>,
          <span class="hljs-attr">info</span>: {
            <span class="hljs-attr">response</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(response),
            status,
            method,
            url,
            <span class="hljs-attr">message</span>: statusText,
            <span class="hljs-attr">errorType</span>: event.<span class="hljs-property">type</span>,
            ...<span class="hljs-title function_">getCommonInfoFromEvent</span>(),
          },
        });
      }
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Tool&#x27;s error: <span class="hljs-subst">${e}</span>`</span>);
    }
  }
  xmlReq.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">send</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">...args</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;error&#x27;</span>, handleEvent);
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;load&#x27;</span>, handleEvent);
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;abort&#x27;</span>, handleEvent);
    <span class="hljs-keyword">return</span> oldSend.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, args);
  };
  xmlReq.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">open</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">...args: any</span>) {
    <span class="hljs-keyword">const</span> [method, url] = args;
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(oldArgs, { method, url });
    oldOpen.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, args);
  };
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">init</span>(<span class="hljs-params">_config: ConfigI</span>) {
  <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(config, _config);
  <span class="hljs-title function_">promiseError</span>();
  <span class="hljs-title function_">assetsError</span>();
  <span class="hljs-title function_">ajaxError</span>();
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> init;
</code></pre>
<h3 id="基于vuejs的项目">基于Vue.js的项目</h3>
<p>针对于Vue.js项目，虽然官方提供有<code>Vue.config.errorHandler</code>来拦截内部错误(生命周期、事件绑定等)。但处理能力有限，无法处理js运行时异步异常(如setTimeout)和资源加载异常等，因此需要使用<code>mointor.js</code> + <code>Vue.config.errorHandler</code>来共同处理</p>
<h3 id="基于reactjs的项目">基于React.js的项目</h3>
<ol>
<li><p>引入<code>monitor.ts</code></p>
</li>
<li><p>添加<code>MErrorBoundary</code>组件用户出现异常后优雅降级显示和收集出错组件</p>
</li>
</ol>
<pre><code class="hljs language-tsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;

<span class="hljs-keyword">class</span> <span class="hljs-title class_">MErrorBoundary</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">React.Component</span>&lt;<span class="hljs-built_in">any</span>, <span class="hljs-built_in">any</span>&gt; {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">props: <span class="hljs-built_in">any</span></span>) {
    <span class="hljs-variable language_">super</span>(props);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = { <span class="hljs-attr">hasError</span>: <span class="hljs-literal">false</span> };
  }

  <span class="hljs-keyword">static</span> <span class="hljs-title function_">getDerivedStateFromError</span>(<span class="hljs-params"></span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;MErrorBoundary&#x27;</span>);
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">hasError</span>: <span class="hljs-literal">true</span> };
  }

  <span class="hljs-title function_">componentDidCatch</span>(<span class="hljs-params">error: <span class="hljs-built_in">any</span>, errorInfo: <span class="hljs-built_in">any</span></span>) {
    <span class="hljs-comment">// logErrorToMyService(error, errorInfo);</span>
  }

  <span class="hljs-title function_">render</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>.<span class="hljs-property">hasError</span>) {
      <span class="hljs-keyword">return</span> (
        <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Something went wrong.<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
      );
    }

    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">props</span>.<span class="hljs-property">children</span>;
  }
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">MErrorBoundary</span>;
</code></pre>
<h2 id="白屏和卡顿">白屏和卡顿</h2>
<p>// todo</p>
</div></div></div></article></div></main><footer class="flex flex-col items-center justify-center leading-8 text-sm w-full py-2 border-t text-skin-muted"><p>Designed &amp; developed by<a class="ml-1 text-yellow" target="_blank" href="https://github.com/mrrs878" rel="noreferrer">Mr.RS</a></p><p>©<!-- --> <!-- -->2022</p></footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"title":"异常监控-异常捕获","tags":["异常监控"],"categories":"前端架构\u0026软实力","description":"## 异常分类\n\n- 编译时异常/运行时异常\n\n**着重处理运行时异常**\n\n## 要处理的异常\n\n- js运行时异常\n- 静态资源加载异常\n- Promise异常\n- ajax请求异常\n- 崩溃和卡顿\n\n## 捕获异常\n\n### 普通前端项目\n\n```js\n// monitor.ts\n\ninterface ConfigI {\n  reportUrl: string;\n}\n\ninterface","createDate":"2020-07-28 11:15:28","updateDate":"2021-02-20 17:14:19","body":"\u003ch2 id=\"异常分类\"\u003e异常分类\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003e编译时异常/运行时异常\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003e着重处理运行时异常\u003c/strong\u003e\u003c/p\u003e\n\u003ch2 id=\"要处理的异常\"\u003e要处理的异常\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003ejs运行时异常\u003c/li\u003e\n\u003cli\u003e静态资源加载异常\u003c/li\u003e\n\u003cli\u003ePromise异常\u003c/li\u003e\n\u003cli\u003eajax请求异常\u003c/li\u003e\n\u003cli\u003e崩溃和卡顿\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"捕获异常\"\u003e捕获异常\u003c/h2\u003e\n\u003ch3 id=\"普通前端项目\"\u003e普通前端项目\u003c/h3\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003e\u003cspan class=\"hljs-comment\"\u003e// monitor.ts\u003c/span\u003e\n\ninterface \u003cspan class=\"hljs-title class_\"\u003eConfigI\u003c/span\u003e {\n  \u003cspan class=\"hljs-attr\"\u003ereportUrl\u003c/span\u003e: string;\n}\n\ninterface \u003cspan class=\"hljs-title class_\"\u003eBaseinfoI\u003c/span\u003e {\n  \u003cspan class=\"hljs-attr\"\u003etitle\u003c/span\u003e: string;\n  \u003cspan class=\"hljs-attr\"\u003elocation\u003c/span\u003e: string;\n  \u003cspan class=\"hljs-attr\"\u003emessage\u003c/span\u003e: string;\n  \u003cspan class=\"hljs-attr\"\u003ekind\u003c/span\u003e: string;\n  \u003cspan class=\"hljs-attr\"\u003etype\u003c/span\u003e: string;\n  \u003cspan class=\"hljs-attr\"\u003eerrorType\u003c/span\u003e: string;\n}\n\ninterface \u003cspan class=\"hljs-title class_\"\u003eJSRunTimeErrorEventI\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eextends\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eBaseinfoI\u003c/span\u003e {\n  \u003cspan class=\"hljs-attr\"\u003efilename\u003c/span\u003e: string;\n  \u003cspan class=\"hljs-attr\"\u003eposition\u003c/span\u003e: string;\n  \u003cspan class=\"hljs-attr\"\u003estack\u003c/span\u003e: string;\n  \u003cspan class=\"hljs-attr\"\u003eselector\u003c/span\u003e: string;\n}\n\ninterface \u003cspan class=\"hljs-title class_\"\u003eAssetsErrorI\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eextends\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eBaseinfoI\u003c/span\u003e {\n  \u003cspan class=\"hljs-attr\"\u003eurl\u003c/span\u003e: string;\n  \u003cspan class=\"hljs-attr\"\u003enodeName\u003c/span\u003e: string;\n}\n\ninterface \u003cspan class=\"hljs-title class_\"\u003eAjaxErrorEventI\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eextends\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eBaseinfoI\u003c/span\u003e {\n  \u003cspan class=\"hljs-attr\"\u003eresponse\u003c/span\u003e: string;\n  \u003cspan class=\"hljs-attr\"\u003estatus\u003c/span\u003e: number;\n  \u003cspan class=\"hljs-attr\"\u003emethod\u003c/span\u003e: string;\n  \u003cspan class=\"hljs-attr\"\u003eurl\u003c/span\u003e: string;\n}\n\ninterface \u003cspan class=\"hljs-title class_\"\u003ePromiseErrorI\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eextends\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eBaseinfoI\u003c/span\u003e {\n  \u003cspan class=\"hljs-attr\"\u003emessage\u003c/span\u003e: string;\n  \u003cspan class=\"hljs-attr\"\u003estack\u003c/span\u003e: string;\n}\n\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003econfig\u003c/span\u003e: \u003cspan class=\"hljs-title class_\"\u003eConfigI\u003c/span\u003e = { \u003cspan class=\"hljs-attr\"\u003ereportUrl\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\u0026#x27;/\u0026#x27;\u003c/span\u003e };\n\n\u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003egetLastEvent\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003e\u003c/span\u003e): \u003cspan class=\"hljs-literal\"\u003eundefined\u003c/span\u003e | \u003cspan class=\"hljs-title class_\"\u003eEvent\u003c/span\u003e {\n  \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e lastEvent;\n  [\u003cspan class=\"hljs-string\"\u003e\u0026#x27;click\u0026#x27;\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e\u0026#x27;touchstart\u0026#x27;\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e\u0026#x27;mousedown\u0026#x27;\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e\u0026#x27;keydown\u0026#x27;\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e\u0026#x27;mouseover\u0026#x27;\u003c/span\u003e].\u003cspan class=\"hljs-title function_\"\u003eforEach\u003c/span\u003e(\u003cspan class=\"hljs-function\"\u003e(\u003cspan class=\"hljs-params\"\u003eeventType\u003c/span\u003e) =\u0026gt;\u003c/span\u003e \u003cspan class=\"hljs-variable language_\"\u003edocument\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003eaddEventListener\u003c/span\u003e(eventType, \u003cspan class=\"hljs-function\"\u003e(\u003cspan class=\"hljs-params\"\u003eevent\u003c/span\u003e) =\u0026gt;\u003c/span\u003e {\n    lastEvent = event;\n  }, {\n    \u003cspan class=\"hljs-attr\"\u003ecapture\u003c/span\u003e: \u003cspan class=\"hljs-literal\"\u003etrue\u003c/span\u003e,\n    \u003cspan class=\"hljs-attr\"\u003epassive\u003c/span\u003e: \u003cspan class=\"hljs-literal\"\u003etrue\u003c/span\u003e,\n  }));\n  \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e lastEvent;\n}\n\n\u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003egetSelector\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003epath: \u003cspan class=\"hljs-built_in\"\u003eArray\u003c/span\u003e\u0026lt;EventTarget\u0026gt;\u003c/span\u003e) {\n  \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026#x27;\u0026#x27;\u003c/span\u003e;\n}\n\n\u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e report\u0026lt;T\u0026gt;(\u003cspan class=\"hljs-attr\"\u003edata\u003c/span\u003e: { \u003cspan class=\"hljs-attr\"\u003etype\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\u0026#x27;JSRunTimeErrorI\u0026#x27;\u003c/span\u003e | \u003cspan class=\"hljs-string\"\u003e\u0026#x27;PromiseErrorT\u0026#x27;\u003c/span\u003e | \u003cspan class=\"hljs-string\"\u003e\u0026#x27;AssetsErrorI\u0026#x27;\u003c/span\u003e | \u003cspan class=\"hljs-string\"\u003e\u0026#x27;AjaxErrorEventI\u0026#x27;\u003c/span\u003e; \u003cspan class=\"hljs-attr\"\u003einfo\u003c/span\u003e: T }) {\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e image = \u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eImage\u003c/span\u003e();\n  image.\u003cspan class=\"hljs-property\"\u003esrc\u003c/span\u003e = \u003cspan class=\"hljs-string\"\u003e`\u003cspan class=\"hljs-subst\"\u003e${config.reportUrl}\u003c/span\u003e?error=\u003cspan class=\"hljs-subst\"\u003e${\u003cspan class=\"hljs-built_in\"\u003eJSON\u003c/span\u003e.stringify(data.info)}\u003c/span\u003e`\u003c/span\u003e;\n}\n\n\u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003egetCommonInfoFromEvent\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003eevent?: Event\u003c/span\u003e) {\n  \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e {\n    \u003cspan class=\"hljs-attr\"\u003etitle\u003c/span\u003e: \u003cspan class=\"hljs-variable language_\"\u003edocument\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003etitle\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003ereplace\u003c/span\u003e(\u003cspan class=\"hljs-regexp\"\u003e/\u0026amp;/\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e\u0026#x27;\u0026#x27;\u003c/span\u003e),\n    \u003cspan class=\"hljs-attr\"\u003elocation\u003c/span\u003e: \u003cspan class=\"hljs-variable language_\"\u003ewindow\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003elocation\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003ehref\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003ereplace\u003c/span\u003e(\u003cspan class=\"hljs-regexp\"\u003e/\u0026amp;/\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e\u0026#x27;\u0026#x27;\u003c/span\u003e),\n    \u003cspan class=\"hljs-attr\"\u003ekind\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\u0026#x27;stability\u0026#x27;\u003c/span\u003e,\n    \u003cspan class=\"hljs-attr\"\u003etype\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\u0026#x27;error\u0026#x27;\u003c/span\u003e,\n  };\n}\n\n\u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003egetLines\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003estack: string | \u003cspan class=\"hljs-literal\"\u003eundefined\u003c/span\u003e\u003c/span\u003e) {\n  \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e stack?.\u003cspan class=\"hljs-title function_\"\u003esplit\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026#x27;\\n\u0026#x27;\u003c/span\u003e).\u003cspan class=\"hljs-title function_\"\u003eslice\u003c/span\u003e(\u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e).\u003cspan class=\"hljs-title function_\"\u003emap\u003c/span\u003e(\u003cspan class=\"hljs-function\"\u003e(\u003cspan class=\"hljs-params\"\u003eitem\u003c/span\u003e) =\u0026gt;\u003c/span\u003e item.\u003cspan class=\"hljs-title function_\"\u003ereplace\u003c/span\u003e(\u003cspan class=\"hljs-regexp\"\u003e/^\\s+at\\s+/g\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e\u0026#x27;\u0026#x27;\u003c/span\u003e)).\u003cspan class=\"hljs-title function_\"\u003ejoin\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026#x27;\u0026#x27;\u003c/span\u003e) || \u003cspan class=\"hljs-string\"\u003e\u0026#x27;\u0026#x27;\u003c/span\u003e;\n}\n\n\u003cspan class=\"hljs-comment\"\u003e// Promise异常\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003epromiseError\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003e\u003c/span\u003e) {\n  \u003cspan class=\"hljs-variable language_\"\u003ewindow\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003eaddEventListener\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026#x27;unhandledrejection\u0026#x27;\u003c/span\u003e, \u003cspan class=\"hljs-function\"\u003e(\u003cspan class=\"hljs-params\"\u003eevent: PromiseRejectionEvent\u003c/span\u003e) =\u0026gt;\u003c/span\u003e {\n    event.\u003cspan class=\"hljs-title function_\"\u003epreventDefault\u003c/span\u003e();\n    \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e message = \u003cspan class=\"hljs-string\"\u003e\u0026#x27;\u0026#x27;\u003c/span\u003e;\n    \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e stack = \u003cspan class=\"hljs-string\"\u003e\u0026#x27;\u0026#x27;\u003c/span\u003e;\n    message = event.\u003cspan class=\"hljs-property\"\u003ereason\u003c/span\u003e;\n    \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e { reason } = event;\n    \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (reason \u003cspan class=\"hljs-keyword\"\u003einstanceof\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eError\u003c/span\u003e) {\n      message = reason.\u003cspan class=\"hljs-property\"\u003emessage\u003c/span\u003e;\n      stack = \u003cspan class=\"hljs-title function_\"\u003egetLines\u003c/span\u003e(reason.\u003cspan class=\"hljs-property\"\u003estack\u003c/span\u003e);\n    }\n\n    report\u0026lt;\u003cspan class=\"hljs-title class_\"\u003ePromiseErrorI\u003c/span\u003e\u0026gt;({ \u003cspan class=\"hljs-attr\"\u003etype\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\u0026#x27;PromiseErrorT\u0026#x27;\u003c/span\u003e, \u003cspan class=\"hljs-attr\"\u003einfo\u003c/span\u003e: { \u003cspan class=\"hljs-attr\"\u003eerrorType\u003c/span\u003e: event.\u003cspan class=\"hljs-property\"\u003etype\u003c/span\u003e, message, stack, ...\u003cspan class=\"hljs-title function_\"\u003egetCommonInfoFromEvent\u003c/span\u003e() } });\n    \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-literal\"\u003etrue\u003c/span\u003e;\n  }, \u003cspan class=\"hljs-literal\"\u003etrue\u003c/span\u003e);\n}\n\n\u003cspan class=\"hljs-comment\"\u003e// 静态资源加载异常\u0026amp;JSRuntime异常\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003eassetsError\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003e\u003c/span\u003e) {\n  \u003cspan class=\"hljs-variable language_\"\u003ewindow\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003eaddEventListener\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026#x27;error\u0026#x27;\u003c/span\u003e, \u003cspan class=\"hljs-function\"\u003e(\u003cspan class=\"hljs-params\"\u003eevent: ErrorEvent\u003c/span\u003e) =\u0026gt;\u003c/span\u003e {\n    \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e { target } = event;\n    \u003cspan class=\"hljs-variable language_\"\u003econsole\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003elog\u003c/span\u003e(event);\n    \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e isElementTarget = target \u003cspan class=\"hljs-keyword\"\u003einstanceof\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eHTMLScriptElement\u003c/span\u003e || target \u003cspan class=\"hljs-keyword\"\u003einstanceof\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eHTMLLinkElement\u003c/span\u003e || target \u003cspan class=\"hljs-keyword\"\u003einstanceof\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eHTMLImageElement\u003c/span\u003e;\n    \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (!isElementTarget) {\n      \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e { message, filename, lineno, colno, error, type } = event;\n      \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e position = \u003cspan class=\"hljs-string\"\u003e`\u003cspan class=\"hljs-subst\"\u003e${lineno}\u003c/span\u003e:\u003cspan class=\"hljs-subst\"\u003e${colno}\u003c/span\u003e`\u003c/span\u003e;\n      \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e stack = \u003cspan class=\"hljs-title function_\"\u003egetLines\u003c/span\u003e(error \u003cspan class=\"hljs-keyword\"\u003einstanceof\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eError\u003c/span\u003e ? error.\u003cspan class=\"hljs-property\"\u003estack\u003c/span\u003e : \u003cspan class=\"hljs-string\"\u003e\u0026#x27;\u0026#x27;\u003c/span\u003e);\n      \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e lastEvent = \u003cspan class=\"hljs-title function_\"\u003egetLastEvent\u003c/span\u003e();\n      \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e selector = lastEvent ? \u003cspan class=\"hljs-title function_\"\u003egetSelector\u003c/span\u003e(lastEvent.\u003cspan class=\"hljs-title function_\"\u003ecomposedPath\u003c/span\u003e()) : \u003cspan class=\"hljs-string\"\u003e\u0026#x27;\u0026#x27;\u003c/span\u003e;\n      report\u0026lt;\u003cspan class=\"hljs-title class_\"\u003eJSRunTimeErrorEventI\u003c/span\u003e\u0026gt;({\n        \u003cspan class=\"hljs-attr\"\u003etype\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\u0026#x27;JSRunTimeErrorI\u0026#x27;\u003c/span\u003e,\n        \u003cspan class=\"hljs-attr\"\u003einfo\u003c/span\u003e: { ...\u003cspan class=\"hljs-title function_\"\u003egetCommonInfoFromEvent\u003c/span\u003e(), message, \u003cspan class=\"hljs-attr\"\u003eerrorType\u003c/span\u003e: type, filename, position, stack, selector },\n      });\n    } \u003cspan class=\"hljs-keyword\"\u003eelse\u003c/span\u003e {\n      \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e url = \u003cspan class=\"hljs-string\"\u003e\u0026#x27;\u0026#x27;\u003c/span\u003e;\n      \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e nodeName = \u003cspan class=\"hljs-string\"\u003e\u0026#x27;\u0026#x27;\u003c/span\u003e;\n      \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (target \u003cspan class=\"hljs-keyword\"\u003einstanceof\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eHTMLImageElement\u003c/span\u003e || target \u003cspan class=\"hljs-keyword\"\u003einstanceof\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eHTMLScriptElement\u003c/span\u003e) {\n        url = target.\u003cspan class=\"hljs-property\"\u003esrc\u003c/span\u003e;\n        nodeName = target.\u003cspan class=\"hljs-property\"\u003enodeName\u003c/span\u003e;\n      }\n      \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (target \u003cspan class=\"hljs-keyword\"\u003einstanceof\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eHTMLLinkElement\u003c/span\u003e) {\n        url = target.\u003cspan class=\"hljs-property\"\u003ehref\u003c/span\u003e;\n        nodeName = target.\u003cspan class=\"hljs-property\"\u003enodeName\u003c/span\u003e;\n      }\n\n      report\u0026lt;\u003cspan class=\"hljs-title class_\"\u003eAssetsErrorI\u003c/span\u003e\u0026gt;({ \u003cspan class=\"hljs-attr\"\u003etype\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\u0026#x27;AssetsErrorI\u0026#x27;\u003c/span\u003e,\n        \u003cspan class=\"hljs-attr\"\u003einfo\u003c/span\u003e: {\n          url,\n          \u003cspan class=\"hljs-attr\"\u003eerrorType\u003c/span\u003e: event.\u003cspan class=\"hljs-property\"\u003etype\u003c/span\u003e,\n          nodeName,\n          \u003cspan class=\"hljs-attr\"\u003emessage\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\u0026#x27;\u0026#x27;\u003c/span\u003e,\n          ...\u003cspan class=\"hljs-title function_\"\u003egetCommonInfoFromEvent\u003c/span\u003e() } });\n    }\n    \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-literal\"\u003etrue\u003c/span\u003e;\n  }, \u003cspan class=\"hljs-literal\"\u003etrue\u003c/span\u003e);\n}\n\n\u003cspan class=\"hljs-comment\"\u003e// ajax请求异常\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003eajaxError\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003e\u003c/span\u003e) {\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e { protocol } = \u003cspan class=\"hljs-variable language_\"\u003ewindow\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003elocation\u003c/span\u003e;\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (protocol === \u003cspan class=\"hljs-string\"\u003e\u0026#x27;file:\u0026#x27;\u003c/span\u003e) \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e;\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (!\u003cspan class=\"hljs-variable language_\"\u003ewindow\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eXMLHttpRequest\u003c/span\u003e) \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e;\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e xmlReq = \u003cspan class=\"hljs-variable language_\"\u003ewindow\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eXMLHttpRequest\u003c/span\u003e;\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e oldSend = xmlReq.\u003cspan class=\"hljs-property\"\u003e\u003cspan class=\"hljs-keyword\"\u003eprototype\u003c/span\u003e\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003esend\u003c/span\u003e;\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e oldOpen = xmlReq.\u003cspan class=\"hljs-property\"\u003e\u003cspan class=\"hljs-keyword\"\u003eprototype\u003c/span\u003e\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eopen\u003c/span\u003e;\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e oldArgs = { \u003cspan class=\"hljs-attr\"\u003emethod\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\u0026#x27;\u0026#x27;\u003c/span\u003e, \u003cspan class=\"hljs-attr\"\u003eurl\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\u0026#x27;\u0026#x27;\u003c/span\u003e };\n  \u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003ehandleEvent\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003eevent: any\u003c/span\u003e) {\n    \u003cspan class=\"hljs-keyword\"\u003etry\u003c/span\u003e {\n      \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (event \u0026amp;\u0026amp; event.\u003cspan class=\"hljs-property\"\u003ecurrentTarget\u003c/span\u003e \u0026amp;\u0026amp; event.\u003cspan class=\"hljs-property\"\u003ecurrentTarget\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003estatus\u003c/span\u003e !== \u003cspan class=\"hljs-number\"\u003e200\u003c/span\u003e) {\n        \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e { response, status, statusText } = event.\u003cspan class=\"hljs-property\"\u003ecurrentTarget\u003c/span\u003e;\n        \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e { method, url } = oldArgs;\n        \u003cspan class=\"hljs-variable language_\"\u003econsole\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003elog\u003c/span\u003e(event);\n\n        report\u0026lt;\u003cspan class=\"hljs-title class_\"\u003eAjaxErrorEventI\u003c/span\u003e\u0026gt;({\n          \u003cspan class=\"hljs-attr\"\u003etype\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\u0026#x27;AjaxErrorEventI\u0026#x27;\u003c/span\u003e,\n          \u003cspan class=\"hljs-attr\"\u003einfo\u003c/span\u003e: {\n            \u003cspan class=\"hljs-attr\"\u003eresponse\u003c/span\u003e: \u003cspan class=\"hljs-title class_\"\u003eJSON\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003eparse\u003c/span\u003e(response),\n            status,\n            method,\n            url,\n            \u003cspan class=\"hljs-attr\"\u003emessage\u003c/span\u003e: statusText,\n            \u003cspan class=\"hljs-attr\"\u003eerrorType\u003c/span\u003e: event.\u003cspan class=\"hljs-property\"\u003etype\u003c/span\u003e,\n            ...\u003cspan class=\"hljs-title function_\"\u003egetCommonInfoFromEvent\u003c/span\u003e(),\n          },\n        });\n      }\n    } \u003cspan class=\"hljs-keyword\"\u003ecatch\u003c/span\u003e (e) {\n      \u003cspan class=\"hljs-variable language_\"\u003econsole\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003elog\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e`Tool\u0026#x27;s error: \u003cspan class=\"hljs-subst\"\u003e${e}\u003c/span\u003e`\u003c/span\u003e);\n    }\n  }\n  xmlReq.\u003cspan class=\"hljs-property\"\u003e\u003cspan class=\"hljs-keyword\"\u003eprototype\u003c/span\u003e\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003esend\u003c/span\u003e = \u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e (\u003cspan class=\"hljs-params\"\u003e...args\u003c/span\u003e) {\n    \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003eaddEventListener\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026#x27;error\u0026#x27;\u003c/span\u003e, handleEvent);\n    \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003eaddEventListener\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026#x27;load\u0026#x27;\u003c/span\u003e, handleEvent);\n    \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003eaddEventListener\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026#x27;abort\u0026#x27;\u003c/span\u003e, handleEvent);\n    \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e oldSend.\u003cspan class=\"hljs-title function_\"\u003eapply\u003c/span\u003e(\u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e, args);\n  };\n  xmlReq.\u003cspan class=\"hljs-property\"\u003e\u003cspan class=\"hljs-keyword\"\u003eprototype\u003c/span\u003e\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eopen\u003c/span\u003e = \u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e (\u003cspan class=\"hljs-params\"\u003e...args: any\u003c/span\u003e) {\n    \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e [method, url] = args;\n    \u003cspan class=\"hljs-title class_\"\u003eObject\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003eassign\u003c/span\u003e(oldArgs, { method, url });\n    oldOpen.\u003cspan class=\"hljs-title function_\"\u003eapply\u003c/span\u003e(\u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e, args);\n  };\n}\n\n\u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003einit\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003e_config: ConfigI\u003c/span\u003e) {\n  \u003cspan class=\"hljs-title class_\"\u003eObject\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003eassign\u003c/span\u003e(config, _config);\n  \u003cspan class=\"hljs-title function_\"\u003epromiseError\u003c/span\u003e();\n  \u003cspan class=\"hljs-title function_\"\u003eassetsError\u003c/span\u003e();\n  \u003cspan class=\"hljs-title function_\"\u003eajaxError\u003c/span\u003e();\n}\n\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003edefault\u003c/span\u003e init;\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch3 id=\"基于vuejs的项目\"\u003e基于Vue.js的项目\u003c/h3\u003e\n\u003cp\u003e针对于Vue.js项目，虽然官方提供有\u003ccode\u003eVue.config.errorHandler\u003c/code\u003e来拦截内部错误(生命周期、事件绑定等)。但处理能力有限，无法处理js运行时异步异常(如setTimeout)和资源加载异常等，因此需要使用\u003ccode\u003emointor.js\u003c/code\u003e + \u003ccode\u003eVue.config.errorHandler\u003c/code\u003e来共同处理\u003c/p\u003e\n\u003ch3 id=\"基于reactjs的项目\"\u003e基于React.js的项目\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003e\u003cp\u003e引入\u003ccode\u003emonitor.ts\u003c/code\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003cp\u003e添加\u003ccode\u003eMErrorBoundary\u003c/code\u003e组件用户出现异常后优雅降级显示和收集出错组件\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ol\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-tsx\"\u003e\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eReact\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026#x27;react\u0026#x27;\u003c/span\u003e;\n\n\u003cspan class=\"hljs-keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eMErrorBoundary\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eextends\u003c/span\u003e \u003cspan class=\"hljs-title class_ inherited__\"\u003eReact.Component\u003c/span\u003e\u0026lt;\u003cspan class=\"hljs-built_in\"\u003eany\u003c/span\u003e, \u003cspan class=\"hljs-built_in\"\u003eany\u003c/span\u003e\u0026gt; {\n  \u003cspan class=\"hljs-title function_\"\u003econstructor\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003eprops: \u003cspan class=\"hljs-built_in\"\u003eany\u003c/span\u003e\u003c/span\u003e) {\n    \u003cspan class=\"hljs-variable language_\"\u003esuper\u003c/span\u003e(props);\n    \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003estate\u003c/span\u003e = { \u003cspan class=\"hljs-attr\"\u003ehasError\u003c/span\u003e: \u003cspan class=\"hljs-literal\"\u003efalse\u003c/span\u003e };\n  }\n\n  \u003cspan class=\"hljs-keyword\"\u003estatic\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003egetDerivedStateFromError\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003e\u003c/span\u003e) {\n    \u003cspan class=\"hljs-variable language_\"\u003econsole\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003elog\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026#x27;MErrorBoundary\u0026#x27;\u003c/span\u003e);\n    \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e { \u003cspan class=\"hljs-attr\"\u003ehasError\u003c/span\u003e: \u003cspan class=\"hljs-literal\"\u003etrue\u003c/span\u003e };\n  }\n\n  \u003cspan class=\"hljs-title function_\"\u003ecomponentDidCatch\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003eerror: \u003cspan class=\"hljs-built_in\"\u003eany\u003c/span\u003e, errorInfo: \u003cspan class=\"hljs-built_in\"\u003eany\u003c/span\u003e\u003c/span\u003e) {\n    \u003cspan class=\"hljs-comment\"\u003e// logErrorToMyService(error, errorInfo);\u003c/span\u003e\n  }\n\n  \u003cspan class=\"hljs-title function_\"\u003erender\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003e\u003c/span\u003e) {\n    \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (\u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003estate\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003ehasError\u003c/span\u003e) {\n      \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e (\n        \u003cspan class=\"language-xml\"\u003e\u003cspan class=\"hljs-tag\"\u003e\u0026lt;\u003cspan class=\"hljs-name\"\u003ediv\u003c/span\u003e\u0026gt;\u003c/span\u003e\n          \u003cspan class=\"hljs-tag\"\u003e\u0026lt;\u003cspan class=\"hljs-name\"\u003eh1\u003c/span\u003e\u0026gt;\u003c/span\u003eSomething went wrong.\u003cspan class=\"hljs-tag\"\u003e\u0026lt;/\u003cspan class=\"hljs-name\"\u003eh1\u003c/span\u003e\u0026gt;\u003c/span\u003e\n        \u003cspan class=\"hljs-tag\"\u003e\u0026lt;/\u003cspan class=\"hljs-name\"\u003ediv\u003c/span\u003e\u0026gt;\u003c/span\u003e\u003c/span\u003e\n      );\n    }\n\n    \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eprops\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003echildren\u003c/span\u003e;\n  }\n}\n\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003edefault\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eMErrorBoundary\u003c/span\u003e;\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch2 id=\"白屏和卡顿\"\u003e白屏和卡顿\u003c/h2\u003e\n\u003cp\u003e// todo\u003c/p\u003e\n"}},"__N_SSG":true},"page":"/post/[title]","query":{"title":"异常监控-异常捕获"},"buildId":"ZYBT_GVMR4rRyxQKNqnGG","assetPrefix":"/next-blog","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>
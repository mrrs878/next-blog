<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><title>Mr.RS的个人博客-React.js学习-hooks原理简析</title><meta name="next-head-count" content="3"/><link rel="preload" href="/next-blog/_next/static/css/1bf96eec8dc413e7.css" as="style"/><link rel="stylesheet" href="/next-blog/_next/static/css/1bf96eec8dc413e7.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/next-blog/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/next-blog/_next/static/chunks/webpack-cf185e4b59cdddcf.js" defer=""></script><script src="/next-blog/_next/static/chunks/framework-91d7f78b5b4003c8.js" defer=""></script><script src="/next-blog/_next/static/chunks/main-1c9e93b8392c1bc9.js" defer=""></script><script src="/next-blog/_next/static/chunks/pages/_app-ca6aae25bc99a05f.js" defer=""></script><script src="/next-blog/_next/static/chunks/899-1cd3a59abdb8ea18.js" defer=""></script><script src="/next-blog/_next/static/chunks/pages/post/%5Btitle%5D-406bad804ceffd1d.js" defer=""></script><script src="/next-blog/_next/static/TVvrPujXTaoFDu5iIhwje/_buildManifest.js" defer=""></script><script src="/next-blog/_next/static/TVvrPujXTaoFDu5iIhwje/_ssgManifest.js" defer=""></script><script src="/next-blog/_next/static/TVvrPujXTaoFDu5iIhwje/_middlewareManifest.js" defer=""></script></head><body><div id="__next" data-reactroot=""><header class="fixed top-0 py-4 left-0 right-0 h-auto px-10 shadow bg-white z-50"><nav><ul class="flex w-auto"><li class="mr-4 hover:text-yellow"><a href="/next-blog">首页</a></li><li class="mx-4 hover:text-yellow"><a href="/next-blog/categories">分类</a></li><li class="mx-4 hover:text-yellow"><a href="/next-blog/tags">标签</a></li><li class="ml-4 hover:text-yellow"><a href="/next-blog/timeline">归档</a></li></ul></nav></header><main class="mt-20 mb-4 mx-auto justify-center w-2/3"><div class="mx-auto lg:max-w-5xl md:max-w-3xl"><article class="flex flex-col justify-around pb-16 px-4 mx-auto space-y-10 text-base"><div class="flex flex-col space-y-4"><h1 class="inline pt-10 text-4xl text-skin-primary">React.js学习-hooks原理简析</h1><div class="text-sm space-x-2 text-skin-muted"><span><svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 inline-block mr-1"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>2021-12-23 11:25:20</span><span><svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 inline-block mr-1"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>44</span></div></div><div class="mt-8 flex"><div class="w-full flex-auto custom-markdown-body"><div class="markdown-body" id="write"><p>让我们从实现两个简单的hook入手来探究hooks原理</p>
<blockquote>
<p><a href="https://github.com/mrrs878/review">示例代码</a></p>
</blockquote>
<h2 id="usestate">useState</h2>
<p><code>useState</code>用于在函数式组件中声明并保存一个变量，<code>useState</code>的使用是这样的：</p>
<pre><code class="hljs language-ts"><span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(count);

<span class="hljs-title function_">setCount</span>(<span class="hljs-number">1</span>);

<span class="hljs-title function_">setCount</span>((pre) + pre + <span class="hljs-number">1</span>);
</code></pre>
<p>有几个特点：</p>
<ol>
<li>接受一个函数或值作为变量的初始值</li>
<li>返回一个数组(元组)，第一个参数是变量值，第二个参数是一个函数，可用来更新变量值</li>
<li>返回的更新函数支持传入一个函数，改函数的参数是当前的变量值</li>
</ol>
<p>据此，可以实现一版简单的<code>useState</code></p>
<pre><code class="hljs language-ts"><span class="hljs-keyword">function</span> <span class="hljs-title function_">useState</span>(<span class="hljs-params">initialState</span>) {
    <span class="hljs-comment">// 没有考虑传入一个函数的情况</span>
    <span class="hljs-keyword">let</span> state = initialState;
    
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">setState</span> = (<span class="hljs-params">newState</span>) =&gt; {
        state = newState;
    }
    
    <span class="hljs-keyword">return</span> [state, setState];
}
</code></pre>
<p>但在使用的时候会发现，当调用<code>setCount</code>的时候，<code>count</code> 并不会变化，这是因为我们没有存储<code>state</code>，导致每次渲染组件的时候，<code>state</code>都会重新设置</p>
<p>为解决这个问题，会自然而然地想到，把<code>state</code>提取出来，存在<code>useState</code>外面：</p>
<pre><code class="hljs language-ts"><span class="hljs-keyword">let</span> _state;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">useState</span>(<span class="hljs-params">initialState</span>) {
  _state = _state || initialState;

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">setState</span> = (<span class="hljs-params">newState</span>) =&gt; {
    _state = <span class="hljs-keyword">typeof</span> newState === <span class="hljs-string">&#x27;function&#x27;</span> ? <span class="hljs-title function_">newState</span>(_state) : newState;
  };

  <span class="hljs-keyword">return</span> [
    _state,
    setState,
  ];
}
</code></pre>
<p>测试用例</p>
<pre><code class="hljs language-ts"><span class="hljs-keyword">import</span> { renderHook, act } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@testing-library/react-hooks&#x27;</span>;
<span class="hljs-keyword">import</span> { useState } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./useState_simple&#x27;</span>;

<span class="hljs-title function_">describe</span>(<span class="hljs-string">&#x27;useState_simple&#x27;</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-title function_">it</span>(<span class="hljs-string">&#x27;useState should be defined&#x27;</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">expect</span>(useState).<span class="hljs-title function_">toBeDefined</span>();
  });

  <span class="hljs-title function_">it</span>(<span class="hljs-string">&#x27;When the update function is called, the data is updated normally&#x27;</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> { result, rerender } = <span class="hljs-title function_">renderHook</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">useState</span>(<span class="hljs-number">1</span>));

    <span class="hljs-keyword">const</span> [, setState] = result.<span class="hljs-property">current</span>;

    <span class="hljs-title function_">act</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-title function_">setState</span>(<span class="hljs-number">2</span>);
      <span class="hljs-title function_">rerender</span>();
    });

    <span class="hljs-keyword">const</span> [state] = result.<span class="hljs-property">current</span>;

    <span class="hljs-title function_">expect</span>(state).<span class="hljs-title function_">toBe</span>(<span class="hljs-number">2</span>);
  });
});
</code></pre>
<p>至此，实现了一个简单的<code>useState</code>，后边会进一步完善</p>
<h2 id="useeffect">useEffect</h2>
<p><code>useEffect</code>的使用是这样的</p>
<pre><code class="hljs language-ts"><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// do something</span>
});

<span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// do something</span>
}, [])

<span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// do something</span>
}, [deps])
</code></pre>
<p><code>useEffect</code>的使用有几个特点：</p>
<ol>
<li>有两个参数<code>callback</code>和<code>deps</code>数组</li>
<li>如果<code>deps</code>不存在，那么<code>callback</code>在每次<code>render</code>时都会执行</li>
<li>如果<code>deps</code>存在，只有当它发生了变化，<code>callback</code>才会执行</li>
</ol>
<p>根据使用方法和特点，可以做一个简单地实现：</p>
<pre><code class="hljs language-tsx"><span class="hljs-keyword">let</span> _deps;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">useEffect</span>(<span class="hljs-params">callback, deps</span>) {
  <span class="hljs-keyword">const</span> hasNoDeps = !deps;
  <span class="hljs-keyword">const</span> hasChangeDeps = _deps
    ? !deps?.<span class="hljs-title function_">every</span>(<span class="hljs-function">(<span class="hljs-params">dep, index</span>) =&gt;</span> _deps[index] === dep)
    : <span class="hljs-literal">true</span>;

  <span class="hljs-keyword">if</span> (hasNoDeps || hasChangeDeps) {
    <span class="hljs-title function_">callback</span>();
    _deps = deps;
  }
}
</code></pre>
<p>测试用例</p>
<pre><code class="hljs language-ts"><span class="hljs-keyword">import</span> { renderHook, act } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@testing-library/react-hooks&#x27;</span>;
<span class="hljs-keyword">import</span> { useEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./useEffect_simple&#x27;</span>;

<span class="hljs-title function_">describe</span>(<span class="hljs-string">&#x27;useEffect_simple&#x27;</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-title function_">it</span>(<span class="hljs-string">&#x27;useEffect should be defined&#x27;</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">expect</span>(useEffect).<span class="hljs-title function_">toBeDefined</span>();
  });

  <span class="hljs-title function_">it</span>(<span class="hljs-string">&#x27;When deps is empty, every rendering callback should be executed&#x27;</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> callback = jest.<span class="hljs-title function_">fn</span>();
    <span class="hljs-keyword">const</span> { rerender } = <span class="hljs-title function_">renderHook</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">useEffect</span>(callback));

    <span class="hljs-title function_">expect</span>(callback).<span class="hljs-title function_">toBeCalledTimes</span>(<span class="hljs-number">1</span>);

    <span class="hljs-title function_">act</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-title function_">rerender</span>();
    });

    <span class="hljs-title function_">expect</span>(callback).<span class="hljs-title function_">toBeCalledTimes</span>(<span class="hljs-number">2</span>);
  });

  <span class="hljs-title function_">it</span>(<span class="hljs-string">&#x27;When deps is an empty array, render multiple times but callback should only be called once&#x27;</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> callback = jest.<span class="hljs-title function_">fn</span>();
    <span class="hljs-keyword">const</span> { rerender } = <span class="hljs-title function_">renderHook</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">useEffect</span>(callback, []));

    <span class="hljs-title function_">expect</span>(callback).<span class="hljs-title function_">toBeCalledTimes</span>(<span class="hljs-number">1</span>);

    <span class="hljs-title function_">act</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-title function_">rerender</span>();
    });

    <span class="hljs-title function_">expect</span>(callback).<span class="hljs-title function_">toBeCalledTimes</span>(<span class="hljs-number">1</span>);
  });

  <span class="hljs-title function_">it</span>(<span class="hljs-string">&#x27;When deps is changed, callback should be called&#x27;</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> callback = jest.<span class="hljs-title function_">fn</span>();
    <span class="hljs-keyword">const</span> { rerender } = <span class="hljs-title function_">renderHook</span>(<span class="hljs-function">(<span class="hljs-params">{ name }</span>) =&gt;</span> <span class="hljs-title function_">useEffect</span>(callback, [name]), {
      <span class="hljs-attr">initialProps</span>: {
        <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;tom&#x27;</span>,
      },
    });

    <span class="hljs-title function_">expect</span>(callback).<span class="hljs-title function_">toBeCalledTimes</span>(<span class="hljs-number">1</span>);

    <span class="hljs-title function_">act</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-title function_">rerender</span>({
        <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;jerry&#x27;</span>,
      });
    });

    <span class="hljs-title function_">expect</span>(callback).<span class="hljs-title function_">toBeCalledTimes</span>(<span class="hljs-number">2</span>);
  });
});
</code></pre>
<p>到这里，我们又实现了一个可以工作的丐版<code>useEffect</code>，hook貌似没有那么难</p>
<h2 id="优化">优化</h2>
<p>我们上边实现的两个简单的hook存在一个致命缺点，在一个组件内只能使用一次，对此，我们可以将<code>_state</code>和<code>_deps</code>保存至一个全局数组<code>memoizedState </code>中，并用一个变量存储当前<code>memoizedState</code>下标</p>
<pre><code class="hljs language-ts"><span class="hljs-keyword">let</span> memoizedStates = []; <span class="hljs-comment">// hooks存放在这个数组</span>
<span class="hljs-keyword">let</span> cursor = <span class="hljs-number">0</span>; <span class="hljs-comment">// 当前memoizedState下标</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">useState</span>(<span class="hljs-params">initialState</span>) {
  memoizedStates[cursor] = memoizedStates[cursor] || initialState;

  <span class="hljs-keyword">const</span> currentCursor = cursor;
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">setState</span> = (<span class="hljs-params">newState</span>) =&gt; {
    memoizedStates[currentCursor] = <span class="hljs-keyword">typeof</span> newState === <span class="hljs-string">&#x27;function&#x27;</span>
      ? <span class="hljs-title function_">newState</span>(memoizedStates[currentCursor])
      : newState;
  };

  <span class="hljs-keyword">const</span> res = [memoizedStates[cursor], setState];
  cursor += <span class="hljs-number">1</span>;

  <span class="hljs-keyword">return</span> res;
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">useEffect</span>(<span class="hljs-params">callback, deps</span>) {
  <span class="hljs-keyword">const</span> hasNoDeps = deps === <span class="hljs-literal">undefined</span>;
  <span class="hljs-keyword">const</span> preDeps = memoizedStates[cursor];
  <span class="hljs-keyword">const</span> hasChangedDeps = preDeps
    ? !deps.<span class="hljs-title function_">every</span>(<span class="hljs-function">(<span class="hljs-params">dep, index</span>) =&gt;</span> dep === preDeps[index])
    : <span class="hljs-literal">true</span>;

  <span class="hljs-keyword">if</span> (hasNoDeps || hasChangedDeps) {
    <span class="hljs-title function_">callback</span>();
    memoizedStates[cursor] = deps;
  }

  cursor += <span class="hljs-number">1</span>;
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">resetCursor</span>(<span class="hljs-params"></span>) {
  cursor = <span class="hljs-number">0</span>;
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">resetMemoizedStates</span>(<span class="hljs-params"></span>) {
  memoizedStates = [];
}
</code></pre>
<p><strong>Not Magic, just Arrays</strong></p>
<p>测试用例</p>
<pre><code class="hljs language-ts"><span class="hljs-keyword">import</span> { act, renderHook } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@testing-library/react-hooks&#x27;</span>;
<span class="hljs-keyword">import</span> {
  resetCursor, useEffect, useState, resetMemoizedStates,
} <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./useState_useEffect&#x27;</span>;
<span class="hljs-title function_">describe</span>(<span class="hljs-string">&#x27;useState_simple&#x27;</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-title function_">it</span>(<span class="hljs-string">&#x27;useState should be defined&#x27;</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">expect</span>(useState).<span class="hljs-title function_">toBeDefined</span>();
  });

  <span class="hljs-title function_">it</span>(<span class="hljs-string">&#x27;When the update function is called, the data is updated normally&#x27;</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">usePeople</span> = (<span class="hljs-params"></span>) =&gt; {
      <span class="hljs-keyword">const</span> [age, setAge] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">1</span>);
      <span class="hljs-keyword">const</span> [name, setName] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">&#x27;tom&#x27;</span>);

      <span class="hljs-keyword">return</span> [age, setAge, name, setName];
    };
    <span class="hljs-keyword">const</span> { result, rerender } = <span class="hljs-title function_">renderHook</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">usePeople</span>());

    <span class="hljs-title function_">expect</span>(result.<span class="hljs-property">current</span>[<span class="hljs-number">0</span>]).<span class="hljs-title function_">toBe</span>(<span class="hljs-number">1</span>);
    <span class="hljs-title function_">expect</span>(result.<span class="hljs-property">current</span>[<span class="hljs-number">2</span>]).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">&#x27;tom&#x27;</span>);

    <span class="hljs-title function_">act</span>(<span class="hljs-function">() =&gt;</span> {
      result.<span class="hljs-property">current</span>[<span class="hljs-number">1</span>](<span class="hljs-function">(<span class="hljs-params">pre</span>) =&gt;</span> pre + <span class="hljs-number">1</span>);
      <span class="hljs-title function_">resetCursor</span>();
      <span class="hljs-title function_">rerender</span>();
    });

    <span class="hljs-title function_">expect</span>(result.<span class="hljs-property">current</span>[<span class="hljs-number">0</span>]).<span class="hljs-title function_">toBe</span>(<span class="hljs-number">2</span>);
    <span class="hljs-title function_">expect</span>(result.<span class="hljs-property">current</span>[<span class="hljs-number">2</span>]).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">&#x27;tom&#x27;</span>);

    <span class="hljs-title function_">act</span>(<span class="hljs-function">() =&gt;</span> {
      result.<span class="hljs-property">current</span>[<span class="hljs-number">3</span>](<span class="hljs-string">&#x27;tom&amp;jerry&#x27;</span>);
      <span class="hljs-title function_">resetCursor</span>();
      <span class="hljs-title function_">rerender</span>();
    });

    <span class="hljs-title function_">expect</span>(result.<span class="hljs-property">current</span>[<span class="hljs-number">0</span>]).<span class="hljs-title function_">toBe</span>(<span class="hljs-number">2</span>);
    <span class="hljs-title function_">expect</span>(result.<span class="hljs-property">current</span>[<span class="hljs-number">2</span>]).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">&#x27;tom&amp;jerry&#x27;</span>);
  });
});

<span class="hljs-title function_">describe</span>(<span class="hljs-string">&#x27;useEffect_simple&#x27;</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">resetCursor</span>();
    <span class="hljs-title function_">resetMemoizedStates</span>();
  });

  <span class="hljs-title function_">it</span>(<span class="hljs-string">&#x27;useEffect should be defined&#x27;</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">expect</span>(useEffect).<span class="hljs-title function_">toBeDefined</span>();
  });

  <span class="hljs-title function_">it</span>(<span class="hljs-string">&#x27;Different DEPs, Callback calls should also be differentcalls should also be different&#x27;</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> callbackWithNoDeps = jest.<span class="hljs-title function_">fn</span>();
    <span class="hljs-keyword">const</span> callbackWithEmptyDeps = jest.<span class="hljs-title function_">fn</span>();
    <span class="hljs-keyword">const</span> callbackWithChangingDeps = jest.<span class="hljs-title function_">fn</span>();

    <span class="hljs-keyword">let</span> name = <span class="hljs-string">&#x27;tom&#x27;</span>;

    <span class="hljs-keyword">const</span> <span class="hljs-title function_">useProple</span> = (<span class="hljs-params"></span>) =&gt; {
      <span class="hljs-title function_">useEffect</span>(callbackWithNoDeps);
      <span class="hljs-title function_">useEffect</span>(callbackWithEmptyDeps, []);
      <span class="hljs-title function_">useEffect</span>(callbackWithChangingDeps, [name]);
    };

    <span class="hljs-keyword">const</span> { rerender } = <span class="hljs-title function_">renderHook</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">useProple</span>());

    <span class="hljs-title function_">expect</span>(callbackWithNoDeps).<span class="hljs-title function_">toBeCalledTimes</span>(<span class="hljs-number">1</span>);
    <span class="hljs-title function_">expect</span>(callbackWithEmptyDeps).<span class="hljs-title function_">toBeCalledTimes</span>(<span class="hljs-number">1</span>);
    <span class="hljs-title function_">expect</span>(callbackWithChangingDeps).<span class="hljs-title function_">toBeCalledTimes</span>(<span class="hljs-number">1</span>);

    <span class="hljs-title function_">act</span>(<span class="hljs-function">() =&gt;</span> {
      name = <span class="hljs-string">&#x27;tom&amp;jerry&#x27;</span>;
      <span class="hljs-title function_">resetCursor</span>();
      <span class="hljs-title function_">rerender</span>();
    });

    <span class="hljs-title function_">expect</span>(callbackWithNoDeps).<span class="hljs-title function_">toBeCalledTimes</span>(<span class="hljs-number">2</span>);
    <span class="hljs-title function_">expect</span>(callbackWithEmptyDeps).<span class="hljs-title function_">toBeCalledTimes</span>(<span class="hljs-number">1</span>);
    <span class="hljs-title function_">expect</span>(callbackWithChangingDeps).<span class="hljs-title function_">toBeCalledTimes</span>(<span class="hljs-number">2</span>);

    <span class="hljs-title function_">act</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-title function_">resetCursor</span>();
      <span class="hljs-title function_">rerender</span>();
    });

    <span class="hljs-title function_">expect</span>(callbackWithNoDeps).<span class="hljs-title function_">toBeCalledTimes</span>(<span class="hljs-number">3</span>);
    <span class="hljs-title function_">expect</span>(callbackWithEmptyDeps).<span class="hljs-title function_">toBeCalledTimes</span>(<span class="hljs-number">1</span>);
    <span class="hljs-title function_">expect</span>(callbackWithChangingDeps).<span class="hljs-title function_">toBeCalledTimes</span>(<span class="hljs-number">2</span>);
  });
});
</code></pre>
<h2 id="真正的react实现">真正的React实现</h2>
<p>虽然我们用数组基本实现了一个可用的Hooks，了解了Hooks的原理，但在React中，实现方式却有一些差异的。</p>
<ol>
<li>React中是通过类似单链表的形式来代替数组的。通过<code>next</code>按顺序串联所有的<code>hook</code></li>
<li><code>memoizedState</code>，<code>cursor</code>是存在哪里的？如何和每个函数组件一一对应的？</li>
</ol>
<p>我们知道，React会生成一棵组件树（或Fiber单链表），树中每个节点对应了一个组件，hooks的数据就作为组件的一个信息，存储在这些节点上，<strong>伴随组件一起出生，一起死亡</strong>。</p>
<pre><code class="hljs language-ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Hooks</span> = {
    <span class="hljs-comment">// others</span>
    <span class="hljs-attr">memoizedState</span>: <span class="hljs-built_in">any</span>, <span class="hljs-comment">// useState中 保存 state 信息 ｜ useEffect 中 保存着 effect 对象 ｜ useMemo 中 保存的是缓存的值和 deps ｜ useRef 中保存的是 ref 对象</span>
    <span class="hljs-attr">next</span>: <span class="hljs-title class_">Hook</span> | <span class="hljs-literal">null</span>, <span class="hljs-comment">// link 到下一个 hooks，通过 next 串联每一个hooks</span>
}
</code></pre>
<h2 id="解惑">解惑</h2>
<p>Q. 为什么只能在函数最外层调用Hook，不要在循环、条件判断或者子函数中调用？</p>
<p>A. <code>memoizedState</code>是按hook定义的顺序来放置数据的，如果hook顺序变化，<code>memoizedState</code>并不会感知到</p>
<p>Q. 为什么<code>useEffect</code>第二个参数是空数组，在组件更新时回调只会执行一次？</p>
<p>A. 因为依赖一直不变化，<code>callback</code>不会二次执行</p>
<p>Q. 自定义的Hook是如何影响使用它的函数组件的？</p>
<p>A. 共享同一个<code>memoizedState</code>，共享同一个顺序</p>
<p>Q. Capture Value 特性是如何产生的？</p>
<p>A. 每一次<code>rerender</code>的时候，都是重新去执行函数组件了，对于之前已经执行过的函数组件，并不会做任何操作。即<strong>每次渲染（执行），都有它自己的xxx</strong></p>
</div></div></div></article></div></main><footer class="flex flex-col items-center justify-center leading-8 text-sm w-full py-2 border-t text-skin-muted"><p>Designed &amp; developed by<a class="ml-1 text-yellow" target="_blank" href="https://github.com/mrrs878" rel="noreferrer">Mr.RS</a></p><p>©<!-- --> <!-- -->2022</p></footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"title":"React.js学习-hooks原理简析","tags":["hooks"],"categories":"React.js","description":"让我们从实现两个简单的hook入手来探究hooks原理\n\n\u003e [示例代码](https://github.com/mrrs878/review)\n\n## useState\n\n`useState`用于在函数式组件中声明并保存一个变量，`useState`的使用是这样的：\n\n``` ts\nconst [count, setCount] = useState(0);\n\nconsole.log(cou","createDate":"2021-12-23 11:25:20","updateDate":"2021-12-23 21:56:54","body":"\u003cp\u003e让我们从实现两个简单的hook入手来探究hooks原理\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/mrrs878/review\"\u003e示例代码\u003c/a\u003e\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003ch2 id=\"usestate\"\u003euseState\u003c/h2\u003e\n\u003cp\u003e\u003ccode\u003euseState\u003c/code\u003e用于在函数式组件中声明并保存一个变量，\u003ccode\u003euseState\u003c/code\u003e的使用是这样的：\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-ts\"\u003e\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e [count, setCount] = \u003cspan class=\"hljs-title function_\"\u003euseState\u003c/span\u003e(\u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e);\n\n\u003cspan class=\"hljs-variable language_\"\u003econsole\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003elog\u003c/span\u003e(count);\n\n\u003cspan class=\"hljs-title function_\"\u003esetCount\u003c/span\u003e(\u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e);\n\n\u003cspan class=\"hljs-title function_\"\u003esetCount\u003c/span\u003e((pre) + pre + \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e);\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e有几个特点：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e接受一个函数或值作为变量的初始值\u003c/li\u003e\n\u003cli\u003e返回一个数组(元组)，第一个参数是变量值，第二个参数是一个函数，可用来更新变量值\u003c/li\u003e\n\u003cli\u003e返回的更新函数支持传入一个函数，改函数的参数是当前的变量值\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e据此，可以实现一版简单的\u003ccode\u003euseState\u003c/code\u003e\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-ts\"\u003e\u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003euseState\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003einitialState\u003c/span\u003e) {\n    \u003cspan class=\"hljs-comment\"\u003e// 没有考虑传入一个函数的情况\u003c/span\u003e\n    \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e state = initialState;\n    \n    \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003esetState\u003c/span\u003e = (\u003cspan class=\"hljs-params\"\u003enewState\u003c/span\u003e) =\u0026gt; {\n        state = newState;\n    }\n    \n    \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e [state, setState];\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e但在使用的时候会发现，当调用\u003ccode\u003esetCount\u003c/code\u003e的时候，\u003ccode\u003ecount\u003c/code\u003e 并不会变化，这是因为我们没有存储\u003ccode\u003estate\u003c/code\u003e，导致每次渲染组件的时候，\u003ccode\u003estate\u003c/code\u003e都会重新设置\u003c/p\u003e\n\u003cp\u003e为解决这个问题，会自然而然地想到，把\u003ccode\u003estate\u003c/code\u003e提取出来，存在\u003ccode\u003euseState\u003c/code\u003e外面：\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-ts\"\u003e\u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e _state;\n\n\u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003euseState\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003einitialState\u003c/span\u003e) {\n  _state = _state || initialState;\n\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003esetState\u003c/span\u003e = (\u003cspan class=\"hljs-params\"\u003enewState\u003c/span\u003e) =\u0026gt; {\n    _state = \u003cspan class=\"hljs-keyword\"\u003etypeof\u003c/span\u003e newState === \u003cspan class=\"hljs-string\"\u003e\u0026#x27;function\u0026#x27;\u003c/span\u003e ? \u003cspan class=\"hljs-title function_\"\u003enewState\u003c/span\u003e(_state) : newState;\n  };\n\n  \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e [\n    _state,\n    setState,\n  ];\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e测试用例\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-ts\"\u003e\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e { renderHook, act } \u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026#x27;@testing-library/react-hooks\u0026#x27;\u003c/span\u003e;\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e { useState } \u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026#x27;./useState_simple\u0026#x27;\u003c/span\u003e;\n\n\u003cspan class=\"hljs-title function_\"\u003edescribe\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026#x27;useState_simple\u0026#x27;\u003c/span\u003e, \u003cspan class=\"hljs-function\"\u003e() =\u0026gt;\u003c/span\u003e {\n  \u003cspan class=\"hljs-title function_\"\u003eit\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026#x27;useState should be defined\u0026#x27;\u003c/span\u003e, \u003cspan class=\"hljs-function\"\u003e() =\u0026gt;\u003c/span\u003e {\n    \u003cspan class=\"hljs-title function_\"\u003eexpect\u003c/span\u003e(useState).\u003cspan class=\"hljs-title function_\"\u003etoBeDefined\u003c/span\u003e();\n  });\n\n  \u003cspan class=\"hljs-title function_\"\u003eit\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026#x27;When the update function is called, the data is updated normally\u0026#x27;\u003c/span\u003e, \u003cspan class=\"hljs-function\"\u003e() =\u0026gt;\u003c/span\u003e {\n    \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e { result, rerender } = \u003cspan class=\"hljs-title function_\"\u003erenderHook\u003c/span\u003e(\u003cspan class=\"hljs-function\"\u003e() =\u0026gt;\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003euseState\u003c/span\u003e(\u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e));\n\n    \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e [, setState] = result.\u003cspan class=\"hljs-property\"\u003ecurrent\u003c/span\u003e;\n\n    \u003cspan class=\"hljs-title function_\"\u003eact\u003c/span\u003e(\u003cspan class=\"hljs-function\"\u003e() =\u0026gt;\u003c/span\u003e {\n      \u003cspan class=\"hljs-title function_\"\u003esetState\u003c/span\u003e(\u003cspan class=\"hljs-number\"\u003e2\u003c/span\u003e);\n      \u003cspan class=\"hljs-title function_\"\u003ererender\u003c/span\u003e();\n    });\n\n    \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e [state] = result.\u003cspan class=\"hljs-property\"\u003ecurrent\u003c/span\u003e;\n\n    \u003cspan class=\"hljs-title function_\"\u003eexpect\u003c/span\u003e(state).\u003cspan class=\"hljs-title function_\"\u003etoBe\u003c/span\u003e(\u003cspan class=\"hljs-number\"\u003e2\u003c/span\u003e);\n  });\n});\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e至此，实现了一个简单的\u003ccode\u003euseState\u003c/code\u003e，后边会进一步完善\u003c/p\u003e\n\u003ch2 id=\"useeffect\"\u003euseEffect\u003c/h2\u003e\n\u003cp\u003e\u003ccode\u003euseEffect\u003c/code\u003e的使用是这样的\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-ts\"\u003e\u003cspan class=\"hljs-title function_\"\u003euseEffect\u003c/span\u003e(\u003cspan class=\"hljs-function\"\u003e() =\u0026gt;\u003c/span\u003e {\n    \u003cspan class=\"hljs-comment\"\u003e// do something\u003c/span\u003e\n});\n\n\u003cspan class=\"hljs-title function_\"\u003euseEffect\u003c/span\u003e(\u003cspan class=\"hljs-function\"\u003e() =\u0026gt;\u003c/span\u003e {\n    \u003cspan class=\"hljs-comment\"\u003e// do something\u003c/span\u003e\n}, [])\n\n\u003cspan class=\"hljs-title function_\"\u003euseEffect\u003c/span\u003e(\u003cspan class=\"hljs-function\"\u003e() =\u0026gt;\u003c/span\u003e {\n    \u003cspan class=\"hljs-comment\"\u003e// do something\u003c/span\u003e\n}, [deps])\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003ccode\u003euseEffect\u003c/code\u003e的使用有几个特点：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e有两个参数\u003ccode\u003ecallback\u003c/code\u003e和\u003ccode\u003edeps\u003c/code\u003e数组\u003c/li\u003e\n\u003cli\u003e如果\u003ccode\u003edeps\u003c/code\u003e不存在，那么\u003ccode\u003ecallback\u003c/code\u003e在每次\u003ccode\u003erender\u003c/code\u003e时都会执行\u003c/li\u003e\n\u003cli\u003e如果\u003ccode\u003edeps\u003c/code\u003e存在，只有当它发生了变化，\u003ccode\u003ecallback\u003c/code\u003e才会执行\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e根据使用方法和特点，可以做一个简单地实现：\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-tsx\"\u003e\u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e _deps;\n\n\u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003euseEffect\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003ecallback, deps\u003c/span\u003e) {\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e hasNoDeps = !deps;\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e hasChangeDeps = _deps\n    ? !deps?.\u003cspan class=\"hljs-title function_\"\u003eevery\u003c/span\u003e(\u003cspan class=\"hljs-function\"\u003e(\u003cspan class=\"hljs-params\"\u003edep, index\u003c/span\u003e) =\u0026gt;\u003c/span\u003e _deps[index] === dep)\n    : \u003cspan class=\"hljs-literal\"\u003etrue\u003c/span\u003e;\n\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (hasNoDeps || hasChangeDeps) {\n    \u003cspan class=\"hljs-title function_\"\u003ecallback\u003c/span\u003e();\n    _deps = deps;\n  }\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e测试用例\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-ts\"\u003e\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e { renderHook, act } \u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026#x27;@testing-library/react-hooks\u0026#x27;\u003c/span\u003e;\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e { useEffect } \u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026#x27;./useEffect_simple\u0026#x27;\u003c/span\u003e;\n\n\u003cspan class=\"hljs-title function_\"\u003edescribe\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026#x27;useEffect_simple\u0026#x27;\u003c/span\u003e, \u003cspan class=\"hljs-function\"\u003e() =\u0026gt;\u003c/span\u003e {\n  \u003cspan class=\"hljs-title function_\"\u003eit\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026#x27;useEffect should be defined\u0026#x27;\u003c/span\u003e, \u003cspan class=\"hljs-function\"\u003e() =\u0026gt;\u003c/span\u003e {\n    \u003cspan class=\"hljs-title function_\"\u003eexpect\u003c/span\u003e(useEffect).\u003cspan class=\"hljs-title function_\"\u003etoBeDefined\u003c/span\u003e();\n  });\n\n  \u003cspan class=\"hljs-title function_\"\u003eit\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026#x27;When deps is empty, every rendering callback should be executed\u0026#x27;\u003c/span\u003e, \u003cspan class=\"hljs-function\"\u003e() =\u0026gt;\u003c/span\u003e {\n    \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e callback = jest.\u003cspan class=\"hljs-title function_\"\u003efn\u003c/span\u003e();\n    \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e { rerender } = \u003cspan class=\"hljs-title function_\"\u003erenderHook\u003c/span\u003e(\u003cspan class=\"hljs-function\"\u003e() =\u0026gt;\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003euseEffect\u003c/span\u003e(callback));\n\n    \u003cspan class=\"hljs-title function_\"\u003eexpect\u003c/span\u003e(callback).\u003cspan class=\"hljs-title function_\"\u003etoBeCalledTimes\u003c/span\u003e(\u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e);\n\n    \u003cspan class=\"hljs-title function_\"\u003eact\u003c/span\u003e(\u003cspan class=\"hljs-function\"\u003e() =\u0026gt;\u003c/span\u003e {\n      \u003cspan class=\"hljs-title function_\"\u003ererender\u003c/span\u003e();\n    });\n\n    \u003cspan class=\"hljs-title function_\"\u003eexpect\u003c/span\u003e(callback).\u003cspan class=\"hljs-title function_\"\u003etoBeCalledTimes\u003c/span\u003e(\u003cspan class=\"hljs-number\"\u003e2\u003c/span\u003e);\n  });\n\n  \u003cspan class=\"hljs-title function_\"\u003eit\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026#x27;When deps is an empty array, render multiple times but callback should only be called once\u0026#x27;\u003c/span\u003e, \u003cspan class=\"hljs-function\"\u003e() =\u0026gt;\u003c/span\u003e {\n    \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e callback = jest.\u003cspan class=\"hljs-title function_\"\u003efn\u003c/span\u003e();\n    \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e { rerender } = \u003cspan class=\"hljs-title function_\"\u003erenderHook\u003c/span\u003e(\u003cspan class=\"hljs-function\"\u003e() =\u0026gt;\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003euseEffect\u003c/span\u003e(callback, []));\n\n    \u003cspan class=\"hljs-title function_\"\u003eexpect\u003c/span\u003e(callback).\u003cspan class=\"hljs-title function_\"\u003etoBeCalledTimes\u003c/span\u003e(\u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e);\n\n    \u003cspan class=\"hljs-title function_\"\u003eact\u003c/span\u003e(\u003cspan class=\"hljs-function\"\u003e() =\u0026gt;\u003c/span\u003e {\n      \u003cspan class=\"hljs-title function_\"\u003ererender\u003c/span\u003e();\n    });\n\n    \u003cspan class=\"hljs-title function_\"\u003eexpect\u003c/span\u003e(callback).\u003cspan class=\"hljs-title function_\"\u003etoBeCalledTimes\u003c/span\u003e(\u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e);\n  });\n\n  \u003cspan class=\"hljs-title function_\"\u003eit\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026#x27;When deps is changed, callback should be called\u0026#x27;\u003c/span\u003e, \u003cspan class=\"hljs-function\"\u003e() =\u0026gt;\u003c/span\u003e {\n    \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e callback = jest.\u003cspan class=\"hljs-title function_\"\u003efn\u003c/span\u003e();\n    \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e { rerender } = \u003cspan class=\"hljs-title function_\"\u003erenderHook\u003c/span\u003e(\u003cspan class=\"hljs-function\"\u003e(\u003cspan class=\"hljs-params\"\u003e{ name }\u003c/span\u003e) =\u0026gt;\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003euseEffect\u003c/span\u003e(callback, [name]), {\n      \u003cspan class=\"hljs-attr\"\u003einitialProps\u003c/span\u003e: {\n        \u003cspan class=\"hljs-attr\"\u003ename\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\u0026#x27;tom\u0026#x27;\u003c/span\u003e,\n      },\n    });\n\n    \u003cspan class=\"hljs-title function_\"\u003eexpect\u003c/span\u003e(callback).\u003cspan class=\"hljs-title function_\"\u003etoBeCalledTimes\u003c/span\u003e(\u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e);\n\n    \u003cspan class=\"hljs-title function_\"\u003eact\u003c/span\u003e(\u003cspan class=\"hljs-function\"\u003e() =\u0026gt;\u003c/span\u003e {\n      \u003cspan class=\"hljs-title function_\"\u003ererender\u003c/span\u003e({\n        \u003cspan class=\"hljs-attr\"\u003ename\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\u0026#x27;jerry\u0026#x27;\u003c/span\u003e,\n      });\n    });\n\n    \u003cspan class=\"hljs-title function_\"\u003eexpect\u003c/span\u003e(callback).\u003cspan class=\"hljs-title function_\"\u003etoBeCalledTimes\u003c/span\u003e(\u003cspan class=\"hljs-number\"\u003e2\u003c/span\u003e);\n  });\n});\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e到这里，我们又实现了一个可以工作的丐版\u003ccode\u003euseEffect\u003c/code\u003e，hook貌似没有那么难\u003c/p\u003e\n\u003ch2 id=\"优化\"\u003e优化\u003c/h2\u003e\n\u003cp\u003e我们上边实现的两个简单的hook存在一个致命缺点，在一个组件内只能使用一次，对此，我们可以将\u003ccode\u003e_state\u003c/code\u003e和\u003ccode\u003e_deps\u003c/code\u003e保存至一个全局数组\u003ccode\u003ememoizedState \u003c/code\u003e中，并用一个变量存储当前\u003ccode\u003ememoizedState\u003c/code\u003e下标\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-ts\"\u003e\u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e memoizedStates = []; \u003cspan class=\"hljs-comment\"\u003e// hooks存放在这个数组\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e cursor = \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e; \u003cspan class=\"hljs-comment\"\u003e// 当前memoizedState下标\u003c/span\u003e\n\n\u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003euseState\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003einitialState\u003c/span\u003e) {\n  memoizedStates[cursor] = memoizedStates[cursor] || initialState;\n\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e currentCursor = cursor;\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003esetState\u003c/span\u003e = (\u003cspan class=\"hljs-params\"\u003enewState\u003c/span\u003e) =\u0026gt; {\n    memoizedStates[currentCursor] = \u003cspan class=\"hljs-keyword\"\u003etypeof\u003c/span\u003e newState === \u003cspan class=\"hljs-string\"\u003e\u0026#x27;function\u0026#x27;\u003c/span\u003e\n      ? \u003cspan class=\"hljs-title function_\"\u003enewState\u003c/span\u003e(memoizedStates[currentCursor])\n      : newState;\n  };\n\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e res = [memoizedStates[cursor], setState];\n  cursor += \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e;\n\n  \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e res;\n}\n\n\u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003euseEffect\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003ecallback, deps\u003c/span\u003e) {\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e hasNoDeps = deps === \u003cspan class=\"hljs-literal\"\u003eundefined\u003c/span\u003e;\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e preDeps = memoizedStates[cursor];\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e hasChangedDeps = preDeps\n    ? !deps.\u003cspan class=\"hljs-title function_\"\u003eevery\u003c/span\u003e(\u003cspan class=\"hljs-function\"\u003e(\u003cspan class=\"hljs-params\"\u003edep, index\u003c/span\u003e) =\u0026gt;\u003c/span\u003e dep === preDeps[index])\n    : \u003cspan class=\"hljs-literal\"\u003etrue\u003c/span\u003e;\n\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (hasNoDeps || hasChangedDeps) {\n    \u003cspan class=\"hljs-title function_\"\u003ecallback\u003c/span\u003e();\n    memoizedStates[cursor] = deps;\n  }\n\n  cursor += \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e;\n}\n\n\u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003eresetCursor\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003e\u003c/span\u003e) {\n  cursor = \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e;\n}\n\n\u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003eresetMemoizedStates\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003e\u003c/span\u003e) {\n  memoizedStates = [];\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003cstrong\u003eNot Magic, just Arrays\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e测试用例\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-ts\"\u003e\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e { act, renderHook } \u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026#x27;@testing-library/react-hooks\u0026#x27;\u003c/span\u003e;\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e {\n  resetCursor, useEffect, useState, resetMemoizedStates,\n} \u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026#x27;./useState_useEffect\u0026#x27;\u003c/span\u003e;\n\u003cspan class=\"hljs-title function_\"\u003edescribe\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026#x27;useState_simple\u0026#x27;\u003c/span\u003e, \u003cspan class=\"hljs-function\"\u003e() =\u0026gt;\u003c/span\u003e {\n  \u003cspan class=\"hljs-title function_\"\u003eit\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026#x27;useState should be defined\u0026#x27;\u003c/span\u003e, \u003cspan class=\"hljs-function\"\u003e() =\u0026gt;\u003c/span\u003e {\n    \u003cspan class=\"hljs-title function_\"\u003eexpect\u003c/span\u003e(useState).\u003cspan class=\"hljs-title function_\"\u003etoBeDefined\u003c/span\u003e();\n  });\n\n  \u003cspan class=\"hljs-title function_\"\u003eit\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026#x27;When the update function is called, the data is updated normally\u0026#x27;\u003c/span\u003e, \u003cspan class=\"hljs-function\"\u003e() =\u0026gt;\u003c/span\u003e {\n    \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003eusePeople\u003c/span\u003e = (\u003cspan class=\"hljs-params\"\u003e\u003c/span\u003e) =\u0026gt; {\n      \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e [age, setAge] = \u003cspan class=\"hljs-title function_\"\u003euseState\u003c/span\u003e(\u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e);\n      \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e [name, setName] = \u003cspan class=\"hljs-title function_\"\u003euseState\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026#x27;tom\u0026#x27;\u003c/span\u003e);\n\n      \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e [age, setAge, name, setName];\n    };\n    \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e { result, rerender } = \u003cspan class=\"hljs-title function_\"\u003erenderHook\u003c/span\u003e(\u003cspan class=\"hljs-function\"\u003e() =\u0026gt;\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003eusePeople\u003c/span\u003e());\n\n    \u003cspan class=\"hljs-title function_\"\u003eexpect\u003c/span\u003e(result.\u003cspan class=\"hljs-property\"\u003ecurrent\u003c/span\u003e[\u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e]).\u003cspan class=\"hljs-title function_\"\u003etoBe\u003c/span\u003e(\u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e);\n    \u003cspan class=\"hljs-title function_\"\u003eexpect\u003c/span\u003e(result.\u003cspan class=\"hljs-property\"\u003ecurrent\u003c/span\u003e[\u003cspan class=\"hljs-number\"\u003e2\u003c/span\u003e]).\u003cspan class=\"hljs-title function_\"\u003etoBe\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026#x27;tom\u0026#x27;\u003c/span\u003e);\n\n    \u003cspan class=\"hljs-title function_\"\u003eact\u003c/span\u003e(\u003cspan class=\"hljs-function\"\u003e() =\u0026gt;\u003c/span\u003e {\n      result.\u003cspan class=\"hljs-property\"\u003ecurrent\u003c/span\u003e[\u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e](\u003cspan class=\"hljs-function\"\u003e(\u003cspan class=\"hljs-params\"\u003epre\u003c/span\u003e) =\u0026gt;\u003c/span\u003e pre + \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e);\n      \u003cspan class=\"hljs-title function_\"\u003eresetCursor\u003c/span\u003e();\n      \u003cspan class=\"hljs-title function_\"\u003ererender\u003c/span\u003e();\n    });\n\n    \u003cspan class=\"hljs-title function_\"\u003eexpect\u003c/span\u003e(result.\u003cspan class=\"hljs-property\"\u003ecurrent\u003c/span\u003e[\u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e]).\u003cspan class=\"hljs-title function_\"\u003etoBe\u003c/span\u003e(\u003cspan class=\"hljs-number\"\u003e2\u003c/span\u003e);\n    \u003cspan class=\"hljs-title function_\"\u003eexpect\u003c/span\u003e(result.\u003cspan class=\"hljs-property\"\u003ecurrent\u003c/span\u003e[\u003cspan class=\"hljs-number\"\u003e2\u003c/span\u003e]).\u003cspan class=\"hljs-title function_\"\u003etoBe\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026#x27;tom\u0026#x27;\u003c/span\u003e);\n\n    \u003cspan class=\"hljs-title function_\"\u003eact\u003c/span\u003e(\u003cspan class=\"hljs-function\"\u003e() =\u0026gt;\u003c/span\u003e {\n      result.\u003cspan class=\"hljs-property\"\u003ecurrent\u003c/span\u003e[\u003cspan class=\"hljs-number\"\u003e3\u003c/span\u003e](\u003cspan class=\"hljs-string\"\u003e\u0026#x27;tom\u0026amp;jerry\u0026#x27;\u003c/span\u003e);\n      \u003cspan class=\"hljs-title function_\"\u003eresetCursor\u003c/span\u003e();\n      \u003cspan class=\"hljs-title function_\"\u003ererender\u003c/span\u003e();\n    });\n\n    \u003cspan class=\"hljs-title function_\"\u003eexpect\u003c/span\u003e(result.\u003cspan class=\"hljs-property\"\u003ecurrent\u003c/span\u003e[\u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e]).\u003cspan class=\"hljs-title function_\"\u003etoBe\u003c/span\u003e(\u003cspan class=\"hljs-number\"\u003e2\u003c/span\u003e);\n    \u003cspan class=\"hljs-title function_\"\u003eexpect\u003c/span\u003e(result.\u003cspan class=\"hljs-property\"\u003ecurrent\u003c/span\u003e[\u003cspan class=\"hljs-number\"\u003e2\u003c/span\u003e]).\u003cspan class=\"hljs-title function_\"\u003etoBe\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026#x27;tom\u0026amp;jerry\u0026#x27;\u003c/span\u003e);\n  });\n});\n\n\u003cspan class=\"hljs-title function_\"\u003edescribe\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026#x27;useEffect_simple\u0026#x27;\u003c/span\u003e, \u003cspan class=\"hljs-function\"\u003e() =\u0026gt;\u003c/span\u003e {\n  \u003cspan class=\"hljs-title function_\"\u003ebeforeEach\u003c/span\u003e(\u003cspan class=\"hljs-function\"\u003e() =\u0026gt;\u003c/span\u003e {\n    \u003cspan class=\"hljs-title function_\"\u003eresetCursor\u003c/span\u003e();\n    \u003cspan class=\"hljs-title function_\"\u003eresetMemoizedStates\u003c/span\u003e();\n  });\n\n  \u003cspan class=\"hljs-title function_\"\u003eit\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026#x27;useEffect should be defined\u0026#x27;\u003c/span\u003e, \u003cspan class=\"hljs-function\"\u003e() =\u0026gt;\u003c/span\u003e {\n    \u003cspan class=\"hljs-title function_\"\u003eexpect\u003c/span\u003e(useEffect).\u003cspan class=\"hljs-title function_\"\u003etoBeDefined\u003c/span\u003e();\n  });\n\n  \u003cspan class=\"hljs-title function_\"\u003eit\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026#x27;Different DEPs, Callback calls should also be differentcalls should also be different\u0026#x27;\u003c/span\u003e, \u003cspan class=\"hljs-function\"\u003e() =\u0026gt;\u003c/span\u003e {\n    \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e callbackWithNoDeps = jest.\u003cspan class=\"hljs-title function_\"\u003efn\u003c/span\u003e();\n    \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e callbackWithEmptyDeps = jest.\u003cspan class=\"hljs-title function_\"\u003efn\u003c/span\u003e();\n    \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e callbackWithChangingDeps = jest.\u003cspan class=\"hljs-title function_\"\u003efn\u003c/span\u003e();\n\n    \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e name = \u003cspan class=\"hljs-string\"\u003e\u0026#x27;tom\u0026#x27;\u003c/span\u003e;\n\n    \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003euseProple\u003c/span\u003e = (\u003cspan class=\"hljs-params\"\u003e\u003c/span\u003e) =\u0026gt; {\n      \u003cspan class=\"hljs-title function_\"\u003euseEffect\u003c/span\u003e(callbackWithNoDeps);\n      \u003cspan class=\"hljs-title function_\"\u003euseEffect\u003c/span\u003e(callbackWithEmptyDeps, []);\n      \u003cspan class=\"hljs-title function_\"\u003euseEffect\u003c/span\u003e(callbackWithChangingDeps, [name]);\n    };\n\n    \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e { rerender } = \u003cspan class=\"hljs-title function_\"\u003erenderHook\u003c/span\u003e(\u003cspan class=\"hljs-function\"\u003e() =\u0026gt;\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003euseProple\u003c/span\u003e());\n\n    \u003cspan class=\"hljs-title function_\"\u003eexpect\u003c/span\u003e(callbackWithNoDeps).\u003cspan class=\"hljs-title function_\"\u003etoBeCalledTimes\u003c/span\u003e(\u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e);\n    \u003cspan class=\"hljs-title function_\"\u003eexpect\u003c/span\u003e(callbackWithEmptyDeps).\u003cspan class=\"hljs-title function_\"\u003etoBeCalledTimes\u003c/span\u003e(\u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e);\n    \u003cspan class=\"hljs-title function_\"\u003eexpect\u003c/span\u003e(callbackWithChangingDeps).\u003cspan class=\"hljs-title function_\"\u003etoBeCalledTimes\u003c/span\u003e(\u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e);\n\n    \u003cspan class=\"hljs-title function_\"\u003eact\u003c/span\u003e(\u003cspan class=\"hljs-function\"\u003e() =\u0026gt;\u003c/span\u003e {\n      name = \u003cspan class=\"hljs-string\"\u003e\u0026#x27;tom\u0026amp;jerry\u0026#x27;\u003c/span\u003e;\n      \u003cspan class=\"hljs-title function_\"\u003eresetCursor\u003c/span\u003e();\n      \u003cspan class=\"hljs-title function_\"\u003ererender\u003c/span\u003e();\n    });\n\n    \u003cspan class=\"hljs-title function_\"\u003eexpect\u003c/span\u003e(callbackWithNoDeps).\u003cspan class=\"hljs-title function_\"\u003etoBeCalledTimes\u003c/span\u003e(\u003cspan class=\"hljs-number\"\u003e2\u003c/span\u003e);\n    \u003cspan class=\"hljs-title function_\"\u003eexpect\u003c/span\u003e(callbackWithEmptyDeps).\u003cspan class=\"hljs-title function_\"\u003etoBeCalledTimes\u003c/span\u003e(\u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e);\n    \u003cspan class=\"hljs-title function_\"\u003eexpect\u003c/span\u003e(callbackWithChangingDeps).\u003cspan class=\"hljs-title function_\"\u003etoBeCalledTimes\u003c/span\u003e(\u003cspan class=\"hljs-number\"\u003e2\u003c/span\u003e);\n\n    \u003cspan class=\"hljs-title function_\"\u003eact\u003c/span\u003e(\u003cspan class=\"hljs-function\"\u003e() =\u0026gt;\u003c/span\u003e {\n      \u003cspan class=\"hljs-title function_\"\u003eresetCursor\u003c/span\u003e();\n      \u003cspan class=\"hljs-title function_\"\u003ererender\u003c/span\u003e();\n    });\n\n    \u003cspan class=\"hljs-title function_\"\u003eexpect\u003c/span\u003e(callbackWithNoDeps).\u003cspan class=\"hljs-title function_\"\u003etoBeCalledTimes\u003c/span\u003e(\u003cspan class=\"hljs-number\"\u003e3\u003c/span\u003e);\n    \u003cspan class=\"hljs-title function_\"\u003eexpect\u003c/span\u003e(callbackWithEmptyDeps).\u003cspan class=\"hljs-title function_\"\u003etoBeCalledTimes\u003c/span\u003e(\u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e);\n    \u003cspan class=\"hljs-title function_\"\u003eexpect\u003c/span\u003e(callbackWithChangingDeps).\u003cspan class=\"hljs-title function_\"\u003etoBeCalledTimes\u003c/span\u003e(\u003cspan class=\"hljs-number\"\u003e2\u003c/span\u003e);\n  });\n});\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch2 id=\"真正的react实现\"\u003e真正的React实现\u003c/h2\u003e\n\u003cp\u003e虽然我们用数组基本实现了一个可用的Hooks，了解了Hooks的原理，但在React中，实现方式却有一些差异的。\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eReact中是通过类似单链表的形式来代替数组的。通过\u003ccode\u003enext\u003c/code\u003e按顺序串联所有的\u003ccode\u003ehook\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003ememoizedState\u003c/code\u003e，\u003ccode\u003ecursor\u003c/code\u003e是存在哪里的？如何和每个函数组件一一对应的？\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e我们知道，React会生成一棵组件树（或Fiber单链表），树中每个节点对应了一个组件，hooks的数据就作为组件的一个信息，存储在这些节点上，\u003cstrong\u003e伴随组件一起出生，一起死亡\u003c/strong\u003e。\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-ts\"\u003e\u003cspan class=\"hljs-keyword\"\u003etype\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eHooks\u003c/span\u003e = {\n    \u003cspan class=\"hljs-comment\"\u003e// others\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003ememoizedState\u003c/span\u003e: \u003cspan class=\"hljs-built_in\"\u003eany\u003c/span\u003e, \u003cspan class=\"hljs-comment\"\u003e// useState中 保存 state 信息 ｜ useEffect 中 保存着 effect 对象 ｜ useMemo 中 保存的是缓存的值和 deps ｜ useRef 中保存的是 ref 对象\u003c/span\u003e\n    \u003cspan class=\"hljs-attr\"\u003enext\u003c/span\u003e: \u003cspan class=\"hljs-title class_\"\u003eHook\u003c/span\u003e | \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e, \u003cspan class=\"hljs-comment\"\u003e// link 到下一个 hooks，通过 next 串联每一个hooks\u003c/span\u003e\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch2 id=\"解惑\"\u003e解惑\u003c/h2\u003e\n\u003cp\u003eQ. 为什么只能在函数最外层调用Hook，不要在循环、条件判断或者子函数中调用？\u003c/p\u003e\n\u003cp\u003eA. \u003ccode\u003ememoizedState\u003c/code\u003e是按hook定义的顺序来放置数据的，如果hook顺序变化，\u003ccode\u003ememoizedState\u003c/code\u003e并不会感知到\u003c/p\u003e\n\u003cp\u003eQ. 为什么\u003ccode\u003euseEffect\u003c/code\u003e第二个参数是空数组，在组件更新时回调只会执行一次？\u003c/p\u003e\n\u003cp\u003eA. 因为依赖一直不变化，\u003ccode\u003ecallback\u003c/code\u003e不会二次执行\u003c/p\u003e\n\u003cp\u003eQ. 自定义的Hook是如何影响使用它的函数组件的？\u003c/p\u003e\n\u003cp\u003eA. 共享同一个\u003ccode\u003ememoizedState\u003c/code\u003e，共享同一个顺序\u003c/p\u003e\n\u003cp\u003eQ. Capture Value 特性是如何产生的？\u003c/p\u003e\n\u003cp\u003eA. 每一次\u003ccode\u003ererender\u003c/code\u003e的时候，都是重新去执行函数组件了，对于之前已经执行过的函数组件，并不会做任何操作。即\u003cstrong\u003e每次渲染（执行），都有它自己的xxx\u003c/strong\u003e\u003c/p\u003e\n"}},"__N_SSG":true},"page":"/post/[title]","query":{"title":"React.js学习-hooks原理简析"},"buildId":"TVvrPujXTaoFDu5iIhwje","assetPrefix":"/next-blog","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>